<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>direito.love â€” Arquivo</title>
  <meta name="theme-color" content="#16A34A">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="styles.css">
  <style>
    .topbar{display:flex;align-items:center;gap:12px}
    .topbar .tools{margin-left:auto;display:flex;gap:8px}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{border:1px solid #E2E8F0;padding:8px;text-align:left;vertical-align:top}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#ECFDF5;color:#065F46;border:1px solid #A7F3D0;font-size:12px}
    .ia-ico{width:20px;height:20px;vertical-align:middle}
    .container{max-width:980px;margin:0 auto;padding:12px 16px}
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <img src="icons/logo-heart.png" alt="direito.love" style="height:56px">
      <div class="title" style="font-weight:800;font-size:24px">direito.love â€” Arquivo</div>
      <div class="tools">
        <button class="btn" onclick="location.href='index.html'">â† Voltar ao Chat</button>
        <button class="btn" onclick="exportJSON()">ğŸ’¾ Exportar</button>
        <label class="btn">ğŸ“‚ Importar <input type="file" accept="application/json" style="display:none" onchange="importJSON(this.files[0])"></label>
        <button class="btn" onclick="clearAll()">ğŸ—‘ï¸ Limpar</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="badge">HistÃ³rico local (armazenado no seu navegador)</div>
    <table class="table" id="arquivoTable">
      <thead>
        <tr><th>Data</th><th>Tema</th><th>EstratÃ©gia</th><th>Prompt</th><th>AÃ§Ãµes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer style="padding:24px;text-align:center;color:#64748B">ğŸ’š direito.love</footer>

  <script>
  const HKEY = "dlove_history_v2";

  function getHistory(){ try{ return JSON.parse(localStorage.getItem(HKEY) || "[]"); }catch(e){ return []; } }
  function setHistory(arr){ localStorage.setItem(HKEY, JSON.stringify(arr)); }

  function exportJSON(){
    const blob = new Blob([localStorage.getItem(HKEY) || "[]"], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "direito-love-historico.json";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const arr = JSON.parse(reader.result);
        if(Array.isArray(arr)){
          setHistory(arr);
          renderTable();
          alert("Arquivo importado com sucesso.");
        }else alert("Arquivo invÃ¡lido.");
      }catch(e){ alert("Erro ao ler JSON."); }
    };
    reader.readAsText(file);
  }
  function clearAll(){
    if(confirm("Apagar todo o arquivo local?")){ setHistory([]); renderTable(); }
  }

  function openIAFromItem(item, which){
    const encoded = encodeURIComponent(item.body);
    let url = "https://chat.openai.com/";
    if(which==="chatgpt") url = `https://chat.openai.com/?q=${encoded}`;
    if(which==="gemini") url = `https://gemini.google.com/app?hl=pt-BR&query=${encoded}`;
    if(which==="perplexity") url = `https://www.perplexity.ai/?q=${encoded}`;
    window.open(url, "_blank");
    if(!Array.isArray(item.used)) item.used=[];
    if(!item.used.includes(which)) item.used.push(which);
    // persist usage
    const data = getHistory();
    const idx = data.findIndex(x=>x.id===item.id);
    if(idx>=0){ data[idx]=item; setHistory(data); renderTable(); }
  }

  function loadIntoChat(item){
    // stores a temp value so index.html can prefill when it opens
    localStorage.setItem("dlove_prefill", JSON.stringify(item));
    location.href = "index.html";
  }

  function renderTable(){
    const tbody = document.querySelector("#arquivoTable tbody");
    const data = getHistory();
    tbody.innerHTML = data.map(item => `
      <tr>
        <td>${new Date(item.date).toLocaleString()}</td>
        <td>${item.tema}</td>
        <td>${item.strategy}</td>
        <td><textarea readonly style="width:100%;min-height:90px">${item.body}</textarea></td>
        <td>
          <div class="row">
            <button class="btn" onclick='loadIntoChat(${JSON.stringify(item).replace(/'/g,"&#39;")})'>Carregar no chat</button>
            <button class="btn" title="Abrir no ChatGPT" onclick='openIAFromItem(${JSON.stringify(item).replace(/'/g,"&#39;")}, "chatgpt")'><img class="ia-ico" src="icons/chatgpt.svg" alt="ChatGPT"> ChatGPT</button>
            <button class="btn" title="Abrir no Gemini" onclick='openIAFromItem(${JSON.stringify(item).replace(/'/g,"&#39;")}, "gemini")'><img class="ia-ico" src="icons/gemini.svg" alt="Gemini"> Gemini</button>
            <button class="btn" title="Abrir no Perplexity" onclick='openIAFromItem(${JSON.stringify(item).replace(/'/g,"&#39;")}, "perplexity")'><img class="ia-ico" src="icons/perplexity.svg" alt="Perplexity"> Perplexity</button>
          </div>
          <div class="small">Usou: ${(item.used||[]).join(", ") || "â€”"}</div>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="5">Sem itens no arquivo ainda.</td></tr>`;
  }

  document.addEventListener("DOMContentLoaded", renderTable);
  </script>
</body>
</html>
