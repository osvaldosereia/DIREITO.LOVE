<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Vade Mecum — Código Penal | direito.love</title>
<meta name="theme-color" content="#0B3A82" />
<link rel="icon" href="favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="favicon-180.png" />
<link rel="manifest" href="manifest.json" />
<style>
  :root{
    --bg:#f6f7fb; --surface:#ffffff; --text:#0b1220; --muted:#334155; --border:#94a3b8;
    --primary:#0b3a82; --primary-hover:#0a2f6a; --highlight:#E6B800; --highlight-hover:#D8A900;
    --radius:12px; --shadow:0 6px 18px rgba(10,15,25,.06);
    --font:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif;
    --btn-pad-y:8px; --btn-pad-x:14px; --btn-font:13.5px; --btn-min-h:36px;
    --mark-bg:#fff59e; --topbar-bg:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:400 14px/1.55 var(--font);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  :focus-visible{outline:2px solid var(--primary);outline-offset:2px;border-radius:8px}

  .topbar{position:sticky;top:0;z-index:50;background:var(--topbar-bg);border-bottom:1px solid var(--border);backdrop-filter:saturate(180%) blur(6px)}
  .topbar__inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand__logo{height:28px}
  .topbar__actions{display:flex;align-items:center;gap:8px}
  .iconbtn{appearance:none;border:1px solid var(--border);background:#fff;color:#0b1220;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.15s;box-shadow:0 2px 4px rgba(10,15,25,.04)}
  .iconbtn:hover{background:#f8fafc}
  .iconbtn svg{width:18px;height:18px;display:block}

  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .layout{display:grid;grid-template-columns:280px 1fr;gap:14px}
  @media (max-width:900px){.layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }

  h1{margin:6px 0 4px;font-weight:650;letter-spacing:.2px;font-size:19px}
  .muted{color:var(--muted)}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}

  .searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .searchbar input{flex:1;padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:15px;background:#fff;color:#0b1220;transition:border-color .15s,box-shadow .15s}
  .searchbar input::placeholder{color:#94a3b8}
  .searchbar input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(11,58,130,.12)}
  .btn{appearance:none;border:1px solid #B58F00;background:var(--highlight);color:#111;padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:10px;font-size:var(--btn-font);font-weight:600;cursor:pointer;transition:background .15s,transform .05s;min-height:var(--btn-min-h)}
  .btn:hover{background:var(--highlight-hover)}
  .btn-alt{appearance:none;border:1px solid #092a57;background:var(--primary);color:#fff;padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:10px;font-size:var(--btn-font);font-weight:600;cursor:pointer;transition:background .15s,transform .05s;min-height:var(--btn-min-h)}
  .btn-alt:hover{background:var(--primary-hover)}
  .btn-sm{padding:6px 10px;min-height:28px;font-size:12px;border-radius:8px}

  .sidebar .card{position:sticky;top:68px}
  .toc{display:flex;flex-direction:column;gap:6px;max-height:calc(100vh - 120px);overflow:auto}
  .toc a{display:block;padding:8px 10px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:#0b1220;background:#fff;transition:.15s;font-size:13px}
  .toc a:hover{background:#f8fafc}
  .toc .group{margin-top:4px;font-weight:700;color:#0b1220;border-top:1px dashed var(--border);padding-top:8px}
  .toc small{display:block;color:#475569;margin-top:2px}

  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
  .pill{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12.5px}
  .pill input{margin-right:6px}

  .articles{display:block}
  .article{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px 12px;margin:10px 0}
  .article header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .article h2{margin:0;font-size:16px}
  .crumbs{color:#475569;font-size:12px;margin:4px 0 8px}
  .article .actions{display:flex;gap:8px;flex-wrap:wrap}
  .article .body{margin-top:8px;white-space:pre-wrap}
  mark{background:var(--mark-bg);padding:0 2px;border-radius:3px}

  .empty{padding:24px;text-align:center;color:#475569}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:6px;padding:2px 6px;font-size:12px}

  .footer{margin:16px 0 24px;color:#475569;font-size:12.5px;text-align:center}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar__inner">
    <a class="brand" href="index.html" aria-label="Início">
      <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
      <strong>Vade Mecum</strong>
    </a>
    <div class="topbar__actions">
      <button id="btnHome" class="iconbtn" type="button" title="Voltar ao início" aria-label="Início">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 12L12 3l9 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M9 21V9h6v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <aside class="sidebar">
      <div class="card">
        <h1 style="margin-bottom:8px">Sumário rápido</h1>
        <div id="toc" class="toc">
          <div class="muted">Carregando...</div>
        </div>
      </div>
    </aside>

    <section class="main">
      <div class="card">
        <h1 style="margin-bottom:8px">Código Penal (DL 2.848/1940)</h1>
        <div class="searchbar">
          <input id="q" type="search" placeholder="Buscar por artigo, palavra-chave, ex.: 'legítima defesa', 'art 121'…" aria-label="Buscar" />
          <button id="btnLimpar" class="btn" type="button" title="Limpar">Limpar</button>
          <button id="btnExpand" class="btn-alt btn-sm" type="button" title="Expandir tudo">Expandir</button>
          <button id="btnCollapse" class="btn-alt btn-sm" type="button" title="Fechar tudo">Fechar</button>
        </div>
        <div class="toolbar">
          <label class="pill"><input type="checkbox" id="onlyArts" /> Mostrar apenas artigos</label>
          <span class="pill muted">Atalhos: <span class="kbd">/</span> buscar · <span class="kbd">Enter</span> ir para artigo</span>
        </div>
      </div>

      <div id="list" class="articles">
        <div class="card empty">Carregando o Código Penal…</div>
      </div>

      <div class="footer">Fonte: texto integral do Código Penal. Página experimental do direito.love.</div>
    </section>
  </div>
</main>

<script>
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const escapeHtml=(s)=>s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const norm=(s="")=>s.normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').toLowerCase();

  const q=$("#q"), list=$("#list"), toc=$("#toc");
  const onlyArts=$("#onlyArts"), btnLimpar=$("#btnLimpar"), btnExpand=$("#btnExpand"), btnCollapse=$("#btnCollapse");
  $("#btnHome").onclick=()=>location.href="index.html";
  document.addEventListener('keydown',e=>{ if(e.key==='/'){ e.preventDefault(); q.focus(); q.select(); }});

  let DATA = [];   // [{id,num,headingPath,head,body,raw}]
  let TOC  = [];   // [{id,label,small}]

  function parseCP(text){
    const lines = text.replace(/\\r?\\n/g,'\\n').split('\\n');

    const H = {parte:'',titulo:'',capitulo:'',secao:'',subsecao:''};
    const isHeading = (s)=>/^(PARTE\\s+\\w+|T[IÍ]TULO\\s+\\w+|CAP[IÍ]TULO\\s+\\w+|SE(C|Ç)[AÃ]O\\s+\\w+|SUBSE(C|Ç)[AÃ]O\\s+\\w+)/i.test(s.trim());
    const headingLevel = (s)=>{
      s=s.trim();
      if(/^PARTE\\s+/i.test(s)) return 'parte';
      if(/^T[IÍ]TULO\\s+/i.test(s)) return 'titulo';
      if/^CAP[IÍ]TULO\\s+/i.test(s) return 'capitulo';
      if/^SE(C|Ç)[AÃ]O\\s+/i.test(s) return 'secao';
      if/^SUBSE(C|Ç)[AÃ]O\\s+/i.test(s) return 'subsecao';
      return null;
    };

    let cur = null;
    const pushCur=()=>{
      if(!cur) return;
      cur.raw = cur.head + '\\n' + cur.body.join('\\n');
      DATA.push(cur);
      cur=null;
    };

    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      if(isHeading(line)){
        const lvl=headingLevel(line);
        if(lvl){ H[lvl]=line.trim(); if(lvl==='parte'){H.titulo=H.capitulo=H.secao=H.subsecao='';}
                 if(lvl==='titulo'){H.capitulo=H.secao=H.subsecao='';}
                 if(lvl==='capitulo'){H.secao=H.subsecao='';}
                 if(lvl==='secao'){H.subsecao='';} }
        // adiciona no TOC apontando para o próximo artigo que surgir
        TOC.push({id:null,label:line.trim(),small:''});
        continue;
      }
      const m = /^\\s*Art\\.\\s*(\\d+)[ºo]?\\s*[-–—]?\\s*(.*)$/.exec(line);
      if(m){
        pushCur();
        const num=parseInt(m[1],10);
        cur = {
          id:'art-'+num,
          num,
          headingPath: Object.assign({},H),
          head: line.trim(),
          body: []
        };
        // liga TOC pendente a este artigo se houver
        for(let k=TOC.length-1;k>=0;k--){
          if(TOC[k].id===null){ TOC[k].id=cur.id; break; }
        }
        continue;
      }
      if(cur){
        cur.body.push(line);
      }
    }
    pushCur();

    // Preenche TOC vazio inicial com primeira âncora
    if(TOC.length && TOC[0].id===null && DATA.length){ TOC[0].id=DATA[0].id; }
  }

  function renderTOC(){
    if(!TOC.length){ toc.innerHTML='<div class="muted">Sumário indisponível.</div>'; return; }
    toc.innerHTML = TOC.map(t=>`
      <div class="group">${escapeHtml(t.label)}</div>
      <a href="#${t.id}">Ir para seção</a>
    `).join('');
  }

  function renderList(query=''){
    const nq = norm(query);
    const showOnlyArts = !!onlyArts.checked;
    const parts = nq.split(/\\s+/).filter(Boolean);
    const test = (txt)=>parts.every(p=>norm(txt).includes(p));

    const items = [];
    for(const it of DATA){
      const base = it.head + '\\n' + it.body.join('\\n');
      const inHeading = !showOnlyArts && (test(it.headingPath.parte) || test(it.headingPath.titulo) || test(it.headingPath.capitulo) || test(it.headingPath.secao) || test(it.headingPath.subsecao));
      if(!query || test(base) || inHeading){
        items.push(it);
      }
    }
    if(!items.length){
      list.innerHTML = '<div class="card empty">Nada encontrado. Ajuste os termos ou tente: <b>art 121</b>, <b>legítima defesa</b>, <b>excesso punível</b>.</div>';
      return;
    }
    const mark = (s)=>{
      if(!query) return escapeHtml(s);
      let html = escapeHtml(s);
      for(const p of parts){
        if(!p) continue;
        const re = new RegExp('('+p.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')+')','ig');
        html = html.replace(re,'<mark>$1</mark>');
      }
      return html;
    };

    list.innerHTML = items.map(it=>{
      const crumbs = [it.headingPath.parte,it.headingPath.titulo,it.headingPath.capitulo,it.headingPath.secao,it.headingPath.subsecao]
        .filter(Boolean).join(' · ');
      const headTxt = it.head.replace(/^\\s*Art\\.\\s*\\d+[ºo]?\\s*[-–—]?\\s*/,'').trim();
      return `
      <article class="article" id="${it.id}">
        <header>
          <h2>Art. ${it.num} — ${headTxt ? mark(headTxt) : ''}</h2>
          <div class="actions">
            <button class="btn-sm btn" data-copy="${escapeHtml(it.raw)}" title="Copiar artigo">Copiar</button>
            <button class="btn-sm btn-alt" data-link="${it.id}" title="Link direto">Link</button>
          </div>
        </header>
        ${crumbs?`<div class="crumbs">${escapeHtml(crumbs)}</div>`:''}
        <div class="body">${mark(it.body.join('\\n').trim())}</div>
      </article>`;
    }).join('');

    // binds
    $$('.actions [data-copy]').forEach(btn=>btn.onclick=()=>{
      const txt = btn.getAttribute('data-copy');
      navigator.clipboard.writeText(txt).then(()=>{ btn.textContent='Copiado!'; setTimeout(()=>btn.textContent='Copiar',1200); });
    });
    $$('.actions [data-link]').forEach(btn=>btn.onclick=()=>{
      const id = btn.getAttribute('data-link');
      history.replaceState(null,'','#'+id);
      const el = document.getElementById(id);
      if(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); }
    });
  }

  function jumpIfArt(q){
    const m = /^(?:art(?:igo)?\\s*)?(\\d{1,4})\\b/i.exec(q.trim());
    if(m){
      const id='art-'+parseInt(m[1],10);
      const el = document.getElementById(id);
      if(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); return true; }
    }
    return false;
  }

  // Events
  q.addEventListener('input',()=>{ localStorage.setItem('vm:q', q.value); renderList(q.value); });
  q.addEventListener('keydown',e=>{ if(e.key==='Enter'){ if(!jumpIfArt(q.value)){ renderList(q.value); } } });
  btnLimpar.onclick=()=>{ q.value=''; q.dispatchEvent(new Event('input')); q.focus(); };
  btnExpand.onclick=()=>{ document.querySelectorAll('.article').forEach(a=>a.open=true); };
  btnCollapse.onclick=()=>{ location.hash=''; window.scrollTo({top:0,behavior:'smooth'}); };

  // Load
  fetch('cp.txt').then(r=>r.text()).then(text=>{
    parseCP(text);
    renderTOC();
    const saved = localStorage.getItem('vm:q')||'';
    q.value = saved;
    renderList(saved);
    // if hash present, jump
    if(location.hash){
      const el = document.querySelector(location.hash);
      if(el){ setTimeout(()=>el.scrollIntoView({behavior:'smooth'}), 150); }
    }
  }).catch(err=>{
    list.innerHTML = '<div class="card empty">Não foi possível carregar o Código Penal. Verifique o arquivo <b>cp.txt</b> na raiz do site.</div>';
    console.error(err);
  });
})();
</script>
</body>
</html>
