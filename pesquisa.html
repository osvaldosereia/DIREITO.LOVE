<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>direito.love — Pesquisa</title>
  <meta name="theme-color" content="#F5C400" />
  <meta name="description" content="Pesquisa de artigos, súmulas, jurisprudências e logo jurídicos no direito.love" />
  <meta name="keywords" content="pesquisa jurídica, direito, OAB, concursos, jurisprudência, súmulas" />
  <meta name="author" content="direito.love" />
  <meta name="robots" content="index, follow" />
  <link rel="icon" href="favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="favicon-180.png" />

  <style>
    :root{
      --bg:#FFFDF0; --surface:#ffffff; --text:#001840; --border:#e5e7eb;
      --primary:#102A71; --highlight:#F5C400; --highlight-light:#FFDC5F;
      --radius:10px; --shadow:0 4px 16px rgba(0,0,0,.05);
      --font:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif;

      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --bar-h: 64px;

      --success:#16a34a;
      --muted-btn:#e5e7eb;

      /* Botão VER NOTÍCIA (verde) */
      --news-btn:#16a34a;
      --news-btn-hover:#22c55e;

      /* Offset para scroll (topbar + mini-relatório) */
      --snap-offset: 120px; /* fallback */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:400 13px/1.4 var(--font);}

    /* TOPBAR */
    .topbar{position:sticky; top:0; z-index:100; background:var(--highlight); border-bottom:1px solid rgba(0,0,0,.08)}
    .topbar__inner{max-width:1160px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:#111}
    .brand__logo{height:36px}
    .chip{padding:6px 14px; border-radius:20px; background:#fff; border:1px solid var(--border); font-size:13px; color:var(--primary); text-decoration:none; font-weight:500; transition:.15s}
    .chip:hover{background:var(--highlight-light)}

    /* Página */
    .wrap{max-width:900px;margin:0 auto;padding:22px; transition:padding-bottom .2s ease;}
    h2{margin:0 0 10px;color:var(--primary)}

    .search-box{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:20px 0;}
    #busca{flex:1; padding:10px 12px; border:2px solid var(--primary); border-radius:8px; font-size:15px}
    #filtroFonte{padding:10px; border:2px solid var(--primary); border-radius:8px; font-size:14px; min-width:220px; background:#fff}

    #btnBuscar{appearance:none; border:none; background:var(--primary); color:#fff; padding:10px 14px; border-radius:8px; font-size:14px; cursor:pointer;}
    #btnBuscar:disabled{opacity:.7; cursor:progress}

    /* Mini-relatório (agora com select "Ir para…") */
    .mini-relatorio{
      position:sticky; top:54px; background:#fff7d6;
      padding:8px 16px; display:none; gap:8px; flex-wrap:wrap;
      border-bottom:1px solid var(--border); z-index:90; justify-content:center;
    }
    #gotoFonte{
      padding:10px; border:2px solid var(--primary); border-radius:8px; font-size:14px; min-width:240px; background:#fff;
    }

    .result{
      background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:12px 14px;margin:12px 0;position:relative;
      /* compensa topbar + mini-relatório */
      scroll-margin-top: var(--snap-offset);
    }
    .result p{margin:0;font-size:13px;line-height:1.4}
    .filetag{margin:0 0 6px 0;font-weight:700}

    .actions{margin-top:8px;display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:none;background:var(--highlight);color:#000;padding:6px 10px;border-radius:8px;
      font-size:13px;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--highlight-light)}
    .btn-alt{appearance:none;border:none;background:var(--primary);color:#fff;padding:6px 10px;border-radius:8px;
      font-size:13px;cursor:pointer;transition:.15s}
    .btn-alt:hover{background:#264399}
    .btn-alt.is-selected{ background: var(--success); color:#fff; }
    .btn-alt.is-selected:hover{ filter:brightness(.95); }

    /* VER NOTÍCIA (verde à direita) */
    .btn-news{background:var(--news-btn);color:#fff;text-decoration:none;display:inline-block;padding:6px 10px;border-radius:8px;font-size:13px;margin-left:auto}
    .btn-news:hover{background:var(--news-btn-hover)}

    .more-wrap{display:flex; justify-content:center; margin:16px 0}
    #btnMais{min-width:180px}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;
      padding:8px 12px;border-radius:999px;opacity:0;transition:.2s;z-index:60}
    .toast.show{opacity:1}

    /* Barra flutuante seleção */
    #dl-bar-selecao{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(12px + var(--safe-bottom)); z-index:9999; background:#111; color:#fff;
      padding:10px 12px; border-radius:12px; display:none; align-items:center; gap:8px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); font: 500 14px/1.2 var(--font);
      pointer-events:none;
    }
    #dl-bar-selecao button{border:0; padding:8px 12px; border-radius:10px; cursor:pointer; pointer-events:auto;}
    #dl-enviar{ background: var(--primary); color:#fff; } #dl-enviar:hover{ background:#264399; } #dl-enviar:disabled{ opacity:.5; filter:grayscale(.3) }
    #dl-limpar{ background: var(--muted-btn); color:#111; } #dl-limpar:hover{ background:#d6dae1 }

    @media (max-width: 600px){
      /* No mobile o filtro aparece antes do input */
      #filtroFonte{order:-1; width:100%}
      .btn,.btn-alt{ padding:8px 12px; }
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar" role="banner">
    <div class="topbar__inner">
      <a class="brand" href="index.html" aria-label="Início">
        <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
      </a>
      <nav class="topbar__actions" aria-label="Ações">
        <a class="chip" href="index.html">Prompt</a>
        <a class="chip" href="pesquisa.html">Pesquisar</a>
      </nav>
    </div>
  </header>

  <!-- Mini-relatório (select "Ir para…") -->
  <div id="miniRelatorio" class="mini-relatorio"></div>

  <div class="wrap">
    <h2>Pesquisa de Conteúdo Jurídico</h2>
    <p>Digite um termo (artigo, súmula, jurisprudência ou palavra-chave) e clique em <b>Buscar</b>.</p>

    <div class="search-box">
      <select id="filtroFonte" aria-label="Filtrar por fonte"></select>
      <input id="busca" type="text" placeholder="Ex: artigo 5º, súmula 381, dano moral..." />
      <button id="btnBuscar">Buscar</button>
    </div>

    <div id="resultados"></div>
    <div class="more-wrap" style="display:none"><button id="btnMais" class="btn">Carregar mais</button></div>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Barra flutuante -->
  <div id="dl-bar-selecao" aria-live="polite">
    <button id="dl-enviar" disabled>Enviar para o Prompt</button>
    <button id="dl-limpar">Limpar</button>
  </div>

<script>
/* ===== pesquisa.js (mantém seleção + copiar + paginação) ===== */
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const resultados=$("#resultados");
  const busca=$("#busca");
  const btnBuscar=$("#btnBuscar");
  const btnMais=$("#btnMais");
  const moreWrap=$(".more-wrap");
  const wrap=$(".wrap");
  const miniRelatorio=$("#miniRelatorio");
  const filtroSelect=$("#filtroFonte");

  const toast=(msg,t=1600)=>{const el=$("#toast");el.textContent=msg;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};
  const norm=(s="")=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  /* === Lista COMPLETA de arquivos === */
  const arquivos = [
    "data/julgados_direito_administrativo.json",
    "data/julgados_direito_ambiental.json",
    "data/julgados_direito_bancario.json",
    "data/julgados_direito_civil.json",
    "data/julgados_direito_constitucional.json",
    "data/julgados_direito_eleitoral.json",
    "data/julgados_direito_empresarial.json",
    "data/noticias_migalhas_1.json",
    "data/noticias_migalhas_2.json",
    "data/noticias_migalhas_3.json",
    "data/penal.json",
    "data/processo_penal.json",
    "data/sumula_stf.json",
    "data/sumulas_stj.json",
    "data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json",
    "data/temas_repetitivos_stj.json",
    "data/teses_stf.json"
  ];

  /* Nomes amigáveis */
  const nomesAmigaveis = {
    "noticias": "Notícias",
    "noticias_migalhas_1": "Notícias Migalhas",
    "noticias_migalhas_2": "Notícias Migalhas",
    "noticias_migalhas_3": "Notícias Migalhas",

    "sumula_stf": "Súmulas STF",
    "sumulas_stj": "Súmulas STJ",
    "sumulas_tse": "Súmulas TSE",
    "sumulas_vinculantes_stf": "Súmulas Vinculantes STF",
    "temas_repetitivos_stj": "Temas Repetitivos STJ",
    "teses_stf": "Teses STF",

    "penal": "Código Penal",
    "processo_penal": "Código de Processo Penal",

    "julgados_direito_administrativo": "Julgados de Direito Administrativo",
    "julgados_direito_ambiental": "Julgados de Direito Ambiental",
    "julgados_direito_bancario": "Julgados de Direito Bancário",
    "julgados_direito_civil": "Julgados de Direito Civil",
    "julgados_direito_constitucional": "Julgados de Direito Constitucional",
    "julgados_direito_eleitoral": "Julgados de Direito Eleitoral",
    "julgados_direito_empresarial": "Julgados de Direito Empresarial"
  };

  const KEY='dl_pesquisa_selecionados';
  const MAX_SNIPPET = 400;
  const PAGE_SIZE = 10;

  const getCarrinho = ()=>JSON.parse(localStorage.getItem(KEY)||'[]');
  const setCarrinho = (arr)=>localStorage.setItem(KEY, JSON.stringify(arr));
  const dedupPush = (arr, item)=>{
    const k = item.id || item._id || (item.fonte+':'+(item.texto||'').slice(0,50));
    if(!arr.some(x => x.id === k)){ arr.push({...item, id: k}); }
    return arr;
  };

  /* Agrupador: normaliza "noticias_*" -> "noticias" */
  const normalizarFonte = (f)=> f && f.startsWith('noticias') ? 'noticias' : f;

  /* Popular o <select> de filtro dinamicamente a partir de 'arquivos' */
  function popularFiltro(){
    filtroSelect.innerHTML = '';
    const optTodas = new Option('Todas as fontes', 'todas', true, true);
    filtroSelect.add(optTodas);

    // opção agregada para notícias
    const optNoticias = new Option('Notícias (todas)', 'noticias', false, false);
    filtroSelect.add(optNoticias);

    // opções para cada arquivo, exceto os de notícias (já agregados)
    const vistos = new Set();
    for(const arq of arquivos){
      const tag = arq.split('/').pop().replace(/\.json$/,'');
      if(tag.startsWith('noticias')) continue; // agregados no "Notícias"
      if(vistos.has(tag)) continue;
      vistos.add(tag);
      const label = nomesAmigaveis[tag] || tag;
      filtroSelect.add(new Option(label, tag, false, false));
    }
  }

  /* Carregar todos os dados */
  async function carregarDados(){
    const dados=[];
    for(const arq of arquivos){
      try{
        const tag = arq.split('/').pop().replace(/\.json$/,'');
        const r=await fetch(arq); if(!r.ok) continue;
        const j=await r.json();
        (Array.isArray(j)? j : []).forEach((it, idx)=>{
          const _id   = it.id || `${tag}_${idx}`;
          const texto = (it.texto || '').trim();
          dados.push({ ...it, _id, fonte: tag, textoNorm: norm(texto) });
        });
      }catch(e){ console.warn("Erro ao carregar",arq,e); }
    }
    return dados;
  }

  let baseDados=[];     // tudo
  let lastResults=[];   // últimos achados
  let pageIndex=0;      // paginação
  let firstByFonte={};  // índice do primeiro item por fonte (normalizada)

  // Ajusta offset do scroll (topbar + mini)
  function ajustarSnapOffset(){
    const top = document.querySelector('.topbar');
    const off = (top?.offsetHeight || 0) + (miniRelatorio?.offsetHeight || 0) + 8;
    document.documentElement.style.setProperty('--snap-offset', off+'px');
  }
  window.addEventListener('resize', ajustarSnapOffset);

  // Inicialização
  popularFiltro();
  carregarDados().then(d=>{
    baseDados=d;
    toast("Base carregada com sucesso!");
  });

  /* Render do mini-relatório como SELECT "Ir para…" */
  function renderMiniRelatorio(results){
    // contagem agregada por fonte normalizada
    const contagem = results.reduce((acc, it)=>{
      const f = normalizarFonte(it.fonte);
      acc[f] = (acc[f]||0) + 1;
      return acc;
    }, {});

    // monta o select
    miniRelatorio.innerHTML = '';
    const goto = document.createElement('select');
    goto.id = 'gotoFonte';
    const placeholder = new Option('Ir para…', '', true, true);
    placeholder.disabled = true;
    goto.add(placeholder);

    // ordena por label amigável
    const fontes = Object.keys(contagem).sort((a,b)=>{
      const la=(nomesAmigaveis[a]||a).toLowerCase();
      const lb=(nomesAmigaveis[b]||b).toLowerCase();
      return la.localeCompare(lb);
    });

    for(const f of fontes){
      const label = (nomesAmigaveis[f] || f);
      goto.add(new Option(`${label} — ${contagem[f]}`, f));
    }

    // handler: auto-carrega lotes até conter o primeiro item da fonte e rola
    goto.addEventListener('change', ()=>{
      const f = goto.value;
      if(!f) return;
      const idx = firstByFonte[f];
      if(idx !== undefined){
        const neededBatches = Math.floor(idx / PAGE_SIZE) + 1;
        while(pageIndex < neededBatches){
          renderBatch(true);
        }
      }
      ajustarSnapOffset();
      const primeiro = document.querySelector(`.result[data-fonte="${f}"]`);
      if(primeiro) primeiro.scrollIntoView({behavior:'smooth', block:'start'});
      // volta para placeholder
      goto.selectedIndex = 0;
    });

    miniRelatorio.appendChild(goto);
    miniRelatorio.style.display = 'flex';
    ajustarSnapOffset();
  }

  /* Render em lote (10 por vez) */
  function renderBatch(append=false){
    const carrinho = getCarrinho();
    const start = pageIndex*PAGE_SIZE;
    const end = Math.min(lastResults.length, start+PAGE_SIZE);
    if(!append){ resultados.innerHTML=""; }

    for(let i=start;i<end;i++){
      const item = lastResults[i];
      const fNorm = normalizarFonte(item.fonte);

      const div=document.createElement("div");
      div.className="result";
      div.setAttribute('data-fonte', fNorm);

      const fonteP=document.createElement('p');
      fonteP.className='filetag';
      const nomeBonito = nomesAmigaveis[fNorm] || nomesAmigaveis[item.fonte] || item.fonte;
      fonteP.innerHTML=`<strong>${nomeBonito}</strong>`;
      div.appendChild(fonteP);

      const p=document.createElement("p");
      const txt=(item.texto||'').trim();
      p.textContent = txt.length>MAX_SNIPPET ? (txt.substring(0,MAX_SNIPPET)+"...") : txt;
      div.appendChild(p);

      const actions=document.createElement("div");
      actions.className="actions";

      if(item.url){
        // Botão à direita, verde
        const verNoticia=document.createElement("a");
        verNoticia.textContent="Ver notícia";
        verNoticia.href=item.url;
        verNoticia.target="_blank";
        verNoticia.className="btn-news";
        actions.appendChild(verNoticia);
      } else {
        const copiar=document.createElement("button");
        copiar.textContent="Copiar";
        copiar.className="btn";
        copiar.addEventListener("click",async()=>{
          try{await navigator.clipboard.writeText(item.texto||'');toast("Copiado!");}
          catch{toast("Erro ao copiar.");}
        });

        const selBtn=document.createElement("button");
        selBtn.className="btn-alt";
        const key=item.id||item._id;
        const syncBtn=(on)=>{selBtn.textContent=on?"Selecionado":"Selecionar";selBtn.classList.toggle('is-selected', on);};
        syncBtn(carrinho.some(x => x.id === key));
        selBtn.addEventListener("click",()=>{
          let arr=getCarrinho();
          const obj = { id:key, fonte:item.fonte, texto:item.texto };
          const isIn = arr.some(x => x.id === key);
          if (isIn){ arr = arr.filter(x => x.id !== key); syncBtn(false); }
          else { arr = dedupPush(arr, obj); syncBtn(true); }
          setCarrinho(arr); updateBar();
        });

        actions.appendChild(copiar);
        actions.appendChild(selBtn);
      }

      div.appendChild(actions);
      resultados.appendChild(div);
    }

    pageIndex++;
    const hasMore = pageIndex*PAGE_SIZE < lastResults.length;
    moreWrap.style.display = hasMore ? "flex" : "none";
    updateBar();
  }

  function updateBar(){
    const c=getCarrinho().length;
    $('#dl-enviar').disabled = c===0;
  }

  function toggleBar(show){
    const bar = $('#dl-bar-selecao');
    bar.style.display = show ? 'flex' : 'none';
    wrap.style.paddingBottom = show ? `calc(var(--bar-h) + 16px + var(--safe-bottom))` : '22px';
  }

  /* Executa busca */
  async function executarBusca(){
    const termo = busca.value.trim();
    resultados.innerHTML="";
    moreWrap.style.display="none";
    pageIndex=0;

    if(!termo){
      miniRelatorio.style.display="none";
      toggleBar(false);
      return;
    }

    btnBuscar.disabled = true;
    document.body.style.cursor = 'progress';
    try{
      const termoNorm = norm(termo);
      const filtroVal = filtroSelect.value; // 'todas' | 'noticias' | tag exata

      lastResults = baseDados.filter(x=>{
        const fNorm = normalizarFonte(x.fonte);
        const fonteOk = (filtroVal==='todas') ? true
                        : (filtroVal==='noticias' ? fNorm==='noticias' : x.fonte===filtroVal);
        return fonteOk && (x.textoNorm||'').includes(termoNorm);
      });

      // mapeia o primeiro índice por fonte normalizada
      firstByFonte = {};
      for(let i=0;i<lastResults.length;i++){
        const f = normalizarFonte(lastResults[i].fonte);
        if(firstByFonte[f] === undefined) firstByFonte[f] = i;
      }

      if(!lastResults.length){
        resultados.innerHTML = "<p>Nenhum resultado encontrado.</p>";
        miniRelatorio.style.display = "none";
        toggleBar(false);
      }else{
        renderMiniRelatorio(lastResults);
        toggleBar(true);
        renderBatch(false);
      }
    }finally{
      btnBuscar.disabled = false;
      document.body.style.cursor = '';
    }
  }

  /* Eventos */
  btnBuscar.addEventListener("click", executarBusca);
  $("#btnMais").addEventListener("click", ()=> renderBatch(true));
  busca.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); executarBusca(); } });

  // Barra: enviar / limpar
  $('#dl-enviar').addEventListener('click', ()=> { window.location.href = 'index.html#pesquisa'; });
  $('#dl-limpar').addEventListener('click', ()=> {
    localStorage.removeItem(KEY);
    updateBar();
    [...$$('.btn-alt.is-selected', resultados)].forEach(b=>b.classList.remove('is-selected'));
    [...$$('.btn-alt', resultados)].forEach(b=>{ if(b.textContent==="Selecionado") b.textContent="Selecionar"; });
  });
})();
</script>
</body>
</html>
