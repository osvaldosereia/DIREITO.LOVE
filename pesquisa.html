<script>
/* ===== pesquisa.js (lazy loading com cache) ===== */
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const resultados=$("#resultados");
  const busca=$("#busca");
  const btnBuscar=$("#btnBuscar");
  const btnMais=$("#btnMais");
  const moreWrap=$(".more-wrap");
  const wrap=$(".wrap");
  const toast=(msg,t=1600)=>{const el=$("#toast");el.textContent=msg;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};

  // Normaliza (ignora acentos/Ã§)
  const norm=(s="")=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  // Config
  const KEY='dl_pesquisa_selecionados';
  const arquivos = [
    "data/julgados_direito_administrativo.json",
    "data/julgados_direito_ambiental.json",
    "data/julgados_direito_bancario.json",
    "data/penal.json",
    "data/processo_penal.json",
    "data/sumula_stf.json",
    "data/sumulas_stj.json",
    "data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json",
    "data/temas_repetitivos_stj.json",
    "data/teses_stf.json"
  ];
  const MAX_SNIPPET = 400;
  const PAGE_SIZE = 40;

  const cache = {}; // ðŸ”¹ guarda os arquivos jÃ¡ carregados

  const getCarrinho = ()=>JSON.parse(localStorage.getItem(KEY)||'[]');
  const setCarrinho = (arr)=>localStorage.setItem(KEY, JSON.stringify(arr));
  const dedupPush = (arr, item)=>{ if(!arr.some(x => x.id === item.id)){ arr.push(item); } return arr; };

  async function loadFile(arq){
    if(cache[arq]) return cache[arq]; // jÃ¡ em cache
    try{
      const tag = arq.split('/').pop().replace(/\.json$/,'');
      const r=await fetch(arq);
      if(!r.ok) return [];
      const j=await r.json();
      const arr = (Array.isArray(j)? j : []).map((it, idx)=>({
        ...it,
        id: it.id || `${tag}_${idx}`,
        fonte: tag,
        textoNorm: norm(it.texto||"")
      }));
      cache[arq] = arr; // guarda em cache
      return arr;
    }catch(e){
      console.warn("Erro ao carregar", arq, e);
      return [];
    }
  }

  let lastResults=[];   
  let pageIndex=0;      

  // Render em lote
  function renderBatch(append=false){
    const carrinho = getCarrinho();
    const start = pageIndex*PAGE_SIZE;
    const end = Math.min(lastResults.length, start+PAGE_SIZE);
    if(!append){ resultados.innerHTML=""; }

    for(let i=start;i<end;i++){
      const item = lastResults[i];
      const div=document.createElement("div");
      div.className="result";

      const fonteP = document.createElement('p');
      fonteP.className = 'filetag';
      fonteP.innerHTML = `<strong>${(item.fonte||'').trim()}</strong>`;
      div.appendChild(fonteP);

      const p=document.createElement("p");
      const txt = (item.texto||'').trim();
      p.textContent = txt.length>MAX_SNIPPET ? (txt.substring(0,MAX_SNIPPET)+"...") : txt;
      div.appendChild(p);

      const actions=document.createElement("div");
      actions.className="actions";

      const copiar=document.createElement("button");
      copiar.textContent="Copiar";
      copiar.className="btn";
      copiar.addEventListener("click",async()=>{ 
        try{ await navigator.clipboard.writeText(item.texto||''); toast("Copiado!"); } 
        catch{ toast("Erro ao copiar."); } 
      });

      const selBtn=document.createElement("button");
      selBtn.className="btn-alt";
      const key=item.id;
      const sync=(on)=>{ selBtn.textContent=on?"Selecionado":"Selecionar"; selBtn.classList.toggle('is-selected',on); };
      sync(carrinho.some(x=>x.id===key));
      selBtn.addEventListener("click",()=>{ 
        let arr=getCarrinho();
        const isIn=arr.some(x=>x.id===key);
        if(isIn){ arr=arr.filter(x=>x.id!==key); sync(false); }
        else { arr=dedupPush(arr,{id:key,fonte:item.fonte,texto:item.texto}); sync(true); }
        setCarrinho(arr); updateBar();
      });

      actions.appendChild(copiar);
      actions.appendChild(selBtn);
      div.appendChild(actions);
      resultados.appendChild(div);
    }

    pageIndex++;
    const hasMore = pageIndex*PAGE_SIZE < lastResults.length;
    moreWrap.style.display = hasMore ? "flex" : "none";
    updateBar();
  }

  function updateBar(){ $('#dl-enviar').disabled = getCarrinho().length===0; }
  function toggleBar(show){ $('#dl-bar-selecao').style.display=show?'flex':'none'; }

  async function executarBusca(){
    const termo = busca.value.trim();
    resultados.innerHTML="";
    moreWrap.style.display="none";
    pageIndex=0;

    if(!termo){ toggleBar(false); return; }

    btnBuscar.disabled = true;
    document.body.style.cursor = 'progress';
    try{
      const termoNorm = norm(termo);
      let achados=[];

      // ðŸ”¹ Carrega arquivos sob demanda
      for(const arq of arquivos){
        const dados = await loadFile(arq);
        const filtro = dados.filter(x => (x.textoNorm||"").includes(termoNorm));
        achados.push(...filtro);
      }

      lastResults = achados;
      if(!lastResults.length){ resultados.innerHTML="<p>Nenhum resultado encontrado.</p>"; toggleBar(false); }
      else { toggleBar(true); renderBatch(false); }

    }finally{
      btnBuscar.disabled=false;
      document.body.style.cursor='';
    }
  }

  // Eventos
  btnBuscar.addEventListener("click", executarBusca);
  $("#btnMais").addEventListener("click", ()=> renderBatch(true));
  busca.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); executarBusca(); } });

  $('#dl-enviar').addEventListener('click', ()=>{ window.location.href='index.html#pesquisa'; });
  $('#dl-limpar').addEventListener('click', ()=>{ localStorage.removeItem(KEY); updateBar(); [...$$('.btn-alt.is-selected')].forEach(b=>b.classList.remove('is-selected')); });
})();
</script>
