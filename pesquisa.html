<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>direito.love — Pesquisa</title>
  <meta name="theme-color" content="#F5C400" />
  <meta name="description" content="Pesquisa de artigos, súmulas, jurisprudências e conteúdos jurídicos no direito.love" />
  <meta name="keywords" content="pesquisa jurídica, direito, OAB, concursos, jurisprudência, súmulas" />
  <meta name="author" content="direito.love" />
  <meta name="robots" content="index, follow" />
  <link rel="icon" href="favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="favicon-180.png" />
  <style>
    :root{
      --bg:#FFFDF0; --surface:#ffffff; --text:#001840; --border:#e5e7eb;
      --primary:#102A71; --highlight:#F5C400; --highlight-light:#FFDC5F;
      --radius:12px; --shadow:0 4px 16px rgba(0,0,0,.05);
      --font:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --bar-h: 56px;
      --success:#16a34a;
      --muted-btn:#e5e7eb;
      --news-btn:#16a34a;
      --news-btn-hover:#22c55e;
      --snap-offset: 96px;
      --btn-pad-y: 6px;
      --btn-pad-x: 10px;
      --btn-font: 12.5px;
      --btn-min-h: 34px;
      --btn-min-w: 96px;
      --chip-pad-y: 6px;
      --chip-pad-x: 10px;
      --chip-font: 12.5px;
      --chip-radius: 8px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:400 13px/1.4 var(--font);}

    /* Topbar */
    .topbar{position:sticky; top:0; z-index:100; background:var(--highlight); border-bottom:1px solid rgba(0,0,0,.08)}
    .topbar__inner{max-width:1160px; margin:0 auto; padding:8px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:#111}
    .brand__logo{height:32px}
    .chip{
      padding:var(--chip-pad-y) var(--chip-pad-x);
      border-radius:var(--chip-radius);
      background:#fff; border:1px solid var(--border);
      font-size:var(--chip-font); color:var(--primary); text-decoration:none; font-weight:600; transition:.15s
    }
    .chip:hover{background:var(--highlight-light)}

    /* Layout */
    .wrap{max-width:900px;margin:0 auto;padding:22px; transition:padding-bottom .2s ease;}
    h2{margin:0 0 10px;color:var(--primary)}
    .search-box{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:20px 0;}
    #busca{flex:1; padding:10px 12px; border:2px solid var(--primary); border-radius:8px; font-size:15px}
    #btnBuscar{
      appearance:none; border:1px solid var(--primary); background:var(--primary); color:#fff;
      padding:var(--btn-pad-y) var(--btn-pad-x); border-radius:8px; font-size:var(--btn-font); cursor:pointer;
      min-height:var(--btn-min-h); min-width:var(--btn-min-w);
    }
    #btnBuscar:disabled{opacity:.7; cursor:progress}

    /* Acordeões de categorias */
    #categorias{ margin-top: 10px; }
    .cat{
      background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow);
      margin:12px 0; overflow:hidden; scroll-margin-top: var(--snap-offset);
    }
    .cat > summary{
      list-style:none; cursor:pointer; padding:10px 14px; font-weight:800; color:var(--primary);
      display:flex; align-items:center; justify-content:space-between;
    }
    .cat > summary::-webkit-details-marker{ display:none; }
    .cat[open] > summary{ background:#fff7d6; }
    .cat-count{ font-weight:700; background:#0f172a0d; color:#0f172a; padding:2px 8px; border-radius:999px; font-size:12px; }

    .cat-body{ padding: 10px 14px; }
    .cat-more{ display:flex; justify-content:center; padding: 4px 14px 12px; }
    .cat-more .btn{ min-width: var(--btn-min-w); }

    /* Card de resultado */
    .result{
      background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);
      padding:12px 14px;margin:10px 0;position:relative;
    }
    .filetag{
      display:inline-block; font-weight:700; font-size:12px; padding:2px 8px; border-radius:999px;
      background:#f1f5f9; color:#0f172a; margin:0 0 8px 0;
    }
    .result p{margin:0;font-size:13px;line-height:1.55}
    .actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Botões */
    .btn{
      appearance:none;border:1px solid var(--border);background:var(--highlight);color:#000;
      padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;
      font-size:var(--btn-font);cursor:pointer;transition:.15s; min-height:var(--btn-min-h); min-width:var(--btn-min-w);
    }
    .btn:hover{background:var(--highlight-light)}
    .btn-alt{
      appearance:none;border:1px solid #0f2a71;background:var(--primary);color:#fff;
      padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;
      font-size:var(--btn-font);cursor:pointer;transition:.15s; min-height:var(--btn-min-h); min-width:var(--btn-min-w);
    }
    .btn-alt:hover{background:#264399}
    .btn-alt.is-selected{ background: var(--success); color:#fff; border-color:#168a44; }
    .btn-alt.is-selected:hover{ filter:brightness(.95); }
    .btn-news{
      background:var(--news-btn);color:#fff;text-decoration:none;display:inline-block;
      padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;font-size:var(--btn-font);
      min-height:var(--btn-min-h); min-width:var(--btn-min-w); margin-left:auto; border:1px solid #0e8f42;
    }
    .btn-news:hover{background:var(--news-btn-hover)}

    .toggle-more{ margin-left:6px; background:none; border:0; color:var(--primary); cursor:pointer; font-size:12px; padding:2px 4px; line-height:1; }

    /* Barra seleção */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;
      padding:8px 12px;border-radius:999px;opacity:0;transition:.2s;z-index:60}
    .toast.show{opacity:1}
    #dl-bar-selecao{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(10px + var(--safe-bottom)); z-index:9999; background:#111; color:#fff;
      padding:8px 10px; border-radius:12px; display:none; align-items:center; gap:8px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); font: 500 13px/1.2 var(--font);
      pointer-events:none;
    }
    #dl-bar-selecao button{
      border:1px solid var(--border); padding:var(--btn-pad-y) var(--btn-pad-x);
      border-radius:8px; cursor:pointer; pointer-events:auto; font-size:var(--btn-font);
      min-height:var(--btn-min-h); min-width:var(--btn-min-w);
    }
    #dl-enviar{ background: var(--primary); color:#fff; border-color:#0f2a71; } #dl-enviar:hover{ background:#264399; } #dl-enviar:disabled{ opacity:.5; filter:grayscale(.3) }
    #dl-limpar{ background:#fff; color:#111; } #dl-limpar:hover{ background:#f2f4f7 }

    @media (max-width: 600px){
      .actions{ gap:8px; }
    }
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="topbar__inner">
      <a class="brand" href="index.html" aria-label="Início">
        <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
      </a>
      <nav class="topbar__actions" aria-label="Ações">
        <a class="chip" href="index.html">Prompt</a>
        <a class="chip" href="pesquisa.html" aria-current="page">Pesquisar</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <h2>Pesquisa de Conteúdo Jurídico</h2>
    <p>Digite um termo (artigo, súmula, jurisprudência ou palavra-chave) e clique em <b>Buscar</b>.</p>

    <div class="search-box">
      <input id="busca" type="text" placeholder="Ex: art. 150 CP, súmula 381, dano moral..." />
      <button id="btnBuscar">Buscar</button>
    </div>

    <!-- Contêiner dos acordeões de categorias -->
    <section id="categorias"></section>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

  <div id="dl-bar-selecao" aria-live="polite">
    <button id="dl-enviar" disabled>Enviar para o Prompt</button>
    <button id="dl-limpar">Limpar</button>
  </div>

<script>
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const categoriasEl=$("#categorias");
  const busca=$("#busca");
  const btnBuscar=$("#btnBuscar");
  const wrap=$(".wrap");
  const toast=(m,t=1600)=>{const el=$("#toast");el.textContent=m;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};

  const AUTO_OPEN_FIRST = false; // todas as categorias fechadas

  /* ======================= Utils & Normalização ======================= */
  const norm = (s="") => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  function hasWhole(hay, word){ if(!word) return true; const re=new RegExp(`(^|[^a-z0-9])${esc(word)}([^a-z0-9]|$)`,'i'); return re.test(hay); }
  function hasAllWords(hay, words){ for(const w of words){ if(!hasWhole(hay,w)) return false; } return true; }
  const romanLower = s => String(s).replace(/[^ivxlcdm]/gi,'').toLowerCase();

  function tokenizeLegal(s){
    // normaliza e quebra em tokens alfanuméricos
    const t = normalizeLegal(s);
    return t.split(/[^a-z0-9]+/).filter(Boolean);
  }
  function normalizeLegal(s){
    let t = norm(s);
    t = t.replace(/\bpar\.?\b/g, ' paragrafo ');
    t = t.replace(/\bart\.?\b|\bartigo\b/g, ' art ');
    t = t.replace(/\binc\.?\b/g, ' inciso ');
    t = t.replace(/\bal\.?\b/g, ' alinea ');
    t = t.replace(/(\d+)\s*[ºªoa]\b/g, '$1');
    t = t.replace(/["'()]/g, ' ').replace(/\s+/g, ' ').trim();
    return t;
  }
  function normalizarFonte(f){ return f && f.startsWith('noticias') ? 'noticias' : f; }

  /* ======================= Intent & Mapas ======================= */
  function fonteFromQueryPad(base){
    const padded = ` ${base} `;
    const map = [
      { re:/\b(cp|cpb|codigo penal( brasileiro)?)\b/,              fonte:'codigo_penal' },
      { re:/\b(cpp|codigo de processo penal)\b/,                    fonte:'codigo_processo_penal' },
      { re:/\b(cc|codigo civil)\b/,                                 fonte:'codigo_civil' },
      { re:/\b(cpc|codigo de processo civil)\b/,                    fonte:'codigo_processo_civil' },
      { re:/\b(ctn|codigo tributario nacional)\b/,                  fonte:'codigo_tributario_nacional' },
      { re:/\b(cdc|codigo de defesa do consumidor)\b/,              fonte:'codigo_defesa_consumidor' },
      { re:/\b(ctb|codigo de transito brasileiro)\b/,               fonte:'codigo_transito_brasileiro' }
    ];
    for(const a of map){ if(a.re.test(padded)) return a.fonte; }
    return null;
  }
  function tribunalFromQuery(base){
    const padded = ` ${base} `;
    if (/\bstf\b|supremo\b/.test(padded)) return 'stf';
    if (/\bstj\b/.test(padded)) return 'stj';
    if (/\btse\b|eleitoral\b/.test(padded)) return 'tse';
    return null;
  }
  function classifyIntent(base){
    const padded = ` ${base} `;
    if (/\bnoticia(s)?\b|migalhas\b/.test(padded)) return 'noticias';
    if (/\bs[uú]mula\b|\bsv\b|vinculante\b/.test(padded)) return 'sumula';
    if (/\btema(s)?(\s+repetitivo(s)?)?\b/.test(padded)) return 'tema';
    if (/\btese(s)?\b/.test(padded)) return 'tese';
    if (/\b(adi|adpf|adc|resp|aresp|re|are|hc|rms|agint|agrg|edcl|edv)\b/i.test(padded)) return 'juris';
    if (/\bart(\.|igo)?\b|\bparagrafo\b|\binciso\b|\balinea\b/.test(padded) || fonteFromQueryPad(base)) return 'codigo';
    return 'geral';
  }

  /* ======================= Parser com SEQUÊNCIA ======================= */
  function parseLegalQuery(raw){
    const base = normalizeLegal(raw);
    const padded = ` ${base} `;
    const fonteFilter = fonteFromQueryPad(base);
    const tribHint = tribunalFromQuery(base);
    const intent = classifyIntent(base);

    // extrai estrutura
    let artNum=null; { const m=padded.match(/\bart\s*([0-9]{1,4})(?:[\-]?[a-z])?\b/); if(m) artNum=m[1]; }
    let paragrafo=null; { const m=padded.match(/\bparagrafo\s*(unico|\d+)\b/); if(m) paragrafo=m[1]; }
    let inciso=null; { const m=padded.match(/\binciso\s*([ivxlcdm]+)\b/); if(m) inciso=romanLower(m[1]); }
    let alinea=null; { const m=padded.match(/\balinea\s*([a-z])\b/); if(m) alinea=m[1].toLowerCase(); }
    const caput = /\bcaput\b/.test(padded);

    let sumulaNum=null; { const m=(raw.match(/\bs[úu]mula(?:\s+vinculante)?\s*(\d{1,4})/i) || raw.match(/\bsv\s*(\d{1,4})\b/i)); if(m) sumulaNum=m[1]; }
    let temaNum=null;   { const m=raw.match(/\btema(?:\s+repetitivo)?\s*(\d{1,4})\b/i); if(m) temaNum=m[1]; }
    let teseNum=null;   { const m=raw.match(/\btese\s*(\d{1,4})\b/i); if(m) teseNum=m[1]; }

    const STOP=new Set(['de','da','do','das','dos','e','ou','a','o','as','os','no','na','nos','nas','para','por','em','um','uma','ao','à','que','com','sem','sobre','entre','ate']);
    const all = base.split(' ').filter(Boolean);

    // sequência em ordem, sem stopwords repetidas
    const seq = [];
    for(const tok of all){
      if(STOP.has(tok)) continue;
      // normalizações já feitas em normalizeLegal
      seq.push(tok);
    }

    // se tiver estrutura, prioriza sequência estruturada (para proximidade)
    const structSeq = [];
    if(artNum){ structSeq.push('art', String(artNum)); if(paragrafo){ structSeq.push('paragrafo', String(paragrafo)); } if(inciso){ structSeq.push('inciso', String(inciso)); } if(alinea){ structSeq.push('alinea', String(alinea)); } if(caput){ structSeq.push('caput'); } }
    if(sumulaNum){ structSeq.push(String(sumulaNum)); }
    if(temaNum){ structSeq.push(String(temaNum)); }
    if(teseNum){ structSeq.push(String(teseNum)); }

    // words (para fallback de uma palavra só)
    const wordsSet=new Set(seq);
    if(artNum){ wordsSet.add('art'); wordsSet.add(String(artNum)); }
    if(paragrafo){ wordsSet.add('paragrafo'); wordsSet.add(String(paragrafo)); }
    if(inciso){ wordsSet.add('inciso'); wordsSet.add(String(inciso)); }
    if(alinea){ wordsSet.add('alinea'); wordsSet.add(String(alinea)); }
    if(caput){ wordsSet.add('caput'); }
    if(sumulaNum){ wordsSet.add(String(sumulaNum)); }
    if(temaNum){ wordsSet.add(String(temaNum)); }
    if(teseNum){ wordsSet.add(String(teseNum)); }

    return {
      intent, fonteFilter, tribHint,
      artNum, paragrafo, inciso, alinea, caput, sumulaNum, temaNum, teseNum,
      seq: structSeq.length>=2 ? structSeq : seq,     // usa sequência estruturada quando útil
      words:[...wordsSet]
    };
  }

  /* ======================= Dados & nomes ======================= */
  const arquivos = [
    "data/julgados_direito_administrativo.json",
    "data/julgados_direito_ambiental.json",
    "data/julgados_direito_bancario.json",
    "data/julgados_direito_civil.json",
    "data/julgados_direito_constitucional.json",
    "data/julgados_direito_eleitoral.json",
    "data/julgados_direito_empresarial.json",
    "data/noticias_migalhas_1.json",
    "data/noticias_migalhas_2.json",
    "data/noticias_migalhas_3.json",
    "data/codigo_penal.json",
    "data/codigo_processo_penal.json",
    "data/sumula_stf.json",
    "data/sumulas_stj.json",
    "data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json",
    "data/temas_repetitivos_stj.json",
    "data/teses_stf.json",
    "data/codigo_processo_civil.json",
    "data/codigo_civil.json",
    "data/codigo_tributario_nacional.json",
    "data/codigo_defesa_consumidor.json",
    "data/codigo_transito_brasileiro.json"
  ];

  const nomesAmigaveis = {
    noticias: "Notícias",
    noticias_migalhas_1: "Notícias Migalhas",
    noticias_migalhas_2: "Notícias Migalhas",
    noticias_migalhas_3: "Notícias Migalhas",
    sumula_stf: "Súmulas STF",
    sumulas_stj: "Súmulas STJ",
    sumulas_tse: "Súmulas TSE",
    sumulas_vinculantes_stf: "Súmulas Vinculantes STF",
    temas_repetitivos_stj: "Temas Repetitivos STJ",
    teses_stf: "Teses STF",
    codigo_tributario_nacional: "Código Tributário Nacional",
    codigo_penal: "Código Penal",
    codigo_civil: "Código Civil",
    codigo_processo_penal: "Código de Processo Penal",
    codigo_processo_civil: "Código de Processo Civil",
    julgados_direito_administrativo: "Julgados de Direito Administrativo",
    julgados_direito_ambiental: "Julgados de Direito Ambiental",
    julgados_direito_bancario: "Julgados de Direito Bancário",
    julgados_direito_civil: "Julgados de Direito Civil",
    julgados_direito_constitucional: "Julgados de Direito Constitucional",
    julgados_direito_eleitoral: "Julgados de Direito Eleitoral",
    julgados_direito_empresarial: "Julgados de Direito Empresarial",
    codigo_defesa_consumidor: "Código de Defesa do Consumidor",
    codigo_transito_brasileiro: "Código de Trânsito Brasileiro"
  };

  const catOrder = ["noticias", "codigos", "sumulas", "julgados", "temas_repetitivos_stj", "teses_stf", "outros"];
  const categorias = {
    noticias: { label: "Notícias", match: f => f.startsWith("noticias") },
    codigos: { label: "Códigos", match: f => f.startsWith("codigo_") },
    sumulas: { label: "Súmulas", match: f => f.startsWith("sumula") || f.startsWith("sumulas_") || f==="sumulas_vinculantes_stf" },
    julgados: { label: "Julgados", match: f => f.startsWith("julgados_") },
    temas_repetitivos_stj: { label: "Temas Repetitivos STJ", match: f => f==="temas_repetitivos_stj" },
    teses_stf: { label: "Teses STF", match: f => f==="teses_stf" },
    outros: { label: "Outros", match: f => true }
  };

  /* ======================= Carregar dados (tokens pré-computados) ======================= */
  async function carregarDados(){
    const dados=[];
    for(const arq of arquivos){
      try{
        const tag=arq.split('/').pop().replace(/\.json$/,'');
        const r=await fetch(arq); if(!r.ok) continue;
        const j=await r.json();
        (Array.isArray(j)?j:[]).forEach((it,idx)=>{
          const _id = it.id || `${tag}_${idx}`;

          const parts=[];
          if(it.titulo) parts.push(String(it.titulo));
          if(it.ementa) parts.push(String(it.ementa));
          if(it.resumo) parts.push(String(it.resumo));
          if(it.texto)  parts.push(String(it.texto));
          if(it.caput)  parts.push(String(it.caput));
          if(Array.isArray(it.paragrafos)) parts.push(it.paragrafos.join(' '));
          if(Array.isArray(it.incisos))    parts.push(it.incisos.join(' '));
          if(it.sumula) parts.push(String(it.sumula));
          if(it.conteudo) parts.push(String(it.conteudo));
          if(it.artigo)   parts.push(String(it.artigo));
          const textoIndex = parts.join(' • ').trim();

          const textoNorm  = norm(textoIndex);
          const textoLegal = normalizeLegal(textoIndex);
          const tokens     = tokenizeLegal(textoIndex);

          // metadados
          let artNumDoc=null;
          if (it.artigo){
            const m=String(it.artigo).match(/art\.?\s*([0-9]{1,4})/i);
            if(m) artNumDoc=m[1];
          }
          if(!artNumDoc && /^codigo_/.test(tag)){
            const m2=textoIndex.match(/art\.?\s*([0-9]{1,4})/i);
            if(m2) artNumDoc=m2[1];
          }

          let sumulaNumDoc=null; {
            const m1=textoIndex.match(/S[úu]mula(?: Vinculante)?\s*(\d{1,4})/i);
            if(m1) sumulaNumDoc=m1[1];
          }
          let temaNumDoc=null; {
            const m2=textoIndex.match(/\bTema(?: Repetitivo)?\s*(\d{1,4})\b/i);
            if(m2) temaNumDoc=m2[1];
          }
          let teseNumDoc=null; {
            const m3=textoIndex.match(/\bTese\s*(\d{1,4})\b/i);
            if(m3) teseNumDoc=m3[1];
          }

          let tribDoc=null;
          if (/sumula_stf|sumulas_vinculantes_stf|teses_stf/.test(tag)) tribDoc='stf';
          else if (/sumulas_stj|temas_repetitivos_stj/.test(tag)) tribDoc='stj';
          else if (/sumulas_tse/.test(tag)) tribDoc='tse';

          dados.push({
            ...it,
            _id,
            fonte:tag,
            texto:textoIndex,
            textoNorm,
            textoLegal,
            tokens,
            artNum:artNumDoc,
            sumulaNum:sumulaNumDoc,
            temaNum:temaNumDoc,
            teseNum:teseNumDoc,
            tribDoc
          });
        });
      }catch(e){ console.warn('Erro ao carregar',arq,e); }
    }
    return dados;
  }

  /* ======================= Proximidade ======================= */
  const MAX_GAP = 1; // <= 1 palavra não informada entre termos
  function proximityScore(tokens, seq, maxGap=MAX_GAP){
    if(!seq || seq.length<2) return -1; // sem sequência para testar
    // encontra a menor “penalidade” caminhando pela sequência na ordem
    // greedy: para cada termo, pega a primeira ocorrência após a posição atual com gap permitido
    let pos = -1; let penalty = 0;
    for(let i=0;i<seq.length;i++){
      const term = seq[i];
      // procurar índice >= pos+1
      let found = -1;
      for(let j=pos+1;j<tokens.length;j++){
        if(tokens[j]===term){
          // se não é o primeiro termo, verifica gap
          if(pos>=0 && (j - pos - 1) > maxGap){ // muito longe
            // ainda pode existir outra ocorrência mais próxima depois; então continue buscando até estourar
            // mas se achar uma próxima ocorrência com gap válido, usamos ela
            // vamos apenas marcar found e calcular a menor que respeite o gap
            // melhor abordagem: procurar a primeira ocorrência que respeite o gap
            // se nenhuma respeitar, falha
            // então aqui não setamos found; seguimos procurando
          }else{
            found = j; break;
          }
        }
      }
      if(found===-1) return Number.NEGATIVE_INFINITY; // falhou proximidade
      if(pos>=0) penalty += (found - pos - 1); // gap usado (0 ou 1 normalmente)
      pos = found;
    }
    return penalty; // menor é melhor (0 perfeito; 1 aceitável)
  }

  /* ======================= Scoring & Busca Flex ======================= */
  let baseDados=[];

  function scoreDoc(doc, q, prox){
    let s = 0;

    if (q.intent === 'noticias' && normalizarFonte(doc.fonte)==='noticias') s += 8;

    if (q.intent === 'sumula'){
      if (/^sumulas?_|^sumula_/.test(doc.fonte)) s += 7;
      if (q.tribHint && doc.tribDoc === q.tribHint) s += 4;
      if (q.sumulaNum && String(doc.sumulaNum||'')===String(q.sumulaNum)) s += 10;
    }

    if (q.intent === 'tema'){
      if (doc.fonte === 'temas_repetitivos_stj') s += 7;
      if (q.temaNum && String(doc.temaNum||'')===String(q.temaNum)) s += 10;
    }

    if (q.intent === 'tese'){
      if (doc.fonte === 'teses_stf') s += 7;
      if (q.teseNum && String(doc.teseNum||'')===String(q.teseNum)) s += 10;
    }

    if (q.intent === 'codigo'){
      if (q.fonteFilter && normalizarFonte(doc.fonte)===q.fonteFilter) s += 8;
      if (q.artNum && String(doc.artNum||'')===String(q.artNum)) s += 12; // art bateu
      if (q.paragrafo && hasWhole(doc.textoLegal,'paragrafo') && hasWhole(doc.textoLegal,String(q.paragrafo))) s += 2;
      if (q.inciso && hasWhole(doc.textoLegal,'inciso') && hasWhole(doc.textoLegal,String(q.inciso))) s += 2;
      if (q.alinea && hasWhole(doc.textoLegal,'alinea') && hasWhole(doc.textoLegal,String(q.alinea))) s += 2;
    }

    if (q.intent === 'juris'){
      if (/^julgados_/.test(doc.fonte)) s += 6;
      if (q.tribHint && doc.tribDoc === q.tribHint) s += 2;
    }

    if (q.words?.length){ for(const w of q.words){ if(hasWhole(doc.textoLegal,w)) s += 1; } }

    // bônus por proximidade: pen = 0 => +8; pen = 1 => +6; (menor melhor)
    if(Number.isFinite(prox) && prox>=0){
      s += (prox===0 ? 8 : prox===1 ? 6 : Math.max(0, 5 - prox)); // degrada suavemente
    }

    return s;
  }

  function escolherCandidatos(q, base){
    const f = normalizarFonte;
    if (q.intent==='noticias')        return base.filter(d=>f(d.fonte)==='noticias');
    if (q.intent==='sumula')          return base.filter(d => /^sumulas?_|^sumula_/.test(d.fonte));
    if (q.intent==='tema')            return base.filter(d => d.fonte==='temas_repetitivos_stj');
    if (q.intent==='tese')            return base.filter(d => d.fonte==='teses_stf');
    if (q.intent==='codigo'){
      if (q.fonteFilter) return base.filter(d => f(d.fonte)===q.fonteFilter);
      return base.filter(d => /^codigo_/.test(d.fonte));
    }
    if (q.intent==='juris')           return base.filter(d => /^julgados_/.test(d.fonte));
    return base; // geral
  }

  function buscarFlex(termoRaw){
    const q = parseLegalQuery(termoRaw||'');
    let cand = escolherCandidatos(q, baseDados);

    // Estrutural (sempre entra)
    let struct = [];
    if (q.intent==='codigo' && q.artNum){
      struct = cand.filter(d => String(d.artNum||'')===String(q.artNum));
    } else if (q.intent==='sumula' && q.sumulaNum){
      struct = cand.filter(d => String(d.sumulaNum||'')===String(q.sumulaNum));
    } else if (q.intent==='tema' && q.temaNum){
      struct = cand.filter(d => String(d.temaNum||'')===String(q.temaNum));
    } else if (q.intent==='tese' && q.teseNum){
      struct = cand.filter(d => String(d.teseNum||'')===String(q.teseNum));
    }

    // Textual com proximidade (se houver sequência útil)
    let text=[];
    if(q.seq && q.seq.length>=2){
      for(const d of cand){
        const pen = proximityScore(d.tokens, q.seq, MAX_GAP);
        if(Number.isFinite(pen) && pen>=0){
          text.push({doc:d, pen});
        }
      }
    }else{
      // fallback para 0/1 termo: palavras inteiras clássicas
      for(const d of cand){
        if(hasAllWords(d.textoLegal, q.words||[])) text.push({doc:d, pen:-1});
      }
    }

    // Unir sem duplicar (manter penalidade)
    const byId=new Map();
    for(const x of struct){ byId.set(x._id, {doc:x, pen:-1}); }
    for(const x of text){
      const prev=byId.get(x.doc._id);
      if(!prev || (prev.pen<0 && x.pen>=0) || (prev.pen>=0 && x.pen>=0 && x.pen<prev.pen)){
        byId.set(x.doc._id, x);
      }
    }
    let results = Array.from(byId.values());

    // Ranking por score + proximidade
    results.sort((a,b)=> scoreDoc(b.doc,q,b.pen) - scoreDoc(a.doc,q,a.pen) );

    // devolve só os docs (o render não precisa da penalidade)
    return results.map(x=>x.doc);
  }

  /* ======================= Selecão & UI ======================= */
  const KEY='dl_pesquisa_selecionados';
  const getCarrinho=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
  const setCarrinho=(a)=>localStorage.setItem(KEY, JSON.stringify(a));
  const dedupPush=(arr,item)=>{ const k=item.id||item._id||(item.fonte+':'+(item.texto||'').slice(0,50)); if(!arr.some(x=>x.id===k)) arr.push({...item,id:k}); return arr; };

  const MAX_SNIPPET=400, PAGE_SIZE=10;

  function buildCard(item, carrinho){
    const fNorm = normalizarFonte(item.fonte);
    const isNoticias = fNorm === 'noticias';
    const nomeBonito = (nomesAmigaveis[fNorm] || nomesAmigaveis[item.fonte] || item.fonte);

    const div=document.createElement("div");
    div.className="result";

    const fonteP=document.createElement('div');
    fonteP.className='filetag';
    fonteP.textContent = nomeBonito;
    div.appendChild(fonteP);

    const p=document.createElement("p");
    const txt=(item.texto||'').trim();
    const isLong=txt.length>MAX_SNIPPET;
    p.textContent=isLong?txt.substring(0,MAX_SNIPPET)+'…':txt;
    div.appendChild(p);

    if(isLong){
      const tg=document.createElement('button'); tg.type='button'; tg.className='toggle-more';
      tg.textContent='Ver mais'; tg.dataset.expanded='0';
      tg.addEventListener('click',()=>{ const on=tg.dataset.expanded==='1';
        if(on){ p.textContent=txt.substring(0,MAX_SNIPPET)+'…'; tg.textContent='Ver mais'; tg.dataset.expanded='0'; }
        else { p.textContent=txt; tg.textContent='Ver menos'; tg.dataset.expanded='1'; }
      }); p.after(tg);
    }

    const actions=document.createElement("div"); actions.className="actions";

    const copyText = (item.texto && item.texto.trim())
      ? item.texto
      : [item.titulo || item.title || '', item.url || ''].filter(Boolean).join(' — ');

    // Copiar: NÃO mostrar para notícias
    if(!isNoticias){
      const copiar=document.createElement("button"); copiar.textContent='Copiar'; copiar.className='btn';
      copiar.addEventListener("click",async()=>{ try{ await navigator.clipboard.writeText(copyText||''); toast('Copiado!'); }catch{ toast('Erro ao copiar.'); } });
      actions.appendChild(copiar);
    }

    // Selecionar: sempre
    const sel=document.createElement("button"); sel.className='btn-alt';
    const key = item.id || item._id || ( (item.fonte||'') + ':' + (copyText||'').slice(0,50) );
    const sync=(on)=>{ sel.textContent=on?'Selecionado':'Selecionar'; sel.classList.toggle('is-selected',on); };
    sync(carrinho.some(x=>x.id===key));
    sel.addEventListener('click',()=>{
      let arr=getCarrinho();
      const obj={ id:key, fonte:item.fonte, texto: copyText };
      if(arr.some(x=>x.id===key)){ arr=arr.filter(x=>x.id!==key); sync(false); }
      else { arr=dedupPush(arr,obj); sync(true); }
      setCarrinho(arr); updateBar();
    });
    actions.appendChild(sel);

    // Ver notícia (se houver URL)
    if(item.url){
      const a=document.createElement('a'); a.textContent='Ver notícia'; a.href=item.url; a.target='_blank'; a.rel='noopener noreferrer'; a.className='btn-news';
      actions.appendChild(a);
    }

    div.appendChild(actions);
    return div;
  }

  function groupResults(items){
    const groups = {};
    for(const id of Object.keys(categorias)){
      groups[id] = { label: categorias[id].label, items: [], rendered: 0 };
    }
    items.forEach(it=>{
      const f = it.fonte || '';
      let bucket = 'outros';
      for(const id of Object.keys(categorias)){
        if(id==='outros') continue;
        if(categorias[id].match(f)){ bucket=id; break; }
      }
      groups[bucket].items.push(it);
    });
    const list = Object.entries(groups)
      .filter(([,g])=>g.items.length>0)
      .sort((a,b)=>{
        const diff = b[1].items.length - a[1].items.length;
        if(diff!==0) return diff;
        return catOrder.indexOf(a[0]) - catOrder.indexOf(b[0]);
      });
    return Object.fromEntries(list);
  }

  function renderCategorias(groups){
    categoriasEl.innerHTML='';
    const entries = Object.entries(groups);
    if(entries.length===0){
      categoriasEl.innerHTML = '<p>Nenhum resultado encontrado.</p>';
      return;
    }
    let firstOpened = false;

    for(const [catId, group] of entries){
      const det = document.createElement('details');
      det.className='cat';
      det.dataset.cat = catId;

      const sum = document.createElement('summary');
      const title = document.createElement('span'); title.textContent = group.label;
      const count = document.createElement('span'); count.className='cat-count'; count.textContent = group.items.length;
      sum.appendChild(title); sum.appendChild(count);
      det.appendChild(sum);

      const body = document.createElement('div'); body.className='cat-body';
      const more = document.createElement('div'); more.className='cat-more';
      const moreBtn = document.createElement('button'); moreBtn.className='btn'; moreBtn.textContent='Carregar mais';
      more.appendChild(moreBtn);
      more.style.display='none';

      det.appendChild(body);
      det.appendChild(more);

      function renderBatch(append=false){
        const carrinho=getCarrinho();
        const start = group.rendered;
        const end = Math.min(group.items.length, start+PAGE_SIZE);
        if(!append){ body.innerHTML=''; }
        for(let i=start;i<end;i++){
          const card = buildCard(group.items[i], carrinho);
          body.appendChild(card);
        }
        group.rendered = end;
        more.style.display = (group.rendered < group.items.length) ? 'flex' : 'none';
      }

      det.addEventListener('toggle', ()=>{ if(det.open && group.rendered===0){ renderBatch(false); } });
      moreBtn.addEventListener('click', ()=> renderBatch(true) );

      categoriasEl.appendChild(det);

      if(AUTO_OPEN_FIRST && !firstOpened){ det.open = true; firstOpened = true; }
    }
  }

  /* ======================= Barra seleção ======================= */
  function updateBar(){
    const hasSel = getCarrinho().length>0;
    $('#dl-enviar').disabled=!hasSel;
    toggleBar(hasSel);
  }
  function toggleBar(show){
    const bar=$('#dl-bar-selecao');
    bar.style.display=show?'flex':'none';
    wrap.style.paddingBottom = show ? `calc(var(--bar-h) + 14px + var(--safe-bottom))` : '22px';
  }
  $('#dl-enviar').addEventListener('click', ()=>{ window.location.href='index.html#pesquisa'; });
  $('#dl-limpar').addEventListener('click', ()=>{ localStorage.removeItem(KEY); updateBar(); });

  /* ======================= Busca ======================= */
  async function executarBusca(){
    const termoRaw=busca.value.trim();
    categoriasEl.innerHTML='';
    if(!termoRaw){ toggleBar(getCarrinho().length>0); return; }
    btnBuscar.disabled=true; document.body.style.cursor='progress';
    try{
      const results = buscarFlex(termoRaw);
      const groups = groupResults(results);
      renderCategorias(groups);
      updateBar();
    }finally{
      btnBuscar.disabled=false; document.body.style.cursor='';
    }
  }

  /* ======================= Eventos & Boot ======================= */
  btnBuscar.addEventListener('click', executarBusca);
  busca.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); executarBusca(); } });

  carregarDados().then(d=>{ baseDados=d; toast('Base carregada com sucesso!'); });

})();
</script>
</body>
</html>
