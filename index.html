<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>direito.love — Busca de Artigos</title>
<meta name="theme-color" content="#0B3A82" />
<link rel="icon" href="favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="favicon-180.png" />
<style>
  :root{
    --bg:#f6f7fb; --surface:#fff; --text:#0b1220; --muted:#475569; --border:#cbd5e1;
    --primary:#0b3a82; --primary-2:#0a2f6a; --radius:14px; --shadow:0 6px 20px rgba(10,15,25,.06);
    --chip:#eef2ff; --chip-b:#c7d2fe; --mark:#fff59e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:400 14.5px/1.55 -apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif}
  a{color:var(--primary)}
  .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  .topbar__in{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
  .brand__logo{height:28px}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px}
  h1{margin:0 0 10px;font-size:20px}
  .muted{color:var(--muted)}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:16px 0}
  .row{display:grid;grid-template-columns: 240px 160px 1fr 150px;gap:10px;align-items:center}
  @media (max-width:820px){ .row{grid-template-columns:1fr} }

  .select,.input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:15px}
  .input[disabled],.select[disabled]{background:#f1f5f9;color:#94a3b8}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--primary-2)}

  .badge{display:inline-block;background:var(--chip);border:1px solid var(--chip-b);color:#111;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;margin-bottom:8px}
  .title{font-size:22px;font-weight:800;margin:0 0 8px}
  .result{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px;margin:12px 0}
  .article-block{margin:.35rem 0}
  .alinea{padding-left:18px}
  .paragrafo{font-weight:600}
  .inciso{font-weight:600}
  .preview{color:#0f172a}
  .actions{margin-top:8px}
  .ghost{border:1px solid var(--border);background:#fff;color:#0b1220}
  .ghost:hover{background:#f8fafc}

  mark{background:var(--mark);padding:0 2px;border-radius:3px}

  .empty{border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:var(--muted)}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar__in">
    <a class="brand" href="#">
      <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
      <strong>direito.love</strong>
    </a>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h1>Buscar artigo — número exato ou palavras-chave</h1>
    <div class="row">
      <select id="codigoSel" class="select" aria-label="Código">
        <option value="codigo_penal">Código Penal</option>
        <option value="codigo_processo_penal">Código de Processo Penal</option>
        <option value="codigo_civil">Código Civil</option>
        <option value="codigo_processo_civil">Código de Processo Civil</option>
        <option value="codigo_tributario_nacional">Código Tributário Nacional</option>
        <option value="codigo_defesa_consumidor">Código de Defesa do Consumidor</option>
        <option value="codigo_transito_brasileiro">Código de Trânsito Brasileiro</option>
        <option value="codigo_eleitoral">Código Eleitoral</option>
        <option value="codigo_florestal">Código Florestal</option>
        <option value="codigo_das_aguas">Código das Águas</option>
      </select>

      <input id="artNum" class="input" inputmode="numeric" pattern="\d*" placeholder="nº do artigo (ex.: 7)" />
      <input id="palavras" class="input" maxlength="80" placeholder="Até 3 palavras-chave (busca no texto)" />
      <button id="btnBuscar" class="btn">Buscar</button>
    </div>
    <p class="muted" style="margin-top:8px">Se preencher o <b>número</b>, a busca por palavra-chave é desativada — e vice-versa.</p>
  </section>

  <section id="resultSec" class="card">
    <div id="results"></div>
  </section>
</main>

<script>
(function(){
  // === Mapeamento dos arquivos por código ===
  const CODE_FILES = {
    codigo_penal: "data/codigo_penal.json",
    codigo_processo_penal: "data/codigo_processo_penal.json",
    codigo_civil: "data/codigo_civil.json",
    codigo_processo_civil: "data/codigo_processo_civil.json",
    codigo_tributario_nacional: "data/codigo_tributario_nacional.json",
    codigo_defesa_consumidor: "data/codigo_defesa_consumidor.json",
    codigo_transito_brasileiro: "data/codigo_transito_brasileiro.json",
    codigo_eleitoral: "data/codigo_eleitoral.json",
    codigo_florestal: "data/codigo_florestal.json",
    codigo_das_aguas: "data/codigo_das_aguas.json"
  };

  const CODE_LABEL = {
    codigo_penal: "Código Penal",
    codigo_processo_penal: "Código de Processo Penal",
    codigo_civil: "Código Civil",
    codigo_processo_civil: "Código de Processo Civil",
    codigo_tributario_nacional: "Código Tributário Nacional",
    codigo_defesa_consumidor: "Código de Defesa do Consumidor",
    codigo_transito_brasileiro: "Código de Trânsito Brasileiro",
    codigo_eleitoral: "Código Eleitoral",
    codigo_florestal: "Código Florestal",
    codigo_das_aguas: "Código das Águas"
  };

  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)];

  const sel = $("#codigoSel");
  const artNum = $("#artNum");
  const palavras = $("#palavras");
  const btnBuscar = $("#btnBuscar");
  const results = $("#results");

  // === helpers ===
  const cleanLawNotes = s => (s||"")
    .replace(/\(.*?(Redação dada|Incluído|Alterado).*?\)/gi,"")
    .replace(/\s+/g," ")
    .trim();

  const norm = s => (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();

  function extractArtNumberFromTitle(titulo){
    if(!titulo) return null;
    const m = String(titulo).match(/Art\.?\s*(\d+)/i);
    return m ? m[1] : null;
  }

  function getArticleNumber(it){
    // tenta via titulo; ou via id "art7"
    let n = extractArtNumberFromTitle(it.titulo || it.title);
    if(!n && it.id){
      const m = String(it.id).match(/art\s*([\da-z]+)/i);
      if(m) n = m[1].replace(/[^\d]/g,"");
    }
    return n || null;
  }

  function tokensFromQuery(q){
    return norm(q).split(/\s+/).filter(Boolean).slice(0,3);
  }

  function highlight(text, tokens){
    if(!text) return "";
    let out = text;
    const used = new Set();
    tokens.forEach(t=>{
      if(!t || used.has(t)) return;
      used.add(t);
      const re = new RegExp(`\\b(${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})\\b`,'gi');
      out = out.replace(re, '<mark>$1</mark>');
    });
    return out;
  }

  // Converte qualquer formato para um shape padrão: {id, titulo, conteudo:[{tipo, texto},...]}
  function normalizeDataset(raw){
    const arr = [];
    if(Array.isArray(raw)){
      raw.forEach(it=>{
        if(it && Array.isArray(it.conteudo)){
          // já no formato novo
          const copy = {
            id: it.id || ("art"+(extractArtNumberFromTitle(it.titulo||"")||"")),
            titulo: it.titulo || it.title || "",
            conteudo: it.conteudo.map(x=>({tipo:x.tipo, texto: cleanLawNotes(x.texto)}))
          };
          arr.push(copy);
        }else{
          // formato antigo em array
          const item = {
            id: it.id || ("art"+(extractArtNumberFromTitle(it.titulo||"")||"")),
            titulo: it.titulo || it.title || "",
            conteudo: []
          };
          if(it.caput) item.conteudo.push({tipo:"caput", texto: cleanLawNotes(it.caput)});
          (it.incisos||[]).forEach(tx=> item.conteudo.push({tipo:"inciso", texto: cleanLawNotes(tx)}));
          (it.alineas||[]).forEach(tx=> item.conteudo.push({tipo:"alinea", texto: cleanLawNotes(tx)}));
          (it.paragrafos||[]).forEach(tx=> item.conteudo.push({tipo:"paragrafo", texto: cleanLawNotes(tx)}));
          arr.push(item);
        }
      });
      return arr;
    }
    // objeto { art7: { titulo, caput, ... } }
    if(raw && typeof raw === "object"){
      Object.entries(raw).forEach(([k,v])=>{
        if(!v) return;
        if(Array.isArray(v.conteudo)){
          arr.push({
            id: v.id || k,
            titulo: v.titulo || "",
            conteudo: v.conteudo.map(x=>({tipo:x.tipo, texto: cleanLawNotes(x.texto)}))
          });
        }else{
          const item = {
            id: v.id || k,
            titulo: v.titulo || "",
            conteudo: []
          };
          if(v.caput) item.conteudo.push({tipo:"caput", texto: cleanLawNotes(v.caput)});
          (v.incisos||[]).forEach(tx=> item.conteudo.push({tipo:"inciso", texto: cleanLawNotes(tx)}));
          (v.alineas||[]).forEach(tx=> item.conteudo.push({tipo:"alinea", texto: cleanLawNotes(tx)}));
          (v.paragrafos||[]).forEach(tx=> item.conteudo.push({tipo:"paragrafo", texto: cleanLawNotes(tx)}));
          arr.push(item);
        }
      });
    }
    return arr;
  }

  async function fetchJson(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("Falha ao carregar "+url);
    return r.json();
  }

  function buildFullText(item){
    return [item.titulo, ...item.conteudo.map(x=>x.texto)].join(" ").trim();
  }

  function renderArticleFull(item){
    const frag = document.createDocumentFragment();

    const h = document.createElement("div");
    h.className = "title";
    h.textContent = item.titulo || ("Art. " + (getArticleNumber(item)||""));
    frag.appendChild(h);

    // blocos em ordem
    item.conteudo.forEach(b=>{
      const p = document.createElement("div");
      p.className = "article-block";
      if(b.tipo === "paragrafo") p.classList.add("paragrafo");
      if(b.tipo === "inciso") p.classList.add("inciso");
      if(b.tipo === "alinea") p.classList.add("alinea");
      p.textContent = b.texto;
      frag.appendChild(p);
    });

    return frag;
  }

  function renderPreviewText(item, tokens){
    // caput se existir; senão primeiros blocos
    const cap = item.conteudo.find(b=>b.tipo==="caput");
    const base = cap ? cap.texto : buildFullText(item);
    const short = base.length > 200 ? base.slice(0,200).trim() + "…" : base;
    const div = document.createElement("div");
    div.className = "preview";
    div.innerHTML = highlight(short, tokens);
    return div;
  }

  function renderCard(codeKey, item, tokens){
    const card = document.createElement("div");
    card.className = "result";

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = CODE_LABEL[codeKey] || "Código";
    card.appendChild(badge);

    // título
    const ttl = document.createElement("div");
    ttl.className = "title";
    ttl.textContent = item.titulo || ("Art. " + (getArticleNumber(item)||""));
    card.appendChild(ttl);

    // preview
    const prev = renderPreviewText(item, tokens);
    card.appendChild(prev);

    // área expandida
    const fullWrap = document.createElement("div");
    fullWrap.style.display = "none";
    fullWrap.appendChild(renderArticleFull(item));
    card.appendChild(fullWrap);

    // ações
    const actions = document.createElement("div");
    actions.className = "actions";
    const btn = document.createElement("button");
    btn.className = "btn ghost";
    btn.textContent = "ver mais ⌄";
    btn.addEventListener("click", ()=>{
      const open = fullWrap.style.display !== "none";
      fullWrap.style.display = open ? "none" : "block";
      btn.textContent = open ? "ver mais ⌄" : "ver menos ︿";
    });
    actions.appendChild(btn);
    card.appendChild(actions);

    return card;
  }

  function emptyState(msg){
    const div = document.createElement("div");
    div.className = "empty";
    div.textContent = msg;
    return div;
  }

  // === Busca ===
  async function runSearch(){
    results.innerHTML = "";
    const code = sel.value;
    const file = CODE_FILES[code];
    if(!file){ results.appendChild(emptyState("Código não suportado.")); return; }

    // desativação mútua
    const nRaw = (artNum.value||"").replace(/[^\d]/g,"");
    artNum.value = nRaw;

    const kwRaw = (palavras.value||"").trim();
    const kwTokens = tokensFromQuery(kwRaw);

    // regra: ou número OU keywords
    if(nRaw && kwTokens.length){ results.appendChild(emptyState("Use número OU palavras-chave, não ambos.")); return; }
    if(!nRaw && kwTokens.length>3){ results.appendChild(emptyState("Use no máximo 3 palavras-chave.")); return; }

    // carrega base
    let base;
    try{
      const j = await fetchJson(file);
      base = normalizeDataset(j);
    }catch(e){
      results.appendChild(emptyState("Não consegui carregar a base do código selecionado."));
      return;
    }

    // busca por número (match exato)
    let out = [];
    if(nRaw){
      out = base.filter(it => (getArticleNumber(it) === nRaw));
    }else if(kwTokens.length){
      out = base.filter(it=>{
        const hay = norm(buildFullText(it));
        return kwTokens.every(t => hay.includes(t));
      });
    }else{
      results.appendChild(emptyState("Informe o número do artigo ou até 3 palavras-chave."));
      return;
    }

    if(out.length===0){
      results.appendChild(emptyState("Nenhum resultado encontrado."));
      return;
    }

    // render
    out.forEach(it => {
      results.appendChild(renderCard(code, it, kwTokens));
    });
  }

  // desativa mutuamente os campos
  function syncDisable(){
    const hasNum = !!artNum.value.trim();
    const hasKw  = !!palavras.value.trim();

    if(hasNum){
      palavras.value = "";
      palavras.disabled = true;
      artNum.disabled = false;
    }else if(hasKw){
      artNum.value = "";
      artNum.disabled = true;
      palavras.disabled = false;
    }else{
      artNum.disabled = false;
      palavras.disabled = false;
    }
  }

  // events
  btnBuscar.addEventListener("click", runSearch);
  artNum.addEventListener("input", syncDisable);
  palavras.addEventListener("input", syncDisable);
  // Enter para buscar
  artNum.addEventListener("keydown", e=>{ if(e.key==="Enter") runSearch(); });
  palavras.addEventListener("keydown", e=>{ if(e.key==="Enter") runSearch(); });

  // estado inicial
  syncDisable();
  // opcional: auto-buscar se vier com valor via cache
})();
</script>
</body>
</html>
