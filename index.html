<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>direito.love — Estudo Jurídico com IA</title>
<meta name="theme-color" content="#F5C400" />
<link rel="icon" href="favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="favicon-180.png" />
<link rel="manifest" href="manifest.json" />
<style>
  :root{
    --bg:#FFFDF0; --surface:#ffffff; --text:#001840; --border:#e5e7eb;
    --primary:#102A71; --highlight:#F5C400; --highlight-light:#FFDC5F;
    --radius:12px; --shadow:0 4px 16px rgba(0,0,0,.05);
    --font:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif;

    --btn-pad-y:6px; --btn-pad-x:10px; --btn-font:12.5px; --btn-min-h:34px;
    --chip-pad-y:6px; --chip-pad-x:10px; --chip-font:12.5px; --chip-radius:8px;
    --mark-bg:#C8FACC;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:400 13.5px/1.5 var(--font);}

  .topbar{position:sticky;top:0;z-index:50;background:var(--highlight);border-bottom:1px solid rgba(0,0,0,.08)}
  .topbar__inner{max-width:980px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:flex-start;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#111}
  .brand__logo{height:32px}

  .wrap{max-width:980px;margin:0 auto;padding:22px}
  h1{margin:8px 0 4px;color:var(--primary);font-size:20px}
  .muted{color:#334155}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:14px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #tema{flex:1;padding:10px 12px;border:2px solid var(--primary);border-radius:8px;font-size:15px}

  .btn{
    appearance:none;border:1px solid var(--border);background:var(--highlight);color:#000;
    padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;font-size:var(--btn-font);cursor:pointer;transition:.15s;min-height:var(--btn-min-h)
  }
  .btn:hover{background:var(--highlight-light)}
  .btn:active,.btn-alt:active{transform:translateY(1px) scale(.99)}
  .btn-alt{
    appearance:none;border:1px solid #0f2a71;background:var(--primary);color:#fff;
    padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;font-size:var(--btn-font);cursor:pointer;transition:.15s;min-height:var(--btn-min-h)
  }
  .btn-alt:hover{background:#264399}
  .btn[disabled],.btn-alt[disabled]{opacity:.6;cursor:progress}

  .acc{margin:12px 0;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
  .acc>summary{list-style:none;cursor:pointer;padding:10px 14px;font-weight:800;color:var(--primary);display:flex;align-items:center;justify-content:space-between}
  .acc>summary::-webkit-details-marker{display:none}
  .acc[open]>summary{background:#fff7d6}
  .acc-body{padding:10px 14px}
  .acc-count{font-weight:700;background:#0f172a0d;color:#0f172a;padding:2px 8px;border-radius:999px;font-size:12px}

  .result{background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:12px 14px;margin:10px 0}
  .filetag{display:inline-block;font-weight:700;font-size:12px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;margin:0 0 8px 0}
  .result p{margin:0}
  .result .actions{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  mark{background:var(--mark-bg);padding:0 2px;border-radius:3px}

  #promptArea{display:none}
  #promptOut{width:100%;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap}
  .ia-row{display:none;flex-wrap:wrap;gap:8px;margin-top:8px}
  .ia{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111;text-decoration:none;font-size:12px}
  .ia:hover{background:#f8fafc}
  .chip-ghost{padding:6px 10px;border-radius:999px;border:1px dashed var(--border);background:#fff;color:#111;font-size:12px;cursor:pointer}

  #installFab{position:fixed;right:14px;bottom:14px;z-index:60;display:none;background:#111;color:#fff;border:0;border-radius:999px;padding:10px 12px;gap:8px;align-items:center;box-shadow:0 6px 20px rgba(0,0,0,.25);cursor:pointer}
  #installFab svg{width:16px;height:16px;display:block}

  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;opacity:0;transition:.2s;z-index:70}
  #toast.show{opacity:1}

  @media (max-width:600px){
    h1{font-size:18px}
    .result p{font-size:12.5px; line-height:1.45}
  }
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar__inner">
    <a class="brand" href="#top" aria-label="Início"><img class="brand__logo" src="icons/logo.png" alt="direito.love" /></a>
  </div>
</header>

<main class="wrap" id="top">
  <section id="temaSec" class="card">
    <h1>Escreva aqui o tema do prompt (mínimo de 5 palavras)</h1>
    <div class="row" style="margin-top:8px">
      <input id="tema" type="text" placeholder="Ex.: responsabilidade civil por dano estético em cirurgia..." />
      <button id="btnAvancar" class="btn-alt">Avançar</button>
    </div>
    <p class="muted" id="temaHint" style="margin:8px 2px 0 2px;display:none">Tema definido. Agora selecione as sugestões e estratégias abaixo.</p>
  </section>

  <section id="sugestoesSec" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h1 style="margin:0">Sugestões para enriquecer seu tema</h1>
      <button id="btnRebuscar" class="btn">Rebuscar</button>
    </div>
    <p class="muted" style="margin-top:6px">Resultados agrupados por categoria. Clique em cada uma para abrir.</p>
    <div id="sugestoesCats"></div>
  </section>

  <section id="estrategiasSec" class="card" style="display:none">
    <h1>Estratégias de estudo</h1>
    <p class="muted" style="margin-top:6px">Abra as categorias, adicione o que fizer sentido e depois gere o prompt.</p>
    <div id="estrategiasCats"></div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="btnGerar" class="btn-alt">Gerar Prompt</button>
    </div>
  </section>

  <section id="promptArea" class="card">
    <h1>Prompt gerado</h1>
    <div id="promptOut"></div>
    <div class="row" style="margin-top:10px; align-items:center; gap:12px;">
      <button id="btnCopy" class="btn">Copiar</button>
      <button id="btnLimpar" class="btn" style="display:none;">Limpar</button>
      <div class="ia-row" id="iaRow">
        <a class="ia" data-ia="chatgpt" href="https://chat.openai.com/" target="_blank" rel="noopener">ChatGPT</a>
        <a class="ia" data-ia="claude"  href="https://claude.ai/new" target="_blank" rel="noopener">Claude</a>
        <a class="ia" data-ia="gemini"  href="https://gemini.google.com/app" target="_blank" rel="noopener">Gemini</a>
        <a class="ia" data-ia="perplexity" href="https://www.perplexity.ai/" target="_blank" rel="noopener">Perplexity</a>
        <a class="ia" data-ia="copilot" href="https://copilot.microsoft.com/" target="_blank" rel="noopener">Copilot</a>
        <a class="ia" data-ia="phind"   href="https://www.phind.com/" target="_blank" rel="noopener">Phind</a>
        <button id="btnFecharChips" class="chip-ghost" title="Fechar">Fechar</button>
      </div>
    </div>
    <p class="muted" style="margin:6px 0 0 0; display:none" id="dicaCliqueDireito">
      Dica: clique com o botão direito em um chip de IA para abrir já com o prompt copiado.
    </p>
  </section>
</main>

<button id="installFab" title="Instalar app">
  <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14a2 2 0 0 0 2-2v-4M3 15v4a2 2 0 0 0 2 2" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  <span>Baixar app</span>
</button>

<div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const toast=(m,t=1600)=>{const el=$("#toast");el.textContent=m;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};

  const temaInput=$("#tema"), btnAvancar=$("#btnAvancar"), temaHint=$("#temaHint");
  const sugestSec=$("#sugestoesSec"), sugCats=$("#sugestoesCats"), btnRebuscar=$("#btnRebuscar");
  const estrSec=$("#estrategiasSec"), estrCats=$("#estrategiasCats"), btnGerar=$("#btnGerar");
  const promptArea=$("#promptArea"), promptOut=$("#promptOut"), btnCopy=$("#btnCopy"), btnLimpar=$("#btnLimpar");
  const iaRow=$("#iaRow"), dicaCliqueDireito=$("#dicaCliqueDireito"), btnFecharChips=$("#btnFecharChips");

  /* =================== Normalização & sinônimos ampliados =================== */
  const STOP=new Set(['de','da','do','das','dos','e','ou','a','o','as','os','no','na','nos','nas','para','por','em','um','uma','ao','à','que','com','sem','sobre','entre','ate']);
  const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const norm=(s="")=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  // Diplomas canônicos (para boosts e match)
  const CANON_LAWS = [
    'codigo penal','codigo de processo penal','codigo civil','codigo de processo civil','codigo tributario nacional',
    'codigo de defesa do consumidor','codigo de transito brasileiro','constituicao federal',
    'consolidacao das leis do trabalho','estatuto da crianca e do adolescente','lei maria da penha',
    'lei geral de protecao de dados','marco civil da internet','lei de drogas','lei de falencias','estatuto do idoso'
  ];

  // Padrões ampliados (sinonímia e variações)
  const SYN = [
    // penal — crimes comuns
    { canon:'homicidio', pats:[/\bhomicid\w+\b/iu] },
    { canon:'homicidio qualificado', pats:[/\bhomicid\w+\s+qualific\w+\b/iu] },
    { canon:'homicidio culposo', pats:[/\bhomicid\w+\s+culpos\w+\b/iu] },
    { canon:'homicidio doloso', pats:[/\bhomicid\w+\s+oloso\b/iu] },
    { canon:'latrocinio', pats:[/\blatrocin\w+\b/iu,/\broubo\s+seguido\s+de\s+mort\w+\b/iu] },
    { canon:'furto', pats:[/\bfurt\w+\b/iu] },
    { canon:'roubo', pats:[/\broub\w+\b/iu] },
    { canon:'estelionato', pats:[/\bestelionat\w+\b/iu] },
    { canon:'lesao corporal', pats:[/\bles[aã]o\s+corpor\w+\b/iu,/\blesao\b/iu] },
    { canon:'violencia domestica', pats:[/\bviol[eê]ncia\s+dom[eé]stic\w+\b/iu] },

    // civil/consumidor
    { canon:'responsabilidade civil', pats:[/\brc\b/iu,/\bresp\.?\s*civil\b/iu,/\bresponsab\w+\s+civil\b/iu] },
    { canon:'dano moral', pats:[/\bdanos?\s+morais?\b/iu] },
    { canon:'dano estetico', pats:[/\bdanos?\s+est[eé]tic\w+\b/iu,/\bdanos?\s+esteic\w+\b/iu] },
    { canon:'lucros cessantes', pats:[/\blucros?\s+cessant\w+\b/iu] },
    { canon:'perda de uma chance', pats:[/\bperda\s+de\s+uma\s+chanc\w+\b/iu] },
    { canon:'nexo causal', pats:[/\bnexo(\s+de)?\s+causal\w+\b/iu] },
    { canon:'relacao de consumo', pats:[/\bcdc\b/iu,/\brela[cç][aã]o\s+de\s+consum\w+\b/iu] },
    { canon:'defeito no servico', pats:[/\bservi[cç]o\s+defeituos\w+\b/iu] },
    { canon:'vicio do produto', pats:[/\bv[ií]cio\s+do\s+produt\w+\b/iu] },

    // trabalho
    { canon:'vinculo empregaticio', pats:[/\bv[ií]nculo\s+empregat\w+\b/iu] },
    { canon:'dano moral trabalhista', pats:[/\bdano\s+moral\s+trabalh\w+\b/iu] },
    { canon:'assedio moral', pats:[/\bass[eé]dio\s+moral\b/iu] },

    // constitucional/adm
    { canon:'responsabilidade objetiva estado', pats:[/\bresponsab\w+\s+objetiv\w+\s+do?\s*estado\b/iu,/\bart\s*37\s*§?\s*6\b/iu] },
    { canon:'improbidade administrativa', pats:[/\bimprobidade\s+administrat\w+\b/iu] },

    // diplomas (aliases)
    { canon:'codigo penal', pats:[/\bcp\b/iu,/\bcod\w+\s+penal\b/iu] },
    { canon:'codigo de processo penal', pats:[/\bcpp\b/iu,/\bcod\w+\s+de\s+processo\s+penal\b/iu] },
    { canon:'codigo civil', pats:[/\bcc\b/iu,/\bcod\w+\s+civil\b/iu] },
    { canon:'codigo de processo civil', pats:[/\bcpc\b/iu,/\bcod\w+\s+de\s+processo\s+civil\b/iu] },
    { canon:'codigo tributario nacional', pats:[/\bctn\b/iu] },
    { canon:'codigo de defesa do consumidor', pats:[/\bcdc\b/iu] },
    { canon:'codigo de transito brasileiro', pats:[/\bctb\b/iu] },
    { canon:'consolidacao das leis do trabalho', pats:[/\bclt\b/iu] },
    { canon:'constituicao federal', pats:[/\bcf\/?88\b/iu,/\bconstitui[cç][aã]o\s*federal\b/iu,/\bcf\b/iu] },
    { canon:'estatuto da crianca e do adolescente', pats:[/\beca\b/iu,/\bestatuto\s+da?\s*crian[cç]a\s+e\s+do?\s*adolescent\w+\b/iu] },
    { canon:'lei maria da penha', pats:[/\blmp\b/iu,/\b11\.340\/?2006\b/iu,/\bmaria\s+da\s+penha\b/iu] },
    { canon:'lei geral de protecao de dados', pats:[/\blgpd\b/iu,/\b13\.709\/?2018\b/iu] },
    { canon:'marco civil da internet', pats:[/\bmci\b/iu,/\b12\.965\/?2014\b/iu,/\bmarco\s+civil\s+da\s+internet\b/iu] },
    { canon:'lei de drogas', pats:[/\blei\s+de\s+drogas\b/iu,/\b11\.343\/?2006\b/iu] },
    { canon:'lei de falencias', pats:[/\b11\.101\/?2005\b/iu,/\blei\s+de\s+fal[eê]nci\w+\b/iu] },
    { canon:'estatuto do idoso', pats:[/\b10\.741\/?2003\b/iu,/\bestatuto\s+do\s+idoso\b/iu] },

    // termos processuais/juris
    { canon:'sumula', pats:[/\bs[uú]mulas?\b/iu,/\bsv\b/iu,/\bsumula\b/iu] },
    { canon:'jurisprudencia', pats:[/\bjurisprud[eê]nci\w+\b/iu,/\bprecedent\w+\b/iu,/\bleading\s+case\b/iu] },
    { canon:'tema repetitivo', pats:[/\btemas?\s+repetitiv\w+\b/iu] },
    { canon:'repercussao geral', pats:[/\brepercuss[aã]o\s+geral\b/iu] },

    // grupos médicos/saúde típicos
    { canon:'erro medico', pats:[/\berro\s+medic\w+\b/iu,/\biatrogen\w+\b/iu,/\bimperici\w+\b/iu,/\bnegligenci\w+\b/iu,/\bimprudenci\w+\b/iu,/\berro\s+odontolog\w+\b/iu] },
  ];

  function applySynonyms(t) {
    for (const s of SYN) for (const p of s.pats) t = t.replace(p, ' ' + s.canon + ' ');
    return t;
  }

  function normalizeLegal(s){
    let t=norm(s);
    t=t.replace(/§+/g,' paragrafo ').replace(/\bpar\.?\b/g,' paragrafo ')
       .replace(/\bart\.?\b|\bartigo\b/g,' art ').replace(/\bincs?\.?\b|\binc\.?\b/g,' inciso ')
       .replace(/\bal\.?\b/g,' alinea ').replace(/\bunico\b/g,' unico ')
       .replace(/(\d+)\s*[ºªoa]\b/g,'$1')
       .replace(/["'()]/g,' ').replace(/\s+/g,' ').trim();

    // lematização leve e correções comuns
    t=t.replace(/\bdanos?\b/g,' dano ')
       .replace(/\bmorais\b/g,' moral ')
       .replace(/\best[eé]tic\w+\b/g,' estetico ')
       .replace(/\besteic\w+\b/g,' estetico ')
       .replace(/\bm[eé]dic\w+\b/g,' medico ');

    // aplicar sinônimos/ampliações
    t = applySynonyms(' '+t+' ');
    return t.replace(/\s+/g,' ').trim();
  }

  function tokensFromLegal(s){
    return s.split(/\s+/).filter(Boolean).filter(w=>!STOP.has(w));
  }

  function highlightText(text,tokens){
    if(!tokens?.length) return text;
    let html=text; const used=new Set();
    for(const tok of tokens){ if(!tok||used.has(tok)) continue; used.add(tok);
      const re=new RegExp(`\\b(${esc(tok)})\\b`,'giu'); html=html.replace(re,'<mark>$1</mark>');
    }
    return html;
  }

  function proximityRegexFromTokens(tokens, n=2){
    if(!tokens.length) return null;
    const parts=tokens.map(w=>`\\b${esc(w)}\\b`);
    const gap=String.raw`(?:[^\p{L}\p{N}]+(?:\p{L}+\p{N}*)){0,${n}}[^\p{L}\p{N}]+`;
    try{ return new RegExp(parts.join(gap),'iu'); }catch{ return null; }
  }

  // Parser estilo “STJ/STF”
  function parseQuery(raw){
    const orig = raw.trim();
    const legal = normalizeLegal(orig);

    // campos
    const fields = {};
    legal.replace(/\b(fonte|titulo|texto):\(([^)]+)\)|\b(fonte|titulo|texto):(\S+)/giu, (_,a,b,c,d)=>{
      const k=(a||c).toLowerCase();
      const v=normalizeLegal(b||d);
      fields[k]=(fields[k]||[]).concat(tokensFromLegal(v));
      return '';
    });

    // frases e proximidade
    const phrases=[]; let rest=legal;
    rest=rest.replace(/"([^"]+)"\s*~\s*(\d+)/giu,(_,p,n)=>{ phrases.push({t:tokensFromLegal(normalizeLegal(p)), n:parseInt(n,10)}); return ' '; });
    rest=rest.replace(/"([^"]+)"/giu,(_,p)=>{ phrases.push({t:tokensFromLegal(normalizeLegal(p)), n:0}); return ' '; });

    // termos E/OU/NAO
    const tokens = rest.split(/\s+/).filter(Boolean);
    const groups=[]; let cur=[];
    for(let i=0;i<tokens.length;i++){
      const w=tokens[i];
      if(/^(ou|or)$/i.test(w)){ if(cur.length) groups.push(cur), cur=[]; continue; }
      if(/^(nao|not)$/i.test(w)){ const nxt=tokens[i+1]; if(nxt){ cur.push({type:'NOT', term:nxt}); i++; continue; } }
      if(/^(e|and)$/i.test(w)){ continue; }
      cur.push({type:'TERM', term:w});
    }
    if(cur.length) groups.push(cur);

    function expandWild(t){
      let s=esc(t).replace(/\\\$/g,'.*').replace(/\\\?/g,'.');
      return new RegExp(`(^|[^\\p{L}\\p{N}])${s}([^\\p{L}\\p{N}]|$)`,'iu');
    }
    const clauses=groups.map(g=>{
      const must=[], not=[];
      for(const it of g){ if(it.type==='NOT') not.push(it.term); else must.push(it.term); }
      return { must, not, compiled: must.map(expandWild), compiledNot: not.map(expandWild) };
    });

    // detectar art + número + diploma (para boost)
    const artMatch = legal.match(/\bart\s*([0-9][0-9a-z\-]*)\b/);
    const artNum = artMatch ? artMatch[1] : null;
    const lawHits = CANON_LAWS.filter(L => new RegExp(`\\b${esc(L)}\\b`,'iu').test(legal));

    return { orig, legal, fields, phrases, clauses, artNum, lawHits };
  }

  function countHits(hay, regs){ let c=0; for(const r of regs){ if(r.test(hay)) c++; } return c; }
  function anyNeg(hay, regs){ for(const r of regs){ if(r.test(hay)) return true; } return false; }

  function fonteBoost(tokensSet, fonte){
    const f=(fonte||'');
    let s=0;
    if(tokensSet.has('art') && f.startsWith('codigo_')) s += 2;
    if(tokensSet.has('sumula') && (f.startsWith('sumula')||f.startsWith('sumulas_')||f==='sumulas_vinculantes_stf')) s += 2;
    if(tokensSet.has('erro') && tokensSet.has('medico')){
      if(f==='julgados_direito_civil' || f==='sumulas_stj' || f==='sumula_stf') s += 2;
    }
    return s;
  }
  function recencyBoost(item){
    const f=(item.fonte||''); if(!f.startsWith('noticias')) return 0;
    const ds=(item.data||item.data_pub||'').slice(0,10); if(!/^\d{4}-\d{2}-\d{2}$/.test(ds)) return 0;
    const now=Date.now(), dt=new Date(ds+'T00:00:00Z').getTime();
    const days=Math.max(0,(now-dt)/(1000*60*60*24)); return Math.max(0, 2.5*Math.exp(-days/20));
  }
  function articleBoost(item, artNum, lawHits){
    if(!artNum) return 0;
    const hay=(item.textoLegal||item.textoNorm||'');
    let s=0;
    if(new RegExp(`\\bart\\s*${esc(artNum)}\\b`,'iu').test(hay)) s+=2;
    if(lawHits.length && lawHits.some(L=>new RegExp(`\\b${esc(L)}\\b`,'iu').test(hay))) s+=2;
    return s;
  }

  function professionalSearch(raw, data){
    const parsed = parseQuery(raw);
    const tokensSet = new Set(tokensFromLegal(parsed.legal));

    // proximidade a partir de frases
    const proxRegs = parsed.phrases.map(ph=>{
      if(!ph.n || ph.n===0) return {re:new RegExp(`\\b${esc(ph.t.join(' '))}\\b`,'iu'), weight:6};
      const re=proximityRegexFromTokens(ph.t, ph.n);
      return {re, weight: (ph.n<=1?5:ph.n<=2?3:2)};
    });

    // filtros por campos
    const fonteFilter=parsed.fields.fonte||null;
    const tituloTerms=parsed.fields.titulo||[];
    const textoTerms=parsed.fields.texto||[];

    // 1) pool por cláusulas (OU entre grupos)
    let pool = data.filter(it=>{
      const hay=(it.textoLegal||it.textoNorm||'');
      if(fonteFilter && fonteFilter.length){
        const f=(it.fonte||'');
        const ok = fonteFilter.some(ff=>{
          if(ff==='codigos') return f.startsWith('codigo_');
          if(ff==='sumulas') return f.startsWith('sumula')||f.startsWith('sumulas_')||f==='sumulas_vinculantes_stf';
          if(ff==='julgados') return f.startsWith('julgados_');
          if(ff==='jurisprudencia') return (f==='temas_repetitivos_stj'||f==='teses_stf');
          if(ff==='noticias') return f.startsWith('noticias');
          return f.includes(ff);
        });
        if(!ok) return false;
      }
      if(tituloTerms.length && !tituloTerms.every(t=>new RegExp(`\\b${esc(t)}\\b`,'iu').test(it.titulo||''))) return false;
      if(textoTerms.length  && !textoTerms.every(t=>new RegExp(`\\b${esc(t)}\\b`,'iu').test(it.texto||''))) return false;

      if(parsed.clauses.length===0) return true;
      return parsed.clauses.some(cl=>{
        if(anyNeg(hay, cl.compiledNot)) return false;
        return cl.compiled.every(re=>re.test(hay));
      });
    });

    // 2) fallback: >=2 tokens canônicos
    if(pool.length===0){
      const toks=tokensFromLegal(parsed.legal);
      pool=data.filter(it=>{
        const hay=(it.textoLegal||it.textoNorm||'');
        let c=0; for(const w of toks){ const re=new RegExp(`(^|[^\\p{L}\\p{N}])${esc(w)}([^\\p{L}\\p{N}]|$)`,'iu'); if(re.test(hay)) c++; }
        return c>=Math.min(2,toks.length);
      });
    }

    // 3) score + boosts
    function score(it){
      const hay=(it.textoLegal||it.textoNorm||'');
      let s=0;
      for(const pr of proxRegs){ if(pr.re && pr.re.test(hay)) s+=pr.weight; }
      if(parsed.clauses.length){
        const best=Math.max(...parsed.clauses.map(cl=>countHits(hay, cl.compiled)));
        s+=best;
      }else{
        const toks=tokensFromLegal(parsed.legal);
        const regs=toks.map(t=>new RegExp(`(^|[^\\p{L}\\p{N}])${esc(t)}([^\\p{L}\\p{N}]|$)`,'iu'));
        s+=countHits(hay, regs);
      }
      s+=fonteBoost(tokensSet, it.fonte);
      s+=articleBoost(it, parsed.artNum, parsed.lawHits);
      const L=Math.max(50,(it.texto||it.titulo||'').length); s-=0.2*Math.log(L);
      s+=recencyBoost(it);
      return s;
    }

    const ranked = pool.map(x=>({x,s:score(x)})).filter(o=>o.s>0).sort((a,b)=>b.s-a.s).slice(0,400).map(o=>o.x);

    const hl=[]; parsed.phrases.forEach(ph=>hl.push(...ph.t));
    parsed.clauses.forEach(cl=>cl.must.forEach(t=>hl.push(t)));
    const fallbackHL = hl.length? hl : tokensFromLegal(parsed.legal);
    return {results: ranked, highlight: Array.from(new Set(fallbackHL))};
  }

  /* =================== Dados & categorias =================== */
  const arquivos=[
    "data/julgados_direito_administrativo.json","data/julgados_direito_ambiental.json","data/julgados_direito_bancario.json",
    "data/julgados_direito_civil.json","data/julgados_direito_constitucional.json","data/julgados_direito_eleitoral.json",
    "data/julgados_direito_empresarial.json","data/noticias_migalhas_1.json","data/noticias_migalhas_2.json","data/noticias_migalhas_3.json",
    "data/codigo_penal.json","data/codigo_processo_penal.json","data/sumula_stf.json","data/sumulas_stj.json","data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json","data/temas_repetitivos_stj.json","data/teses_stf.json","data/codigo_processo_civil.json",
    "data/codigo_civil.json","data/codigo_tributario_nacional.json","data/codigo_defesa_consumidor.json","data/codigo_transito_brasileiro.json"
  ];
  const nomesAmigaveis={noticias:"Notícias",noticias_migalhas_1:"Notícias Migalhas",noticias_migalhas_2:"Notícias Migalhas",noticias_migalhas_3:"Notícias Migalhas",
    sumula_stf:"Súmulas STF",sumulas_stj:"Súmulas STJ",sumulas_tse:"Súmulas TSE",sumulas_vinculantes_stf:"Súmulas Vinculantes STF",
    temas_repetitivos_stj:"Temas Repetitivos STJ",teses_stf:"Teses STF",codigo_penal:"Código Penal",codigo_processo_penal:"Código de Processo Penal",
    codigo_processo_civil:"Código de Processo Civil",codigo_civil:"Código Civil",codigo_tributario_nacional:"Código Tributário Nacional",
    codigo_defesa_consumidor:"Código de Defesa do Consumidor",codigo_transito_brasileiro:"Código de Trânsito Brasileiro",
    julgados_direito_administrativo:"Julgados de Direito Administrativo",julgados_direito_ambiental:"Julgados de Direito Ambiental",
    julgados_direito_bancario:"Julgados de Direito Bancário",julgados_direito_civil:"Julgados de Direito Civil",
    julgados_direito_constitucional:"Julgados de Direito Constitucional",julgados_direito_eleitoral:"Julgados de Direito Eleitoral",
    julgados_direito_empresarial:"Julgados de Direito Empresarial"};
  const categorias={
    codigos:{label:"Códigos",test:f=>f.startsWith('codigo_')},
    sumulas:{label:"Súmulas",test:f=>f.startsWith('sumula')||f.startsWith('sumulas_')||f==='sumulas_vinculantes_stf'},
    jurisprudencia:{label:"Jurisprudência",test:f=>f==='temas_repetitivos_stj'||f==='teses_stf'},
    julgados:{label:"Julgados",test:f=>f.startsWith('julgados_')},
    noticias:{label:"Notícias",test:f=>f.startsWith('noticias')},
    outros:{label:"Outros",test:_=>true}
  };
  const normalizarFonte=f=>f&&f.startsWith('noticias')?'noticias':f;

  let baseDados=[];
  async function carregarDados(){
    const dados=[];
    for(const arq of arquivos){
      try{
        const tag=arq.split('/').pop().replace(/\.json$/,'');
        const r=await fetch(arq); if(!r.ok) continue;
        const j=await r.json();
        (Array.isArray(j)?j:[]).forEach((it,idx)=>{
          const _id=it.id||`${tag}_${idx}`;
          const texto=(it.texto||it.descricao||it.conteudo||'').trim();
          const titulo=it.titulo||it.title||'';
          dados.push({...it,_id,fonte:tag,titulo,texto,textoNorm:norm(texto||titulo),textoLegal:normalizeLegal(texto||titulo)});
        });
      }catch(e){ console.warn('Erro ao carregar',arq,e); }
    }
    return dados;
  }

  function ensureVisible(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); }

  function buildCard(item,tokens){
    const fNorm=normalizarFonte(item.fonte);
    const nomeBonito=nomesAmigaveis[fNorm]||nomesAmigaveis[item.fonte]||item.fonte;
    const div=document.createElement('div'); div.className='result';
    const tag=document.createElement('div'); tag.className='filetag'; tag.textContent=nomeBonito; div.appendChild(tag);
    const p=document.createElement('p'); const baseText=(item.texto&&item.texto.trim())||(item.titulo||'');
    p.innerHTML=highlightText(baseText,tokens); div.appendChild(p);
    const actions=document.createElement('div'); actions.className='actions';
    const add=document.createElement('button'); add.className='btn-alt'; add.textContent='Incluir no tema';
    add.addEventListener('click',()=>{
      const piece=item.texto?.trim()||[item.titulo||'',item.url||''].filter(Boolean).join(' — ');
      if(piece){ if(temaInput.value && !temaInput.value.trim().endsWith('—')) temaInput.value=temaInput.value.trim()+' — '; temaInput.value+=piece; toast('Conteúdo adicionado ao tema.'); }
    });
    actions.appendChild(add);
    if(item.url && fNorm==='noticias'){
      const a=document.createElement('a'); a.textContent='Ver notícia'; a.href=item.url; a.target='_blank'; a.rel='noopener'; a.className='btn';
      actions.appendChild(a);
    }
    div.appendChild(actions);
    return div;
  }

  function groupByCategory(items){
    const groups={}; for(const k in categorias){ groups[k]={label:categorias[k].label,items:[]} }
    for(const it of items){
      const f=it.fonte||''; let cat='outros';
      for(const k in categorias){ if(k==='outros') continue; if(categorias[k].test(f)){ cat=k; break; } }
      groups[cat].items.push(it);
    }
    return Object.fromEntries(Object.entries(groups).filter(([,g])=>g.items.length>0).sort((a,b)=>b[1].items.length-a[1].items.length));
  }

  function renderSugeridos(items,tokens){
    sugCats.innerHTML='';
    const groups=groupByCategory(items);
    const entries=Object.entries(groups);
    if(entries.length===0){ sugCats.innerHTML='<p>Nenhum resultado encontrado para o tema informado.</p>'; return; }
    for(const [catId,group] of entries){
      const det=document.createElement('details'); det.className='acc';
      const sum=document.createElement('summary'); const ttl=document.createElement('span'); ttl.textContent=group.label;
      const count=document.createElement('span'); count.className='acc-count'; count.textContent=group.items.length;
      sum.appendChild(ttl); sum.appendChild(count); det.appendChild(sum);
      const body=document.createElement('div'); body.className='acc-body';
      group.items.slice(0,12).forEach(it=>body.appendChild(buildCard(it,tokens)));
      det.appendChild(body); sugCats.appendChild(det);
    }
  }

  /* =================== Estratégias de estudo =================== */
  const ESTRATEGIAS={
    'Fundamentos':[
      ['Conceitos e Definições','Definições objetivas, linguagem clara e diferenciações essenciais, com 1–2 exemplos curtos.'],
      ['Base Legal Essencial','Citar e contextualizar os dispositivos legais diretamente relacionados ao tema.'],
      ['Súmulas e Enunciados','Apontar súmulas vinculantes, do STF, STJ, TJs e enunciados pertinentes.'],
      ['Doutrina Relevante','Síntese de 2–3 posições doutrinárias com autores e correntes.']
    ],
    'Aplicação Prática':[
      ['Exemplos e Casos Práticos','Mini-casos e hipóteses para treinar aplicação do conteúdo.'],
      ['Estrutura de Peça / Modelos','Esqueleto de peça processual ou roteiro de resposta dissertativa.'],
      ['Quadro Comparativo','Tabela com institutos correlatos, elementos e diferenças-chave.'],
      ['Raciocínio Jurídico (passo a passo)','Passos lógicos para resolver a questão do tema.']
    ],
    'Revisão Rápida':[
      ['Checklist de Peça','Itens mínimos a conferir em uma peça prática.'],
      ['Erros Comuns','Armadilhas frequentes e como evitá-las.'],
      ['Flashcards','Termos, conceitos e artigos em formato de pergunta/resposta.'],
      ['Dicas de Prova (OAB/Concursos)','Pontos de atenção e gestão de tempo.']
    ]
  };
  const escolhidas=[];
  function selecionarEstrategia(nome,desc){ if(!escolhidas.some(x=>x.nome===nome)) escolhidas.push({nome,desc}); }

  function renderEstrategias(){
    estrCats.innerHTML='';
    for(const cat in ESTRATEGIAS){
      const det=document.createElement('details'); det.className='acc';
      const sum=document.createElement('summary'); const ttl=document.createElement('span'); ttl.textContent=cat;
      const count=document.createElement('span'); count.className='acc-count'; count.textContent=ESTRATEGIAS[cat].length;
      sum.appendChild(ttl); sum.appendChild(count); det.appendChild(sum);
      const body=document.createElement('div'); body.className='acc-body';
      ESTRATEGIAS[cat].forEach(([nome,desc])=>{
        const div=document.createElement('div'); div.className='result';
        const tag=document.createElement('div'); tag.className='filetag'; tag.textContent=nome; div.appendChild(tag);
        const p=document.createElement('p'); p.textContent=desc; div.appendChild(p);
        const actions=document.createElement('div'); actions.className='actions';
        const btn=document.createElement('button'); btn.className='btn-alt'; btn.textContent='Adicionar ao prompt';
        btn.addEventListener('click',()=>{ selecionarEstrategia(nome,desc); toast('Sessão adicionada ao prompt.'); });
        actions.appendChild(btn); div.appendChild(actions);
        body.appendChild(div);
      });
      det.appendChild(body); estrCats.appendChild(det);
    }
  }

  /* =================== Geração do Prompt =================== */
  function gerarPrompt(){
    const temaFinal=temaInput.value.trim();
    if(!temaFinal){ toast('Defina o tema antes.'); return; }

    let baseLista=escolhidas.slice();
    if(baseLista.length===0){
      baseLista=[
        {nome:'Conceitos e Definições',desc:'Definições objetivas e diferenciações essenciais, com 1–2 exemplos curtos.'},
        {nome:'Base Legal Essencial',desc:'Dispositivos legais diretamente relacionados ao tema.'},
        {nome:'Súmulas e Enunciados',desc:'Súmulas vinculantes, STF/STJ e enunciados pertinentes.'},
        {nome:'Raciocínio Jurídico (passo a passo)',desc:'Passos lógicos para resolver a questão do tema.'}
      ];
    }

    const linhas=[];
    linhas.push('Você é um professor de Direito. Ajude-me a estudar o tema abaixo:\n');
    linhas.push('TEMA: '+temaFinal+'\n');
    linhas.push('Estruture a resposta nas seções a seguir, sendo didático e objetivo:');
    baseLista.forEach(({nome,desc})=>linhas.push(`- ${nome}: ${desc}`));
    linhas.push('\nRegras: cite artigos com número e diploma; quando houver, inclua Súmulas (STF/STJ) e leading cases; use exemplos curtos; ao final, proponha 3 questões objetivas com gabarito e 1 discursiva.');

    promptOut.textContent=linhas.join('\n');
    promptArea.style.display='block';
    setTimeout(()=>ensureVisible(promptArea),50);
    toast('Prompt gerado.');
  }

  /* =================== Execução da busca =================== */
  function executarBuscaDoTema(){
    const temaRaw=temaInput.value.trim();
    if(temaRaw.split(/\s+/).length<5){ toast("Digite pelo menos 5 palavras."); temaInput.focus(); return; }

    temaHint.style.display='block'; sugestSec.style.display='block';
    btnRebuscar.disabled=true; btnRebuscar.textContent='Buscando…';

    const {results, highlight} = professionalSearch(temaRaw, baseDados);
    renderSugeridos(results, highlight);
    estrSec.style.display='block';
    renderEstrategias();
    setTimeout(()=>{ ensureVisible(sugestSec); }, 50);

    btnRebuscar.disabled=false; btnRebuscar.textContent='Rebuscar';
  }

  btnAvancar.addEventListener('click', executarBuscaDoTema);
  btnRebuscar.addEventListener('click', executarBuscaDoTema);

  /* Dica automática após 3s desde a 1ª digitação */
  let hintTimer=null, hinted=false;
  temaInput.addEventListener('input', ()=>{
    if(hinted) return;
    if(hintTimer) clearTimeout(hintTimer);
    if(temaInput.value.trim().length>0){
      hintTimer=setTimeout(()=>{ temaHint.style.display='block'; hinted=true; }, 3000);
    }
  });

  /* Copiar -> chips de IA + Fechar */
  btnCopy.addEventListener('click', async()=>{
    try{
      await navigator.clipboard.writeText(promptOut.textContent||'');
      toast('Copiado!');
      iaRow.style.display='flex';
      dicaCliqueDireito.style.display='block';
      btnLimpar.style.display='inline-block';
    }catch{ toast('Erro ao copiar.'); }
  });
  $$('.ia').forEach(a=>{
    a.addEventListener('contextmenu', async (ev)=>{
      ev.preventDefault();
      try{ await navigator.clipboard.writeText(promptOut.textContent||''); toast('Copiado!'); }catch{}
      window.open(a.href,'_blank','noopener');
    });
  });
  function resetApp(){
    temaInput.value='';
    temaHint.style.display='none';
    sugestSec.style.display='none'; sugCats.innerHTML='';
    estrSec.style.display='none'; estrCats.innerHTML='';
    promptArea.style.display='none'; promptOut.textContent='';
    iaRow.style.display='none'; dicaCliqueDireito.style.display='none';
    btnLimpar.style.display='none';
    hinted=false; if(hintTimer) clearTimeout(hintTimer); hintTimer=null;
    window.scrollTo({top:0,behavior:'smooth'});
  }
  btnFecharChips.addEventListener('click', resetApp);
  btnLimpar.addEventListener('click', resetApp);

  /* Boot & PWA */
  async function boot(){
    baseDados = await carregarDados();
    toast('Base carregada com sucesso!');
  }
  boot();

  let deferredPrompt=null;
  const installFab=$("#installFab");
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installFab.style.display='flex'; });
  installFab.addEventListener('click', async()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice;
    if(outcome==='accepted') toast('Instalação iniciada.'); installFab.style.display='none'; deferredPrompt=null;
  });
})();
</script>
</body>
</html>
