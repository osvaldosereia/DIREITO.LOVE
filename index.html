<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>direito.love — Vade Mecum simples</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root{
      --topbar-h: 44px;
      --subbar-h: 40px;
      --bottombar-h: 56px;
      --bg:#fff;
      --fg:#111;
      --muted:#666;
      --line:#e9e9e9;
      --accent:#eaf8f6; /* destaque clarinho do artigo ao clicar em ESTUDAR */
      --chip-bg:#f5f5f5;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    button,input,select{font:inherit}

    /* Topbar */
    .topbar{
      position:fixed;top:0;left:0;right:0;height:var(--topbar-h);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 12px;border-bottom:1px solid var(--line);background:#fff;z-index:50
    }
    .brand{font-weight:700}
    .actions{display:flex;gap:8px}
    .btn{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* Subbar (seletor de códigos) */
    .subbar{
      position:fixed;top:var(--topbar-h);left:0;right:0;height:var(--subbar-h);
      display:flex;align-items:center;gap:8px;padding:0 12px;border-bottom:1px solid var(--line);background:#fff;z-index:40
    }
    .subbar label{font-weight:600}
    .subbar .select-wrap{flex:1}
    .subbar select{width:100%;height:28px;border:1px solid var(--line);border-radius:8px;background:#fff;padding:0 8px}

    /* Conteúdo (scroll) */
    .content{
      position:relative;
      padding: calc(var(--topbar-h) + var(--subbar-h) + 10px) 12px calc(var(--bottombar-h) + 16px);
      min-height:100dvh;
    }
    .placeholder{
      padding:24px;border:1px dashed var(--line);border-radius:12px;color:var(--muted)
    }

    /* Blocos de artigo */
    .articles{max-width:1000px;margin:0 auto}
    article{
      white-space:pre-wrap; /* preserva o .txt */
      border-bottom:1px solid var(--line);
      padding:16px 8px;
      scroll-margin: 80px;
    }
    article .art-title{display:block;font-weight:700;margin-bottom:8px}
    article.current-outline{outline:2px solid #e0f0ff;outline-offset:2px;border-radius:8px}
    article.highlight-study{background:var(--accent);border-radius:8px}

    /* Destaque de busca */
    mark{padding:0 2px;border-radius:3px}

    /* Barra fixa inferior */
    .bottombar{
      position:fixed;left:0;right:0;bottom:0;height:var(--bottombar-h);
      display:flex;align-items:center;gap:8px;padding:8px 12px;border-top:1px solid var(--line);background:#fff;z-index:60
    }
    .bottombar .nav{
      display:flex;gap:6px;align-items:center
    }
    .iconbtn{width:36px;height:36px;border:1px solid var(--line);background:#fff;border-radius:8px;display:grid;place-items:center;cursor:pointer}
    .search{flex:1;display:flex;align-items:center;gap:6px}
    .search input{
      width:100%;height:36px;border:1px solid var(--line);border-radius:8px;padding:0 10px
    }
    .count{min-width:70px;text-align:center;color:var(--muted);font-size:12px}
    .study{min-width:110px}

    /* Modal central IA */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:100}
    .modal{background:#fff;border-radius:12px;max-width:640px;width:92%;padding:16px;border:1px solid var(--line)}
    .modal h3{margin:0 0 12px}
    .ia-grid{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 10px;border:1px solid var(--line);background:var(--chip-bg);border-radius:999px;cursor:pointer}
    .modal .foot{margin-top:12px;display:flex;justify-content:flex-end}
    .close{padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}

    /* Toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--bottombar-h) + 12px);background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:200}
    .toast.show{opacity:1}

    /* Invisível até carregar um código */
    .bottombar[hidden]{display:none}
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">direito.love</div>
    <div class="actions">
      <button class="btn" id="btnInstall" hidden>Instalar</button>
      <button class="btn" id="btnReset">Reiniciar</button>
    </div>
  </header>

  <div class="subbar">
    <label for="codeSelect">Código/Lei:</label>
    <div class="select-wrap">
      <select id="codeSelect">
        <option value="">— selecione —</option>
        <option value="data/codigo_civil.txt">Código Civil</option>
        <option value="data/codigo_consumidor.txt">Código de Defesa do Consumidor</option>
        <option value="data/codigo_penal.txt">Código Penal</option>
        <option value="data/codigo_Processo_Civil.txt">Código de Processo Civil</option>
        <option value="data/codigo_Processo_Penal.txt">Código de Processo Penal</option>
      </select>
    </div>
  </div>

  <main class="content">
    <div class="articles" id="articles">
      <div class="placeholder">
        Selecione um código acima para carregar o texto completo. Use a busca da barra inferior como um <strong>Ctrl+F</strong> com setas para navegar.
      </div>
    </div>
  </main>

  <!-- Barra inferior (setas, busca, estudar) -->
  <div class="bottombar" id="bottomBar" hidden>
    <div class="nav">
      <button class="iconbtn" id="prevBtn" title="Anterior" aria-label="Anterior">◀</button>
      <button class="iconbtn" id="nextBtn" title="Próximo" aria-label="Próximo">▶</button>
    </div>
    <div class="search">
      <input id="searchInput" type="search" placeholder="Buscar no texto…" autocomplete="off" />
      <div class="count" id="count">0/0</div>
    </div>
    <button class="btn study" id="studyBtn">ESTUDAR</button>
  </div>

  <!-- Modal IA -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Estude o Artigo X com as I.As. abaixo. Escolha e cole o prompt.</h3>
      <div class="ia-grid">
        <a class="chip" href="https://chat.openai.com" target="_blank" rel="noopener">ChatGPT</a>
        <a class="chip" href="https://gemini.google.com/app" target="_blank" rel="noopener">Gemini</a>
        <a class="chip" href="https://www.perplexity.ai/" target="_blank" rel="noopener">Perplexity</a>
        <a class="chip" href="https://notebooklm.google.com/" target="_blank" rel="noopener">NotebookLM</a>
      </div>
      <div class="foot">
        <button class="close" id="closeModal">Fechar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">✅ Prompt copiado!</div>

  <script>
    // ===== PWA: SW + Install Button =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
    let deferredPrompt = null;
    const installBtn = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
    });
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.hidden = true;
    });

    // ===== App State =====
    const els = {
      codeSelect: document.getElementById('codeSelect'),
      articles: document.getElementById('articles'),
      bottomBar: document.getElementById('bottomBar'),
      searchInput: document.getElementById('searchInput'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      count: document.getElementById('count'),
      studyBtn: document.getElementById('studyBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      modalTitle: document.getElementById('modalTitle'),
      closeModal: document.getElementById('closeModal'),
      toast: document.getElementById('toast'),
      btnReset: document.getElementById('btnReset')
    };

    const state = {
      rawText: '',
      articles: [],           // {title, text, htmlId}
      currentArticleIdx: -1,
      searchTerm: '',
      matchNodes: [],
      matchIdx: -1
    };

    // ===== Utils =====
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const escapeHtml = (s)=> s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const showToast = (msg='✅ Prompt copiado!')=>{
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(()=>els.toast.classList.remove('show'), 1000);
    };

    // Detecta artigo em evidência (próximo do centro da viewport)
    const getArticleInView = ()=>{
      const nodes = document.querySelectorAll('article[data-idx]');
      const cy = window.innerHeight/2;
      let hitIdx = -1;
      for (const el of nodes){
        const r = el.getBoundingClientRect();
        if (r.top <= cy && r.bottom >= cy){ hitIdx = Number(el.dataset.idx); break; }
      }
      if (hitIdx === -1 && nodes.length){
        // fallback: primeiro visível
        for (const el of nodes){
          const r = el.getBoundingClientRect();
          if (r.bottom > 0 && r.top < window.innerHeight){ hitIdx = Number(el.dataset.idx); break; }
        }
      }
      return hitIdx;
    };

    const updateCurrentOutline = ()=>{
      const idx = getArticleInView();
      if (idx === state.currentArticleIdx) return;
      state.currentArticleIdx = idx;
      document.querySelectorAll('article.current-outline').forEach(n=>n.classList.remove('current-outline'));
      if (idx >= 0){
        document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('current-outline');
      }
    };

    window.addEventListener('scroll', ()=>{
      if (!state.articles.length) return;
      updateCurrentOutline();
    }, {passive:true});

    // ===== Parser de artigos =====
    // Regra: começa em "Art" (A maiúsculo) e termina no último "." ou ")" antes do próximo "Art".
    function parseArticlesFromText(txt){
      const starts = [];
      const re = /(^|\n)(?=Art(?![a-z]))/g; // "Art" não seguido de minúscula (evita "Artigo")
      let m;
      while((m = re.exec(txt))!==null){
        const idx = m.index + (m[0].startsWith('\n') ? 1 : 0);
        starts.push(idx);
      }
      if (!starts.length){
        // Sem "Art" — retorna texto inteiro como 1 bloco
        return [{ title: 'Texto', text: txt.trim(), htmlId: 'art-0'}];
      }

      const arts = [];
      for (let i=0;i<starts.length;i++){
        const from = starts[i];
        const to = (i+1<starts.length) ? starts[i+1] : txt.length;
        let chunk = txt.slice(from, to);

        // Encontrar o fim: último '.' ou ')' dentro do chunk
        let endDot = chunk.lastIndexOf('.');
        let endPar = chunk.lastIndexOf(')');
        let end = Math.max(endDot, endPar);
        if (end === -1){
          // Sem '.' e ')': termina no char anterior ao próximo Art (ou fim)
          // (chunk já está cortado até o próximo Art)
          end = chunk.length - 1;
        }
        chunk = chunk.slice(0, end+1).trimEnd();

        // Título (primeira linha até quebra)
        const firstLine = chunk.split(/\r?\n/,1)[0].trim();
        // Algo como "Art. 1.", "Art. 121-A." … se não bater, usa início do texto
        const mtitle = firstLine.match(/^Art[^\d]*\s*\d{1,4}(?:-[A-Z])?\.?/);
        const title = mtitle ? mtitle[0].trim() : firstLine.slice(0,40);
        arts.push({ title, text: chunk, htmlId: `art-${i}` });
      }
      return arts;
    }

    // ===== Render =====
    function renderArticles(){
      const frag = document.createDocumentFragment();
      state.articles.forEach((a, i)=>{
        const el = document.createElement('article');
        el.dataset.idx = i;
        el.id = a.htmlId;
        // Exibe título destacado apenas se o .txt não tiver quebra logo após "Art."
        // (para manter o arquivo o mais fiel possível)
        // Aqui: não forçamos "<br/>": usamos pre-wrap no CSS.
        const titleSpan = document.createElement('span');
        titleSpan.className = 'art-title';
        titleSpan.textContent = a.title;
        el.appendChild(titleSpan);

        const content = document.createElement('div');
        content.className = 'art-body';
        content.textContent = a.text.replace(a.title, '').trimStart();
        el.appendChild(content);

        frag.appendChild(el);
      });
      els.articles.innerHTML = '';
      els.articles.appendChild(frag);
      els.bottomBar.hidden = false;
      updateCurrentOutline();
    }

    // ===== Busca (Ctrl+F simplificado) =====
    function clearMarks(){
      // re-render rápido usando os dados originais (mantém fidelidade)
      // estratégia: reatribuir textContent com split título + corpo
      const nodes = document.querySelectorAll('article[data-idx]');
      nodes.forEach(node=>{
        const i = Number(node.dataset.idx);
        const a = state.articles[i];
        node.innerHTML = '';
        const titleSpan = document.createElement('span');
        titleSpan.className = 'art-title';
        titleSpan.textContent = a.title;
        const content = document.createElement('div');
        content.className = 'art-body';
        content.textContent = a.text.replace(a.title, '').trimStart();
        node.appendChild(titleSpan);
        node.appendChild(content);
      });
      state.matchNodes = [];
      state.matchIdx = -1;
      els.count.textContent = '0/0';
    }

    function highlightTerm(term){
      clearMarks();
      if (!term){ return; }
      const rx = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const nodes = document.querySelectorAll('article .art-body, article .art-title');

      for (const n of nodes){
        const raw = n.textContent;
        if (!rx.test(raw)) continue;
        // reset lastIndex
        rx.lastIndex = 0;
        const html = escapeHtml(raw).replace(rx, (m)=>`<mark>${m}</mark>`);
        n.innerHTML = html;
      }
      // coletar todos os <mark>
      state.matchNodes = Array.from(document.querySelectorAll('mark'));
      if (state.matchNodes.length){
        state.matchIdx = 0;
        scrollToMatch(0);
        els.count.textContent = `1/${state.matchNodes.length}`;
      }else{
        els.count.textContent = `0/0`;
      }
    }

    function scrollToMatch(idx){
      const m = state.matchNodes[idx];
      if (!m) return;
      m.scrollIntoView({behavior:'smooth',block:'center'});
      // Atualiza contador
      els.count.textContent = `${idx+1}/${state.matchNodes.length}`;
    }

    els.searchInput.addEventListener('input', (e)=>{
      state.searchTerm = e.target.value.trim();
      highlightTerm(state.searchTerm);
    });

    els.nextBtn.addEventListener('click', ()=>{
      if (!state.matchNodes.length) return;
      state.matchIdx = (state.matchIdx + 1) % state.matchNodes.length;
      scrollToMatch(state.matchIdx);
    });
    els.prevBtn.addEventListener('click', ()=>{
      if (!state.matchNodes.length) return;
      state.matchIdx = (state.matchIdx - 1 + state.matchNodes.length) % state.matchNodes.length;
      scrollToMatch(state.matchIdx);
    });

    // ===== ESTUDAR (gera e copia prompt, destaca artigo em evidência) =====
    function extractArticleTitleText(a){
      // Usa o título detectado (ex.: "Art. 1.") para "X"
      return a?.title || 'Artigo';
    }
    function buildPrompt(a){
      const artigo = a?.text || '';
      const primeiraLinha = artigo.split(/\r?\n/)[0]?.trim() || '';
      const tema = primeiraLinha || a?.title || 'Artigo';
      return [
        'Assuma a persona de um professor de Direito experiente convidado pelo direito.love e gere um material de estudo rápido. ',
        'Analise detalhadamente todo o artigo abaixo (caput, paragrafos, incisos e alineas), cobrindo: ',
        '(1) conceito com visão doutrinária, jurisprudência majoritária e prática; ',
        '(2) mini exemplo prático; ',
        '(3) checklist essencial; ',
        '(4) erros comuns e pegadinhas de prova; ',
        '(5) Pontos de atenção na prática jurídica; ',
        '(6) Princípios Relacionados ao tema; ',
        '(7) nota comparativa se houver artigos correlatos. ',
        'Responda em português claro, sem enrolação, objetivo e didático.\n\n',
        `Tema: "${tema}"\n\n`,
        artigo,
        '\n\n💚 direito.love'
      ].join('');
    }

    els.studyBtn.addEventListener('click', async ()=>{
      if (!state.articles.length) return;
      updateCurrentOutline();
      const idx = state.currentArticleIdx ?? 0;
      const a = state.articles[idx] || state.articles[0];

      // Destaque visual do artigo escolhido
      document.querySelectorAll('article.highlight-study').forEach(n=>n.classList.remove('highlight-study'));
      const node = document.querySelector(`article[data-idx="${idx}"]`);
      node?.classList.add('highlight-study');

      // Prompt
      const prompt = buildPrompt(a);
      try{
        await navigator.clipboard.writeText(prompt);
        showToast('✅ Prompt copiado!');
      }catch(e){
        showToast('Copie manualmente no próximo passo.');
        console.warn('Clipboard falhou:', e);
      }

      // Modal IA
      els.modalTitle.textContent = `Estude o ${extractArticleTitleText(a)} com as I.As. abaixo. Escolha e cole o prompt.`;
      els.modalBackdrop.style.display = 'flex';
      els.modalBackdrop.setAttribute('aria-hidden','false');
    });

    els.closeModal.addEventListener('click', ()=>{
      els.modalBackdrop.style.display = 'none';
      els.modalBackdrop.setAttribute('aria-hidden','true');
    });
    els.modalBackdrop.addEventListener('click', (e)=>{
      if (e.target === els.modalBackdrop) els.closeModal.click();
    });

    // ===== Carregamento do código (TXT) =====
    els.codeSelect.addEventListener('change', async (e)=>{
      const url = e.target.value;
      if (!url){ resetAll(true); return; }
      els.articles.innerHTML = '<div class="placeholder">Carregando…</div>';
      try{
        const res = await fetch(url, {cache:'reload'});
        const txt = await res.text();
        state.rawText = txt;

        // Parse em "fatias" para não travar (yield entre loops)
        state.articles = parseArticlesFromText(txt);
        renderArticles();
        clearMarks(); // limpa estado de busca
        window.scrollTo({top:0,behavior:'instant'});
      }catch(err){
        console.error(err);
        els.articles.innerHTML = '<div class="placeholder">Falha ao carregar o arquivo. Verifique o caminho em /data/.</div>';
        els.bottomBar.hidden = true;
      }
    });

    // ===== Reiniciar =====
    function resetAll(keepSelect=false){
      state.rawText = '';
      state.articles = [];
      state.currentArticleIdx = -1;
      state.searchTerm = '';
      state.matchNodes = [];
      state.matchIdx = -1;

      els.searchInput.value = '';
      els.count.textContent = '0/0';
      els.bottomBar.hidden = true;
      els.articles.innerHTML = '<div class="placeholder">Selecione um código acima para carregar o texto completo. Use a busca da barra inferior como um <strong>Ctrl+F</strong> com setas para navegar.</div>';
      if (!keepSelect) els.codeSelect.value = '';
      document.querySelectorAll('.highlight-study,.current-outline').forEach(n=>n.classList.remove('highlight-study','current-outline'));
      els.modalBackdrop.style.display = 'none';
      els.modalBackdrop.setAttribute('aria-hidden','true');
      window.scrollTo({top:0,behavior:'instant'});
    }
    els.btnReset.addEventListener('click', ()=>resetAll());

    // Primeira atualização do destaque ao rolar
    document.addEventListener('DOMContentLoaded', ()=>updateCurrentOutline());
  </script>
</body>
</html>
