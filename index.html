<script>
/* =============== Refs =============== */
const els = {
  // topo / status
  brandBtn: document.getElementById('brandBtn'),
  progress: document.getElementById('progress'),
  progressBar: document.getElementById('progressBar'),

  // containers
  articles: document.getElementById('articles'),

  // barras base
  bottomInfo: document.getElementById('bottomInfo'),
  bottomSearch: document.getElementById('bottomSearch'),
  bottomStudy: document.getElementById('bottomStudy'),

  // barra info (seletor + toggle)
  openPicker: document.getElementById('openPicker'),
  fileIndicator: document.getElementById('fileIndicator'),
  globalToggle: document.getElementById('globalToggle'),

  // barra busca
  searchInput: document.getElementById('searchInput'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  spinner: document.getElementById('spinner'),
  count: document.getElementById('count'),
  doSearchBtn: document.getElementById('doSearchBtn'),
  resetBtn: document.getElementById('resetBtn'),

  // barra estudo
  studyBtn: document.getElementById('studyBtn'),

  // modal prompt
  modalBackdrop: document.getElementById('modalBackdrop'),
  modalTitle: document.getElementById('modalTitle'),
  closeModal: document.getElementById('closeModal'),
  toast: document.getElementById('toast'),

  // sheet seletor
  codeSelect: document.getElementById('codeSelect'),
  pickerSheet: document.getElementById('pickerSheet'),
  pickerSearch: document.getElementById('pickerSearch'),
  pickerList: document.getElementById('pickerList'),
};

/* =============== Estado =============== */
const state = {
  // arquivo atual (modo leitura do arquivo)
  currentFileUrl: null,
  currentFileLabel: 'Escolher cÃ³digo',
  rawText: '',
  articles: [],              // lista renderizada do arquivo atual (para modo normal)
  currentArticleIdx: -1,

  // render atual
  currentMode: 'idle',       // 'idle' | 'file' | 'global'
  currentList: [],           // lista atualmente renderizada (arquivo completo OU resultados globais)
  currentTokens: [],         // termos usados na Ãºltima marcaÃ§Ã£o

  // busca / navegaÃ§Ã£o
  matchNodes: [],
  matchIdx: -1,

  // progresso
  progressTimer: null,

  // global
  globalOn: false,
  cache: new Map(),          // url -> texto limpo
  urlToLabel: new Map(),     // url -> label
};

/* =============== Utilidades UI =============== */
function showToast(msg='âœ… Pronto!'){
  els.toast.textContent = msg;
  els.toast.classList.add('show');
  setTimeout(()=> els.toast.classList.remove('show'), 1000);
}
function setProgressActive(active){
  if (active){
    els.progress.hidden = false;
    els.progressBar.style.width = '0%';
    let p = 0;
    clearInterval(state.progressTimer);
    state.progressTimer = setInterval(()=>{
      p = Math.min(85, p + 8 + Math.random()*7);
      els.progressBar.style.width = p + '%';
    }, 180);
  } else {
    clearInterval(state.progressTimer);
    els.progressBar.style.width = '100%';
    setTimeout(()=>{ els.progress.hidden = true; els.progressBar.style.width = '0%'; }, 240);
  }
}
function setBusy(isBusy){
  els.bottomSearch.setAttribute('aria-busy', String(isBusy));
  els.doSearchBtn.disabled = isBusy;
  els.prevBtn.disabled = isBusy;
  els.nextBtn.disabled = isBusy;
  els.spinner.hidden = !isBusy;
  setProgressActive(isBusy);
}
function updateCount(){
  if (!state.matchNodes.length){ els.count.textContent = '0/0'; return; }
  els.count.textContent = `${state.matchIdx+1}/${state.matchNodes.length}`;
}
function setFileIndicator(label){
  const full = (label || 'Escolher cÃ³digo').trim();
  els.fileIndicator.textContent = full;
  els.openPicker.title = full;
}

/* =============== NormalizaÃ§Ã£o / Parser =============== */
const sanitizeForLayout = (s)=> s
  .replace(/\u00A0/g, ' ')
  .replace(/\t/g, ' ')
  .replace(/\s+\n/g, '\n');

function normalizeWithMap(s){
  let norm = '';
  const map = [];
  for (let i=0;i<s.length;i++){
    const de = s[i].normalize('NFD');
    for (let k=0;k<de.length;k++){
      const c = de[k];
      const code = c.codePointAt(0);
      if (code>=0x0300 && code<=0x036F) continue;
      norm += c.toLowerCase();
      map.push(i);
    }
  }
  return {norm, map};
}
const normalizeTerm = (s)=> (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

function findRanges(raw, term){
  if (!term) return [];
  const {norm, map} = normalizeWithMap(raw);
  const needle = normalizeTerm(term);
  if (!needle) return [];
  const out = [];
  let from = 0;
  while(true){
    const pos = norm.indexOf(needle, from);
    if (pos === -1) break;
    const s = map[pos];
    const e = map[pos + needle.length - 1] + 1;
    out.push([s,e]);
    from = pos + needle.length;
  }
  return out;
}
function mergeRanges(ranges){
  if (!ranges.length) return [];
  ranges.sort((a,b)=> a[0]-b[0]);
  const out = [ranges[0].slice()];
  for (let i=1;i<ranges.length;i++){
    const [s,e] = ranges[i];
    const last = out[out.length-1];
    if (s <= last[1]) last[1] = Math.max(last[1], e);
    else out.push([s,e]);
  }
  return out;
}
function findRangesMulti(raw, tokens){
  let all = [];
  for (const t of tokens){
    const r = findRanges(raw, t);
    if (r.length) all = all.concat(r);
  }
  return mergeRanges(all);
}
function highlightElementByRanges(el, ranges){
  if (!ranges.length) return;
  const raw = el.textContent;
  let out = '', last = 0;
  for (const [s,e] of ranges){
    out += escapeHtml(raw.slice(last, s));
    out += '<mark>' + escapeHtml(raw.slice(s, e)) + '</mark>';
    last = e;
  }
  out += escapeHtml(raw.slice(last));
  el.innerHTML = out;
}
const escapeHtml = (s)=> s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

/* ======= Parse de blocos ======= */
function splitBlockSupraTitleBody(raw){
  const lines = raw.replace(/^\s+|\s+$/g,'').split(/\r?\n/);
  const artIdx = lines.findIndex(line =>
    /^\s*(?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:Âº|o)?\.?/.test(line)
  );

  if (artIdx >= 0){
    const supra = lines.slice(0, artIdx).map(s=>s.trim()).filter(Boolean);
    const titleLine = lines[artIdx];

    const mt = titleLine.match(/^\s*((?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:Âº|o)?\.?)/);
    let titleText = mt ? mt[1].trim() : titleLine.trim();

    // Normaliza 10-A â†’ 10A
    titleText = titleText.replace(/(\d+)-?([A-Z])/, "$1$2");

    const afterTitle = titleLine.slice(mt ? mt[1].length : 0).trimStart();
    const rest = lines.slice(artIdx+1).join('\n').trimStart();
    const body = afterTitle ? (rest ? afterTitle + '\n' + rest : afterTitle) : rest;

    return { supra, titleText, body };
  } else {
    const titleText = (lines[0]||'').trim();
    const body = lines.slice(1).join('\n').trimStart();
    return { supra:[], titleText, body };
  }
}
function parseByDelimiters(txt){
  const sepRe = /(^|\n)[^\S\r\n]*-{5,}[^\S\r\n]*(?=\n|$)/g;
  const seps = [];
  let m;
  while ((m = sepRe.exec(txt)) !== null) {
    const idx = m.index + (m[0].startsWith('\n') ? 1 : 0);
    seps.push(idx);
  }
  if (seps.length < 2) return [];
  const arts = [];
  for (let i = 0; i + 1 < seps.length; i += 1) {
    const startLineEnd = txt.indexOf('\n', seps[i]);
    const from = (startLineEnd === -1) ? txt.length : startLineEnd + 1;
    const to = seps[i + 1];
    if (from >= to) continue;
    const raw = txt.slice(from, to).trim();
    if (!raw) continue;
    const split = splitBlockSupraTitleBody(raw);
    const title = split.titleText || `Bloco ${arts.length + 1}`;
    arts.push({ title, text: raw, htmlId: `art-${arts.length}`, _split: split });
  }
  return arts;
}
function parseByArt(txt){
  const re = /(^|\n)\s*((?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:Âº|o)?\.?)/g;
  const starts = [];
  let m;
  while ((m = re.exec(txt)) !== null) {
    const idxArt = re.lastIndex - m[2].length;
    starts.push(idxArt);
  }
  if (!starts.length) return [{
    title:'Texto',
    text: txt.trim(),
    htmlId:'art-0',
    _split: splitBlockSupraTitleBody(txt.trim())
  }];

  const arts = [];
  for (let i = 0; i < starts.length; i++) {
    const from = starts[i];
    const to   = (i + 1 < starts.length) ? starts[i + 1] : txt.length;
    let chunk = txt.slice(from, to).trimEnd();

    // corta em ponto final/fecha parÃªntese
    const endDot = chunk.lastIndexOf('.');
    const endPar = chunk.lastIndexOf(')');
    const end    = Math.max(endDot, endPar);
    if (end !== -1) chunk = chunk.slice(0, end + 1).trimEnd();

    const split = splitBlockSupraTitleBody(chunk);
    const title = split.titleText || chunk.split('\n')[0].slice(0,40);
    arts.push({ title, text: chunk, htmlId: `art-${i}`, _split: split });
  }
  return arts;
}
function parseSumulas(txt){
  const cleaned = sanitizeForLayout(txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'));
  const parts = cleaned.split(/^\s*-{5,}\s*$/m).map(s => s.trim()).filter(Boolean);
  const out = [];
  parts.forEach((block, i)=>{
    const lines = block.split('\n').map(l=>l.trim());
    const header = (lines.shift() || 'SÃºmula').trim(); // "SÃºmula 736 - STF"
    const body = lines.join('\n').trim();
    out.push({
      title: header,
      text: header + (body ? '\n' + body : ''),
      htmlId: `sumula-${i}`,
      _split: { supra: [], titleText: header, body }
    });
  });
  return out;
}
function parsePrincipios(txt){
  const cleaned = sanitizeForLayout(txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'));
  const parts = cleaned.split(/^\s*-{5,}\s*$/m).map(s => s.trim()).filter(Boolean);
  const out = [];
  parts.forEach((block, i)=>{
    const lines = block.split('\n').map(l=>l.trim());
    let header = (lines.shift() || 'PrincÃ­pio').trim();
    const reHeader = /^\s*Princ[iÃ­]pio\b/i;
    if (!reHeader.test(header)){
      if (lines.length && reHeader.test(lines[0])) header = lines.shift();
      else header = 'PrincÃ­pio';
    }
    const body = lines.join('\n').trim();
    out.push({
      title: header,
      text: header + (body ? '\n' + body : ''),
      htmlId: `principio-${i}`,
      _split: { supra: [], titleText: header, body }
    });
  });
  return out;
}
function parseByUrl(url, txt){
  const isSumulas = /(^|\/)data\/sumulas\/?/i.test(url);
  const isPrincipios = /(^|\/)data\/principios\/?/i.test(url);
  return isSumulas ? parseSumulas(txt)
       : isPrincipios ? parsePrincipios(txt)
       : (parseByDelimiters(txt).length ? parseByDelimiters(txt) : parseByArt(txt));
}

/* =============== RenderizaÃ§Ã£o =============== */
function renderArticles(list, {globalMode=false}={}){
  const frag = document.createDocumentFragment();
  list.forEach((a, i)=>{
    const el = document.createElement('article');
    el.dataset.idx = i;
    el.id = a.htmlId || `art-${i}`;

    const split = a._split || splitBlockSupraTitleBody(a.text);

    // Supra + badge de arquivo (somente no modo global)
    const supraWrap = document.createElement('div');
    supraWrap.className = 'supra';

    if (globalMode && a._fileLabel){
      const badge = document.createElement('div');
      badge.textContent = `[${a._fileLabel}]`;
      supraWrap.appendChild(badge);
    }
    if (split.supra && split.supra.length){
      split.supra.forEach(line=>{
        const d = document.createElement('div');
        d.textContent = line;
        supraWrap.appendChild(d);
      });
    }
    if (supraWrap.childNodes.length){ el.appendChild(supraWrap); }

    const titleSpan = document.createElement('span');
    titleSpan.className = 'art-title';
    titleSpan.textContent = split.titleText || a.title || 'Artigo';
    el.appendChild(titleSpan);

    const content = document.createElement('div');
    content.className = 'art-body';
    content.textContent = split.body || '';
    el.appendChild(content);

    frag.appendChild(el);
  });

  els.articles.innerHTML = '';
  if (list.length){
    els.articles.appendChild(frag);
  } else {
    els.articles.innerHTML = '<div class="placeholder"><p>ðŸ¤” Nenhum resultado com todos os termos. Tente variar as palavras.</p></div>';
  }

  // manter barras visÃ­veis
  els.bottomInfo.hidden = false;
  els.bottomSearch.hidden = false;
  els.bottomStudy.hidden = false;

  state.currentList = list;
  updateCurrentOutline();
  // limpa contagem
  state.matchNodes = [];
  state.matchIdx = -1;
  updateCount();
}

/* =============== Destaque / Busca no DOM =============== */
function clearMarksAndRerender(){
  // Re-renderiza a lista atual SEM marcaÃ§Ãµes
  renderArticles(state.currentList, {globalMode: state.currentMode === 'global'});
}
async function highlightTokensChunked(tokens){
  clearMarksAndRerender();
  if (!tokens.length) return;

  setBusy(true);
  els.count.textContent = '...';

  const nodes = [
    ...document.querySelectorAll('article .art-body'),
    ...document.querySelectorAll('article .art-title'),
    ...document.querySelectorAll('article .supra > div')
  ];

  const BATCH = 14;
  for (let i = 0; i < nodes.length; i += BATCH){
    for (let j = i; j < Math.min(i+BATCH, nodes.length); j++){
      const n = nodes[j];
      const raw = n.textContent;
      const ranges = findRangesMulti(raw, tokens);
      if (ranges.length) highlightElementByRanges(n, ranges);
    }
    await new Promise(r=>setTimeout(r,0));
  }

  state.matchNodes = Array.from(document.querySelectorAll('mark'));
  if (state.matchNodes.length){
    state.matchIdx = 0;
    state.matchNodes[0].scrollIntoView({behavior:'smooth', block:'center'});
  } else {
    state.matchIdx = -1;
  }
  updateCount();
  setBusy(false);
}

/* =============== Scroll / Outline =============== */
function getArticleInView(){
  const nodes = document.querySelectorAll('article[data-idx]');
  const cy = window.innerHeight / 2;
  let hitIdx = -1;
  for (const el of nodes){
    const r = el.getBoundingClientRect();
    if (r.top <= cy && r.bottom >= cy){ hitIdx = Number(el.dataset.idx); break; }
  }
  if (hitIdx === -1 && nodes.length){
    for (const el of nodes){
      const r = el.getBoundingClientRect();
      if (r.bottom > 0 && r.top < window.innerHeight){ hitIdx = Number(el.dataset.idx); break; }
    }
  }
  return hitIdx;
}
function updateCurrentOutline(){
  const idx = getArticleInView();
  if (idx === state.currentArticleIdx) return;
  state.currentArticleIdx = idx;
  document.querySelectorAll('article.current-outline').forEach(n=>n.classList.remove('current-outline'));
  if (idx >= 0){
    document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('current-outline');
  }
}
window.addEventListener('scroll', ()=>{ if (state.currentList.length) updateCurrentOutline(); }, {passive:true});

/* =============== CatÃ¡logo (select oculto) =============== */
function buildCatalogMaps(){
  const sel = els.codeSelect;
  state.urlToLabel.clear();
  sel.querySelectorAll('option').forEach(opt=>{
    const url = opt.value?.trim();
    const label = opt.textContent?.trim();
    if (url) state.urlToLabel.set(url, label);
  });
}
function getGroupsFromSelect(){
  const sel = els.codeSelect;
  const groups = [];
  let current = null;
  sel.querySelectorAll('optgroup, option').forEach(node=>{
    if (node.tagName.toLowerCase()==='optgroup'){
      current = { label: node.label || '', items: [] };
      groups.push(current);
    } else if (node.tagName.toLowerCase()==='option'){
      const label = node.textContent.trim();
      const value = node.value;
      if (!label || !current) return;
      current.items.push({ label, value });
    }
  });
  return groups;
}

/* =============== Loader de arquivo =============== */
async function fetchTextCached(url){
  if (state.cache.has(url)) return state.cache.get(url);
  const res = await fetch(url, {cache: 'force-cache'});
  if (!res.ok) throw new Error(`HTTP ${res.status} â€” ${res.statusText}`);
  const txt = sanitizeForLayout(await res.text());
  state.cache.set(url, txt);
  return txt;
}
async function loadFile(url){
  if (!url) return;
  setBusy(true);
  try{
    const txt = await fetchTextCached(url);
    state.rawText = txt;
    const list = parseByUrl(url, txt);
    state.currentFileUrl = url;
    state.currentFileLabel = state.urlToLabel.get(url) || 'Documento';
    state.articles = list;
    state.currentMode = 'file';
    renderArticles(list, {globalMode:false});
    setFileIndicator(state.currentFileLabel);
    window.scrollTo({top:0,behavior:'instant'});
  }catch(err){
    console.error(err);
    els.articles.innerHTML = `<div class="placeholder"><p>Falha ao carregar:<br><code>${(err && err.message) || 'Erro desconhecido'}</code></p></div>`;
  }
  setBusy(false);
}

/* =============== Busca Local (arquivo atual) =============== */
async function runLocalSearch(){
  const q = els.searchInput.value.trim();
  if (!q) { clearMarksAndRerender(); return; }
  const tokens = q.split(/\s+/).filter(Boolean);
  state.currentTokens = tokens;
  await highlightTokensChunked(tokens);
}

/* =============== Busca Global (AND) =============== */
function blockFullText(a){
  const s = a._split || splitBlockSupraTitleBody(a.text);
  const supra = s.supra?.length ? s.supra.join('\n')+'\n' : '';
  const title = s.titleText || a.title || '';
  const body  = s.body || '';
  return (title+'\n'+supra+body).trim();
}
async function runGlobalSearch(){
  const q = els.searchInput.value.trim();
  const tokens = q.split(/\s+/).map(normalizeTerm).filter(Boolean);
  state.currentTokens = tokens;

  if (!tokens.length){
    // sem termos â†’ volta para o arquivo aberto, se houver
    if (state.currentFileUrl){
      state.currentMode = 'file';
      renderArticles(state.articles, {globalMode:false});
      updateCount();
    } else {
      els.articles.innerHTML = '<div class="placeholder"><p>Digite algo para buscar em todos os cÃ³digos.</p></div>';
    }
    return;
  }

  setBusy(true);
  const results = [];
  const sel = els.codeSelect;
  // percorre todos os arquivos do catÃ¡logo
  for (const opt of sel.querySelectorAll('option')){
    const url = opt.value?.trim();
    const label = opt.textContent?.trim();
    if (!url) continue;
    try{
      const txt = await fetchTextCached(url);
      const items = parseByUrl(url, txt);
      for (const it of items){
        const full = blockFullText(it);
        const norm = normalizeTerm(full);
        const allHit = tokens.every(t => norm.indexOf(t) !== -1);
        if (allHit){
          results.push({
            ...it,
            htmlId: `g-${results.length}`,
            _fileUrl: url,
            _fileLabel: label
          });
        }
      }
    } catch(e){ /* ignora erros individuais */ }
    await new Promise(r=>setTimeout(r,0)); // ceder o thread p/ UI
  }

  state.currentMode = 'global';
  renderArticles(results, {globalMode:true});
  if (results.length){
    await highlightTokensChunked(tokens);
  } else {
    // sem matches â†’ contador 0/0
    state.matchNodes = [];
    state.matchIdx = -1;
    updateCount();
  }
  setBusy(false);
}

/* =============== Sheet (seletor na base) =============== */
function norm(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
function escRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

function renderPicker(filter=''){
  const groups = getGroupsFromSelect();
  const f = norm(filter);
  els.pickerList.innerHTML = '';
  let total = 0;

  groups.forEach(g=>{
    const items = g.items.filter(it => !f || norm(it.label).includes(f));
    if (!items.length) return;

    const sec = document.createElement('div'); sec.className = 'list-section';
    const h = document.createElement('h4'); h.textContent = g.label; sec.appendChild(h);

    items.forEach(it=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'item';
      let labelHTML = it.label;
      if (f) labelHTML = it.label.replace(new RegExp(escRe(filter), 'ig'), m => `<span class="highlight">${m}</span>`);
      btn.innerHTML = `<b>${labelHTML}</b>`;
      btn.addEventListener('click', async ()=>{
        await loadFile(it.value);
        closePicker();
      });
      sec.appendChild(btn);
      total++;
    });

    els.pickerList.appendChild(sec);
  });

  if (!total){
    els.pickerList.innerHTML = '<div class="placeholder" style="margin:8px">Nada encontrado.</div>';
  }
}
function openPicker(){
  els.pickerSheet.hidden = false;
  els.pickerSheet.setAttribute('aria-hidden', 'false');
  els.pickerSearch.value = '';
  renderPicker('');
  document.addEventListener('keydown', onPickerKey);
}
function closePicker(){
  els.pickerSheet.hidden = true;
  els.pickerSheet.setAttribute('aria-hidden', 'true');
  document.removeEventListener('keydown', onPickerKey);
}
function onPickerKey(e){
  if (e.key === 'Escape') closePicker();
}
els.openPicker.addEventListener('click', openPicker);
els.pickerSheet.addEventListener('click', e=>{
  if (e.target.closest('[data-close]')) closePicker();
});
els.pickerSearch.addEventListener('input', e=> renderPicker(e.target.value));

/* =============== IA: construir prompt do artigo em foco =============== */
function buildPrompt(a){
  const split = a._split || splitBlockSupraTitleBody(a.text);
  const supraText = split.supra && split.supra.length ? split.supra.join('\n') + '\n' : '';
  const artigo = (split.titleText ? split.titleText + ' ' : '') + (split.body || '');
  const tema = split.titleText || (a.title || 'Artigo');
  return [
    'Assuma a persona de um professor de Direito experiente convidado pelo direito.love e gere um material de estudo. ',
    'Explique detalhadamente todo o artigo abaixo (caput, parÃ¡grafos, incisos e alÃ­neas), cobrindo: ',
    '(1) conceito com padrÃ£o acadÃªmico (doutrina e jurisprudÃªncia majoritÃ¡ria); ',
    '(2) mini exemplo prÃ¡tico; (3) checklist; (4) princÃ­pios relacionados; ',
    '(5) pontos de atenÃ§Ã£o na prÃ¡tica; (6) erros comuns/pegadinhas; (7) notas comparativas. ',
    'Responda em portuguÃªs claro, objetivo e didÃ¡tico.\n\n',
    `Tema: "${tema}"\n\n`,
    supraText + artigo,
    '\n\nðŸ’š direito.love'
  ].join('');
}
function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; }
function openIA(url){
  showToast('Abrindoâ€¦');
  if (isStandalone()) location.href = url;
  else window.open(url, '_blank', 'noopener,noreferrer');
}
document.querySelectorAll('.ia-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> openIA(btn.dataset.url));
});
function openModal(title){
  els.modalTitle.textContent = `Estude o ${title} com I.A.`;
  els.modalBackdrop.style.display = 'flex';
  els.modalBackdrop.setAttribute('aria-hidden','false');
  els.modalBackdrop.querySelector('.ia-btn')?.focus();
}
function closeModal(){ els.modalBackdrop.style.display = 'none'; els.modalBackdrop.setAttribute('aria-hidden','true'); }
els.closeModal.addEventListener('click', closeModal);
els.modalBackdrop.addEventListener('click', (e)=>{ if (e.target === els.modalBackdrop) closeModal(); });
document.addEventListener('keydown', (e)=>{ if (els.modalBackdrop.style.display === 'flex' && e.key === 'Escape') closeModal(); });

els.studyBtn.addEventListener('click', async ()=>{
  if (state.currentMode !== 'file' || !state.articles.length){
    showToast('Abra um cÃ³digo para estudar.');
    return;
  }
  const idx = state.currentArticleIdx >= 0 ? state.currentArticleIdx : 0;
  const a = state.articles[idx] || state.articles[0];
  document.querySelectorAll('article.highlight-study').forEach(n=>n.classList.remove('highlight-study'));
  document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('highlight-study');

  const prompt = buildPrompt(a);
  try{ await navigator.clipboard.writeText(prompt); showToast('âœ… Prompt copiado!'); }
  catch{ showToast('Copie manualmente no prÃ³ximo passo.'); }

  const title = (a._split?.titleText) || a.title || 'Artigo';
  openModal(title);
});

/* =============== Controles da busca e navegaÃ§Ã£o =============== */
els.doSearchBtn.addEventListener('click', async ()=>{
  if (state.globalOn) await runGlobalSearch();
  else await runLocalSearch();
});
els.searchInput.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter'){ e.preventDefault(); els.doSearchBtn.click(); }
  else if (e.key === 'Escape'){ e.preventDefault(); resetAll(); }
});
els.nextBtn.addEventListener('click', ()=>{
  if (!state.matchNodes.length) return;
  state.matchIdx = (state.matchIdx + 1) % state.matchNodes.length;
  const m = state.matchNodes[state.matchIdx];
  m.scrollIntoView({behavior:'smooth',block:'center'});
  updateCount();
});
els.prevBtn.addEventListener('click', ()=>{
  if (!state.matchNodes.length) return;
  state.matchIdx = (state.matchIdx - 1 + state.matchNodes.length) % state.matchNodes.length;
  const m = state.matchNodes[state.matchIdx];
  m.scrollIntoView({behavior:'smooth',block:'center'});
  updateCount();
});
els.globalToggle.addEventListener('click', ()=>{
  state.globalOn = !state.globalOn;
  els.globalToggle.setAttribute('aria-pressed', String(state.globalOn));
  els.globalToggle.textContent = 'Buscar Global: ' + (state.globalOn ? 'ON' : 'OFF');
  if (!state.globalOn && state.currentMode === 'global'){
    // saiu do global â†’ volta a mostrar arquivo aberto (se houver)
    if (state.currentFileUrl){
      state.currentMode = 'file';
      renderArticles(state.articles, {globalMode:false});
    } else {
      resetAll();
    }
  }
});
els.resetBtn.addEventListener('click', resetAll);
els.brandBtn.addEventListener('click', resetAll);

/* =============== Reset inicial =============== */
function resetAll(){
  // estado
  state.currentFileUrl = null;
  state.currentFileLabel = 'Escolher cÃ³digo';
  state.rawText = '';
  state.articles = [];
  state.currentArticleIdx = -1;
  state.currentList = [];
  state.currentMode = 'idle';
  state.currentTokens = [];

  // busca
  state.matchNodes = [];
  state.matchIdx = -1;
  els.searchInput.value = '';
  updateCount();

  // UI
  setFileIndicator('Escolher cÃ³digo');
  els.globalToggle.setAttribute('aria-pressed','false');
  els.globalToggle.textContent = 'Buscar Global: OFF';
  state.globalOn = false;

  els.articles.innerHTML = `
    <div class="placeholder">
      <p>
        ðŸ’š<br> Bem-vindo ao <strong>Direito.Love</strong><br>
        O <em>Mini Vade Mecum Digital</em> que tambÃ©m te auxilia nos estudos com <strong>I.A.</strong>
        <br><br>ðŸ˜Ž <br><strong>Use o menu na parte inferior</strong> para comeÃ§ar. <br>Bons estudos!
      </p>
    </div>`;

  // barras sempre visÃ­veis
  els.bottomInfo.hidden = false;
  els.bottomSearch.hidden = false;
  els.bottomStudy.hidden = false;

  window.scrollTo({top:0,behavior:'instant'});
}

/* =============== Boot =============== */
document.addEventListener('DOMContentLoaded', ()=>{
  buildCatalogMaps();
  setFileIndicator('Escolher cÃ³digo');
  resetAll(); // inicia jÃ¡ com as barras visÃ­veis + mensagem central
});
</script>
