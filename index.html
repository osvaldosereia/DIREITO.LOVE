<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>direito.love â€” Leitor jurÃ­dico</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#142B6F">
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root{
  /* Cores */
  --white:#FFFFFF;
  --navy:#142B6F;
  --yellow:#FFD601;
  --muted:#5f6470;

  /* Fundo do site */
  --bg:#f4f6f8;     /* cinza muito claro para diferenciar do branco */
  --fg:#101418;

  /* Barras base */
  --bar-info-bg:#e0e3e9; /* barra info mais marcada */
  --bar-bg:#ffffff;      /* barra busca neutra branca */
  --bar-bg-2:#142B6F;    /* barra estudo azul navy forte */

  /* DimensÃµes */
  --topbar-h: 64px;
  --progress-h: 6px;
  --bottom-info-h: 56px;
  --bottom-search-h: 56px;
  --bottom-study-h: 64px;

  /* UI */
  --focus:#9bb6ff;
  --radius:12px;
  --shadow:0 2px 10px rgba(0,0,0,.06);
  --accent: rgba(255,214,1,.2);
}


    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      background:var(--bg); color:var(--fg);
      font:15px/1.58 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      max-width:100%; overflow-x:hidden;
    }
    button,input,select{font:inherit}

    /* Topo â€” logo centralizada */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:var(--topbar-h);
      display:flex; align-items:center; justify-content:center;
      background:var(--navy); color:#fff; z-index:100; box-shadow:var(--shadow);
    }
    .topbar-inner{
      width:clamp(320px, 92vw, 960px);
      padding:0 12px; display:flex; align-items:center; justify-content:center;
    }
    .brand{
      height:42px; width:auto; object-fit:contain; display:block; cursor:pointer;
    }
    .brand:focus{outline:2px solid #fff; outline-offset:2px}

    /* Barra de progresso (busca) */
    .progress{
      position:fixed; top:var(--topbar-h); left:0; right:0; height:var(--progress-h); z-index:95;
      background:transparent;
    }
    .progress .bar{
      height:100%; width:0%; background:linear-gradient(90deg, #FFD601, #E1DEE6);
      transition:width .2s ease;
    }
    .progress[hidden]{display:none}

    /* ConteÃºdo */
    .content{
      position:relative;
      padding: calc(var(--topbar-h) + var(--progress-h) + 14px) 0 calc(var(--bottom-info-h) + var(--bottom-search-h) + var(--bottom-study-h) + 24px);
      min-height:100dvh;
    }
    .container{ width:clamp(320px, 92vw, 960px); margin:0 auto; padding:0 12px }
    .placeholder{
      padding:24px; border:1px dashed #dcdfea; border-radius:var(--radius);
      color:var(--muted); background:#fafbff; text-align:center;
    }
    .placeholder p{ font-size:1.08rem; line-height:1.65; margin:0 }

    /* Artigos / Blocos (mantidos para quando carregar o texto) */
    article{
      white-space:pre-wrap; border-bottom:1px solid #eef0f6;
      padding:18px 10px; scroll-margin: 92px; border-radius:10px;
      overflow-wrap:anywhere; word-break:break-word; hyphens:auto; max-width:100%;
    }
    .supra{ color:#6c7282; font-weight:600; font-size:12px; margin-bottom:6px; }
    .supra div{ line-height:1.35 }
    .art-title{ display:block; font-weight:800; color:#0e1638; margin:0 0 6px; font-size:13px }
    .art-body { font-size: 14px; line-height: 1.6; }
    article.current-outline{ outline:3px solid #7aa8ff; outline-offset:2px; }
    article.highlight-study{ background:var(--accent) }
    mark{padding:0 2px; border-radius:3px; background:#ffef99}

    /* ===== Base â€” Barra INFO (seletor + toggle global) ===== */
.bottom-info{
  position:fixed; left:0; right:0; bottom:calc(var(--bottom-search-h) + var(--bottom-study-h));
  height:var(--bottom-info-h);
  background:var(--bar-info-bg);   /* cinza mÃ©dio */
  border-top:2px solid #c9cdd6;    /* borda mais visÃ­vel */
  z-index:72; display:flex; align-items:center; justify-content:center;
}
    .bottom-info-inner{
      width:clamp(320px, 92vw, 960px);
      display:flex; align-items:center; gap:8px; padding:6px 12px;
    }
    .file-indicator{
      flex:1 1 auto; min-width:0; max-width:75%;
      font-size:13px; color:#6c7282; background:#fff; border:1px solid #e2e5f2;
      padding:8px 12px; border-radius:10px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; cursor:pointer;
    }
    .global-toggle{
      flex:0 0 auto; padding:10px 14px; border-radius:10px; border:1px solid #dfe3ef;
      background:#fff; cursor:pointer; font-weight:800;
    }
    .global-toggle[aria-pressed="true"]{ background:#eaf3ff; border-color:#b9cffb; }

    /* ===== Base â€” Barra 1 (BUSCA) ===== */
.bottom-search{
  position:fixed; left:0; right:0; bottom:var(--bottom-study-h);
  height:var(--bottom-search-h);
  background:var(--bar-bg);        /* branco puro */
  border-top:2px solid #d9dde6;    /* separador */
  z-index:70; display:flex; align-items:center; justify-content:center;
}
    .bottom-search-inner{
      width:clamp(320px, 92vw, 960px);
      display:flex; align-items:center; gap:8px; padding:8px 12px;
    }
    .iconbtn{
  width:34px;
  height:34px;
  border:1px solid #cfd4e2;
  background:#fff;
  border-radius:8px;
  display:grid;
  place-items:center;
  cursor:pointer;
  user-select:none;
  flex:0 0 34px;
  font-size:16px;
  line-height:1;
  transition: background .2s, border .2s, transform .1s;
}
.iconbtn:hover{
  background:#f7f8fc;
  border-color:#9bb6ff;
  transform:translateY(-1px);
}
.iconbtn.danger{
  border-color:#f5b5b5;
  color:#a33;
}
.iconbtn:focus{
  outline:2px solid var(--focus);
  outline-offset:2px;
}

    .search{flex:1; display:flex; align-items:center; gap:8px; min-width:0}
    .search input{
  width:100%;
  height:36px;
  border:1px solid #cfd4e2;
  border-radius:10px;
  padding:0 12px;
  background:#fff;
  flex:1 1 auto;
  min-width:0;
  box-shadow:0 1px 2px rgba(0,0,0,.05);
  transition:border .2s, box-shadow .2s;
}
.search input:focus{
  border-color:#9bb6ff;
  box-shadow:0 0 0 3px rgba(155,182,255,.35);
  outline:none;
}

    .spinner{width:18px; height:18px; border:2px solid #e2e5f2; border-top-color:#142B6F; border-radius:50%;
      animation:spin 1s linear infinite; flex:0 0 18px}
    .spinner[hidden]{display:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    .result-count{
      min-width:68px; font-size:12px; color:#6c7282; border:1px solid #e2e5f2;
      background:#f7f8fc; padding:6px 10px; border-radius:8px; text-align:center;
    }

   /* ===== Base â€” Barra 2 (ESTUDAR / BUSCAR) ===== */
.bottom-study{
  position:fixed; left:0; right:0; bottom:0; height:var(--bottom-study-h);
  background:var(--bar-bg-2);      /* azul navy forte */
  border-top:2px solid #0a1c4a;    /* borda no mesmo tom */
  z-index:75; display:flex; align-items:center; justify-content:center; padding:8px 0;
}
    .bottom-study-inner{
      width:clamp(320px, 92vw, 960px); padding:0 12px; display:flex; align-items:center; gap:12px;
    }
    .study,.do-search{
  flex:1 1 0; padding:12px 16px; border-radius:12px; font-weight:800; cursor:pointer;
  transition: background .2s, color .2s, transform .1s;
}
.study{
  border:1px solid #FFD601;
  background:#FFD601;
  color:#0a0a0a; /* texto escuro sobre amarelo */
}
.study:hover{ background:#ffe84a; transform:translateY(-1px); }

.do-search{
  border:1px solid #fff;
  background:#fff;
  color:#142B6F; /* texto azul sobre fundo branco */
}
.do-search:hover{ background:#f7f8fc; transform:translateY(-1px); }


    /* Modal IA */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:center; justify-content:center; z-index:100}
    .modal{
      background:#fff; border-radius:16px; width:min(640px, 92vw); padding:18px; border:1px solid #eceef7; box-shadow: var(--shadow)
    }
    .modal h3{margin:0 0 8px; color:#0f173a}
    .modal .subtitle{margin:0 0 14px; font-size:13px; color:#3a7f48}
    .ia-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .ia-btn{
      display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #e6e8f2; background:#f6f7fb;
      border-radius:12px; cursor:pointer; text-decoration:none; color:#111; font-weight:700; justify-content:center;
    }
    .ia-btn:focus{outline:2px solid var(--focus); outline-offset:2px}
    .modal .foot{margin-top:12px; display:flex; justify-content:flex-end}
    .modal .close-btn{padding:8px 12px; border:1px solid #e2e5f2; background:#fff; border-radius:10px; cursor:pointer}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(var(--bottom-study-h) + var(--bottom-search-h) + 14px);
      background:#111; color:#fff; padding:8px 12px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .2s; z-index:200
    }
    .toast.show{opacity:1}

    /* Sheet (seletor mobile) */
    .sheet{ position:fixed; inset:0; z-index:120; }
    .sheet[hidden]{ display:none; }
    .sheet-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.32); }
    .sheet-panel{
      position:absolute; left:0; right:0; bottom:0;
      background:#fff; border-radius:16px 16px 0 0;
      max-height:80vh; display:flex; flex-direction:column;
      padding-bottom:max(8px, env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.12);
    }
    .sheet-head{ display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border-bottom:1px solid #eceef2; }
    .sheet-title{ color:#0e1638; font-weight:800; }
    .sheet-close{
      width:32px; height:32px; border:1px solid #e2e5f2; background:#fff;
      border-radius:10px; display:grid; place-items:center; cursor:pointer;
    }
    .sheet-search{ padding:10px 16px; }
    .sheet-search input{
  width:100%;
  height:38px;
  border:1px solid #cfd4e2;
  border-radius:10px;
  padding:0 12px;
  background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.05);
  transition:border .2s, box-shadow .2s;
}
.sheet-search input:focus{
  border-color:#9bb6ff;
  box-shadow:0 0 0 3px rgba(155,182,255,.35);
  outline:none;
}

    .sheet-body{ overflow:auto; padding:8px 12px 12px; }
    .list-section{ padding:6px 0; }
    .list-section h4{
      font-size:12px; letter-spacing:.4px; font-weight:800; color:#6c7282;
      margin:6px 2px 4px; text-transform:uppercase;
    }
    .item{
      width:100%; text-align:left; cursor:pointer;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:10px; margin:6px 0;
      border:1px solid #eceff4; background:#f9fafc;
    }
    .item b{ font-weight:800; color:#0e1638; }
    .item small{ color:#6c7282; }
    .item:hover, .item:focus{ outline:2px solid var(--focus); outline-offset:2px; }
    .highlight{ background:#ffef99; border-radius:3px; }

    /* Responsivo (sem seletor no topo) */
    .select-wrap, #codeSelect{ display:none !important; }
    @media (max-width: 768px){
      .brand{ height:38px; }
    }
  </style>
</head>
<body>

  <!-- TOPO COM LOGO CENTRALIZADA -->
  <header class="topbar">
    <div class="topbar-inner">
      <img src="icons/logo.png" alt="direito.love" class="brand" id="brandBtn" title="Clique para reiniciar">
    </div>
  </header>

  <!-- PROGRESS BAR -->
  <div class="progress" id="progress" hidden>
    <div class="bar" id="progressBar"></div>
  </div>

  <!-- CONTEÃšDO -->
  <main class="content">
    <div class="container">
      <div class="articles" id="articles">
        <div class="placeholder">
          <p>
            ðŸ’š<br> Bem-vindo ao <strong>Direito.Love</strong><br>
            O <em>Mini Vade Mecum Digital</em> que tambÃ©m te auxilia nos estudos com <strong>I.A.</strong>
            <br><br>ðŸ˜Ž <br><strong>Use o menu na parte inferior</strong> para comeÃ§ar. <br>Bons estudos!
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- CATÃLOGO OCULTO (fonte dos arquivos para o seletor da base) -->
  <select id="codeSelect" title="Escolher arquivo" style="display:none">
    <option value="">â€” selecione â€”</option>

    <optgroup label="CF88">
      <option value="data/CF88/CF88.txt">ConstituiÃ§Ã£o Federal 1988</option>
    </optgroup>

    <optgroup label="CÃ³digos">
      <option value="data/codigos/codigo_civil.txt">CÃ³digo Civil</option>
      <option value="data/codigos/codigo_processo_civil.txt">CÃ³digo de Processo Civil</option>
      <option value="data/codigos/codigo_penal.txt">CÃ³digo Penal</option>
      <option value="data/codigos/codigo_processo_penal.txt">CÃ³digo de Processo Penal</option>
      <option value="data/codigos/codigo_consumidor.txt">CÃ³digo de Defesa do Consumidor</option>
      <option value="data/codigos/codigo_clt.txt">CLT - ConsolidaÃ§Ã£o das Leis do Trabalho</option>
      <option value="data/codigos/codigo_tributario_nacional.txt">CÃ³digo TributÃ¡rio Nacional</option>
    </optgroup>

    <optgroup label="Leis">
      <option value="data/leis/lei_maria_da_penha.txt">Lei Maria da Penha</option>
      <option value="data/leis/lei_de_execucao_penal.txt">Lei de ExecuÃ§Ã£o Penal</option>
      <option value="data/leis/lei_de_drogas.txt">Lei de Drogas</option>
      <option value="data/leis/lei_lgpd.txt">Lei LGPD</option>
      <option value="data/leis/marco_civil_da_internet.txt">Marco Civil da Internet</option>
      <option value="data/leis/crimes_hediondos.txt">Lei dos Crimes Hediondos</option>
    </optgroup>

    <optgroup label="Estatutos">
      <option value="data/estatutos/eca.txt">ECA - Estatuto da CrianÃ§a e Adolescente</option>
      <option value="data/estatutos/estatuto_do_desarmamento.txt">Estatuto do Desarmamento</option>
      <option value="data/estatutos/estatuto_do_idoso.txt">Estatuto do Idoso</option>
      <option value="data/estatutos/estatuto_da_juventude.txt">Estatuto da Juventude</option>
      <option value="data/estatutos/estatuto_da_pessoa_com_deficiencia.txt">Estatuto da Pessoa com DeficiÃªncia</option>
    </optgroup>

    <optgroup label="SÃºmulas">
      <option value="data/sumulas/sumulas_stj.txt">SÃºmulas do STJ</option>
      <option value="data/sumulas/sumulas_stf.txt">SÃºmulas do STF</option>
    </optgroup>

    <optgroup label="PrincÃ­pios">
      <option value="data/principios/principios_do_direito.txt">PrincÃ­pios (Rol Exemplificativo)</option>
    </optgroup>
  </select>

  <!-- BARRA INFORMATIVA (seletor + toggle da busca global) -->
  <div class="bottom-info" id="bottomInfo">
    <div class="bottom-info-inner">
      <!-- Abre o mesmo modal (sheet) do seletor -->
      <button class="file-indicator" id="openPicker" type="button" aria-haspopup="dialog" aria-controls="pickerSheet" title="Escolher cÃ³digo">
        <span id="fileIndicator">Escolher cÃ³digo</span>
      </button>
      <!-- Alterna Busca Global -->
      <button class="global-toggle" id="globalToggle" type="button" aria-pressed="false" title="Ativar/Desativar busca em todos os cÃ³digos">
        Buscar Global: OFF
      </button>
    </div>
  </div>

  <!-- BARRA 1: BUSCA -->
  <div class="bottom-search" id="bottomSearch">
    <div class="bottom-search-inner" aria-live="polite">
      <button class="iconbtn" id="prevBtn" title="Anterior" aria-label="Anterior">â—€</button>
      <button class="iconbtn" id="nextBtn" title="PrÃ³ximo" aria-label="PrÃ³ximo">â–¶</button>
      <div class="search">
        <input id="searchInput" type="search" placeholder="Buscar no textoâ€¦" autocomplete="off" />
        <div class="spinner" id="spinner" hidden></div>
      </div>
      <div class="result-count" title="OcorrÃªncia atual / Total"><span id="count">0/0</span></div>
      <button class="iconbtn danger" id="resetBtn" title="Reiniciar" aria-label="Reiniciar">âœ•</button>
    </div>
  </div>

  <!-- BARRA 2: ESTUDAR -->
  <div class="bottom-study" id="bottomStudy">
    <div class="bottom-study-inner">
      <button class="study" id="studyBtn">Estude com I.A.</button>
      <button class="do-search" id="doSearchBtn">Buscar</button>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast">âœ… Prompt copiado!</div>

  <!-- MODAL DE I.A. -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Prompt copiado!</h3>
      <p class="subtitle">âœ… Prompt pronto! Escolha uma IA e cole para estudar:</p>
      <div class="ia-grid">
        <button class="ia-btn" data-url="https://chat.openai.com/">ðŸ’¬ ChatGPT</button>
        <button class="ia-btn" data-url="https://gemini.google.com/app">ðŸ§  Gemini</button>
        <button class="ia-btn" data-url="https://copilot.microsoft.com/">âœ¨ Copilot</button>
        <button class="ia-btn" data-url="https://www.perplexity.ai/">ðŸ”Ž Perplexity</button>
      </div>
      <div class="foot">
        <button class="close-btn" id="closeModal">Fechar</button>
      </div>
    </div>
  </div>

  <!-- MODAL SELECTOR (SHEET) -->
  <div id="pickerSheet" class="sheet" hidden aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-panel" role="document">
      <div class="sheet-head">
        <strong class="sheet-title">Escolher cÃ³digo</strong>
        <button class="sheet-close" type="button" data-close aria-label="Fechar">âœ•</button>
      </div>
      <div class="sheet-search">
        <input id="pickerSearch" type="search" placeholder="Buscarâ€¦" autocomplete="off" />
      </div>
      <div class="sheet-body" id="pickerList" aria-live="polite"></div>
    </div>
  </div>
/* =============== Refs =============== */
const els = {
  // topo / status
  brandBtn: document.getElementById('brandBtn'),
  progress: document.getElementById('progress'),
  progressBar: document.getElementById('progressBar'),

  // containers
  articles: document.getElementById('articles'),

  // barras base
  bottomInfo: document.getElementById('bottomInfo'),
  bottomSearch: document.getElementById('bottomSearch'),
  bottomStudy: document.getElementById('bottomStudy'),

  // barra info (seletor + toggle)
  openPicker: document.getElementById('openPicker'),
  fileIndicator: document.getElementById('fileIndicator'),
  globalToggle: document.getElementById('globalToggle'),

  // barra busca
  searchInput: document.getElementById('searchInput'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  spinner: document.getElementById('spinner'),
  count: document.getElementById('count'),
  doSearchBtn: document.getElementById('doSearchBtn'),
  resetBtn: document.getElementById('resetBtn'),

  // barra estudo
  studyBtn: document.getElementById('studyBtn'),

  // modal prompt
  modalBackdrop: document.getElementById('modalBackdrop'),
  modalTitle: document.getElementById('modalTitle'),
  closeModal: document.getElementById('closeModal'),
  toast: document.getElementById('toast'),

  // sheet seletor
  codeSelect: document.getElementById('codeSelect'),
  pickerSheet: document.getElementById('pickerSheet'),
  pickerSearch: document.getElementById('pickerSearch'),
  pickerList: document.getElementById('pickerList'),
};

/* =============== Estado =============== */
const state = {
  // arquivo atual (modo leitura do arquivo)
  currentFileUrl: null,
  currentFileLabel: 'Escolher cÃ³digo',
  rawText: '',
  articles: [],              // lista renderizada do arquivo atual (para modo normal)
  currentArticleIdx: -1,

  // render atual
  currentMode: 'idle',       // 'idle' | 'file' | 'global'
  currentList: [],           // lista atualmente renderizada (arquivo completo OU resultados globais)
  currentTokens: [],         // termos usados na Ãºltima marcaÃ§Ã£o

  // busca / navegaÃ§Ã£o
  matchNodes: [],
  matchIdx: -1,

  // progresso
  progressTimer: null,

  // global
  globalOn: false,
  cache: new Map(),          // url -> texto limpo
  urlToLabel: new Map(),     // url -> label
};

/* =============== Utilidades UI =============== */
function showToast(msg='âœ… Pronto!'){
  els.toast.textContent = msg;
  els.toast.classList.add('show');
  setTimeout(()=> els.toast.classList.remove('show'), 1000);
}
function setProgressActive(active){
  if (active){
    els.progress.hidden = false;
    els.progressBar.style.width = '0%';
    let p = 0;
    clearInterval(state.progressTimer);
    state.progressTimer = setInterval(()=>{
      p = Math.min(85, p + 8 + Math.random()*7);
      els.progressBar.style.width = p + '%';
    }, 180);
  } else {
    clearInterval(state.progressTimer);
    els.progressBar.style.width = '100%';
    setTimeout(()=>{ els.progress.hidden = true; els.progressBar.style.width = '0%'; }, 240);
  }
}
function setBusy(isBusy){
  els.bottomSearch.setAttribute('aria-busy', String(isBusy));
  els.doSearchBtn.disabled = isBusy;
  els.prevBtn.disabled = isBusy;
  els.nextBtn.disabled = isBusy;
  els.spinner.hidden = !isBusy;
  setProgressActive(isBusy);
}
function updateCount(){
  if (!state.matchNodes.length){ els.count.textContent = '0/0'; return; }
  els.count.textContent = `${state.matchIdx+1}/${state.matchNodes.length}`;
}
function setFileIndicator(label){
  const full = (label || 'Escolher cÃ³digo').trim();
  els.fileIndicator.textContent = full;
  els.openPicker.title = full;
}

/* =============== NormalizaÃ§Ã£o / Parser =============== */
const sanitizeForLayout = (s)=> s
  .replace(/\u00A0/g, ' ')
  .replace(/\t/g, ' ')
  .replace(/\s+\n/g, '\n');

function normalizeWithMap(s){
  let norm = '';
  const map = [];
  for (let i=0;i<s.length;i++){
    const de = s[i].normalize('NFD');
    for (let k=0;k<de.length;k++){
      const c = de[k];
      const code = c.codePointAt(0);
      if (code>=0x0300 && code<=0x036F) continue;
      norm += c.toLowerCase();
      map.push(i);
    }
  }
  return {norm, map};
}
const normalizeTerm = (s)=> (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

function findRanges(raw, term){
  if (!term) return [];
  const {norm, map} = normalizeWithMap(raw);
  const needle = normalizeTerm(term);
  if (!needle) return [];
  const out = [];
  let from = 0;
  while(true){
    const pos = norm.indexOf(needle, from);
    if (pos === -1) break;
    const s = map[pos];
    const e = map[pos + needle.length - 1] + 1;
    out.push([s,e]);
    from = pos + needle.length;
  }
  return out;
}
function mergeRanges(ranges){
  if (!ranges.length) return [];
  ranges.sort((a,b)=> a[0]-b[0]);
  const out = [ranges[0].slice()];
  for (let i=1;i<ranges.length;i++){
    const [s,e] = ranges[i];
    const last = out[out.length-1];
    if (s <= last[1]) last[1] = Math.max(last[1], e);
    else out.push([s,e]);
  }
  return out;
}
function findRangesMulti(raw, tokens){
  let all = [];
  for (const t of tokens){
    const r = findRanges(raw, t);
    if (r.length) all = all.concat(r);
  }
  return mergeRanges(all);
}
function highlightElementByRanges(el, ranges){
  if (!ranges.length) return;
  const raw = el.textContent;
  let out = '', last = 0;
  for (const [s,e] of ranges){
    out += escapeHtml(raw.slice(last, s));
    out += '<mark>' + escapeHtml(raw.slice(s, e)) + '</mark>';
    last = e;
  }
  out += escapeHtml(raw.slice(last));
  el.innerHTML = out;
}
const escapeHtml = (s)=> s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

/* ======= Parse de blocos ======= */
function splitBlockSupraTitleBody(raw){
  const lines = raw.replace(/^\s+|\s+$/g,'').split(/\r?\n/);
  const artIdx = lines.findIndex(line =>
    /^\s*(?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:Âº|o)?\.?/.test(line)
  );

  if (artIdx >= 0){
    const supra = lines.slice(0, artIdx).map(s=>s.trim()).filter(Boolean);
    const titleLine = lines[artIdx];

    const mt = titleLine.match(/^\s*((?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:Âº|o)?\.?)/);
    let titleText = mt ? mt[1].trim() : titleLine.trim();

    // Normaliza 10-A â†’ 10A
    titleText = titleText.replace(/(\d+)-?([A-Z])/, "$1$2");

    const afterTitle = titleLine.slice(mt ? mt[1].length : 0).trimStart();
    const rest = lines.slice(artIdx+1).join('\n').trimStart();
    const body = afterTitle ? (rest ? afterTitle + '\n' + rest : afterTitle) : rest;

    return { supra, titleText, body };
  } else {
    const titleText = (lines[0]||'').trim();
    const body = lines.slice(1).join('\n').trimStart();
    return { supra:[], titleText, body };
  }
}
function parseByDelimiters(txt){
  const sepRe = /(^|\n)[^\S\r\n]*-{5,}[^\S\r\n]*(?=\n|$)/g;
  const seps = [];
  let m;
  while ((m = sepRe.exec(txt)) !== null) {
    const idx = m.index + (m[0].startsWith('\n') ? 1 : 0);
    seps.push(idx);
  }
  if (seps.length < 2) return [];
  const arts = [];
  for (let i = 0; i + 1 < seps.length; i += 1) {
    const startLineEnd = txt.indexOf('\n', seps[i]);
    const from = (startLineEnd === -1) ? txt.length : startLineEnd + 1;
    const to = seps[i + 1];
    if (from >= to) continue;
    const raw = txt.slice(from, to).trim();
    if (!raw) continue;
    const split = splitBlockSupraTitleBody(raw);
    const title = split.titleText || `Bloco ${arts.length + 1}`;
    arts.push({ title, text: raw, htmlId: `art-${arts.length}`, _split: split });
  }
  return arts;
}
function parseByArt(txt){
  const re = /(^|\n)\s*((?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:Âº|o)?\.?)/g;
  const starts = [];
  let m;
  while ((m = re.exec(txt)) !== null) {
    const idxArt = re.lastIndex - m[2].length;
    starts.push(idxArt);
  }
  if (!starts.length) return [{
    title:'Texto',
    text: txt.trim(),
    htmlId:'art-0',
    _split: splitBlockSupraTitleBody(txt.trim())
  }];

  const arts = [];
  for (let i = 0; i < starts.length; i++) {
    const from = starts[i];
    const to   = (i + 1 < starts.length) ? starts[i + 1] : txt.length;
    let chunk = txt.slice(from, to).trimEnd();

    // corta em ponto final/fecha parÃªntese
    const endDot = chunk.lastIndexOf('.');
    const endPar = chunk.lastIndexOf(')');
    const end    = Math.max(endDot, endPar);
    if (end !== -1) chunk = chunk.slice(0, end + 1).trimEnd();

    const split = splitBlockSupraTitleBody(chunk);
    const title = split.titleText || chunk.split('\n')[0].slice(0,40);
    arts.push({ title, text: chunk, htmlId: `art-${i}`, _split: split });
  }
  return arts;
}
function parseSumulas(txt){
  const cleaned = sanitizeForLayout(txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'));
  const parts = cleaned.split(/^\s*-{5,}\s*$/m).map(s => s.trim()).filter(Boolean);
  const out = [];
  parts.forEach((block, i)=>{
    const lines = block.split('\n').map(l=>l.trim());
    const header = (lines.shift() || 'SÃºmula').trim(); // "SÃºmula 736 - STF"
    const body = lines.join('\n').trim();
    out.push({
      title: header,
      text: header + (body ? '\n' + body : ''),
      htmlId: `sumula-${i}`,
      _split: { supra: [], titleText: header, body }
    });
  });
  return out;
}
function parsePrincipios(txt){
  const cleaned = sanitizeForLayout(txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'));
  const parts = cleaned.split(/^\s*-{5,}\s*$/m).map(s => s.trim()).filter(Boolean);
  const out = [];
  parts.forEach((block, i)=>{
    const lines = block.split('\n').map(l=>l.trim());
    let header = (lines.shift() || 'PrincÃ­pio').trim();
    const reHeader = /^\s*Princ[iÃ­]pio\b/i;
    if (!reHeader.test(header)){
      if (lines.length && reHeader.test(lines[0])) header = lines.shift();
      else header = 'PrincÃ­pio';
    }
    const body = lines.join('\n').trim();
    out.push({
      title: header,
      text: header + (body ? '\n' + body : ''),
      htmlId: `principio-${i}`,
      _split: { supra: [], titleText: header, body }
    });
  });
  return out;
}
function parseByUrl(url, txt){
  const isSumulas = /(^|\/)data\/sumulas\/?/i.test(url);
  const isPrincipios = /(^|\/)data\/principios\/?/i.test(url);
  return isSumulas ? parseSumulas(txt)
       : isPrincipios ? parsePrincipios(txt)
       : (parseByDelimiters(txt).length ? parseByDelimiters(txt) : parseByArt(txt));
}

/* =============== RenderizaÃ§Ã£o =============== */
function renderArticles(list, {globalMode=false}={}){
  const frag = document.createDocumentFragment();
  list.forEach((a, i)=>{
    const el = document.createElement('article');
    el.dataset.idx = i;
    el.id = a.htmlId || `art-${i}`;

    const split = a._split || splitBlockSupraTitleBody(a.text);

    // Supra + badge de arquivo (somente no modo global)
    const supraWrap = document.createElement('div');
    supraWrap.className = 'supra';

    if (globalMode && a._fileLabel){
      const badge = document.createElement('div');
      badge.textContent = `[${a._fileLabel}]`;
      supraWrap.appendChild(badge);
    }
    if (split.supra && split.supra.length){
      split.supra.forEach(line=>{
        const d = document.createElement('div');
        d.textContent = line;
        supraWrap.appendChild(d);
      });
    }
    if (supraWrap.childNodes.length){ el.appendChild(supraWrap); }

    const titleSpan = document.createElement('span');
    titleSpan.className = 'art-title';
    titleSpan.textContent = split.titleText || a.title || 'Artigo';
    el.appendChild(titleSpan);

    const content = document.createElement('div');
    content.className = 'art-body';
    content.textContent = split.body || '';
    el.appendChild(content);

    frag.appendChild(el);
  });

  els.articles.innerHTML = '';
  if (list.length){
    els.articles.appendChild(frag);
  } else {
    els.articles.innerHTML = '<div class="placeholder"><p>ðŸ¤” Nenhum resultado com todos os termos. Tente variar as palavras.</p></div>';
  }

  // manter barras visÃ­veis
  els.bottomInfo.hidden = false;
  els.bottomSearch.hidden = false;
  els.bottomStudy.hidden = false;

  state.currentList = list;
  updateCurrentOutline();
  // limpa contagem
  state.matchNodes = [];
  state.matchIdx = -1;
  updateCount();
}
// ...cÃ³digo anterior...


/* =============== Scroll / Outline =============== */
function getArticleInView(){
  const nodes = document.querySelectorAll('article[data-idx]');
  const cy = window.innerHeight / 2;
  let hitIdx = -1;
  for (const el of nodes){
    const r = el.getBoundingClientRect();
    if (r.top <= cy && r.bottom >= cy){ hitIdx = Number(el.dataset.idx); break; }
  }
  if (hitIdx === -1 && nodes.length){
    for (const el of nodes){
      const r = el.getBoundingClientRect();
      if (r.bottom > 0 && r.top < window.innerHeight){ hitIdx = Number(el.dataset.idx); break; }
    }
  }
  return hitIdx;
}
function updateCurrentOutline(){
  const idx = getArticleInView();
  if (idx === state.currentArticleIdx) return;
  state.currentArticleIdx = idx;
  document.querySelectorAll('article.current-outline').forEach(n=>n.classList.remove('current-outline'));
  if (idx >= 0){
    document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('current-outline');
  }
}
window.addEventListener('scroll', ()=>{ if (state.currentList.length) updateCurrentOutline(); }, {passive:true});

/* =============== CatÃ¡logo (select oculto) =============== */
function buildCatalogMaps(){
  const sel = els.codeSelect;
  state.urlToLabel.clear();
  sel.querySelectorAll('option').forEach(opt=>{
    const url = opt.value?.trim();
    const label = opt.textContent?.trim();
    if (url) state.urlToLabel.set(url, label);
  });
}
function getGroupsFromSelect(){
  const sel = els.codeSelect;
  const groups = [];
  let current = null;
  sel.querySelectorAll('optgroup, option').forEach(node=>{
    if (node.tagName.toLowerCase()==='optgroup'){
      current = { label: node.label || '', items: [] };
      groups.push(current);
    } else if (node.tagName.toLowerCase()==='option'){
      const label = node.textContent.trim();
      const value = node.value;
      if (!label || !current) return;
      current.items.push({ label, value });
    }
  });
  return groups;
}

/* =============== Loader de arquivo =============== */
async function fetchTextCached(url){
  if (state.cache.has(url)) return state.cache.get(url);
  const res = await fetch(url, {cache: 'force-cache'});
  if (!res.ok) throw new Error(`HTTP ${res.status} â€” ${res.statusText}`);
  const txt = sanitizeForLayout(await res.text());
  state.cache.set(url, txt);
  return txt;
}
async function loadFile(url){
  if (!url) return;
  setBusy(true);
  try{
    const txt = await fetchTextCached(url);
    state.rawText = txt;
    const list = parseByUrl(url, txt);
    state.currentFileUrl = url;
    state.currentFileLabel = state.urlToLabel.get(url) || 'Documento';
    state.articles = list;
    state.currentMode = 'file';
    renderArticles(list, {globalMode:false});
    setFileIndicator(state.currentFileLabel);
    window.scrollTo({top:0,behavior:'instant'});
  }catch(err){
    console.error(err);
    els.articles.innerHTML = `<div class="placeholder"><p>Falha ao carregar:<br><code>${(err && err.message) || 'Erro desconhecido'}</code></p></div>`;
  }
  setBusy(false);
}

/* =============== Busca Local (arquivo atual) =============== */
async function runLocalSearch(){
  const q = els.searchInput.value.trim();
  if (!q) { clearMarksAndRerender(); return; }
  const tokens = q.split(/\s+/).filter(Boolean);
  state.currentTokens = tokens;
  await highlightTokensChunked(tokens);
}

/* =============== Busca Global (AND) â€” AGRUPADA POR ARQUIVO =============== */

// Renderer dos grupos (um bloco por arquivo)
function renderGlobalGroups(groups){
  const frag = document.createDocumentFragment();
  let runningIdx = 0;

  groups.forEach(g=>{
    // CabeÃ§alho do grupo (arquivo)
    const sec = document.createElement('section');
    const header = document.createElement('div');
    header.className = 'group-header';
    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:8px 10px;margin:10px 0 2px;border:1px solid #eceff4;background:#fafbff;border-radius:10px;';
    header.innerHTML = `
      <div style="font-weight:800;color:#0e1638;">
        ${g.fileLabel} <small style="font-weight:600;color:#6c7282">(${g.items.length})</small>
      </div>
      <button type="button" class="iconbtn open-doc" data-url="${g.fileUrl}" title="Abrir documento">â¤´</button>
    `;
    sec.appendChild(header);

    // Lista de cards (somente os que bateram)
    g.items.forEach((a, i)=>{
      const el = document.createElement('article');
      el.dataset.idx = runningIdx++;               // idx global para navegaÃ§Ã£o/outline
      el.id = a.htmlId || `g-${el.dataset.idx}`;

      const split = a._split || splitBlockSupraTitleBody(a.text);

      // supra (se houver)
      if (split.supra && split.supra.length){
        const supra = document.createElement('div');
        supra.className = 'supra';
        split.supra.forEach(line=>{
          const d = document.createElement('div');
          d.textContent = line;
          supra.appendChild(d);
        });
        el.appendChild(supra);
      }

      // tÃ­tulo
      const titleSpan = document.createElement('span');
      titleSpan.className = 'art-title';
      titleSpan.textContent = split.titleText || a.title || 'Artigo';
      el.appendChild(titleSpan);

      // corpo
      const content = document.createElement('div');
      content.className = 'art-body';
      content.textContent = split.body || '';
      el.appendChild(content);

      sec.appendChild(el);
    });

    frag.appendChild(sec);
  });

  els.articles.innerHTML = '';
  if (groups.length){
    els.articles.appendChild(frag);
  } else {
    els.articles.innerHTML = '<div class="placeholder"><p>ðŸ¤” Nenhum resultado com todos os termos. Tente variar as palavras.</p></div>';
  }

  // barras sempre visÃ­veis
  els.bottomInfo.hidden = false;
  els.bottomSearch.hidden = false;
  els.bottomStudy.hidden = false;

  // atualiza estado de render
  state.currentList = flattenGroups(groups); // versÃ£o achatada para destaque/contagem
  updateCurrentOutline();

  // listeners "Abrir documento" (troca para o arquivo correspondente)
  els.articles.querySelectorAll('.open-doc').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const url = btn.getAttribute('data-url');
      await loadFile(url);
      // ao abrir o arquivo, sai do modo global
      state.globalOn = false;
      els.globalToggle.setAttribute('aria-pressed','false');
      els.globalToggle.textContent = 'Buscar Global: OFF';
    });
  });

  // zera contagem de marcaÃ§Ãµes
  state.matchNodes = [];
  state.matchIdx = -1;
  updateCount();
}

// Helper: achata os grupos em uma lista linear (mantÃ©m ordem visual)
function flattenGroups(groups){
  const flat = [];
  groups.forEach(g => g.items.forEach(it => flat.push(it)));
  return flat;
}

// Nova busca global (AND entre palavras, agrupada por arquivo)
async function runGlobalSearch(){
  const q = els.searchInput.value.trim();
  const tokens = q.split(/\s+/).map(normalizeTerm).filter(Boolean);
  state.currentTokens = tokens;

  // sem termos â†’ volta para o arquivo atual (se houver) ou placeholder
  if (!tokens.length){
    state.globalGroups = [];
    if (state.currentFileUrl){
      state.currentMode = 'file';
      renderArticles(state.articles, {globalMode:false});
      updateCount();
    } else {
      els.articles.innerHTML = '<div class="placeholder"><p>Digite algo para buscar em todos os cÃ³digos.</p></div>';
      state.currentList = [];
      state.matchNodes = [];
      state.matchIdx = -1;
      updateCount();
    }
    return;
  }

  setBusy(true);

  // varrer catÃ¡logo na mesma ordem do <select>
  const groups = [];
  const selectGroups = getGroupsFromSelect(); // preserva ordem de grupos/itens do catÃ¡logo

  for (const g of selectGroups){
    for (const it of g.items){
      const url = it.value;
      const label = it.label;
      try{
        const txt = await fetchTextCached(url);
        const blocks = parseByUrl(url, txt);

        // filtra: mantÃ©m somente cards que contÃ©m TODAS as palavras (AND)
        const hits = [];
        for (const b of blocks){
          const full = blockFullText(b);
          const norm = normalizeTerm(full);
          const allHit = tokens.every(t => norm.indexOf(t) !== -1);
          if (allHit){
            hits.push({
              ...b,
              _fileUrl: url,
              _fileLabel: label
            });
          }
        }

        if (hits.length){
          groups.push({
            fileUrl: url,
            fileLabel: label,
            items: hits
          });
        }
      }catch(e){ /* ignora erros individuais */ }
      // cede o thread p/ manter UI responsiva
      await new Promise(r=>setTimeout(r,0));
    }
  }

  // salva e renderiza agrupado
  state.currentMode = 'global';
  state.globalGroups = groups;
  renderGlobalGroups(groups);

  // destaca tokens (continua funcionando)
  if (groups.length){
    await highlightTokensChunked(tokens);
  }else{
    state.matchNodes = [];
    state.matchIdx = -1;
    updateCount();
  }

  setBusy(false);
}


/* =============== Sheet (seletor na base) =============== */
function norm(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
function escRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

function renderPicker(filter=''){
  const groups = getGroupsFromSelect();
  const f = norm(filter);
  els.pickerList.innerHTML = '';
  let total = 0;

  groups.forEach(g=>{
    const items = g.items.filter(it => !f || norm(it.label).includes(f));
    if (!items.length) return;

    const sec = document.createElement('div'); sec.className = 'list-section';
    const h = document.createElement('h4'); h.textContent = g.label; sec.appendChild(h);

    items.forEach(it=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'item';
      let labelHTML = it.label;
      if (f) labelHTML = it.label.replace(new RegExp(escRe(filter), 'ig'), m => `<span class="highlight">${m}</span>`);
      btn.innerHTML = `<b>${labelHTML}</b>`;
      btn.addEventListener('click', async ()=>{
        await loadFile(it.value);
        closePicker();
      });
      sec.appendChild(btn);
      total++;
    });

    els.pickerList.appendChild(sec);
  });

  if (!total){
    els.pickerList.innerHTML = '<div class="placeholder" style="margin:8px">Nada encontrado.</div>';
  }
}
function openPicker(){
  els.pickerSheet.hidden = false;
  els.pickerSheet.setAttribute('aria-hidden', 'false');
  els.pickerSearch.value = '';
  renderPicker('');
  document.addEventListener('keydown', onPickerKey);
}
function closePicker(){
  els.pickerSheet.hidden = true;
  els.pickerSheet.setAttribute('aria-hidden', 'true');
  document.removeEventListener('keydown', onPickerKey);
}
function onPickerKey(e){
  if (e.key === 'Escape') closePicker();
}
els.openPicker.addEventListener('click', openPicker);
els.pickerSheet.addEventListener('click', e=>{
  if (e.target.closest('[data-close]')) closePicker();
});
els.pickerSearch.addEventListener('input', e=> renderPicker(e.target.value));

/* =============== IA: construir prompt do artigo em foco =============== */
function buildPrompt(a){
  const split = a._split || splitBlockSupraTitleBody(a.text);
  const supraText = split.supra && split.supra.length ? split.supra.join('\n') + '\n' : '';
  const artigo = (split.titleText ? split.titleText + ' ' : '') + (split.body || '');
  const tema = split.titleText || (a.title || 'Artigo');
  return [
    'Assuma a persona de um professor de Direito experiente convidado pelo direito.love e gere um material de estudo. ',
    'Explique detalhadamente todo o artigo abaixo (caput, parÃ¡grafos, incisos e alÃ­neas), cobrindo: ',
    '(1) conceito com padrÃ£o acadÃªmico (doutrina e jurisprudÃªncia majoritÃ¡ria); ',
    '(2) mini exemplo prÃ¡tico; (3) checklist; (4) princÃ­pios relacionados; ',
    '(5) pontos de atenÃ§Ã£o na prÃ¡tica; (6) erros comuns/pegadinhas; (7) notas comparativas. ',
    'Responda em portuguÃªs claro, objetivo e didÃ¡tico.\n\n',
    `Tema: "${tema}"\n\n`,
    supraText + artigo,
    '\n\nðŸ’š direito.love'
  ].join('');
}
function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; }
function openIA(url){
  showToast('Abrindoâ€¦');
  if (isStandalone()) location.href = url;
  else window.open(url, '_blank', 'noopener,noreferrer');
}
document.querySelectorAll('.ia-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> openIA(btn.dataset.url));
});
function openModal(title){
  els.modalTitle.textContent = `Estude o ${title} com I.A.`;
  els.modalBackdrop.style.display = 'flex';
  els.modalBackdrop.setAttribute('aria-hidden','false');
  els.modalBackdrop.querySelector('.ia-btn')?.focus();
}
function closeModal(){ els.modalBackdrop.style.display = 'none'; els.modalBackdrop.setAttribute('aria-hidden','true'); }
els.closeModal.addEventListener('click', closeModal);
els.modalBackdrop.addEventListener('click', (e)=>{ if (e.target === els.modalBackdrop) closeModal(); });
document.addEventListener('keydown', (e)=>{ if (els.modalBackdrop.style.display === 'flex' && e.key === 'Escape') closeModal(); });

els.studyBtn.addEventListener('click', async ()=>{
  if (state.currentMode !== 'file' || !state.articles.length){
    showToast('Abra um cÃ³digo para estudar.');
    return;
  }
  const idx = state.currentArticleIdx >= 0 ? state.currentArticleIdx : 0;
  const a = state.articles[idx] || state.articles[0];
  document.querySelectorAll('article.highlight-study').forEach(n=>n.classList.remove('highlight-study'));
  document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('highlight-study');

  const prompt = buildPrompt(a);
  try{ await navigator.clipboard.writeText(prompt); showToast('âœ… Prompt copiado!'); }
  catch{ showToast('Copie manualmente no prÃ³ximo passo.'); }

  const title = (a._split?.titleText) || a.title || 'Artigo';
  openModal(title);
});

/* =============== Controles da busca e navegaÃ§Ã£o =============== */
els.doSearchBtn.addEventListener('click', async ()=>{
  if (state.globalOn) await runGlobalSearch();
  else await runLocalSearch();
});
els.searchInput.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter'){ e.preventDefault(); els.doSearchBtn.click(); }
  else if (e.key === 'Escape'){ e.preventDefault(); resetAll(); }
});
els.nextBtn.addEventListener('click', ()=>{
  if (!state.matchNodes.length) return;
  state.matchIdx = (state.matchIdx + 1) % state.matchNodes.length;
  const m = state.matchNodes[state.matchIdx];
  m.scrollIntoView({behavior:'smooth',block:'center'});
  updateCount();
});
els.prevBtn.addEventListener('click', ()=>{
  if (!state.matchNodes.length) return;
  state.matchIdx = (state.matchIdx - 1 + state.matchNodes.length) % state.matchNodes.length;
  const m = state.matchNodes[state.matchIdx];
  m.scrollIntoView({behavior:'smooth',block:'center'});
  updateCount();
});
els.globalToggle.addEventListener('click', ()=>{
  state.globalOn = !state.globalOn;
  els.globalToggle.setAttribute('aria-pressed', String(state.globalOn));
  els.globalToggle.textContent = 'Buscar Global: ' + (state.globalOn ? 'ON' : 'OFF');
  if (!state.globalOn && state.currentMode === 'global'){
    // saiu do global â†’ volta a mostrar arquivo aberto (se houver)
    if (state.currentFileUrl){
      state.currentMode = 'file';
      renderArticles(state.articles, {globalMode:false});
    } else {
      resetAll();
    }
  }
});
els.resetBtn.addEventListener('click', resetAll);
els.brandBtn.addEventListener('click', resetAll);

/* =============== Reset inicial =============== */
function resetAll(){
  // estado
  state.currentFileUrl = null;
  state.currentFileLabel = 'Escolher cÃ³digo';
  state.rawText = '';
  state.articles = [];
  state.currentArticleIdx = -1;
  state.currentList = [];
  state.currentMode = 'idle';
  state.currentTokens = [];

  // busca
  state.matchNodes = [];
  state.matchIdx = -1;
  els.searchInput.value = '';
  updateCount();

  // UI
  setFileIndicator('Escolher cÃ³digo');
  els.globalToggle.setAttribute('aria-pressed','false');
  els.globalToggle.textContent = 'Buscar Global: OFF';
  state.globalOn = false;

  els.articles.innerHTML = `
    <div class="placeholder">
      <p>
        ðŸ’š<br> Bem-vindo ao <strong>Direito.Love</strong><br>
        O <em>Mini Vade Mecum Digital</em> que tambÃ©m te auxilia nos estudos com <strong>I.A.</strong>
        <br><br>ðŸ˜Ž <br><strong>Use o menu na parte inferior</strong> para comeÃ§ar. <br>Bons estudos!
      </p>
    </div>`;

  // barras sempre visÃ­veis
  els.bottomInfo.hidden = false;
  els.bottomSearch.hidden = false;
  els.bottomStudy.hidden = false;

  window.scrollTo({top:0,behavior:'instant'});
}

/* =============== Boot =============== */
document.addEventListener('DOMContentLoaded', ()=>{
  buildCatalogMaps();
  setFileIndicator('Escolher cÃ³digo');
  resetAll(); // inicia jÃ¡ com as barras visÃ­veis + mensagem central
});
</script>
