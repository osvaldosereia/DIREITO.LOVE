<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>direito.love — Estudo Jurídico com IA</title>
<meta name="theme-color" content="#F5C400" />
<link rel="icon" href="favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="favicon-180.png" />
<link rel="manifest" href="manifest.json" />
<style>
  :root{
    --bg:#FFFDF0; --surface:#ffffff; --text:#001840; --border:#e5e7eb;
    --primary:#102A71; --highlight:#F5C400; --highlight-light:#FFDC5F;
    --radius:12px; --shadow:0 4px 16px rgba(0,0,0,.05);
    --font:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif;

    --btn-pad-y:6px; --btn-pad-x:10px; --btn-font:12.5px; --btn-min-h:34px;
    --chip-pad-y:6px; --chip-pad-x:10px; --chip-font:12.5px; --chip-radius:8px;
    --mark-bg:#C8FACC;
    --success:#16a34a; --success-border:#138a3e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:400 13.5px/1.5 var(--font);}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:50;background:var(--highlight);border-bottom:1px solid rgba(0,0,0,.08)}
  .topbar__inner{max-width:980px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#111}
  .brand__logo{height:32px}
  .topbar__actions{display:flex;align-items:center;gap:8px}
  .iconbtn{
    appearance:none;border:1px solid rgba(0,0,0,.12);background:#fff;color:#111;
    width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;
    transition:.15s;
  }
  .iconbtn:hover{background:#fff6cc}
  .iconbtn svg{width:18px;height:18px;display:block}

  .wrap{max-width:980px;margin:0 auto;padding:22px}
  h1{margin:8px 0 4px;color:var(--primary);font-size:20px}
  .muted{color:#334155}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:14px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #tema{flex:1;padding:10px 12px;border:2px solid var(--primary);border-radius:8px;font-size:15px}

  .btn{
    appearance:none;border:1px solid var(--border);background:var(--highlight);color:#000;
    padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;font-size:var(--btn-font);cursor:pointer;transition:.15s;min-height:var(--btn-min-h)
  }
  .btn:hover{background:var(--highlight-light)}
  .btn:active,.btn-alt:active{transform:translateY(1px) scale(.99)}
  .btn-alt{
    appearance:none;border:1px solid #0f2a71;background:var(--primary);color:#fff;
    padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:8px;font-size:var(--btn-font);cursor:pointer;transition:.15s;min-height:var(--btn-min-h)
  }
  .btn-alt:hover{background:#264399}
  .btn[disabled],.btn-alt[disabled]{opacity:.8;cursor:default}
  .btn-ok{ background:var(--success)!important; color:#fff!important; border-color:var(--success-border)!important; }

  .acc{margin:12px 0;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
  .acc>summary{list-style:none;cursor:pointer;padding:10px 14px;font-weight:800;color:var(--primary);display:flex;align-items:center;justify-content:space-between}
  .acc>summary::-webkit-details-marker{display:none}
  .acc[open]>summary{background:#fff7d6}
  .acc-body{padding:10px 14px}
  .acc-count{font-weight:700;background:#0f172a0d;color:#0f172a;padding:2px 8px;border-radius:999px;font-size:12px}

  .result{background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:12px 14px;margin:10px 0}
  .filetag{display:inline-block;font-weight:700;font-size:12px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;margin:0 0 8px 0}
  .result p{margin:0}
  .result .actions{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  mark{background:var(--mark-bg);padding:0 2px;border-radius:3px}

  #promptArea{display:none}
  #promptOut{width:100%;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap}
  .ia-row{display:none;flex-wrap:wrap;gap:8px;margin-top:8px}
  .ia{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111;text-decoration:none;font-size:12px}
  .ia:hover{background:#f8fafc}
  .chip-ghost{padding:6px 10px;border-radius:999px;border:1px dashed var(--border);background:#fff;color:#111;font-size:12px;cursor:pointer}

  .callout-red{ background:#ffecec; border:1px solid #ffd4d4; color:#7a0e0e; padding:8px 10px; border-radius:8px; }

  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.36); display:none; align-items:center; justify-content:center; z-index:80; }
  .modal{ width:min(92vw, 560px); background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.2); padding:14px; }
  .modal header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
  .modal h2{margin:0; color:var(--primary); font-size:18px}
  .modal .close{appearance:none; border:1px solid var(--border); background:#fff; border-radius:10px; width:36px; height:36px; cursor:pointer}
  .modal .content{color:#334155; font-size:13.5px; line-height:1.5}

  #installFab{position:fixed;right:14px;bottom:14px;z-index:60;display:none;background:#111;color:#fff;border:0;border-radius:999px;padding:10px 12px;gap:8px;align-items:center;box-shadow:0 6px 20px rgba(0,0,0,.25);cursor:pointer}
  #installFab svg{width:16px;height:16px;display:block}

  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;opacity:0;transition:.2s;z-index:90}
  #toast.show{opacity:1}

  @media (max-width:600px){
    h1{font-size:18px}
    .result p{font-size:12.5px; line-height:1.45}
  }
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar__inner">
    <a class="brand" href="#top" aria-label="Início">
      <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
    </a>
    <div class="topbar__actions">
      <button id="btnAbout" class="iconbtn" type="button" title="Sobre">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#111" stroke-width="2"/><path d="M12 10v6m0-9h.01" stroke="#111" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button id="btnInstallTop" class="iconbtn" type="button" title="Baixar app" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14a2 2 0 0 0 2-2v-4M3 15v4a2 2 0 0 0 2 2" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
</header>

<main class="wrap" id="top">
  <section id="temaSec" class="card">
    <h1>Escreva aqui o tema do prompt (mínimo de 5 palavras)</h1>
    <div class="row" style="margin-top:8px">
      <input id="tema" type="text" placeholder="Ex.: responsabilidade civil por dano estético em cirurgia..." />
      <button id="btnAvancar" class="btn-alt" type="button">Avançar</button>
    </div>
    <p class="muted callout-red" id="temaHint" style="margin:8px 2px 0 2px;display:none">Tema definido. Agora selecione as sugestões e estratégias abaixo.</p>
  </section>

  <section id="sugestoesSec" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h1 style="margin:0">Sugestões para enriquecer seu tema</h1>
      <button id="btnRebuscar" class="btn" type="button">Rebuscar</button>
    </div>
    <p class="muted" style="margin-top:6px">Resultados agrupados por categoria. Clique em cada uma para abrir.</p>
    <div id="sugestoesCats"></div>
  </section>

  <section id="estrategiasSec" class="card" style="display:none">
    <h1>Estratégias de estudo</h1>
    <p class="muted" style="margin-top:6px">Abra as categorias, adicione o que fizer sentido e depois gere o prompt.</p>
    <div id="estrategiasCats"></div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="btnGerar" class="btn-alt" type="button">Gerar Prompt</button>
    </div>
  </section>

  <section id="promptArea" class="card">
    <h1>Prompt gerado</h1>
    <div id="promptOut"></div>
    <div class="row" style="margin-top:10px; align-items:center; gap:12px;">
      <button id="btnCopy" class="btn" type="button">Copiar</button>
      <button id="btnLimpar" class="btn" type="button" style="display:none;">Limpar</button>
      <div class="ia-row" id="iaRow">
        <a class="ia" data-ia="chatgpt" href="https://chat.openai.com/" target="_blank" rel="noopener">ChatGPT</a>
        <a class="ia" data-ia="claude"  href="https://claude.ai/new" target="_blank" rel="noopener">Claude</a>
        <a class="ia" data-ia="gemini"  href="https://gemini.google.com/app" target="_blank" rel="noopener">Gemini</a>
        <a class="ia" data-ia="perplexity" href="https://www.perplexity.ai/" target="_blank" rel="noopener">Perplexity</a>
        <a class="ia" data-ia="copilot" href="https://copilot.microsoft.com/" target="_blank" rel="noopener">Copilot</a>
        <a class="ia" data-ia="phind"   href="https://www.phind.com/" target="_blank" rel="noopener">Phind</a>
        <button id="btnFecharChips" class="chip-ghost" type="button" title="Fechar">Fechar</button>
      </div>
    </div>
    <p class="muted" style="margin:6px 0 0 0; display:none" id="dicaCliqueDireito">
      Dica: clique com o botão direito em um chip de IA para abrir já com o prompt copiado.
    </p>
  </section>
</main>

<!-- Modal Sobre -->
<div id="aboutBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <header>
      <h2 id="aboutTitle">Sobre o direito.love</h2>
      <button class="close" id="aboutClose" type="button" aria-label="Fechar">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="#111" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </header>
    <div class="content">
      <p>O direito.love ajuda estudantes a montar prompts de estudo de forma rápida e inteligente. Digite um tema, receba sugestões do nosso acervo (códigos, súmulas, julgados e jurisprudência), escolha as sessões do seu estudo e gere um prompt otimizado para a IA de sua preferência.</p>
      <p>Funciona como PWA no Android: <b>Baixe o app</b> para acesso instantâneo e offline básico.</p>
    </div>
  </div>
</div>

<!-- PWA float (opcional) -->
<button id="installFab" title="Instalar app">
  <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14a2 2 0 0 0 2-2v-4M3 15v4a2 2 0 0 0 2 2" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  <span>Baixar app</span>
</button>

<div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const toast=(m,t=1600)=>{const el=$("#toast");el.textContent=m;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};

  const temaInput=$("#tema"), btnAvancar=$("#btnAvancar"), temaHint=$("#temaHint");
  const sugestSec=$("#sugestoesSec"), sugCats=$("#sugestoesCats"), btnRebuscar=$("#btnRebuscar");
  const estrSec=$("#estrategiasSec"), estrCats=$("#estrategiasCats"), btnGerar=$("#btnGerar");
  const promptArea=$("#promptArea"), promptOut=$("#promptOut"), btnCopy=$("#btnCopy"), btnLimpar=$("#btnLimpar");
  const iaRow=$("#iaRow"), dicaCliqueDireito=$("#dicaCliqueDireito"), btnFecharChips=$("#btnFecharChips");

  const btnInstallTop=$("#btnInstallTop");
  const btnAbout=$("#btnAbout");
  const aboutBackdrop=$("#aboutBackdrop");
  const aboutClose=$("#aboutClose");

  /* ===== Normalização + Sinônimos ===== */
  const STOP=new Set(['de','da','do','das','dos','e','ou','a','o','as','os','no','na','nos','nas','para','por','em','um','uma','ao','à','que','com','sem','sobre','entre','ate','das','dos','do','da']);
  const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const norm=(s="")=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  // canônicos de códigos (usados para tirar do requisito de proximidade)
  const LAW_CANONS = [
    'codigo penal','codigo de processo penal','codigo civil','codigo de processo civil',
    'codigo tributario nacional','codigo de defesa do consumidor','codigo de transito brasileiro',
    'codigo eleitoral','codigo comercial','codigo penal militar','codigo de processo penal militar',
    'codigo florestal','codigo das aguas','codigo de minas',
    'codigo brasileiro de aeronautica','codigo brasileiro de telecomunicacoes',
    'consolidacao das leis do trabalho'
  ];

  const SYN = [
    // marcadores estruturais
    { canon:'art',    pats:[/\bart(?:s|\.)?\b/giu,/\bartigo\b/giu] },
    { canon:'inciso', pats:[/\bincs?\.?\b/giu,/\binc\.?\b/giu,/\binciso\b/giu] },
    { canon:'alinea', pats:[/\bal\.?\b/giu,/\balinea\b/giu] },
    { canon:'paragrafo', pats:[/\bpar\.?\b/giu,/\b§+\b/giu] },

    // códigos e siglas
    { canon:'codigo penal', pats:[/\bcp\b/giu,/\bcod(?:\.|igo)?\s+penal\b/giu] },
    { canon:'codigo de processo penal', pats:[/\bcpp\b/giu,/\bcod(?:\.|igo)?\s+de\s+processo\s+penal\b/giu] },
    { canon:'codigo civil', pats:[/\bcc\b/giu,/\bcod(?:\.|igo)?\s+civil\b/giu] },
    { canon:'codigo de processo civil', pats:[/\bcpc\b/giu,/\bcod(?:\.|igo)?\s+de\s+processo\s+civil\b/giu] },
    { canon:'codigo tributario nacional', pats:[/\bctn\b/giu,/\bcod(?:\.|igo)?\s+tributario\s+nacional\b/giu] },
    { canon:'codigo de defesa do consumidor', pats:[/\bcdc\b/giu,/\bcod(?:\.|igo)?\s+de\s+defesa\s+do\s+consumidor\b/giu] },
    { canon:'codigo de transito brasileiro', pats:[/\bctb\b/giu,/\bcod(?:\.|igo)?\s+de?\s*transito\b/giu] },
    { canon:'codigo eleitoral', pats:[/\bce\b/giu,/\bcod(?:\.|igo)?\s+eleitoral\b/giu] },
    { canon:'codigo comercial', pats:[/\bcod(?:\.|igo)?\s+comercial\b/giu] },
    { canon:'codigo penal militar', pats:[/\bcpm\b/giu,/\bcod(?:\.|igo)?\s+penal\s+militar\b/giu] },
    { canon:'codigo de processo penal militar', pats:[/\bcppm\b/giu,/\bcod(?:\.|igo)?\s+de\s+processo\s+penal\s+militar\b/giu] },
    { canon:'codigo florestal', pats:[/\bcod(?:\.|igo)?\s+florestal\b/giu] },
    { canon:'codigo das aguas', pats:[/\bcod(?:\.|igo)?\s+das\s+aguas\b/giu] },
    { canon:'codigo de minas', pats:[/\bcod(?:\.|igo)?\s+de\s+minas\b/giu] },
    { canon:'codigo brasileiro de aeronautica', pats:[/\bcba\b/giu,/\bcod(?:\.|igo)?\s+brasileiro\s+de\s+aeronautica\b/giu] },
    { canon:'codigo brasileiro de telecomunicacoes', pats:[/\bcod(?:\.|igo)?\s+brasileiro\s+de\s+telecomunicacoes\b/giu] },
    { canon:'consolidacao das leis do trabalho', pats:[/\bclt\b/giu,/\bconsolidac[aã]o\s+das\s+leis\s+do\s+trabalho\b/giu] },

    // temas comuns
    { canon:'dano', pats:[/\bdanos?\b/giu] },
    { canon:'moral', pats:[/\bmorais\b/giu] },
    { canon:'estetico', pats:[/\best[eé]tic\w+\b/giu,/\besteic\w+\b/giu] },
    { canon:'medico', pats:[/\bm[eé]dic\w+\b/giu] },
    { canon:'erro medico', pats:[/\berro\s+medic\w+\b/giu,/\biatrogen\w+\b/giu,/\bimperici\w+\b/giu,/\bnegligenci\w+\b/giu,/\bimprudenci\w+\b/giu,/\berro\s+odontolog\w+\b/giu] },

    // jurisprudência e afins
    { canon:'sumula', pats:[/\bs[uú]mulas?\b/giu,/\bsv\b/giu,/\bsumula\b/giu] },
    { canon:'jurisprudencia', pats:[/\bjurisprud[eê]nci\w+\b/giu,/\bprecedent\w+\b/giu,/\bleading\s+case\b/giu] },
    { canon:'tema repetitivo', pats:[/\btemas?\s+repetitiv\w+\b/giu] },
    { canon:'repercussao geral', pats:[/\brepercuss[aã]o\s+geral\b/giu] },
  ];
  function applySynonyms(t){ for(const s of SYN){ for(const p of s.pats){ t = t.replace(p, ' '+s.canon+' '); } } return t; }

  function normalizeLegal(s){
    let t=norm(s);

    // normalizar "art120", "art.120", "artigo120"
    t=t.replace(/\b(art(?:igo)?\.?)\s*(\d+[a-z\-]*)\b/giu,' art $2 ');

    // remover pontos dentro de números (ex.: 13.709 -> 13709, 2.018 -> 2018)
    t=t.replace(/\b\d{1,3}(?:\.\d{3})+(?:\/\d{2,4})?\b/g, m => m.replace(/\./g,''));
    t=t.replace(/(\d)\.(?=\d)/g,'$1'); // fallback extra

    // suprimir marcações de grau/ordinais
    t=t.replace(/(\d+)\s*[ºªoa]\b/g,'$1');

    // limpar pontuação solta
    t=t.replace(/["'()]/g,' ').replace(/\s+/g,' ').trim();

    // unicizar "único"
    t=t.replace(/\bunico\b/giu,' unico ');

    // aplicar sinônimos/canônicos
    t=applySynonyms(' '+t+' ');

    return t.replace(/\s+/g,' ').trim();
  }

  function tokensFromLegal(s){ return s.split(/\s+/).filter(Boolean); }
  const isRelevant = w => w.length>=3 && !STOP.has(w);

  function highlightText(text,tokens){
    if(!tokens?.length) return text;
    let html=text; const used=new Set();
    for(const tok of tokens){ if(!tok||used.has(tok)) continue; used.add(tok);
      const re=new RegExp(`\\b(${esc(tok)})\\b`,'giu'); html=html.replace(re,'<mark>$1</mark>');
    }
    return html;
  }

  /* ===== Regras de proximidade (cadeia) ===== */
  function hasProxChain(hayTokens, targetsArr, requireDistinct, maxGap=2){
    if(!targetsArr.length) return false;
    const targetSet = new Set(targetsArr);
    const posByTok = new Map();
    for(let i=0;i<hayTokens.length;i++){
      const w=hayTokens[i];
      if(targetSet.has(w)){
        if(!posByTok.has(w)) posByTok.set(w, []);
        posByTok.get(w).push(i);
      }
    }
    if(posByTok.size < requireDistinct) return false;

    const occs=[];
    for(const [tok, arr] of posByTok){ for(const p of arr){ occs.push({pos:p, tok}); } }
    occs.sort((a,b)=>a.pos-b.pos);

    for(let s=0;s<occs.length;s++){
      let used=new Set([occs[s].tok]);
      let last=occs[s].pos;
      for(let t=s+1;t<occs.length;t++){
        const gap = occs[t].pos - last - 1;
        if(gap <= maxGap){
          if(!used.has(occs[t].tok)) used.add(occs[t].tok);
          last = occs[t].pos;
          if(used.size >= requireDistinct) return true;
        } else {
          break;
        }
      }
    }
    return false;
  }

  /* ===== Dados e categorias ===== */
  const arquivos=[
    "data/julgados_direito_administrativo.json","data/julgados_direito_ambiental.json","data/julgados_direito_bancario.json",
    "data/julgados_direito_civil.json","data/julgados_direito_constitucional.json","data/julgados_direito_eleitoral.json",
    "data/julgados_direito_empresarial.json","data/noticias_migalhas_1.json","data/noticias_migalhas_2.json","data/noticias_migalhas_3.json",
    "data/codigo_penal.json","data/codigo_processo_penal.json","data/sumula_stf.json","data/sumulas_stj.json","data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json","data/temas_repetitivos_stj.json","data/teses_stf.json","data/codigo_processo_civil.json",
    "data/codigo_civil.json","data/codigo_tributario_nacional.json","data/codigo_defesa_consumidor.json","data/codigo_transito_brasileiro.json"
  ];
  const nomesAmigaveis={noticias:"Notícias",noticias_migalhas_1:"Notícias Migalhas",noticias_migalhas_2:"Notícias Migalhas",noticias_migalhas_3:"Notícias Migalhas",
    sumula_stf:"Súmulas STF",sumulas_stj:"Súmulas STJ",sumulas_tse:"Súmulas TSE",sumulas_vinculantes_stf:"Súmulas Vinculantes STF",
    temas_repetitivos_stj:"Temas Repetitivos STJ",teses_stf:"Teses STF",codigo_penal:"Código Penal",codigo_processo_penal:"Código de Processo Penal",
    codigo_processo_civil:"Código de Processo Civil",codigo_civil:"Código Civil",codigo_tributario_nacional:"Código Tributário Nacional",
    codigo_defesa_consumidor:"Código de Defesa do Consumidor",codigo_transito_brasileiro:"Código de Trânsito Brasileiro",
    julgados_direito_administrativo:"Julgados de Direito Administrativo",julgados_direito_ambiental:"Julgados de Direito Ambiental",
    julgados_direito_bancario:"Julgados de Direito Bancário",julgados_direito_civil:"Julgados de Direito Civil",
    julgados_direito_constitucional:"Julgados de Direito Constitucional",julgados_direito_eleitoral:"Julgados de Direito Eleitoral",
    julgados_direito_empresarial:"Julgados de Direito Empresarial"};
  const categorias={
    codigos:{label:"Códigos",test:f=>f.startsWith('codigo_')},
    sumulas:{label:"Súmulas",test:f=>f.startsWith('sumula')||f.startsWith('sumulas_')||f==='sumulas_vinculantes_stf'},
    jurisprudencia:{label:"Jurisprudência",test:f=>f==='temas_repetitivos_stj'||f==='teses_stf'},
    julgados:{label:"Julgados",test:f=>f.startsWith('julgados_')},
    noticias:{label:"Notícias",test:f=>f.startsWith('noticias')},
    outros:{label:"Outros",test:_=>true}
  };
  const normalizarFonte=f=>f&&f.startsWith('noticias')?'noticias':f;

  let baseDados=[];
  async function carregarDados(){
    const dados=[];
    for(const arq of arquivos){
      try{
        const tag=arq.split('/').pop().replace(/\.json$/,'');
        const r=await fetch(arq); if(!r.ok) continue;
        const j=await r.json();
        (Array.isArray(j)?j:[]).forEach((it,idx)=>{
          const _id=it.id||`${tag}_${idx}`;
          const texto=(it.texto||it.descricao||it.conteudo||'').trim();
          const titulo=it.titulo||it.title||'';
          dados.push({...it,_id,fonte:tag,titulo,texto,textoNorm:norm(texto||titulo),textoLegal:normalizeLegal(texto||titulo)});
        });
      }catch(e){ console.warn('Erro ao carregar',arq,e); }
    }
    return dados;
  }
  function ensureVisible(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); }

  /* ===== Busca profissional com proximidade e códigos fora do requisito ===== */
  function professionalSearch(raw, data){
    const qLegal = normalizeLegal(raw);
    const qTokensAll = tokensFromLegal(qLegal);
    const qDistinct = Array.from(new Set(qTokensAll));

    // detectar menções a códigos (para não exigir proximidade deles)
    const lawHits = LAW_CANONS.filter(c => qLegal.includes(c));
    const lawTokSet = new Set(lawHits.flatMap(c => tokensFromLegal(c)));

    // targets para cadeia: tirar tokens de código e stopwords
    let chainTargets = qDistinct.filter(t => !lawTokSet.has(t) && !STOP.has(t));

    // regra de quantos termos distintos exigir na cadeia
    let requireDistinct, maxGap = 2;
    if (chainTargets.length <= 1){
      requireDistinct = 1;
    } else if (chainTargets.length <= 3){
      requireDistinct = chainTargets.length;
    } else {
      const relev = chainTargets.filter(isRelevant);
      chainTargets = relev.length ? relev : chainTargets;
      requireDistinct = Math.min(4, chainTargets.length);
    }
    if (chainTargets.length===0){ chainTargets = qDistinct.filter(t=>!STOP.has(t)); requireDistinct = Math.min(1, chainTargets.length); }

    const highlight = (chainTargets.length? chainTargets : qDistinct).slice(0,8);

    const results=[];
    for(const it of data){
      const hay = (it.textoLegal || it.textoNorm || '');
      const hTokens = tokensFromLegal(hay);

      // precisa conter pelo menos um target
      if (!chainTargets.some(t => hTokens.includes(t))) continue;

      if (requireDistinct===1){
        results.push(it);
      } else {
        if (hasProxChain(hTokens, chainTargets, requireDistinct, maxGap)) results.push(it);
      }
    }
    return { results, highlight };
  }

  /* ===== UI dos cartões / categorias ===== */
  function buildCard(item,tokens){
    const fNorm=normalizarFonte(item.fonte);
    const nomeBonito=nomesAmigaveis[fNorm]||nomesAmigaveis[item.fonte]||item.fonte;
    const div=document.createElement('div'); div.className='result';
    const tag=document.createElement('div'); tag.className='filetag'; tag.textContent=nomeBonito; div.appendChild(tag);
    const p=document.createElement('p'); const baseText=(item.texto&&item.texto.trim())||(item.titulo||'');
    p.innerHTML=highlightText(baseText,tokens); div.appendChild(p);
    const actions=document.createElement('div'); actions.className='actions';
    const add=document.createElement('button'); add.className='btn-alt'; add.type='button'; add.textContent='Incluir no tema';
    add.addEventListener('click',()=>{
      const piece=item.texto?.trim()||[item.titulo||'',item.url||''].filter(Boolean).join(' — ');
      if(piece){
        if(temaInput.value && !temaInput.value.trim().endsWith('—')) temaInput.value=temaInput.value.trim()+' — ';
        temaInput.value+=piece;
        toast('Conteúdo adicionado ao tema.');
        add.classList.add('btn-ok'); add.textContent='Adicionado'; add.disabled=true;
        temaHint.style.display='block';
      }
    });
    actions.appendChild(add);
    if(item.url && fNorm==='noticias'){
      const a=document.createElement('a'); a.textContent='Ver notícia'; a.href=item.url; a.target='_blank'; a.rel='noopener'; a.className='btn';
      actions.appendChild(a);
    }
    div.appendChild(actions);
    return div;
  }

  function groupByCategory(items){
    const groups={}; for(const k in categorias){ groups[k]={label:categorias[k].label,items:[]} }
    for(const it of items){
      const f=it.fonte||''; let cat='outros';
      for(const k in categorias){ if(k==='outros') continue; if(categorias[k].test(f)){ cat=k; break; } }
      groups[cat].items.push(it);
    }
    return Object.fromEntries(Object.entries(groups).filter(([,g])=>g.items.length>0).sort((a,b)=>b[1].items.length-a[1].items.length));
  }

  function renderSugeridos(items,tokens){
    sugCats.innerHTML='';
    const groups=groupByCategory(items);
    const entries=Object.entries(groups);
    if(entries.length===0){ sugCats.innerHTML='<p>Nenhum resultado encontrado para o tema informado.</p>'; return; }
    for(const [catId,group] of entries){
      const det=document.createElement('details'); det.className='acc';
      const sum=document.createElement('summary'); const ttl=document.createElement('span'); ttl.textContent=group.label;
      const count=document.createElement('span'); count.className='acc-count'; count.textContent=group.items.length;
      sum.appendChild(ttl); sum.appendChild(count); det.appendChild(sum);
      const body=document.createElement('div'); body.className='acc-body';
      group.items.slice(0,12).forEach(it=>body.appendChild(buildCard(it,tokens)));
      det.appendChild(body); sugCats.appendChild(det);
    }
  }

  /* ===== Estratégias ===== */
  const ESTRATEGIAS={
    'Fundamentos':[
      ['Conceitos e Definições','Definições objetivas, linguagem clara e diferenciações essenciais, com 1–2 exemplos curtos.'],
      ['Base Legal Essencial','Citar e contextualizar os dispositivos legais diretamente relacionados ao tema.'],
      ['Súmulas e Enunciados','Apontar súmulas vinculantes, do STF, STJ, TJs e enunciados pertinentes.'],
      ['Doutrina Relevante','Síntese de 2–3 posições doutrinárias com autores e correntes.']
    ],
    'Aplicação Prática':[
      ['Exemplos e Casos Práticos','Mini-casos e hipóteses para treinar aplicação do conteúdo.'],
      ['Estrutura de Peça / Modelos','Esqueleto de peça processual ou roteiro de resposta dissertativa.'],
      ['Quadro Comparativo','Tabela com institutos correlatos, elementos e diferenças-chave.'],
      ['Raciocínio Jurídico (passo a passo)','Passos lógicos para resolver a questão do tema.']
    ],
    'Revisão Rápida':[
      ['Checklist de Peça','Itens mínimos a conferir em uma peça prática.'],
      ['Erros Comuns','Armadilhas frequentes e como evitá-las.'],
      ['Flashcards','Termos, conceitos e artigos em formato de pergunta/resposta.'],
      ['Dicas de Prova (OAB/Concursos)','Pontos de atenção e gestão de tempo.']
    ]
  };
  const escolhidas=[];
  function selecionarEstrategia(nome,desc){ if(!escolhidas.some(x=>x.nome===nome)) escolhidas.push({nome,desc}); }
  function renderEstrategias(){
    estrCats.innerHTML='';
    for(const cat in ESTRATEGIAS){
      const det=document.createElement('details'); det.className='acc';
      const sum=document.createElement('summary'); const ttl=document.createElement('span'); ttl.textContent=cat;
      const count=document.createElement('span'); count.className='acc-count'; count.textContent=ESTRATEGIAS[cat].length;
      sum.appendChild(ttl); sum.appendChild(count); det.appendChild(sum);
      const body=document.createElement('div'); body.className='acc-body';
      ESTRATEGIAS[cat].forEach(([nome,desc])=>{
        const div=document.createElement('div'); div.className='result';
        const tag=document.createElement('div'); tag.className='filetag'; tag.textContent=nome; div.appendChild(tag);
        const p=document.createElement('p'); p.textContent=desc; div.appendChild(p);
        const actions=document.createElement('div'); actions.className='actions';
        const btn=document.createElement('button'); btn.className='btn-alt'; btn.type='button'; btn.textContent='Adicionar ao prompt';
        btn.addEventListener('click',()=>{
          selecionarEstrategia(nome,desc);
          toast('Sessão adicionada ao prompt.');
          btn.classList.add('btn-ok'); btn.textContent='Adicionado'; btn.disabled=true;
        });
        actions.appendChild(btn); div.appendChild(actions);
        body.appendChild(div);
      });
      det.appendChild(body); estrCats.appendChild(det);
    }
  }

  /* ===== Prompt ===== */
  function gerarPrompt(){
    const temaFinal=temaInput.value.trim();
    if(!temaFinal){ toast('Defina o tema antes.'); return; }

    let baseLista=escolhidas.slice();
    if(baseLista.length===0){
      baseLista=[
        {nome:'Conceitos e Definições',desc:'Definições objetivas e diferenciações essenciais, com 1–2 exemplos curtos.'},
        {nome:'Base Legal Essencial',desc:'Dispositivos legais diretamente relacionados ao tema.'},
        {nome:'Súmulas e Enunciados',desc:'Súmulas vinculantes, STF/STJ e enunciados pertinentes.'},
        {nome:'Raciocínio Jurídico (passo a passo)',desc:'Passos lógicos para resolver a questão do tema.'}
      ];
    }

    const linhas=[];
    linhas.push('Você é um professor de Direito com uma didática impecável, linguagem simples mas rica em conhecimento. Ajude-me a estudar o tema abaixo:\n');
    linhas.push('TEMA: '+temaFinal+'\n');
    linhas.push('Estruture a resposta nas seções a seguir, sendo didático, detalhista e sempre que possível comente usando mini exemplos. A cada 2 seções solicite autorização para continuar.');
    baseLista.forEach(({nome,desc})=>linhas.push(`- ${nome}: ${desc}`));
    linhas.push('\nRegras: cite artigos com número e diploma; quando houver, inclua Súmulas (STF/STJ) e leading cases; use exemplos curtos; ao final, proponha 3 questões objetivas com gabarito e 1 discursiva.');

    promptOut.textContent=linhas.join('\n');
    promptArea.style.display='block';
    setTimeout(()=>ensureVisible(promptArea),50);
    toast('Prompt gerado.');
  }

  /* ===== Execução ===== */
  function executarBuscaDoTema(){
    const temaRaw=temaInput.value.trim();
    if(!temaRaw){ toast("Digite um tema."); temaInput.focus(); return; }

    temaHint.style.display='block'; sugestSec.style.display='block';
    btnRebuscar.disabled=true; btnRebuscar.textContent='Buscando…';

    const {results, highlight} = professionalSearch(temaRaw, baseDados);
    renderSugeridos(results, highlight);
    estrSec.style.display='block';
    renderEstrategias();
    setTimeout(()=>{ ensureVisible(sugestSec); }, 50);

    btnRebuscar.disabled=false; btnRebuscar.textContent='Rebuscar';
  }

  btnAvancar.addEventListener('click', executarBuscaDoTema);
  btnRebuscar.addEventListener('click', executarBuscaDoTema);
  btnGerar.addEventListener('click', gerarPrompt);

  // Dica automática após 3s desde a 1ª digitação
  let hintTimer=null, hinted=false;
  temaInput.addEventListener('input', ()=>{
    if(hinted) return;
    if(hintTimer) clearTimeout(hintTimer);
    if(temaInput.value.trim().length>0){
      hintTimer=setTimeout(()=>{ temaHint.style.display='block'; hinted=true; }, 3000);
    }
  });

  // Copiar -> chips de IA + Fechar
  btnCopy.addEventListener('click', async()=>{
    try{
      await navigator.clipboard.writeText(promptOut.textContent||'');
      toast('Copiado!');
      iaRow.style.display='flex';
      dicaCliqueDireito.style.display='block';
      btnLimpar.style.display='inline-block';
    }catch{ toast('Erro ao copiar.'); }
  });
  $$('.ia').forEach(a=>{
    a.addEventListener('contextmenu', async (ev)=>{
      ev.preventDefault();
      try{ await navigator.clipboard.writeText(promptOut.textContent||''); toast('Copiado!'); }catch{}
      window.open(a.href,'_blank','noopener');
    });
  });
  function resetApp(){
    temaInput.value='';
    temaHint.style.display='none';
    sugestSec.style.display='none'; sugCats.innerHTML='';
    estrSec.style.display='none'; estrCats.innerHTML='';
    promptArea.style.display='none'; promptOut.textContent='';
    iaRow.style.display='none'; dicaCliqueDireito.style.display='none';
    btnLimpar.style.display='none';
    hinted=false; if(hintTimer) clearTimeout(hintTimer); hintTimer=null;
    window.scrollTo({top:0,behavior:'smooth'});
  }
  btnFecharChips.addEventListener('click', resetApp);
  btnLimpar.addEventListener('click', resetApp);

  // Boot & PWA
  async function boot(){
    baseDados = await carregarDados();
    toast('Base carregada com sucesso!');
  }
  boot();

  // Modal Sobre
  function openAbout(){ aboutBackdrop.style.display='flex'; aboutBackdrop.setAttribute('aria-hidden','false'); }
  function closeAbout(){ aboutBackdrop.style.display='none'; aboutBackdrop.setAttribute('aria-hidden','true'); }
  btnAbout.addEventListener('click', openAbout);
  aboutClose.addEventListener('click', closeAbout);
  aboutBackdrop.addEventListener('click', (e)=>{ if(e.target===aboutBackdrop) closeAbout(); });

  // PWA (Android)
  let deferredPrompt=null;
  const installFab=$("#installFab");
  const isAndroid = /Android/i.test(navigator.userAgent || '');
  if(isAndroid) btnInstallTop.style.display='flex';
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt=e;
    btnInstallTop.style.display='flex';
  });
  function doInstall(){
    if(deferredPrompt){
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(({outcome})=>{
        if(outcome==='accepted') toast('Instalação iniciada.');
        deferredPrompt=null;
      });
    }else{
      toast('No Android, use “Adicionar à tela inicial” no menu do navegador.');
    }
  }
  btnInstallTop.addEventListener('click', doInstall);
  installFab.addEventListener('click', doInstall);
})();
</script>
</body>
</html>
