<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>direito.love ‚Äî Leitor jur√≠dico</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#142B6F">

  <style>
    :root{
      /* Paleta */
      --white:#FFFFFF; --lilac:#E1DEE6; --navy:#142B6F; --yellow:#FFD601;
      --bg:var(--white); --fg:#101418; --muted:#5f6470;

      /* Dimens√µes */
      --topbar-h: 68px;        /* leve respiro na topbar */
      --progress-h: 3px;
      --bottom-search-h: 56px;
      --bottom-study-h: 64px;

      --focus:#9bb6ff; --radius:12px; --shadow:0 2px 10px rgba(0,0,0,.06);
      --accent: rgba(255,214,1,.2);
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      background:var(--bg); color:var(--fg);
      font:15px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    button,input,select{font:inherit}

    /* Topbar (logo √† esq., seletor √† dir.) */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:var(--topbar-h);
      display:flex; align-items:center; justify-content:center;
      background:var(--navy); color:#fff; z-index:80; box-shadow:var(--shadow);
    }
    .topbar-inner{
      width:clamp(320px, 92vw, 960px);
      padding:0 12px; display:flex; align-items:center; gap:12px;
    }
    .brand{
      appearance:none; border:0; background:none; color:#fff; cursor:pointer;
      font-weight:800; letter-spacing:.2px; border-radius:8px;
      flex:0 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size: clamp(18px, 2.2vw, 24px);
      line-height: 1.1;
      padding: 8px 10px;
    }
    .brand:focus{outline:2px solid #fff; outline-offset:2px}
    .spacer{flex:1 1 auto; min-width:0}
    .select-wrap{flex:1 1 50%; min-width:0; max-width:60vw}
    select{
      width:100%; height:38px; border:1px solid rgba(255,255,255,.35);
      background:#fff; color:#161b33; border-radius:10px; padding:0 10px;
    }
    select:focus{outline:2px solid var(--focus); outline-offset:2px}

    /* Barra de progresso fina (busca) */
    .progress{
      position:fixed; top:var(--topbar-h); left:0; right:0; height:var(--progress-h); z-index:85;
      background:transparent;
    }
    .progress .bar{
      height:100%; width:0%; background:linear-gradient(90deg, #FFD601, #E1DEE6);
      transition:width .2s ease;
    }
    .progress[hidden]{display:none}

    /* Conte√∫do */
    .content{
      position:relative;
      padding: calc(var(--topbar-h) + var(--progress-h) + 14px) 0 calc(var(--bottom-search-h) + var(--bottom-study-h) + 24px);
      min-height:100dvh;
    }
    .container{ width:clamp(320px, 92vw, 960px); margin:0 auto; padding:0 12px }
    .placeholder{
      padding:24px; border:1px dashed #dcdfea; border-radius:var(--radius);
      color:var(--muted); background:#fafbff
    }

    /* Blocos */
    article{
      white-space:pre-wrap;
      border-bottom:1px solid #eef0f6;
      padding:18px 10px; scroll-margin: 92px; border-radius:10px;
    }
    /* T√≠tulo do artigo agora leve; r√≥tulo "Art. X" fica em negrito suave */
    .art-title{display:block; font-weight:400; color:#0e1638; margin:0 0 8px}
    .art-label{font-weight:600;} /* negrito n√£o muito forte */
    article.current-outline{outline:2px solid #cfe0ff; outline-offset:2px}
    article.highlight-study{background:var(--accent)}

    /* Blocos meta (ep√≠grafes, cap√≠tulos, t√≠tulos, livros, se√ß√µes) */
    .meta-block{
      white-space:pre-wrap; padding:14px 10px; border-bottom:1px solid #eef0f6; border-radius:10px;
      font-weight:600; color:#0e1638;
    }

    /* Destaque busca */
    mark{padding:0 2px; border-radius:3px; background:#ffef99}

    /* Barra inferior 1: BUSCA + SETAS + spinner */
    .bottom-search{
      position:fixed; left:0; right:0; bottom:var(--bottom-study-h);
      height:var(--bottom-search-h); background:#fff; border-top:1px solid #e9eaf2; z-index:70;
      display:flex; align-items:center; justify-content:center;
    }
    .bottom-search-inner{
      width:clamp(320px, 92vw, 960px);
      display:flex; align-items:center; gap:6px; padding:8px 12px;
    }
    .iconbtn{
      width:32px; height:32px; border:1px solid #e2e5f2; background:#fff; border-radius:8px;
      display:grid; place-items:center; cursor:pointer; user-select:none; flex:0 0 32px;
      font-size:16px; line-height:1;
    }
    .iconbtn:focus,input:focus{outline:2px solid var(--focus); outline-offset:2px}
    .search{flex:1; display:flex; align-items:center; gap:6px; min-width:0}
    .search input{
      width:100%; height:36px; border:1px solid #e2e5f2; border-radius:10px; padding:0 12px; background:#fff;
      flex:1 1 auto; min-width:0;
    }
    .spinner{width:18px; height:18px; border:2px solid #e2e5f2; border-top-color:#142B6F; border-radius:50%;
      animation:spin 1s linear infinite; flex:0 0 18px}
    .spinner[hidden]{display:none}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Barra inferior 2: CONTADOR + ESTUDAR */
    .bottom-study{
      position:fixed; left:0; right:0; bottom:0; height:var(--bottom-study-h);
      background:#fff; border-top:1px solid #e9eaf2; z-index:75;
      display:flex; align-items:center; justify-content:center; padding:8px 0;
    }
    .bottom-study-inner{
      width:clamp(320px, 92vw, 960px); padding:0 12px;
      display:flex; align-items:center; gap:12px;
    }
    .result-count{
      min-width:64px; font-size:12px; color:#6c7282; border:1px solid #e2e5f2;
      background:#f7f8fc; padding:6px 10px; border-radius:8px; text-align:center;
    }
    .study{
      flex:1 1 auto; padding:12px 16px; border-radius:12px;
      border:1px solid #f0e08b; background:var(--yellow); color:#0a0a0a; font-weight:800; cursor:pointer;
    }

    /* Modal IA ‚Äî padr√£o do site */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:center; justify-content:center; z-index:100}
    .modal{
      background:#fff; border-radius:16px; width:min(640px, 92vw); padding:18px; border:1px solid #eceef7; box-shadow: var(--shadow)
    }
    .modal h3{margin:0 0 8px; color:#0f173a}
    .modal .subtitle{margin:0 0 14px; font-size:13px; color:#3a7f48}
    .ia-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .ia-btn{
      display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #e6e8f2; background:#f6f7fb;
      border-radius:12px; cursor:pointer; text-decoration:none; color:#111; font-weight:700; justify-content:center;
    }
    .ia-btn:focus{outline:2px solid var(--focus); outline-offset:2px}
    .modal .foot{margin-top:12px; display:flex; justify-content:flex-end}
    .modal .close-btn{padding:8px 12px; border:1px solid #e2e5f2; background:#fff; border-radius:10px; cursor:pointer}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(var(--bottom-study-h) + var(--bottom-search-h) + 14px);
      background:#111; color:#fff; padding:8px 12px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .2s; z-index:200
    }
    .toast.show{opacity:1}

    /* Esconder barras at√© carregar um arquivo */
    .bottom-search[hidden], .bottom-study[hidden]{display:none}

    @media (max-width: 420px){
      .brand{ font-size: 18px; }
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <button class="brand" id="brandBtn" title="Clique para reiniciar">direito.love</button>
      <div class="spacer"></div>
      <div class="select-wrap">
        <select id="codeSelect" title="Escolher arquivo">
          <option value="">‚Äî selecione ‚Äî</option>
          <option value="data/codigo_civil.txt">C√≥d. Civil</option>
          <option value="data/codigo_consumidor.txt">CDC</option>
          <option value="data/codigo_penal.txt">C√≥d. Penal</option>
          <option value="data/codigo_Processo_Civil.txt">CPC</option>
          <option value="data/codigo_Processo_Penal.txt">CPP</option>
          <!-- futuros: sumulas.txt, jurisprudencia.txt, noticias.txt (mesmo padr√£o -----) -->
        </select>
      </div>
    </div>
  </header>

  <!-- PROGRESS BAR -->
  <div class="progress" id="progress" hidden>
    <div class="bar" id="progressBar"></div>
  </div>

  <!-- CONTE√öDO -->
  <main class="content">
    <div class="container">
      <div class="articles" id="articles">
        <div class="placeholder">
          Selecione um arquivo na barra superior.  
          Regras atuais: <strong>cada Artigo inicia em ‚ÄúArt‚Äù</strong> (A mai√∫sculo) e <strong>termina na pr√≥xima linha ‚Äú-----‚Äù</strong>.  
          Tudo que estiver fora desses blocos ser√° exibido como <strong>t√≠tulo/cap√≠tulo (negrito suave)</strong>.
        </div>
      </div>
    </div>
  </main>

  <!-- BARRA INFERIOR 1 (BUSCA + SETAS + SPINNER) -->
  <div class="bottom-search" id="bottomSearch" hidden>
    <div class="bottom-search-inner" aria-live="polite">
      <button class="iconbtn" id="prevBtn" title="Anterior" aria-label="Anterior">‚óÄ</button>
      <button class="iconbtn" id="nextBtn" title="Pr√≥ximo" aria-label="Pr√≥ximo">‚ñ∂</button>
      <div class="search">
        <input id="searchInput" type="search" placeholder="Buscar no texto‚Ä¶" autocomplete="off" />
        <button class="iconbtn" id="searchBtn" title="Executar busca" aria-label="Buscar">üîé</button>
        <button class="iconbtn" id="clearBtn" title="Limpar busca" aria-label="Limpar">‚úï</button>
        <div class="spinner" id="spinner" hidden></div>
      </div>
    </div>
  </div>

  <!-- BARRA INFERIOR 2 (CONTADOR + ESTUDAR) -->
  <div class="bottom-study" id="bottomStudy" hidden>
    <div class="bottom-study-inner">
      <div class="result-count" title="Ocorr√™ncia atual / Total"><span id="count">0/0</span></div>
      <button class="study" id="studyBtn">ESTUDAR</button>
    </div>
  </div>

  <!-- MODAL IA -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Estude o Artigo X com as I.As. abaixo.</h3>
      <p class="subtitle">‚úÖ Prompt j√° copiado para a √°rea de transfer√™ncia. Escolha uma IA para abrir e cole o prompt.</p>
      <div class="ia-grid">
        <button class="ia-btn" data-url="https://chatgpt.com/">üí¨ ChatGPT</button>
        <button class="ia-btn" data-url="https://gemini.google.com/app">üß† Gemini</button>
        <button class="ia-btn" data-url="https://copilot.microsoft.com/">‚ú® Copilot</button>
        <button class="ia-btn" data-url="https://www.perplexity.ai/">üîé Perplexity</button>
      </div>
      <div class="foot">
        <button class="close-btn" id="closeModal">Fechar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‚úÖ Prompt copiado!</div>

  <script>
    /* ================= Estado ================= */
    const els = {
      brandBtn: document.getElementById('brandBtn'),
      codeSelect: document.getElementById('codeSelect'),
      articles: document.getElementById('articles'),
      bottomSearch: document.getElementById('bottomSearch'),
      bottomStudy: document.getElementById('bottomStudy'),
      searchInput: document.getElementById('searchInput'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      count: document.getElementById('count'),
      searchBtn: document.getElementById('searchBtn'),
      clearBtn: document.getElementById('clearBtn'),
      spinner: document.getElementById('spinner'),
      progress: document.getElementById('progress'),
      progressBar: document.getElementById('progressBar'),
      studyBtn: document.getElementById('studyBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      modalTitle: document.getElementById('modalTitle'),
      closeModal: document.getElementById('closeModal'),
      toast: document.getElementById('toast')
    };

    const state = {
      rawText: '',
      blocks: [],            // [{type:'article'|'meta', text, htmlId, articleIdx?}]
      currentArticleIdx: -1, // √≠ndice relativo de artigos (ignora metas)
      matchNodes: [],
      matchIdx: -1,
      progressTimer: null
    };

    const escapeHtml = (s)=> s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const showToast = (msg='‚úÖ Prompt copiado!')=>{
      els.toast.textContent = msg; els.toast.classList.add('show');
      setTimeout(()=>els.toast.classList.remove('show'), 1000);
    };

    /* ================= Helpers UI ================= */
    function setBusy(isBusy){
      els.bottomSearch.setAttribute('aria-busy', String(isBusy));
      els.searchBtn.disabled = isBusy;
      els.clearBtn.disabled = isBusy;
      els.prevBtn.disabled = isBusy;
      els.nextBtn.disabled = isBusy;
      els.spinner.hidden = !isBusy;
      setProgressActive(isBusy);
    }
    function setProgressActive(active){
      if (active){
        els.progress.hidden = false;
        els.progressBar.style.width = '0%';
        let p = 0;
        clearInterval(state.progressTimer);
        state.progressTimer = setInterval(()=>{
          p = Math.min(85, p + 8 + Math.random()*7);
          els.progressBar.style.width = p + '%';
        }, 180);
      }else{
        clearInterval(state.progressTimer);
        els.progressBar.style.width = '100%';
        setTimeout(()=>{ els.progress.hidden = true; els.progressBar.style.width = '0%'; }, 250);
      }
    }

    /* ================= Visibilidade do artigo (centro da viewport) ================= */
    const getArticleInView = ()=>{
      const nodes = document.querySelectorAll('article[data-idx]');
      const cy = window.innerHeight/2;
      let hitIdx = -1;
      for (const el of nodes){
        const r = el.getBoundingClientRect();
        if (r.top <= cy && r.bottom >= cy){ hitIdx = Number(el.dataset.idx); break; }
      }
      if (hitIdx === -1 && nodes.length){
        for (const el of nodes){
          const r = el.getBoundingClientRect();
          if (r.bottom > 0 && r.top < window.innerHeight){ hitIdx = Number(el.dataset.idx); break; }
        }
      }
      return hitIdx;
    };

    const updateCurrentOutline = ()=>{
      const idx = getArticleInView();
      if (idx === state.currentArticleIdx) return;
      state.currentArticleIdx = idx;
      document.querySelectorAll('article.current-outline').forEach(n=>n.classList.remove('current-outline'));
      if (idx >= 0){
        document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('current-outline');
      }
    };
    window.addEventListener('scroll', ()=>{
      if (!state.blocks.length) return;
      updateCurrentOutline();
    }, {passive:true});

    /* ================= Parser (Art inicia, termina em "-----") =================
       - Artigo: linha que come√ßa com "Art" (A mai√∫sculo), at√© a PR√ìXIMA linha "-----".
       - Tudo fora desses blocos => "meta".
       - Se n√£o houver "-----", usamos fallback antigo (por "Art" at√© pr√≥ximo "Art"/ponto).
    =========================================================================== */
    function parseBlocksFromText(txt){
      txt = txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'); // limpa BOM e normaliza
      const lines = txt.split('\n');

      const isSep = (ln)=> /^\s*-{5,}\s*$/.test(ln);
      const isArtStart = (ln)=> /^\s*Art\.?\s*\d{1,4}(?:-[A-Z])?(?:¬∫|o)?\b/.test(ln); // "Art" (A mai√∫sculo) apenas

      let i = 0;
      const blocks = [];
      let articleCount = 0;

      while (i < lines.length){
        // pular separadores isolados
        if (isSep(lines[i])) { i++; continue; }

        if (isArtStart(lines[i])){
          const start = i;
          i++;
          // vai at√© o pr√≥ximo "-----" (terminador do artigo)
          while (i < lines.length && !isSep(lines[i])) i++;
          let chunk = lines.slice(start, i).join('\n').trimEnd();
          const b = { type:'article', text: chunk, htmlId:`art-${articleCount}`, articleIdx: articleCount };
          blocks.push(b);
          articleCount++;
          continue; // i pode estar no sep; pr√≥ximo la√ßo vai pular
        }else{
          // META: acumula at√© pr√≥ximo Art (ignorando seps no meio)
          const start = i;
          while (i < lines.length){
            if (isSep(lines[i])) { i++; continue; }
            if (isArtStart(lines[i])) break;
            i++;
          }
          let chunk = lines.slice(start, i).filter(l=>!isSep(l)).join('\n').trim();
          if (chunk){
            blocks.push({ type:'meta', text: chunk, htmlId:`meta-${blocks.length}` });
          }
        }
      }

      // Se n√£o montou nada como article e h√° "Art" no texto sem "-----", cai no fallback
      const hasArt = /(^|\n)\s*Art\.?\s*\d{1,4}(?:-[A-Z])?(?:¬∫|o)?\b/.test(txt);
      const hasSep = /(^|\n)\s*-{5,}\s*(?=\n|$)/.test(txt);
      if (!hasSep && hasArt && !blocks.some(b=>b.type==='article')){
        return parseBlocksFallback(txt);
      }
      return blocks.length ? blocks : [{type:'meta', text: txt.trim(), htmlId:'meta-0'}];
    }

    // Fallback antigo: Art at√© pr√≥ximo Art ou at√© √∫ltimo "." / ")"
    function parseBlocksFallback(txt){
      const re = /(^|\n)\s*(Art\.?\s*\d{1,4}(?:-[A-Z])?(?:¬∫|o)?\.?)/g;
      const starts = [];
      let m;
      while ((m = re.exec(txt)) !== null) {
        const idxArt = re.lastIndex - m[2].length;
        starts.push(idxArt);
      }
      if (!starts.length) return [{type:'meta', text: txt.trim(), htmlId:'meta-0'}];

      const blocks = [];
      for (let i = 0; i < starts.length; i++) {
        const from = starts[i];
        const to   = (i + 1 < starts.length) ? starts[i + 1] : txt.length;

        let chunk = txt.slice(from, to);
        const endDot = chunk.lastIndexOf('.');
        const endPar = chunk.lastIndexOf(')');
        const end    = Math.max(endDot, endPar);
        if (end !== -1) chunk = chunk.slice(0, end + 1).trimEnd();

        blocks.push({ type:'article', text: chunk, htmlId:`art-${i}`, articleIdx:i });
      }

      // Tudo antes do primeiro Art vira meta
      if (starts[0] > 0){
        const head = txt.slice(0, starts[0]).trim();
        if (head) blocks.unshift({type:'meta', text: head, htmlId:'meta-head'});
      }
      return blocks;
    }

    /* ====== Util para render: extrai r√≥tulo "Art. X" e corpo ====== */
    function splitArticleLabelAndBody(raw){
      const t  = raw.replace(/^\s+/, '');
      const nl = t.indexOf('\n');
      const firstLine = (nl === -1) ? t : t.slice(0, nl);

      const m = firstLine.match(/^\s*(Art\.?\s*\d{1,4}(?:-[A-Z])?(?:¬∫|o)?)(.*)$/); // captura r√≥tulo + resto da linha
      const label = m ? m[1].trim() : firstLine.trim();
      const afterLabel = m ? m[2].trimStart() : '';
      const rest = (nl === -1) ? '' : t.slice(nl + 1).trimStart();
      const body = afterLabel ? (rest ? afterLabel + '\n' + rest : afterLabel) : rest;
      return { label, body };
    }

    /* ================= Render ================= */
    function renderBlocks(){
      const frag = document.createDocumentFragment();
      let artIdx = 0;
      state.blocks.forEach((b, i)=>{
        if (b.type === 'article'){
          const el = document.createElement('article');
          el.dataset.idx = artIdx;
          el.dataset.bidx = i;
          const { label, body } = splitArticleLabelAndBody(b.text);

          const titleSpan = document.createElement('span');
          titleSpan.className = 'art-title';
          titleSpan.innerHTML = `<span class="art-label">${escapeHtml(label)}</span>` + (body ? '' : '');

          const content = document.createElement('div');
          content.className = 'art-body';
          content.textContent = body;

          el.appendChild(titleSpan);
          el.appendChild(content);
          frag.appendChild(el);

          b.articleIdx = artIdx;
          artIdx++;
        }else{
          const el = document.createElement('div');
          el.className = 'meta-block';
          el.dataset.bidx = i;
          el.textContent = b.text;
          frag.appendChild(el);
        }
      });
      els.articles.innerHTML = '';
      els.articles.appendChild(frag);
      els.bottomSearch.hidden = false;
      els.bottomStudy.hidden = false;
      updateCurrentOutline();
    }

    /* ================= Busca (clicar p/ executar) ================= */

    // Normaliza√ß√£o sem acentos + mapa para √≠ndices do texto original
    function normalizeWithMap(s){
      let norm = '';
      const map = [];
      for (let i=0;i<s.length;i++){
        const ch = s[i];
        const decomp = ch.normalize('NFD');
        for (let k=0;k<decomp.length;k++){
          const c = decomp[k];
          const code = c.codePointAt(0);
          if (code>=0x0300 && code<=0x036F) continue;
          norm += c.toLowerCase();
          map.push(i);
        }
      }
      return {norm, map};
    }
    const normalizeTerm = (s)=> s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

    function findRanges(raw, term){
      if (!term) return [];
      const {norm, map} = normalizeWithMap(raw);
      const needle = normalizeTerm(term);
      if (!needle) return [];
      const ranges = [];
      let from = 0;
      while (true){
        const pos = norm.indexOf(needle, from);
        if (pos === -1) break;
        const start = map[pos];
        const end   = map[pos + needle.length - 1] + 1;
        ranges.push([start, end]);
        from = pos + needle.length;
      }
      return ranges;
    }

    function highlightElementByRanges(el, ranges){
      if (!ranges.length){ return; }
      const raw = el.textContent;
      let out = '', last = 0;
      for (const [s,e] of ranges){
        out += escapeHtml(raw.slice(last, s));
        out += '<mark>' + escapeHtml(raw.slice(s, e)) + '</mark>';
        last = e;
      }
      out += escapeHtml(raw.slice(last));
      el.innerHTML = out;
    }

    function clearMarks(){
      // Re-render dos conte√∫dos (preserva estrutura/metas)
      const y = window.scrollY;
      renderBlocks();
      window.scrollTo(0, y);
      state.matchNodes = [];
      state.matchIdx = -1;
      els.count.textContent = '0/0';
    }

    async function highlightTermChunked(term){
      clearMarks();
      if (!term){ return; }

      setBusy(true);
      els.count.textContent = '...';

      const nodes = Array.from(document.querySelectorAll('article .art-body, article .art-title, .meta-block'));
      const BATCH = 10;
      for (let i = 0; i < nodes.length; i += BATCH){
        for (let j = i; j < Math.min(i+BATCH, nodes.length); j++){
          const n = nodes[j];
          const raw = n.textContent;
          const ranges = findRanges(raw, term);
          if (ranges.length) highlightElementByRanges(n, ranges);
        }
        await new Promise(r=>setTimeout(r,0));
      }

      state.matchNodes = Array.from(document.querySelectorAll('mark'));
      if (state.matchNodes.length){
        state.matchIdx = 0;
        state.matchNodes[0].scrollIntoView({behavior:'smooth', block:'center'});
        els.count.textContent = `1/${state.matchNodes.length}`;
      }else{
        els.count.textContent = '0/0';
      }

      setBusy(false);
    }

    // Clique BUSCAR (√≠cone)
    els.searchBtn.addEventListener('click', ()=>{
      const term = els.searchInput.value.trim();
      highlightTermChunked(term);
    });
    // Clique LIMPAR (√≠cone)
    els.clearBtn.addEventListener('click', ()=>{
      els.searchInput.value = '';
      clearMarks();
    });
    // Enter = buscar; Esc = limpar
    els.searchInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        els.searchBtn.click();
      }else if (e.key === 'Escape'){
        e.preventDefault();
        els.clearBtn.click();
      }
    });

    // Navega√ß√£o entre ocorr√™ncias
    els.nextBtn.addEventListener('click', ()=>{
      if (!state.matchNodes.length) return;
      state.matchIdx = (state.matchIdx + 1) % state.matchNodes.length;
      const m = state.matchNodes[state.matchIdx];
      m.scrollIntoView({behavior:'smooth',block:'center'});
      els.count.textContent = `${state.matchIdx+1}/${state.matchNodes.length}`;
    });
    els.prevBtn.addEventListener('click', ()=>{
      if (!state.matchNodes.length) return;
      state.matchIdx = (state.matchIdx - 1 + state.matchNodes.length) % state.matchNodes.length;
      const m = state.matchNodes[state.matchIdx];
      m.scrollIntoView({behavior:'smooth',block:'center'});
      els.count.textContent = `${state.matchIdx+1}/${state.matchNodes.length}`;
    });

    /* ================= ESTUDAR (gera prompt + modal) ================= */
    function getCurrentArticleBlock(){
      if (!state.blocks.length) return null;
      const idx = state.currentArticleIdx ?? -1;
      if (idx < 0) return null;
      return state.blocks.find(b => b.type==='article' && b.articleIdx === idx) || null;
    }
    function extractArticleLabel(b){
      const { label } = splitArticleLabelAndBody(b?.text || '');
      return label || 'Artigo';
    }
    function buildPrompt(b){
      const artigo = b?.text || '';
      const primeiraLinha = artigo.split(/\r?\n/)[0]?.trim() || '';
      const tema = primeiraLinha || extractArticleLabel(b);
      return [
        'Assuma a persona de um professor de Direito experiente convidado pelo direito.love e gere um material de estudo r√°pido. ',
        'Analise detalhadamente todo o artigo abaixo (caput, paragrafos, incisos e alineas), cobrindo: ',
        '(1) conceito com vis√£o doutrin√°ria, jurisprud√™ncia majorit√°ria e pr√°tica; ',
        '(2) mini exemplo pr√°tico; ',
        '(3) checklist essencial; ',
        '(4) erros comuns e pegadinhas de prova; ',
        '(5) Pontos de aten√ß√£o na pr√°tica jur√≠dica; ',
        '(6) Princ√≠pios Relacionados ao tema; ',
        '(7) nota comparativa se houver artigos correlatos. ',
        'Responda em portugu√™s claro, sem enrola√ß√£o, objetivo e did√°tico.\n\n',
        `Tema: "${tema}"\n\n`,
        artigo,
        '\n\nüíö direito.love'
      ].join('');
    }

    function isStandalone(){
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }
    function openIA(url){
      showToast('Abrindo‚Ä¶');
      if (isStandalone()){ location.href = url; }
      else{ window.open(url, '_blank', 'noopener,noreferrer'); }
    }
    document.querySelectorAll('.ia-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> openIA(btn.dataset.url));
    });

    function openModal(title){
      els.modalTitle.textContent = `Estude o ${title} com as I.As. abaixo.`;
      els.modalBackdrop.style.display = 'flex';
      els.modalBackdrop.setAttribute('aria-hidden','false');
      const first = els.modalBackdrop.querySelector('.ia-btn'); first?.focus();
    }
    function closeModal(){
      els.modalBackdrop.style.display = 'none';
      els.modalBackdrop.setAttribute('aria-hidden','true');
    }
    els.closeModal.addEventListener('click', closeModal);
    els.modalBackdrop.addEventListener('click', (e)=>{
      if (e.target === els.modalBackdrop) closeModal();
    });
    document.addEventListener('keydown', (e)=>{
      if (els.modalBackdrop.style.display === 'flex' && e.key === 'Escape') closeModal();
    });

    els.studyBtn.addEventListener('click', async ()=>{
      const b = getCurrentArticleBlock();
      if (!b){ showToast('Posicione um artigo na tela.'); return; }

      document.querySelectorAll('article.highlight-study').forEach(n=>n.classList.remove('highlight-study'));
      const aEl = document.querySelector(`article[data-idx="${b.articleIdx}"]`);
      aEl?.classList.add('highlight-study');

      const prompt = buildPrompt(b);
      try{ await navigator.clipboard.writeText(prompt); showToast('‚úÖ Prompt copiado!'); }
      catch{ showToast('Copie manualmente no pr√≥ximo passo.'); }

      openModal(extractArticleLabel(b));
    });

    /* ================= Reset (logo) ================= */
    function resetAll(){
      state.rawText = '';
      state.blocks = [];
      state.currentArticleIdx = -1;
      state.matchNodes = [];
      state.matchIdx = -1;

      els.searchInput.value = '';
      els.count.textContent = '0/0';
      els.bottomSearch.hidden = true;
      els.bottomStudy.hidden = true;
      els.articles.innerHTML = '<div class="placeholder">Selecione um arquivo na barra superior.<br>Regras: <strong>cada Artigo inicia em ‚ÄúArt‚Äù</strong> (A mai√∫sculo) e <strong>termina na pr√≥xima ‚Äú-----‚Äù</strong>. T√≠tulos/cap√≠tulos fora dos artigos aparecem em negrito suave.</div>';
      els.codeSelect.value = '';
      document.querySelectorAll('.highlight-study,.current-outline').forEach(n=>n.classList.remove('highlight-study','current-outline'));
      closeModal();
      window.scrollTo({top:0});
    }
    els.brandBtn.addEventListener('click', resetAll);

    /* ================= Carregar TXT ================= */
    els.codeSelect.addEventListener('change', async (e)=>{
      const url = e.target.value;
      if (!url){ resetAll(); return; }
      els.articles.innerHTML = '<div class="placeholder">Carregando‚Ä¶</div>';
      try{
        const res = await fetch(url, {cache:'reload'});
        const txt = await res.text();
        state.rawText = txt;

        state.blocks = parseBlocksFromText(txt);
        renderBlocks();
        clearMarks();
        window.scrollTo({top:0});
      }catch(err){
        console.error(err);
        els.articles.innerHTML = '<div class="placeholder">Falha ao carregar o arquivo. Verifique o caminho em /data/.</div>';
        els.bottomSearch.hidden = true; els.bottomStudy.hidden = true;
      }
    });

    document.addEventListener('DOMContentLoaded', ()=>updateCurrentOutline());
  </script>
</body>
</html>
