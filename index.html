<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>direito.love — Pesquisa por Código e Artigo</title>
<meta name="theme-color" content="#0B3A82" />
<style>
  :root{
    --bg:#f6f7fb; --surface:#fff; --text:#0b1220; --muted:#475569; --border:#cbd5e1;
    --primary:#0b3a82; --primary-2:#0a2f6a; --radius:14px; --shadow:0 8px 22px rgba(10,15,25,.06);
    --chip:#eef2ff; --chip-b:#c7d2fe; --mark:#fff59e; --ok:#15803d; --danger:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:400 14px/1.55 -apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif}
  .topbar{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--border)}
  .topbar__inner{max-width:1000px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand__logo{width:22px;height:22px;border-radius:6px;background:#16a34a;display:inline-block}
  .brand__txt{font-weight:700;letter-spacing:.2px}
  .wrap{max-width:1000px;margin:0 auto;padding:18px}
  h1{margin:8px 0 14px;font-size:18px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:12px 0}
  .grid3{display:grid;grid-template-columns: 1.1fr .6fr 1.2fr auto;gap:10px}
  @media (max-width:840px){ .grid3{grid-template-columns:1fr} }
  select,input,button{height:40px;border-radius:10px;border:1.4px solid var(--border);background:#fff;color:var(--text);font-size:14px;padding:8px 12px}
  input:focus,select:focus{outline:2px solid var(--primary);outline-offset:2px}
  button{border-color:#0b3a82;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
  button:hover{background:var(--primary-2)}
  .btn-light{background:#fff;color:#0b1220;border-color:var(--border)}
  .muted{color:var(--muted)}
  .hint{font-size:12.5px;margin-top:6px}
  .result{border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#fff}
  .title{font-weight:700;margin:0 0 4px}
  .tag{display:inline-block;margin-right:8px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px;font-weight:600}
  .caps{font-variant-caps:all-small-caps;letter-spacing:.4px}
  mark{background:var(--mark)}
  .empty{padding:10px;border:1px dashed var(--border);border-radius:10px;background:#fff}
  details{border-top:1px dashed var(--border);margin-top:8px;padding-top:8px}
  .count{font-weight:700}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--danger);font-weight:700}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  code.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12.5px}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar__inner">
    <span class="brand" aria-label="direito.love">
      <span class="brand__logo" aria-hidden="true"></span>
      <span class="brand__txt">direito.love</span>
    </span>
  </div>
</header>

<main class="wrap">
  <section class="card" role="search" aria-label="Formulário de busca">
    <h1>Pesquisa por Código, Artigo e Termos</h1>
    <div class="grid3">
      <!-- 1) Seletor de códigos -->
      <label class="sr-only" for="codigo">Selecione o código</label>
      <select id="codigo" aria-label="Código (ex.: Código Penal)">
        <option value="" selected>— Selecione o Código —</option>
        <option value="codigo_penal">Código Penal</option>
        <option value="codigo_civil">Código Civil</option>
        <option value="codigo_processo_civil">Código de Processo Civil (CPC)</option>
        <option value="codigo_processo_penal">Código de Processo Penal (CPP)</option>
        <option value="codigo_tributario_nacional">Código Tributário Nacional</option>
        <option value="codigo_defesa_consumidor">Código de Defesa do Consumidor</option>
        <option value="codigo_transito_brasileiro">Código de Trânsito Brasileiro</option>
        <option value="codigo_eleitoral">Código Eleitoral</option>
        <option value="codigo_florestal">Código Florestal</option>
        <option value="codigo_das_aguas">Código das Águas</option>
      </select>

      <!-- 2) Número do artigo -->
      <div>
        <label class="sr-only" for="artnum">Número do artigo</label>
        <input id="artnum" inputmode="numeric" pattern="[0-9]*" placeholder="Número do artigo (ex.: 121)" aria-label="Número do artigo (digite apenas números)" />
        <div class="hint muted">Digite só o número (ex.: 121). Casa em <span class="caps">titulo</span> (“Art. 121”).</div>
      </div>

      <!-- 3) Termos -->
      <div>
        <label class="sr-only" for="termos">Buscar por termos (5+ letras)</label>
        <input id="termos" placeholder="Termos (ex.: anterioridade retroatividade temporária)" aria-label="Termos de busca" />
        <div class="hint muted">Considera apenas palavras com 5+ letras e exige que <b>todas</b> apareçam no artigo.</div>
      </div>

      <!-- Botões -->
      <div class="toolbar">
        <button id="btnBuscar" type="button" aria-label="Buscar">Buscar</button>
        <button id="btnLimpar" class="btn-light" type="button" aria-label="Limpar">Limpar</button>
      </div>
    </div>
  </section>

  <section id="status" class="card" style="display:none" aria-live="polite"></section>

  <section id="resultados" class="card" style="display:none">
    <div id="resumo" class="muted" style="margin-bottom:8px"></div>
    <div id="lista"></div>
  </section>
</main>

<script>
(function(){
  // ======= Helpers =======
  const $ = (s,r=document)=>r.querySelector(s);
  const $$= (s,r=document)=>[...r.querySelectorAll(s)];

  const codigoSel = $('#codigo');
  const artnumInp = $('#artnum');
  const termosInp = $('#termos');
  const btnBuscar = $('#btnBuscar');
  const btnLimpar = $('#btnLimpar');
  const statusBox = $('#status');
  const resBox = $('#resultados');
  const resumo = $('#resumo');
  const lista = $('#lista');

  // Mapear arquivos dos códigos (coloque seus JSONs em /data/)
  const CODE_FILE = {
    codigo_penal: 'data/codigo_penal.json',
    codigo_civil: 'data/codigo_civil.json',
    codigo_processo_civil: 'data/codigo_processo_civil.json',
    codigo_processo_penal: 'data/codigo_processo_penal.json',
    codigo_tributario_nacional: 'data/codigo_tributario_nacional.json',
    codigo_defesa_consumidor: 'data/codigo_defesa_consumidor.json',
    codigo_transito_brasileiro: 'data/codigo_transito_brasileiro.json',
    codigo_eleitoral: 'data/codigo_eleitoral.json',
    codigo_florestal: 'data/codigo_florestal.json',
    codigo_das_aguas: 'data/codigo_das_aguas.json'
  };
  const CODE_NAME = {
    codigo_penal: 'Código Penal',
    codigo_civil: 'Código Civil',
    codigo_processo_civil: 'Código de Processo Civil',
    codigo_processo_penal: 'Código de Processo Penal',
    codigo_tributario_nacional: 'Código Tributário Nacional',
    codigo_defesa_consumidor: 'Código de Defesa do Consumidor',
    codigo_transito_brasileiro: 'Código de Trânsito Brasileiro',
    codigo_eleitoral: 'Código Eleitoral',
    codigo_florestal: 'Código Florestal',
    codigo_das_aguas: 'Código das Águas'
  };

  const cache = new Map();

  // Normaliza: remove acento e baixa
  const norm = s => (s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();

  // Só dígitos
  const onlyDigits = s => (s||'').replace(/\D+/g,'');
  artnumInp.addEventListener('input', ()=>{ artnumInp.value = onlyDigits(artnumInp.value); });

  // Extrai termos de 5+ letras
  function extractTerms(raw){
    return (norm(raw).match(/[a-z]{5,}/g)||[]);
  }

  // Pega número do título "Art. N"
  function getArtNumberFromTitulo(titulo){
    const m = (titulo||'').match(/^\s*Art\.?\s*(\d+)\b/i);
    return m ? m[1] : null;
  }

  // Coleta strings de todas as chaves relevantes
  function flattenText(article){
    let parts = [];
    if (article.caput) parts.push(article.caput);
    if (article.texto) parts.push(article.texto);
    const ps = Array.isArray(article.paragrafos) ? article.paragrafos : [];
    for (const p of ps){
      if (p && p.texto) parts.push(p.texto);
      const incs = Array.isArray(p?.incisos) ? p.incisos : [];
      for (const inc of incs){
        if (inc && inc.texto) parts.push(inc.texto);
        const als = Array.isArray(inc?.alineas) ? inc.alineas : [];
        for (const a of als){ if (a) parts.push(a); }
      }
    }
    return parts.join(' ');
  }

  // Destaque acento-insensível por palavra (5+)
  function highlight(text, terms){
    if(!text) return '';
    if(!terms || !terms.length) return escapeHtml(text);

    const tset = new Set(terms.map(t=>t)); // termos já normalizados
    // Percorre por palavras unicode (letras/diacríticos)
    let out = '';
    let last = 0;
    const re = /([\p{L}\p{M}]+)/gu; // grupos de letras (com acentos)
    let m;
    while ((m = re.exec(text)) !== null){
      const start = m.index;
      const end = start + m[0].length;
      const word = m[0];
      out += escapeHtml(text.slice(last, start));
      if (tset.has(norm(word))) {
        out += '<mark>' + escapeHtml(word) + '</mark>';
      } else {
        out += escapeHtml(word);
      }
      last = end;
    }
    out += escapeHtml(text.slice(last));
    return out;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[c]));
  }

  // Renderização
  function renderItem(codeKey, article, terms){
    const card = document.createElement('div');
    card.className = 'result';

    const head = document.createElement('div');
    head.innerHTML = `
      <div class="tag">${CODE_NAME[codeKey]||codeKey}</div>
      <div class="title">${escapeHtml(article.titulo||'(sem título)')}</div>
    `;
    card.appendChild(head);

    const cap = document.createElement('div');
    cap.innerHTML = article.caput ? highlight(article.caput, terms) : '<span class="muted">Sem caput.</span>';
    card.appendChild(cap);

    const det = document.createElement('details');
    const sum = document.createElement('summary');
    sum.textContent = 'Ver detalhes';
    det.appendChild(sum);

    const body = document.createElement('div');

    // Parágrafos / Incisos / Alíneas
    if (Array.isArray(article.paragrafos) && article.paragrafos.length){
      const ulP = document.createElement('ul');
      for (const [pi, p] of article.paragrafos.entries()){
        const liP = document.createElement('li');
        const pLabel = '§ ' + (pi+1) + (p?.texto ? '.' : '');
        liP.innerHTML = `<b>${pLabel}</b> ${p?.texto ? highlight(p.texto, terms) : '<span class="muted">[sem texto]</span>'}`;

        if (Array.isArray(p?.incisos) && p.incisos.length){
          const ulI = document.createElement('ul');
          for (const [ii, inc] of p.incisos.entries()){
            const liI = document.createElement('li');
            const incText = inc?.texto ? highlight(inc.texto, terms) : '<span class="muted">[inciso sem texto]</span>';
            liI.innerHTML = `<b>Inciso ${ii+1}.</b> ${incText}`;

            if (Array.isArray(inc?.alineas) && inc.alineas.length){
              const ulA = document.createElement('ul');
              for (const [ai, al] of inc.alineas.entries()){
                const liA = document.createElement('li');
                liA.innerHTML = `<b>Alínea ${String.fromCharCode(97+ai)})</b> ${highlight(String(al||''), terms)}`;
                ulA.appendChild(liA);
              }
              liI.appendChild(ulA);
            }
            ulI.appendChild(liI);
          }
          liP.appendChild(ulI);
        }
        ulP.appendChild(liP);
      }
      body.appendChild(ulP);
    } else {
      const empty = document.createElement('div');
      empty.className = 'empty muted';
      empty.textContent = 'Sem parágrafos/incisos cadastrados.';
      body.appendChild(empty);
    }

    det.appendChild(body);
    card.appendChild(det);
    return card;
  }

  function showStatus(msg, ok=true){
    statusBox.style.display = 'block';
    statusBox.innerHTML = `<span class="${ok?'ok':'bad'}">${ok?'✔':'✖'}</span> ${escapeHtml(msg)}`;
  }
  function clearStatus(){ statusBox.style.display = 'none'; statusBox.textContent = ''; }
  function clearResults(){
    resBox.style.display = 'none'; resumo.textContent = ''; lista.innerHTML = '';
  }

  async function loadCode(codeKey){
    const file = CODE_FILE[codeKey];
    if (!file) throw new Error('Código não suportado.');
    if (cache.has(codeKey)) return cache.get(codeKey);
    const r = await fetch(file, {cache:'no-store'});
    if(!r.ok) throw new Error('Falha ao carregar o arquivo do código.');
    const data = await r.json();
    cache.set(codeKey, Array.isArray(data)?data:[]);
    return cache.get(codeKey);
  }

  function filterData(data, artNum, terms){
    const wantsArt = !!artNum;
    const wantsTerms = terms.length>0;

    return data.filter(item=>{
      // 1) Filtro pelo número do artigo (no "titulo")
      if (wantsArt){
        const n = getArtNumberFromTitulo(item.titulo||'');
        if (!n || String(n)!==String(artNum)) return false;
      }

      // 2) Filtro por termos (todas as palavras com 5+ letras)
      if (wantsTerms){
        const blob = norm(flattenText(item));
        for (const t of terms){
          if (!blob.includes(t)) return false;
        }
      }

      return true;
    });
  }

  function runSearch(){
    clearStatus();
    clearResults();

    const codeKey = codigoSel.value;
    if(!codeKey){
      showStatus('Selecione um código para buscar.', false);
      return;
    }

    const artNum = onlyDigits(artnumInp.value);
    const terms = extractTerms(termosInp.value);

    // UX: se digitou coisa curta em termos, orienta
    if (!artNum && termosInp.value.trim() && terms.length===0){
      showStatus('Os termos devem ter 5+ letras. Ajuste sua busca.', false);
      return;
    }

    showStatus('Carregando base do '+(CODE_NAME[codeKey]||codeKey)+'…');

    loadCode(codeKey).then(data=>{
      showStatus('Base carregada. Processando busca…');

      const results = filterData(data, artNum, terms);
      resBox.style.display = 'block';
      const count = results.length;

      const parts = [];
      parts.push(`<span class="count">${count}</span> resultado${count!==1?'s':''}`);
      if (artNum) parts.push(`• Artigo <b>${escapeHtml(artNum)}</b> (em <span class="caps">titulo</span>)`);
      if (terms.length){
        parts.push('• Termos: '+terms.map(t=>`<code class="pill">${escapeHtml(t)}</code>`).join(' '));
      }
      resumo.innerHTML = parts.join(' ');

      if (count===0){
        const div = document.createElement('div');
        div.className = 'empty';
        div.innerHTML = 'Nenhum resultado. Tente: escolher outro código, ajustar o número do artigo, ou usar termos com 5+ letras.';
        lista.appendChild(div);
      } else {
        const frag = document.createDocumentFragment();
        for (const it of results){
          frag.appendChild(renderItem(codeKey, it, terms));
        }
        lista.appendChild(frag);
      }

      clearStatus();
    }).catch(err=>{
      showStatus('Erro: '+(err?.message||'falha ao carregar dados.'), false);
    });
  }

  btnBuscar.addEventListener('click', runSearch);
  btnLimpar.addEventListener('click', ()=>{
    codigoSel.value = '';
    artnumInp.value = '';
    termosInp.value = '';
    clearStatus(); clearResults();
    codigoSel.focus();
  });

  // Enter envia busca
  [codigoSel, artnumInp, termosInp].forEach(el=>{
    el.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); runSearch(); }
    });
  });
})();
</script>
</body>
</html>
