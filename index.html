<script>
  // ===== Frase aleatória =====
  const QUOTES=['Não há liberdade sem lei. — Montesquieu','A justiça sem força é impotente; a força sem justiça é tirana. — Pascal'];
  function loadRandomQuote(){
    const pick=QUOTES[Math.floor(Math.random()*QUOTES.length)];
    const parts=pick.split('—');
    document.getElementById('quote').textContent=(parts[0]||pick).trim();
    document.getElementById('author').textContent=parts[1]?'— '+parts[1].trim():'';
  }
  loadRandomQuote();

  // ===== Tabs =====
  const tabIds=['gerador','book','dicas'];
  function activateTab(id){
    for(const t of tabIds){
      document.getElementById('tab-'+t).classList.toggle('is-active',t===id);
      document.getElementById('tabbtn-'+t)?.setAttribute('aria-selected',String(t===id));
      document.getElementById('m-tabbtn-'+t)?.setAttribute('aria-selected',String(t===id));
    }
  }
  for(const t of tabIds){
    document.getElementById('tabbtn-'+t)?.addEventListener('click',()=>activateTab(t));
    document.getElementById('m-tabbtn-'+t)?.addEventListener('click',()=>activateTab(t));
  }

  // ===== PWA: Service Worker =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // ===== PWA: POPUP (sem barra fixa) =====
  (function () {
    const popup = document.getElementById('pwa-popup');
    const btnInstall = document.getElementById('pwa-install');
    const btnClose = document.getElementById('pwa-close');
    const btnX = document.getElementById('pwa-x');
    const msg = document.getElementById('pwa-msg');

    const REAPPEAR_DAYS = 7, MS = 86400000;
    const KEY_DISMISSED_AT = 'pwa_popup_dismissed_at';
    const KEY_INSTALLED = 'pwa_popup_installed';

    const standalone = matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;
    if (standalone) { localStorage.setItem(KEY_INSTALLED,'1'); return; }
    if (localStorage.getItem(KEY_INSTALLED)==='1') return;

    const lastDismiss = Number(localStorage.getItem(KEY_DISMISSED_AT) || 0);
    const blocked = lastDismiss && (Date.now() - lastDismiss) < (REAPPEAR_DAYS * MS);
    if (blocked) return;

    let deferredPrompt = null;
    let shown = false;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (!shown){ popup.style.display='block'; shown=true; }
    });

    const ua = navigator.userAgent;
    const isIOS = /iphone|ipad|ipod/i.test(ua);
    const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    if (isIOS && isSafari) {
      setTimeout(()=>{ msg.innerHTML='No iPhone: toque em <b>Compartilhar</b> → <b>Adicionar à Tela de Início</b>.'; popup.style.display='block'; shown=true; }, 400);
    }

    setTimeout(()=>{ 
      if (!shown){ msg.innerHTML='No Android: três pontinhos do Chrome → <b>Adicionar à tela inicial</b>.'; popup.style.display='block'; shown=true; }
    }, 6000);

    function closePopup(){
      localStorage.setItem(KEY_DISMISSED_AT, String(Date.now()));
      popup.style.display='none';
    }
    btnClose.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closePopup(); });
    btnX.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closePopup(); });

    btnInstall.addEventListener('click', async (e) => {
      e.preventDefault(); e.stopPropagation();
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice.catch(()=>{});
        deferredPrompt = null;
        closePopup();
        return;
      }
      alert('No Android/Chrome: toque nos três pontinhos → "Adicionar à tela inicial".');
    });

    window.addEventListener('appinstalled', () => {
      localStorage.setItem(KEY_INSTALLED,'1');
      popup.style.display='none';
    });
  })();

  // ====== GERADOR: TEMPLATES COMPLETOS ======
  const TEMPLATES = {
    explicacao: (tema) => `Você é um **tutor de Direito** no Brasil, especialista em didática jurídica.
Persona: professor paciente e criativo, que explica para iniciantes.
Linguagem: simples, clara, sem juridiquês; use analogias.

Tarefa: Explique o tema **${tema}**.
Estrutura:
1) Definição essencial (até 3 linhas).
2) 2–3 analogias do cotidiano.
3) 3 pontos-chave (o que é, para que serve, onde se aplica).
4) 2 erros comuns dos alunos + forma correta.
5) Mini-exemplo prático.

Recursos: headings (H2–H3), listas, parágrafos curtos.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: síntese (2 frases) + fontes (até 5).`,

    resumo: (tema) => `Você é um **professor universitário de Direito** no Brasil, especialista em provas da OAB e concursos.
Persona: objetivo e estratégico, como quem monta checklists.
Linguagem: direta, sem floreios.

Tarefa: Resuma **${tema}** em formato RAIO-X.
Inclua:
1) Conceito-chave (até 2 linhas);
2) Base legal essencial (artigos);
3) Estrutura/elementos;
4) Diferenças fáceis de confundir (3 pares);
5) Tendências jurisprudenciais;
6) 3 pegadinhas de prova;
7) 2 mini-cases resolvidos.

Recursos: tópicos numerados, negrito nos termos centrais.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: resumo de bolso (2 frases) + fontes (até 5).`,

    artigo: (tema) => `Você é um **jurista pesquisador**, especialista em produção acadêmica.
Persona: acadêmico crítico, mas acessível.
Linguagem: técnica, formal, sem excesso; parágrafos curtos.

Tarefa: Produza artigo acadêmico sobre **${tema}**.
Estrutura:
# Introdução: problema, relevância prática e hipótese.
# Desenvolvimento: conceitos centrais, evolução histórica, correntes doutrinárias (prós/contrás), análise crítica, tendências jurisprudenciais, (opcional: direito comparado).
# Conclusão: síntese crítica + proposta prática.

Recursos: headings H1–H4, listas quando cabíveis, destaques em **negrito**.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: resumo final (2 frases) + referências (até 5).`,

    aplicacao: (tema) => `Você é um **advogado experiente e professor de prática jurídica**.
Persona: prático, direto, como quem treina estagiários.
Linguagem: clara, com exemplos.

Tarefa: Mostre como aplicar **${tema}** na prática.
Estrutura:
1) Caso fictício realista.
2) Enquadramento jurídico (fundamentos e raciocínio).
3) Solução provável (e alternativas).
4) Mini-modelo de peça (endereçamento, fatos, fundamentos, pedidos).
5) Checklist (3–5 pontos).

Recursos: listas, blocos de texto para peças.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: resumo executivo (2 frases) + fontes (até 5).`,

    simulado: (tema) => `Você é um **examinador da OAB** montando questões sobre ${tema}.
Persona: avaliador exigente, mas didático no comentário.
Linguagem: objetiva, estilo prova.

Tarefa: Crie 5 questões sobre **${tema}**.
Estrutura:
- 2 fáceis, 2 médias, 1 difícil.
- Estilo múltipla escolha ou discursiva curta.
- Gabarito comentado logo após cada questão.

Recursos: blocos por questão; resposta correta em **negrito**.
Regras: sem links; jurisprudência só se 100% segura.

Fecho: 3 dicas práticas de estudo + fontes (até 5).`,

    faq: (tema) => `Você é um **monitor de Direito** explicando conceitos básicos.
Persona: colega didático, rápido e claro.
Linguagem: simples, sem juridiquês.

Tarefa: Responda dúvidas rápidas sobre **${tema}**.
Estrutura:
- 15 perguntas essenciais.
- Respostas em até 3 linhas.
- 2 confusões comuns + a forma correta.

Recursos: pergunta em **negrito**, resposta em texto normal.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: resumo de bolso (2 frases) + fontes (até 5).`,

    debate: (tema) => `Você é um **professor de Filosofia do Direito** mediando debate sobre ${tema}.
Persona: provocador crítico, mas neutro.
Linguagem: reflexiva e clara.

Tarefa: Promova um debate sobre **${tema}**.
Estrutura:
1) Problema central (até 4 linhas).
2) 3 argumentos pró.
3) 3 argumentos contra.
4) 1 dilema ético ou prático.
5) Perguntas-guia para discussão.

Recursos: listas; destaques em **negrito**.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: síntese imparcial (2 frases) + fontes (até 5).`,

    atualizacao: (tema) => {
      const d=new Date();
      const data=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      return `Você é um **jurista analista de legislação e jurisprudência**.
Persona: atualizado, conecta norma e impacto prático.
Linguagem: clara, objetiva.

Tarefa: Traga panorama atualizado sobre **${tema}** (até ${data}).
Estrutura:
1) Alterações legislativas recentes.
2) Tendências jurisprudenciais atuais.
3) Impactos práticos (provas e advocacia).
4) Pontos controversos e cuidados.

Recursos: subtítulos H3; destaque artigos em **negrito**.
Regras: sem links; enunciados, súmulas e jurisprudência só se 100% segura.

Fecho: resumo (2 frases) + fontes (até 5).`;
    },

    plano: (tema) => `Você é um **coach de estudos jurídicos** especialista em memorização.
Persona: motivador, organizado.
Linguagem: objetiva e encorajadora.

Tarefa: Crie plano de estudo sobre **${tema}** para 4 semanas.
Estrutura:
1) Objetivo do ciclo.
2) Cronograma semanal (Semana 1–4).
3) Rotina de revisão espaçada (1-1-7-15).
4) Exercícios práticos.
5) Erros comuns e como evitar.

Recursos: listas e tabela simples em texto.
Regras: sem links.

Fecho: frase motivadora (2 linhas) + fontes (até 5).`,

    sustentacao: (tema) => `Você é um **professor-orientador de Direito**.
Persona: colega didático, rápido e claro.
Linguagem: simples e persuasiva.

Tarefa: Simule uma apresentação oral de até 4 minutos (~400–500 palavras) sobre **${tema}**.
Estrutura:
1) Abertura chamativa.
2) Contexto e relevância jurídica/social.
3) Desenvolvimento: definição, base legal, doutrina e jurisprudência segura, caso ilustrativo.
4) Argumentação persuasiva.
5) Fechamento forte.

Regras: sem links; cite enunciados/súmulas só se 100% seguro.

Fecho: frase de impacto + fontes (até 5).`,

    jurisprudencia: (tema) => `Você é um **jurista analista de jurisprudência**.
Persona: pesquisador criterioso, atualizado.
Linguagem: clara e técnica.

Tarefa: Monte um radar de **jurisprudência** sobre **${tema}** com 15 itens verificados (tribunal, nº/ano, tese resumida e impacto prático).
Regras:
- Não invente decisões.
- Use apenas fontes confiáveis.
- Sem links se não tiver certeza absoluta.
Saída: lista numerada de 15 itens.`
  };

  // ====== GERADOR: handlers ======
  const strategyEl=document.getElementById('strategy');
  const themeEl=document.getElementById('theme');
  const resultEl=document.getElementById('result');
  const btnGen=document.getElementById('generate');
  const btnCopy=document.getElementById('copy');
  const btnReset=document.getElementById('reset');

  function strategyHumanName(v){
    const map={
      explicacao:'Explicação Básica',
      resumo:'Resumo Objetivo',
      artigo:'Análise Detalhada',
      aplicacao:'Aplicação Prática',
      simulado:'Exercícios/Testes',
      faq:'FAQ',
      debate:'Debate/Reflexão',
      atualizacao:'Contexto Atualizado',
      plano:'Plano de Estudo',
      sustentacao:'Apresentação em Sala',
      jurisprudencia:'Jurisprudência'
    }; return map[v]||v;
  }

  function generate(){
    const s = strategyEl.value; const t = (themeEl.value||'').trim();
    if(!s){ alert('Selecione o objetivo.'); return; }
    if(!t){ alert('Digite o tema.'); themeEl.focus(); return; }
    const tpl = TEMPLATES[s];
    if(!tpl){ alert('Estratégia inválida. Atualize a página.'); return; }
    const out = tpl(t);
    resultEl.value = out;

    // Book local
    let bookData=[]; 
    try{ bookData = JSON.parse(localStorage.getItem('book_data_v1')||'[]'); if(!Array.isArray(bookData)) bookData=[]; }catch{ bookData=[]; }
    const entry = { objetivo: strategyHumanName(s), tema: t, prompt: out, ts: Date.now() };
    bookData.unshift(entry);
    if(bookData.length>500) bookData = bookData.slice(0,500);
    try{ localStorage.setItem('book_data_v1', JSON.stringify(bookData)); }catch{}

    // Se Book estiver aberto, re-renderiza
    if(document.getElementById('tab-book').classList.contains('is-active')){ clearBookUI(); renderBatch(); }

    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  }

  async function copyOut(){
    if(!resultEl.value) return alert('Nada para copiar.');
    try{
      await navigator.clipboard.writeText(resultEl.value);
      const old = btnCopy.textContent; btnCopy.textContent='COPIADO'; btnCopy.disabled=true;
      setTimeout(()=>{ btnCopy.textContent=old; btnCopy.disabled=false; }, 1200);
    }catch{
      const ta = document.createElement('textarea'); ta.value = resultEl.value; ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta); ta.focus(); ta.select();
      try{ document.execCommand('copy'); const old = btnCopy.textContent; btnCopy.textContent='COPIADO'; btnCopy.disabled=true; setTimeout(()=>{ btnCopy.textContent=old; btnCopy.disabled=false; }, 1200); }
      catch{ alert('Não foi possível copiar.'); }
      finally{ document.body.removeChild(ta); }
    }
  }
  function resetAll(){ strategyEl.value=''; themeEl.value=''; resultEl.value=''; window.scrollTo({top:0,behavior:'smooth'}); }

  btnGen?.addEventListener('click', generate);
  btnCopy?.addEventListener('click', copyOut);
  btnReset?.addEventListener('click', resetAll);
  themeEl?.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='enter'){generate();}});

  // ===== Book (persistência local) =====
  const BOOK_KEY='book_data_v1';
  const PAGE_SIZE=10;
  let bookData=[]; let bookCursor=0; const bookWrap=document.getElementById('book-list');

  function loadBook(){ try{ bookData = JSON.parse(localStorage.getItem(BOOK_KEY)||'[]'); if(!Array.isArray(bookData)) bookData=[]; }catch{ bookData=[]; } }
  function truncate150(s){return (s||'').length>150?s.slice(0,150)+'…':s}
  function clearBookUI(){ if(bookWrap){ bookWrap.innerHTML=''; bookCursor=0; } }
  function renderBatch(){
    if(!bookWrap) return; const end=Math.min(bookCursor+PAGE_SIZE, bookData.length); const frag=document.createDocumentFragment();
    for(let i=bookCursor;i<end;i++){
      const {objetivo,tema,prompt}=bookData[i];
      const el=document.createElement('div'); el.className='book-item';
      el.innerHTML=`<div class="book-meta"><div class="book-obj">${objetivo||'—'}</div><div class="book-tema">${truncate150(tema||'')}</div></div><div><button class="chipbtn" data-prompt="${String(prompt||'').replace(/"/g,'&quot;')}">Copiar</button></div>`;
      frag.appendChild(el);
    }
    bookWrap.appendChild(frag); bookCursor=end;
  }
  function onScroll(){ if(!bookWrap) return; const near=bookWrap.scrollTop+bookWrap.clientHeight>=bookWrap.scrollHeight-8; if(near && bookCursor<bookData.length) renderBatch(); }
  bookWrap?.addEventListener('scroll', onScroll);
  const _activate=activateTab; activateTab=function(id){ _activate(id); if(id==='book'){ if(!bookData.length){ loadBook(); } if(bookCursor===0){ renderBatch(); } } }

  // Delegação: copiar item do book
  document.addEventListener('click',async e=>{
    const btn=e.target.closest('.chipbtn'); if(!btn||!btn.dataset.prompt) return;
    try{ await navigator.clipboard.writeText(btn.dataset.prompt); btn.textContent='Copiado!'; setTimeout(()=>btn.textContent='Copiar',1000);}catch{ alert('Não foi possível copiar.'); }
  });
</script>
