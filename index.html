<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>direito.love — Estudo Jurídico com IA</title>
<meta name="theme-color" content="#0F172A" />
<link rel="icon" href="favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="favicon-180.png" />
<link rel="manifest" href="manifest.json" />
<style>
  :root{
    /* Paleta com alto contraste */
    --bg:#0B1220;            /* fundo escuro elegante */
    --surface:#0F172A;       /* cartões */
    --text:#E6EAF2;          /* texto primário */
    --subtext:#A7B0C0;       /* texto secundário */
    --border:rgba(255,255,255,.12);

    --primary:#7CC4FF;       /* ação principal */
    --primary-700:#3CA0F4;
    --accent:#F5C400;        /* destaque brand */
    --success:#22C55E;
    --danger:#F43F5E;

    --radius:12px; --shadow:0 6px 24px rgba(0,0,0,.35);
    --font: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, system-ui, sans-serif;

    --btn-pad-y:7px; --btn-pad-x:12px; --btn-font:13px; --btn-min-h:34px;
    --chip-radius:999px;
    --mark-bg:#154c2a;       /* marca-texto: verde escuro translúcido */
    --mark-tint:#C8FACC;     /* texto marcado */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0B1220,#0B1220 40%,#0C1628);color:var(--text);font:400 14px/1.55 var(--font);}

  /* Topbar minimalista */
  .topbar{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .topbar__inner{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand__logo{height:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4))}
  .topbar__actions{display:flex;align-items:center;gap:8px}
  .iconbtn{
    appearance:none;border:1px solid var(--border);background:transparent;color:var(--text);
    width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;
    transition:.15s;
  }
  .iconbtn:hover{background:rgba(255,255,255,.06)}
  .iconbtn svg{width:18px;height:18px;display:block;stroke:var(--text)}

  .wrap{max-width:980px;margin:0 auto;padding:22px}
  h1{margin:6px 0 8px;color:#F8FAFC;font-weight:600;letter-spacing:.2px;font-size:20px}
  .muted{color:var(--subtext)}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:14px 0}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #tema{
    flex:1;padding:12px 14px;border:1px solid var(--border);background:#0B1220;color:var(--text);
    border-radius:10px;font-size:15px;outline: none;
  }
  #tema::placeholder{color:#73809a}

  .btn{
    appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);
    padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:10px;font-size:var(--btn-font);cursor:pointer;transition:.15s;min-height:var(--btn-min-h)
  }
  .btn:hover{background:rgba(255,255,255,.1)}
  .btn-ghost{background:transparent;border-color:var(--border)}
  .btn-alt{
    appearance:none;border:0;background:var(--primary);color:#0B1220;
    padding:var(--btn-pad-y) var(--btn-pad-x);border-radius:10px;font-size:var(--btn-font);cursor:pointer;transition:.15s;min-height:var(--btn-min-h);font-weight:600;
  }
  .btn-alt:hover{background:var(--primary-700)}
  .btn-small{font-size:12px;min-height:30px;padding:6px 10px;border-radius:9px}
  .btn-ok{ background:var(--success)!important; color:#06220f!important; border-color:transparent!important; }
  .btn-danger{ background:var(--danger)!important; color:#1f0710!important; }

  .acc{margin:12px 0;border:1px solid var(--border);border-radius:12px;background:#0B1426;box-shadow:var(--shadow)}
  .acc>summary{
    list-style:none;cursor:pointer;padding:12px 14px;color:#E8EEF8;display:flex;align-items:center;justify-content:space-between;
    font-weight:600; letter-spacing:.2px;
  }
  .acc>summary::-webkit-details-marker{display:none}
  .acc[open]>summary{background:#0D1A30}
  .acc-body{padding:12px 14px}

  .result{
    background:#0D162B;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px;margin:10px 0
  }
  .result .header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .filetag{
    display:inline-block;font-weight:600;font-size:12px;padding:3px 10px;border-radius:999px;background:rgba(124,196,255,.15);color:#BFE3FF
  }
  .result p{margin:0;color:#DDE3EE}
  .result .actions{margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}

  /* Estratégias (uma lista única) */
  .strat{background:#0D162B;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px;margin:10px 0}
  .strat .head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .strat h3{margin:0;color:#F8FAFC;font-size:16px;font-weight:700;letter-spacing:.2px}
  .strat hr{border:0;border-top:1px solid var(--border);margin:8px 0}
  .strat .meta{color:var(--subtext);margin:0 0 8px 0}
  .strat .toggle{appearance:none;background:transparent;border:0;color:#BFE3FF;text-decoration:underline;cursor:pointer;font-size:12.5px;padding:0}
  .strat .body{display:none}
  .strat.open .body{display:block}

  mark{background:var(--mark-bg);color:var(--mark-tint);padding:0 .15em;border-radius:3px}

  #promptArea{display:none}
  #promptOut{
    width:100%;min-height:160px;border:1px solid var(--border);border-radius:10px;padding:12px;background:#0B1220;
    color:#E6EAF2;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap
  }
  .ia-row{display:none;flex-wrap:wrap;gap:8px;margin-top:8px}
  .ia{padding:6px 10px;border-radius:var(--chip-radius);border:1px solid var(--border);background:#0B1220;color:#E6EAF2;text-decoration:none;font-size:12px}
  .ia:hover{background:#0E1A31}
  .chip-ghost{padding:6px 10px;border-radius:var(--chip-radius);border:1px dashed var(--border);background:transparent;color:#E6EAF2;font-size:12px;cursor:pointer}

  .callout-red{ background:rgba(244,63,94,.12); border:1px solid rgba(244,63,94,.35); color:#fecaca; padding:8px 10px; border-radius:8px; }

  /* Modal Sobre */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:80; }
  .modal{
    width:min(92vw, 560px); background:#0F172A; border:1px solid var(--border); border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.6); padding:16px;
  }
  .modal header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
  .modal h2{margin:0; color:#F8FAFC; font-size:18px}
  .modal .close{appearance:none; border:1px solid var(--border); background:#0B1220; color:var(--text); border-radius:10px; width:36px; height:36px; cursor:pointer}
  .modal .content{color:var(--subtext); font-size:13.5px; line-height:1.55}

  /* FAB opcional */
  #installFab{position:fixed;right:14px;bottom:14px;z-index:60;display:none;background:var(--primary);color:#0B1220;border:0;border-radius:999px;padding:10px 12px;gap:8px;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,.5);cursor:pointer}
  #installFab svg{width:16px;height:16px;display:block;stroke:#0B1220}

  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0B1220;color:#E6EAF2;padding:8px 12px;border:1px solid var(--border);border-radius:999px;opacity:0;transition:.2s;z-index:90}
  #toast.show{opacity:1}

  @media (max-width:600px){
    h1{font-size:18px}
    .result p{font-size:13px; line-height:1.5}
  }
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar__inner">
    <a class="brand" href="#top" aria-label="Início">
      <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
    </a>
    <div class="topbar__actions">
      <button id="btnAbout" class="iconbtn" type="button" title="Sobre" aria-label="Sobre">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 10v6m0-9h.01" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button id="btnInstallTop" class="iconbtn" type="button" title="Baixar app" aria-label="Baixar app" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14a2 2 0 0 0 2-2v-4M3 15v4a2 2 0 0 0 2 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
</header>

<main class="wrap" id="top">
  <section id="temaSec" class="card">
    <h1>Escreva aqui o tema do prompt</h1>
    <div class="row" style="margin-top:8px">
      <input id="tema" type="text" placeholder="Ex.: responsabilidade civil por dano estético em cirurgia..." />
      <button id="btnAvancar" class="btn-alt" type="button">Avançar</button>
    </div>
    <p class="muted callout-red" id="temaHint" style="margin:10px 2px 6px 2px;display:none">Tema definido. Agora selecione as sugestões e estratégias abaixo.</p>
    <p class="muted" id="temaAdded" style="margin:0;display:none"></p>
  </section>

  <section id="sugestoesSec" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h1 style="margin:0">Sugestões para enriquecer seu tema</h1>
      <button id="btnRebuscar" class="btn" type="button">Rebuscar</button>
    </div>
    <p class="muted" style="margin-top:6px">Resultados agrupados por categoria. Abra cada grupo e use <b>Adicionar</b> (toggle) para incluir no tema.</p>
    <div id="sugestoesCats"></div>
  </section>

  <section id="estrategiasSec" class="card" style="display:none">
    <h1>Estratégias de estudo</h1>
    <div id="estrategiasList"></div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="btnGerar" class="btn-alt" type="button">Gerar Prompt</button>
    </div>
  </section>

  <section id="promptArea" class="card">
    <h1>Prompt gerado</h1>
    <div id="promptOut"></div>
    <div class="row" style="margin-top:10px; align-items:center; gap:12px;">
      <button id="btnCopy" class="btn" type="button">Copiar</button>
      <button id="btnLimpar" class="btn" type="button" style="display:none;">Limpar</button>
      <div class="ia-row" id="iaRow">
        <a class="ia" data-ia="chatgpt" href="https://chat.openai.com/" target="_blank" rel="noopener">ChatGPT</a>
        <a class="ia" data-ia="claude"  href="https://claude.ai/new" target="_blank" rel="noopener">Claude</a>
        <a class="ia" data-ia="gemini"  href="https://gemini.google.com/app" target="_blank" rel="noopener">Gemini</a>
        <a class="ia" data-ia="perplexity" href="https://www.perplexity.ai/" target="_blank" rel="noopener">Perplexity</a>
        <a class="ia" data-ia="copilot" href="https://copilot.microsoft.com/" target="_blank" rel="noopener">Copilot</a>
        <a class="ia" data-ia="phind"   href="https://www.phind.com/" target="_blank" rel="noopener">Phind</a>
        <button id="btnFecharChips" class="chip-ghost" type="button" title="Fechar">Fechar</button>
      </div>
    </div>
    <p class="muted" style="margin:6px 0 0 0; display:none" id="dicaCliqueDireito">
      Dica: clique com o botão direito em um chip de IA para abrir já com o prompt copiado.
    </p>
  </section>
</main>

<!-- Modal Sobre -->
<div id="aboutBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <header>
      <h2 id="aboutTitle">Sobre o direito.love</h2>
      <button class="close" id="aboutClose" type="button" aria-label="Fechar">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="#E6EAF2" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </header>
    <div class="content">
      <p>O direito.love ajuda estudantes a montar prompts de estudo de forma rápida e inteligente. Digite um tema, receba sugestões do nosso acervo (códigos, súmulas, julgados e jurisprudência), escolha as sessões do seu estudo e gere um prompt otimizado para a IA de sua preferência.</p>
      <p>Funciona como PWA no Android: <b>Baixe o app</b> para acesso instantâneo e offline básico.</p>
    </div>
  </div>
</div>

<!-- FAB opcional -->
<button id="installFab" title="Instalar app">
  <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14a2 2 0 0 0 2-2v-4M3 15v4a2 2 0 0 0 2 2" stroke="#0B1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  <span>Baixar app</span>
</button>

<div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const toast=(m,t=1600)=>{const el=$("#toast");el.textContent=m;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};

  const temaInput=$("#tema"), btnAvancar=$("#btnAvancar"), temaHint=$("#temaHint"), temaAdded=$("#temaAdded");
  const sugestSec=$("#sugestoesSec"), sugCats=$("#sugestoesCats"), btnRebuscar=$("#btnRebuscar");
  const estrSec=$("#estrategiasSec"), estrList=$("#estrategiasList"), btnGerar=$("#btnGerar");
  const promptArea=$("#promptArea"), promptOut=$("#promptOut"), btnCopy=$("#btnCopy"), btnLimpar=$("#btnLimpar");
  const iaRow=$("#iaRow"), dicaCliqueDireito=$("#dicaCliqueDireito"), btnFecharChips=$("#btnFecharChips");

  const btnInstallTop=$("#btnInstallTop");
  const btnAbout=$("#btnAbout");
  const aboutBackdrop=$("#aboutBackdrop");
  const aboutClose=$("#aboutClose");

  /* ===== Normalização + Sinônimos ===== */
  const STOP=new Set(['de','da','do','das','dos','e','ou','a','o','as','os','no','na','nos','nas','para','por','em','um','uma','ao','à','que','com','sem','sobre','entre','ate','das','dos','do','da']);
  const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const norm=(s="")=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  const LAW_CANONS = [
    'codigo penal','codigo de processo penal','codigo civil','codigo de processo civil',
    'codigo tributario nacional','codigo de defesa do consumidor','codigo de transito brasileiro',
    'codigo eleitoral','codigo comercial','codigo penal militar','codigo de processo penal militar',
    'codigo florestal','codigo das aguas','codigo de minas',
    'codigo brasileiro de aeronautica','codigo brasileiro de telecomunicacoes',
    'consolidacao das leis do trabalho'
  ];

  const SYN = [
    // estruturais
    { canon:'art',    pats:[/\bart(?:s|\.)?\b/giu,/\bartigo\b/giu] },
    { canon:'inciso', pats:[/\bincs?\.?\b/giu,/\binc\.?\b/giu,/\binciso\b/giu] },
    { canon:'alinea', pats:[/\bal\.?\b/giu,/\balinea\b/giu] },
    { canon:'paragrafo', pats:[/\bpar\.?\b/giu,/\b§+\b/giu] },

    // códigos + siglas
    { canon:'codigo penal', pats:[/\bcp\b/giu,/\bcod(?:\.|igo)?\s+penal\b/giu] },
    { canon:'codigo de processo penal', pats:[/\bcpp\b/giu,/\bcod(?:\.|igo)?\s+de\s+processo\s+penal\b/giu] },
    { canon:'codigo civil', pats:[/\bcc\b/giu,/\bcod(?:\.|igo)?\s+civil\b/giu] },
    { canon:'codigo de processo civil', pats:[/\bcpc\b/giu,/\bcod(?:\.|igo)?\s+de\s+processo\s+civil\b/giu] },
    { canon:'codigo tributario nacional', pats:[/\bctn\b/giu,/\bcod(?:\.|igo)?\s+tributario\s+nacional\b/giu] },
    { canon:'codigo de defesa do consumidor', pats:[/\bcdc\b/giu,/\bcod(?:\.|igo)?\s+de\s+defesa\s+do\s+consumidor\b/giu] },
    { canon:'codigo de transito brasileiro', pats:[/\bctb\b/giu,/\bcod(?:\.|igo)?\s+de?\s*transito\b/giu] },
    { canon:'codigo eleitoral', pats:[/\bce\b/giu,/\bcod(?:\.|igo)?\s+eleitoral\b/giu] },
    { canon:'codigo comercial', pats:[/\bcod(?:\.|igo)?\s+comercial\b/giu] },
    { canon:'codigo penal militar', pats:[/\bcpm\b/giu,/\bcod(?:\.|igo)?\s+penal\s+militar\b/giu] },
    { canon:'codigo de processo penal militar', pats:[/\bcppm\b/giu,/\bcod(?:\.|igo)?\s+de\s+processo\s+penal\s+militar\b/giu] },
    { canon:'codigo florestal', pats:[/\bcod(?:\.|igo)?\s+florestal\b/giu] },
    { canon:'codigo das aguas', pats:[/\bcod(?:\.|igo)?\s+das\s+aguas\b/giu] },
    { canon:'codigo de minas', pats:[/\bcod(?:\.|igo)?\s+de\s+minas\b/giu] },
    { canon:'codigo brasileiro de aeronautica', pats:[/\bcba\b/giu,/\bcod(?:\.|igo)?\s+brasileiro\s+de\s+aeronautica\b/giu] },
    { canon:'codigo brasileiro de telecomunicacoes', pats:[/\bcod(?:\.|igo)?\s+brasileiro\s+de\s+telecomunicacoes\b/giu] },
    { canon:'consolidacao das leis do trabalho', pats:[/\bclt\b/giu,/\bconsolidac[aã]o\s+das\s+leis\s+do\s+trabalho\b/giu] },

    // temas comuns
    { canon:'dano', pats:[/\bdanos?\b/giu] },
    { canon:'moral', pats:[/\bmorais\b/giu] },
    { canon:'estetico', pats:[/\best[eé]tic\w+\b/giu,/\besteic\w+\b/giu] },
    { canon:'medico', pats:[/\bm[eé]dic\w+\b/giu] },
    { canon:'erro medico', pats:[/\berro\s+medic\w+\b/giu,/\biatrogen\w+\b/giu,/\bimperici\w+\b/giu,/\bnegligenci\w+\b/giu,/\bimprudenci\w+\b/giu,/\berro\s+odontolog\w+\b/giu] },

    // jurisprudência e afins
    { canon:'sumula', pats:[/\bs[uú]mulas?\b/giu,/\bsv\b/giu,/\bsumula\b/giu] },
    { canon:'jurisprudencia', pats:[/\bjurisprud[eê]nci\w+\b/giu,/\bprecedent\w+\b/giu,/\bleading\s+case\b/giu] },
    { canon:'tema repetitivo', pats:[/\btemas?\s+repetitiv\w+\b/giu] },
    { canon:'repercussao geral', pats:[/\brepercuss[aã]o\s+geral\b/giu] },
  ];
  function applySynonyms(t){ for(const s of SYN){ for(const p of s.pats){ t = t.replace(p, ' '+s.canon+' '); } } return t; }

  function normalizeLegal(s){
    let t=norm(s);

    // normalizar "art120", "art.120", "artigo120"
    t=t.replace(/\b(art(?:igo)?\.?)\s*(\d+[a-z\-]*)\b/giu,' art $2 ');

    // remover pontos dentro de números (ex.: 13.709 -> 13709, 2.018 -> 2018)
    t=t.replace(/\b\d{1,3}(?:\.\d{3})+(?:\/\d{2,4})?\b/g, m => m.replace(/\./g,''));
    t=t.replace(/(\d)\.(?=\d)/g,'$1');

    // suprimir grau/ordinais
    t=t.replace(/(\d+)\s*[ºªoa]\b/g,'$1');

    // limpar pontuação solta
    t=t.replace(/["'()]/g,' ').replace(/\s+/g,' ').trim();

    // "único" -> unico
    t=t.replace(/\bunico\b/giu,' unico ');

    // aplicar sinônimos/canônicos
    t=applySynonyms(' '+t+' ');

    return t.replace(/\s+/g,' ').trim();
  }

  const tokensFromLegal = s => s.split(/\s+/).filter(Boolean);
  const isRelevant = w => w.length>=3 && !STOP.has(w);

  function highlightText(text,tokens){
    if(!tokens?.length) return text;
    let html=text; const used=new Set();
    for(const tok of tokens){ if(!tok||used.has(tok)) continue; used.add(tok);
      const re=new RegExp(`\\b(${esc(tok)})\\b`,'giu'); html=html.replace(re,'<mark>$1</mark>');
    }
    return html;
  }

  /* ===== Proximidade (cadeia) ===== */
  function hasProxChain(hayTokens, targetsArr, requireDistinct, maxGap=2){
    if(!targetsArr.length) return false;
    const targetSet = new Set(targetsArr);
    const posByTok = new Map();
    for(let i=0;i<hayTokens.length;i++){
      const w=hayTokens[i];
      if(targetSet.has(w)){
        if(!posByTok.has(w)) posByTok.set(w, []);
        posByTok.get(w).push(i);
      }
    }
    if(posByTok.size < requireDistinct) return false;

    const occs=[]; for(const [tok, arr] of posByTok){ for(const p of arr){ occs.push({pos:p, tok}); } }
    occs.sort((a,b)=>a.pos-b.pos);

    for(let s=0;s<occs.length;s++){
      let used=new Set([occs[s].tok]);
      let last=occs[s].pos;
      for(let t=s+1;t<occs.length;t++){
        const gap = occs[t].pos - last - 1;
        if(gap <= maxGap){
          if(!used.has(occs[t].tok)) used.add(occs[t].tok);
          last = occs[t].pos;
          if(used.size >= requireDistinct) return true;
        } else break;
      }
    }
    return false;
  }

  /* ===== Dados / categorias ===== */
  const arquivos=[
    "data/julgados_direito_administrativo.json","data/julgados_direito_ambiental.json","data/julgados_direito_bancario.json",
    "data/julgados_direito_civil.json","data/julgados_direito_constitucional.json","data/julgados_direito_eleitoral.json",
    "data/julgados_direito_empresarial.json","data/noticias_migalhas_1.json","data/noticias_migalhas_2.json","data/noticias_migalhas_3.json",
    "data/codigo_penal.json","data/codigo_processo_penal.json","data/sumula_stf.json","data/sumulas_stj.json","data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json","data/temas_repetitivos_stj.json","data/teses_stf.json","data/codigo_processo_civil.json",
    "data/codigo_civil.json","data/codigo_tributario_nacional.json","data/codigo_defesa_consumidor.json","data/codigo_transito_brasileiro.json"
  ];
  const nomesAmigaveis={noticias:"Notícias",noticias_migalhas_1:"Notícias Migalhas",noticias_migalhas_2:"Notícias Migalhas",noticias_migalhas_3:"Notícias Migalhas",
    sumula_stf:"Súmulas STF",sumulas_stj:"Súmulas STJ",sumulas_tse:"Súmulas TSE",sumulas_vinculantes_stf:"Súmulas Vinculantes STF",
    temas_repetitivos_stj:"Temas Repetitivos STJ",teses_stf:"Teses STF",codigo_penal:"Código Penal",codigo_processo_penal:"Código de Processo Penal",
    codigo_processo_civil:"Código de Processo Civil",codigo_civil:"Código Civil",codigo_tributario_nacional:"Código Tributário Nacional",
    codigo_defesa_consumidor:"Código de Defesa do Consumidor",codigo_transito_brasileiro:"Código de Trânsito Brasileiro",
    julgados_direito_administrativo:"Julgados de Direito Administrativo",julgados_direito_ambiental:"Julgados de Direito Ambiental",
    julgados_direito_bancario:"Julgados de Direito Bancário",julgados_direito_civil:"Julgados de Direito Civil",
    julgados_direito_constitucional:"Julgados de Direito Constitucional",julgados_direito_eleitoral:"Julgados de Direito Eleitoral",
    julgados_direito_empresarial:"Julgados de Direito Empresarial"};
  const categorias={
    codigos:{label:"Códigos",test:f=>f.startsWith('codigo_')},
    sumulas:{label:"Súmulas",test:f=>f.startsWith('sumula')||f.startsWith('sumulas_')||f==='sumulas_vinculantes_stf'},
    jurisprudencia:{label:"Jurisprudência",test:f=>f==='temas_repetitivos_stj'||f==='teses_stf'},
    julgados:{label:"Julgados",test:f=>f.startsWith('julgados_')},
    noticias:{label:"Notícias",test:f=>f.startsWith('noticias')},
    outros:{label:"Outros",test:_=>true}
  };
  const normalizarFonte=f=>f&&f.startsWith('noticias')?'noticias':f;

  let baseDados=[];
  async function carregarDados(){
    const dados=[];
    for(const arq of arquivos){
      try{
        const tag=arq.split('/').pop().replace(/\.json$/,'');
        const r=await fetch(arq); if(!r.ok) continue;
        const j=await r.json();
        (Array.isArray(j)?j:[]).forEach((it,idx)=>{
          const _id=it.id||`${tag}_${idx}`;
          const texto=(it.texto||it.descricao||it.conteudo||'').trim();
          const titulo=it.titulo||it.title||'';
          dados.push({...it,_id,fonte:tag,titulo,texto,textoNorm:norm(texto||titulo),textoLegal:normalizeLegal(texto||titulo)});
        });
      }catch(e){ console.warn('Erro ao carregar',arq,e); }
    }
    return dados;
  }

  function ensureVisible(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); }

  /* ===== Busca profissional ===== */
  function professionalSearch(raw, data){
    const qLegal = normalizeLegal(raw);
    const qTokensAll = tokensFromLegal(qLegal);
    const qDistinct = Array.from(new Set(qTokensAll));

    const lawHits = LAW_CANONS.filter(c => qLegal.includes(c));
    const lawTokSet = new Set(lawHits.flatMap(c => tokensFromLegal(c)));

    let chainTargets = qDistinct.filter(t => !lawTokSet.has(t) && !STOP.has(t));

    let requireDistinct, maxGap = 2;
    if (chainTargets.length <= 1){
      requireDistinct = 1;
    } else if (chainTargets.length <= 3){
      requireDistinct = chainTargets.length;
    } else {
      const relev = chainTargets.filter(isRelevant);
      chainTargets = relev.length ? relev : chainTargets;
      requireDistinct = Math.min(4, chainTargets.length);
    }
    if (chainTargets.length===0){ chainTargets = qDistinct.filter(t=>!STOP.has(t)); requireDistinct = Math.min(1, chainTargets.length); }

    const highlight = (chainTargets.length? chainTargets : qDistinct).slice(0,8);

    const results=[];
    for(const it of data){
      const hay = (it.textoLegal || it.textoNorm || '');
      const hTokens = tokensFromLegal(hay);

      if (!chainTargets.some(t => hTokens.includes(t))) continue;

      if (requireDistinct===1){
        results.push(it);
      } else {
        if (hasProxChain(hTokens, chainTargets, requireDistinct, maxGap)) results.push(it);
      }
    }
    return { results, highlight };
  }

  /* ===== Estado das seleções (para poder remover depois) ===== */
  const selectedPieces = new Map();      // id -> texto incluído no tema
  const selectedStrategies = new Set();  // nome da estratégia

  function updateTemaAdded(){
    const n = selectedPieces.size;
    if(n>0){
      temaAdded.style.display='block';
      temaAdded.textContent = n===1 ? '1 item adicionado ao tema.' : `${n} itens adicionados ao tema.`;
    }else{
      temaAdded.style.display='none';
      temaAdded.textContent='';
    }
  }

  /* ===== UI: cartões de resultados ===== */
  function buildCard(item,tokens){
    const fNorm=normalizarFonte(item.fonte);
    const nomeBonito=nomesAmigaveis[fNorm]||nomesAmigaveis[item.fonte]||item.fonte;

    const div=document.createElement('div'); div.className='result';

    const head=document.createElement('div'); head.className='header';
    const tag=document.createElement('div'); tag.className='filetag'; tag.textContent=nomeBonito;
    head.appendChild(tag);

    const actionsTop=document.createElement('div'); actionsTop.className='actions';
    const add=document.createElement('button'); add.className='btn btn-small'; add.type='button';
    const piece=item.texto?.trim()||[item.titulo||'',item.url||''].filter(Boolean).join(' — ');
    function setAddUI(){
      const added = selectedPieces.has(item._id);
      add.textContent = added ? 'Adicionado — Remover' : 'Adicionar';
      add.classList.toggle('btn-ok', added);
      add.setAttribute('aria-pressed', added ? 'true':'false');
    }
    setAddUI();
    add.addEventListener('click',()=>{
      if(!selectedPieces.has(item._id)){
        selectedPieces.set(item._id, piece);
        toast('Adicionado ao tema.');
      }else{
        selectedPieces.delete(item._id);
        toast('Removido do tema.');
      }
      setAddUI();
      updateTemaAdded();
    });
    actionsTop.appendChild(add);
    head.appendChild(actionsTop);
    div.appendChild(head);

    const p=document.createElement('p');
    const baseText=(item.texto&&item.texto.trim())||(item.titulo||'');
    p.innerHTML=highlightText(baseText,tokens);
    div.appendChild(p);

    // ações extra no rodapé (ex.: link notícia)
    const actions=document.createElement('div'); actions.className='actions';
    if(item.url && fNorm==='noticias'){
      const a=document.createElement('a'); a.textContent='Abrir notícia'; a.href=item.url; a.target='_blank'; a.rel='noopener'; a.className='btn btn-small';
      actions.appendChild(a);
      div.appendChild(actions);
    }
    return div;
  }

  function groupByCategory(items){
    const groups={}; for(const k in categorias){ groups[k]={label:categorias[k].label,items:[]} }
    for(const it of items){
      const f=it.fonte||''; let cat='outros';
      for(const k in categorias){ if(k==='outros') continue; if(categorias[k].test(f)){ cat=k; break; } }
      groups[cat].items.push(it);
    }
    // remove vazios e ordena por tamanho
    return Object.fromEntries(Object.entries(groups).filter(([,g])=>g.items.length>0).sort((a,b)=>b[1].items.length-a[1].items.length));
  }

  function renderSugeridos(items,tokens){
    // esconder toda a seção se não há qualquer item
    if(!items || items.length===0){
      sugestSec.style.display='none';
      sugCats.innerHTML='';
      return;
    } else {
      sugestSec.style.display='block';
    }

    sugCats.innerHTML='';
    const groups=groupByCategory(items);
    const entries=Object.entries(groups);

    for(const [catId,group] of entries){
      const det=document.createElement('details'); det.className='acc';
      const sum=document.createElement('summary');

      const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
      const ttl=document.createElement('span'); ttl.textContent=group.label; ttl.style.fontWeight='700';
      const count=document.createElement('span'); count.textContent=group.items.length; count.style.opacity='.8';
      left.appendChild(ttl); left.appendChild(count);
      sum.appendChild(left);
      det.appendChild(sum);

      const body=document.createElement('div'); body.className='acc-body';
      det.appendChild(body);

      // carregar os primeiros 10
      let shown = 0;
      const loadWrap=document.createElement('div');
      loadWrap.style.display='flex';
      loadWrap.style.justifyContent='center';
      loadWrap.style.marginTop='6px';
      const loadBtn=document.createElement('button'); loadBtn.className='btn btn-small'; loadBtn.textContent='Carregar mais';
      loadWrap.appendChild(loadBtn);

      function appendMore(n=10){
        const slice = group.items.slice(shown, shown+n);
        for(const it of slice){
          const card = buildCard(it,tokens);
          body.insertBefore(card, loadWrap); // <- botão fica SEMPRE no fim
        }
        shown += slice.length;
        if(shown >= group.items.length){
          // remove o botão se acabou
          loadWrap.remove();
        } else {
          loadBtn.textContent = 'Carregar mais';
        }
      }
      appendMore(10);
      if(group.items.length>shown){
        loadBtn.addEventListener('click', ()=>appendMore(10));
        body.appendChild(loadWrap);
      }

      sugCats.appendChild(det);
    }
  }

  /* ===== Estratégias (sem categorias) ===== */
  const STRATEGIES = [
    {nome:'Resumo Explicativo', desc:'Retorno em linguagem simples e didática. Bom pra revisar antes da prova.', exemplo:'Explique em até 10 linhas o art. 121 do CP, com exemplos práticos e sem juridiquês pesado.'},
    {nome:'Questões Objetivas (OAB/Concursos)', desc:'10 a 15 questões de múltipla escolha, gabarito só no final.', exemplo:'Crie 10 questões objetivas sobre processo penal, estilo OAB, com 4 alternativas.'},
    {nome:'Casos Concretos', desc:'Enunciados práticos como peça ou prova oral, com análise da solução.', exemplo:'Formule 3 casos práticos sobre dano moral coletivo, com resposta fundamentada.'},
    {nome:'Quadro Comparativo', desc:'Tabelas curtas comparando institutos próximos.', exemplo:'Monte um quadro comparativo entre prisão preventiva e prisão temporária.'},
    {nome:'Mapa Mental / Esquema', desc:'Tópicos hierárquicos/fluxograma. Ideal pra memorização visual.', exemplo:'Organize em tópicos o procedimento do júri do recebimento à sentença.'},
    {nome:'Flash Points (Memorização Rápida)', desc:'Lista do que não pode esquecer: artigos, súmulas, prazos.', exemplo:'Liste 10 pontos essenciais sobre competência no CPC que caem em prova.'},
    {nome:'Jurisprudência Atualizada', desc:'Precedentes recentes + súmulas relacionadas.', exemplo:'Traga 5 precedentes do STJ sobre responsabilidade civil médica, em tópicos.'},
    {nome:'Sustentação Oral / Explicação Oral', desc:'Texto para “defender” em 5 minutos.', exemplo:'Faça uma sustentação simulada sobre a insignificância no furto simples.'},
    {nome:'Peça Prática (Esqueleto)', desc:'Estrutura modelo da peça pedida.', exemplo:'Monte o esqueleto de uma apelação criminal por nulidade de interceptação telefônica.'},
    {nome:'Doutrina vs Jurisprudência', desc:'Contrasta autores e decisões sobre o mesmo tema.', exemplo:'Compare Nucci e Capez sobre crime de perigo abstrato com posição do STJ.'},
  ];

  function renderEstrategias(){
    estrList.innerHTML='';
    STRATEGIES.forEach((s)=>{
      const card=document.createElement('div'); card.className='strat';
      const head=document.createElement('div'); head.className='head';

      const title=document.createElement('h3'); title.textContent=s.nome;
      head.appendChild(title);

      const btn=document.createElement('button'); btn.type='button'; btn.className='btn btn-small';
      function setBtn(){
        const on = selectedStrategies.has(s.nome);
        btn.textContent = on ? 'Adicionado — Remover' : 'Adicionar';
        btn.classList.toggle('btn-ok', on);
        btn.setAttribute('aria-pressed', on ? 'true':'false');
      }
      setBtn();
      btn.addEventListener('click', ()=>{
        if(selectedStrategies.has(s.nome)){
          selectedStrategies.delete(s.nome);
          toast('Estratégia removida.');
        }else{
          selectedStrategies.add(s.nome);
          toast('Estratégia adicionada.');
        }
        setBtn();
      });
      head.appendChild(btn);
      card.appendChild(head);

      const hr=document.createElement('hr'); card.appendChild(hr);

      const meta=document.createElement('p'); meta.className='meta'; meta.textContent=s.desc; card.appendChild(meta);

      const toggle=document.createElement('button'); toggle.className='toggle'; toggle.type='button'; toggle.textContent='Mostrar detalhes';
      card.appendChild(toggle);

      const body=document.createElement('div'); body.className='body';
      const ex=document.createElement('p'); ex.innerHTML = `<span class="muted">Exemplo:</span> ${s.exemplo}`;
      body.appendChild(ex);
      card.appendChild(body);

      toggle.addEventListener('click', ()=>{
        const open = card.classList.toggle('open');
        toggle.textContent = open ? 'Ocultar detalhes' : 'Mostrar detalhes';
      });

      estrList.appendChild(card);
    });
  }

  /* ===== Prompt ===== */
  function gerarPrompt(){
    const temaDigitado=temaInput.value.trim();
    if(!temaDigitado){ toast('Defina o tema antes.'); return; }

    // tema final = digitado + peças selecionadas
    const anexos = Array.from(selectedPieces.values());
    const temaFinal = anexos.length ? (temaDigitado + ' — ' + anexos.join(' — ')) : temaDigitado;

    // pacotinho padrão se nada escolhido
    let lista = Array.from(selectedStrategies).map(n=>({nome:n}));
    if(lista.length===0){
      lista = [
        {nome:'Resumo Explicativo'},
        {nome:'Jurisprudência Atualizada'},
        {nome:'Flash Points (Memorização Rápida)'},
        {nome:'Questões Objetivas (OAB/Concursos)'}
      ];
    }

    const linhas=[];
    linhas.push('Você é um professor de Direito com didática clara. Me ajude a estudar o tema abaixo:\n');
    linhas.push('TEMA: '+temaFinal+'\n');
    linhas.push('Estruture a resposta usando as seções (ou objetivos) abaixo, sendo objetivo e didático:');
    lista.forEach(({nome})=>linhas.push(`- ${nome}`));
    linhas.push('\nRegras: cite artigos com número e diploma; quando houver, inclua Súmulas (STF/STJ) e leading cases; use exemplos curtos; ao final, proponha 3 questões objetivas com gabarito e 1 discursiva.');

    promptOut.textContent=linhas.join('\n');
    promptArea.style.display='block';
    setTimeout(()=>ensureVisible(promptArea),50);
    toast('Prompt gerado.');
  }

  /* ===== Execução ===== */
  function executarBuscaDoTema(){
    const temaRaw=temaInput.value.trim();
    if(!temaRaw){ toast("Digite um tema."); temaInput.focus(); return; }

    temaHint.style.display='block';
    btnRebuscar.disabled=true; btnRebuscar.textContent='Buscando…';

    const {results, highlight} = professionalSearch(temaRaw, baseDados);
    renderSugeridos(results, highlight);
    estrSec.style.display='block';
    renderEstrategias();
    setTimeout(()=>{ ensureVisible(sugestSec); }, 50);

    btnRebuscar.disabled=false; btnRebuscar.textContent='Rebuscar';
  }

  btnAvancar.addEventListener('click', executarBuscaDoTema);
  btnRebuscar.addEventListener('click', executarBuscaDoTema);
  btnGerar.addEventListener('click', gerarPrompt);

  // Dica automática após 3s desde a 1ª digitação
  let hintTimer=null, hinted=false;
  temaInput.addEventListener('input', ()=>{
    if(hinted) return;
    if(hintTimer) clearTimeout(hintTimer);
    if(temaInput.value.trim().length>0){
      hintTimer=setTimeout(()=>{ temaHint.style.display='block'; hinted=true; }, 3000);
    }
  });

  // Copiar -> chips de IA + Fechar
  btnCopy.addEventListener('click', async()=>{
    try{
      await navigator.clipboard.writeText(promptOut.textContent||'');
      toast('Copiado!');
      iaRow.style.display='flex';
      dicaCliqueDireito.style.display='block';
      btnLimpar.style.display='inline-block';
    }catch{ toast('Erro ao copiar.'); }
  });
  $$('.ia').forEach(a=>{
    a.addEventListener('contextmenu', async (ev)=>{
      ev.preventDefault();
      try{ await navigator.clipboard.writeText(promptOut.textContent||''); toast('Copiado!'); }catch{}
      window.open(a.href,'_blank','noopener');
    });
  });
  function resetApp(){
    temaInput.value='';
    temaHint.style.display='none';
    sugestSec.style.display='none'; sugCats.innerHTML='';
    estrSec.style.display='none'; estrList.innerHTML='';
    promptArea.style.display='none'; promptOut.textContent='';
    iaRow.style.display='none'; dicaCliqueDireito.style.display='none';
    btnLimpar.style.display='none';
    selectedPieces.clear(); selectedStrategies.clear(); updateTemaAdded();
    hinted=false; if(hintTimer) clearTimeout(hintTimer); hintTimer=null;
    window.scrollTo({top:0,behavior:'smooth'});
  }
  btnFecharChips.addEventListener('click', resetApp);
  btnLimpar.addEventListener('click', resetApp);

  // Boot & PWA
  async function boot(){
    baseDados = await carregarDados();
    toast('Base carregada com sucesso!');
  }
  boot();

  // Modal Sobre
  function openAbout(){ aboutBackdrop.style.display='flex'; aboutBackdrop.setAttribute('aria-hidden','false'); }
  function closeAbout(){ aboutBackdrop.style.display='none'; aboutBackdrop.setAttribute('aria-hidden','true'); }
  btnAbout.addEventListener('click', openAbout);
  aboutClose.addEventListener('click', closeAbout);
  aboutBackdrop.addEventListener('click', (e)=>{ if(e.target===aboutBackdrop) closeAbout(); });

  // PWA (Android)
  let deferredPrompt=null;
  const installFab=$("#installFab");
  const isAndroid = /Android/i.test(navigator.userAgent || '');
  if(isAndroid) btnInstallTop.style.display='flex';
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt=e;
    btnInstallTop.style.display='flex';
  });
  function doInstall(){
    if(deferredPrompt){
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(({outcome})=>{
        if(outcome==='accepted') toast('Instalação iniciada.');
        deferredPrompt=null;
      });
    }else{
      toast('No Android, use “Adicionar à tela inicial” no menu do navegador.');
    }
  }
  btnInstallTop.addEventListener('click', doInstall);
  installFab.addEventListener('click', doInstall);
})();
</script>
</body>
</html>
