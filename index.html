<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c4160" />
  <title>direito.love</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    /* ======================
       DESIGN TOKENS + THEME
       ====================== */
    :root{
      /* Cores base */
      --ink:#0b2f3b;          /* texto prim√°rio */
      --ink-2:#2a4a56;        /* texto secund√°rio */
      --bg:#ffffff;           /* canvas */
      --bg-gradient: radial-gradient(1200px 800px at 10% -10%, #eaf7f5 0%, transparent 60%),
                     radial-gradient(800px 600px at 110% 10%, #f1f6fb 0%, transparent 55%);
      --surface:#ffffff;      /* cart√µes */
      --surface-2:#e9f2f5;    /* campos/√°reas */

      --btn:#0b3b4a;          /* CTA */
      --btn-copy:#6b7785;     /* secund√°rio */
      --btn-reset:#4b5563;    /* perigo leve */
      --border:#d8e2e7;       /* linhas sutis */
      --topbar:#0c4160;       /* app bar */

      /* Dimens√µes */
      --topbar-h:56px;        /* respiro */
      --logo-h:30px;

      /* Tipografia fluida */
      --fs-body: clamp(14px, 1.8vw, 16px);
      --fs-h1: clamp(24px, 6vw, 56px);
      --fs-h2: clamp(18px, 2.6vw, 24px);
      --fs-label: clamp(15px, 2.2vw, 20px);

      /* Sombra/Eleva√ß√£o */
      --elev-1: 0 2px 8px rgba(0,0,0,.06);
      --elev-2: 0 10px 28px rgba(0,0,0,.08);

      /* Altura da barra de recentes fixa */
      --recent-h:64px;

      color-scheme: light dark; /* habilita dark nativo */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:var(--fs-body);
      line-height:1.45;
      background:var(--bg);
      background-image: var(--bg-gradient);
      color:var(--ink);
      /* Safe-area: evita encostar no notch e reserva base para recentes */
      padding-top: calc(var(--topbar-h) + max(0px, env(safe-area-inset-top)));
      padding-bottom: calc(var(--recent-h) + max(16px, env(safe-area-inset-bottom)));
    }

    /* =========
       TOP BAR
       ========= */
    .topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:var(--topbar);z-index:1000;border-bottom:1px solid var(--border)}
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;width:100%;padding:0 14px;margin:0 auto;max-width:960px}
    .brand-wrap{display:flex;align-items:center;gap:8px;min-width:0}
    .brand-logo{display:block;height:var(--logo-h);width:auto;max-width:min(220px,60vw);object-fit:contain;object-position:left center}
    .insta-link{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;text-decoration:none;transition:transform .12s ease}
    .insta-link:hover{transform:translateY(-1px)}
    .insta-link svg{display:block;width:100%;height:100%}

    /* ========
       HERO
       ======== */
    .hero{display:grid;gap:8px;max-width:960px;margin:0 auto;padding:28px 16px 16px;align-items:start}
    .quote{font-weight:800;line-height:1.05;color:var(--ink);font-size:var(--fs-h1)}
    .author{font-style:italic;font-size:clamp(13px,2.2vw,20px);opacity:.85}

    /* ========
       PANEL
       ======== */
    .panel{background:var(--surface);border-radius:24px;padding:20px;max-width:960px;margin:0 auto;box-shadow:var(--elev-1)}
    @media (min-width:861px){.panel{padding:28px;box-shadow:var(--elev-2)}}

    /* Campos */
    .field-wrap{margin:14px 0 16px}
    .label{font-weight:900;font-size:var(--fs-label);color:#08333e;margin:0 0 10px}
    .help{color:var(--ink-2);font-size:.95em;margin-top:6px}
    .field{width:100%;background:var(--surface-2);border:1px solid var(--border);border-radius:16px;padding:14px;color:#11323c;outline:none;transition:box-shadow .15s,border-color .15s}
    .field:focus{border-color:#0b3b4a;box-shadow:0 0 0 3px rgba(11,59,74,.15)}
    textarea.field{min-height:110px;resize:vertical}

    /* A√ß√µes */
    .actions-out{display:grid;gap:12px}
    .actions-buttons{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:none;border-radius:14px;padding:12px 16px;font-weight:800;letter-spacing:.3px;color:#fff;cursor:pointer;transition:transform .06s ease, opacity .2s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--btn);flex:1}
    .btn-copy{background:var(--btn-copy);font-size:14px;padding:10px 12px}
    .btn-reset{background:var(--btn-reset)}
    .output{background:var(--surface-2);border:1px solid var(--border);border-radius:16px;min-height:150px;padding:14px;color:#16333b;width:100%;resize:vertical}

    /* Abas (desktop) */
    .tabs{max-width:960px;margin:12px auto;padding:0 16px;display:none;gap:8px}
    .tab-btn{border:1px solid var(--border);background:#fff;color:#000;padding:9px 14px;border-radius:999px;font-weight:700;cursor:pointer;font-size:14px}
    .tab-btn[aria-selected="true"]{background:var(--ink);color:#fff;border-color:transparent}

    /* Conte√∫do das abas */
    .tab-content{display:none;padding:0 16px 72px}
    .tab-content.is-active{display:block}

    /* Tabbar (mobile) */
    .tabbar{position:fixed;bottom:var(--recent-h);left:0;right:0;height:56px;background:#ffffffcc;backdrop-filter:saturate(120%) blur(8px);border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;z-index:1000;padding-bottom:env(safe-area-inset-bottom)}
    .tabbar button{all:unset;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 10px;border-radius:10px}
    .tabbar button[aria-selected="true"]{background:#e7fbf8;border:1px solid #bdebe3}
    .tabbar .lbl{font-size:15px;font-weight:700;color:#0b2f3b}
    @media (min-width:861px){.tabbar{display:none}.tabs{display:flex}.tab-content{padding-bottom:16px}}

    /* ARQUIVO (book) */
    .book-list{display:grid;gap:12px;max-height:60vh;overflow:auto;padding-right:6px;scroll-behavior:smooth}
    .book-item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:16px;padding:12px 14px}
    .book-meta{display:grid;gap:4px;min-width:0}
    .book-obj{font-weight:900;color:#08333e}
    .book-tema{color:#16333b;word-break:break-word}
    .chipbtn{border:1px solid var(--border);background:#ffffff;color:#0b2f3b;font-weight:800;padding:7px 12px;border-radius:999px;cursor:pointer;white-space:nowrap}
    .chipbtn:active{transform:translateY(1px)}
    @media (max-width:480px){.book-item{flex-direction:column;align-items:stretch}.chipbtn{align-self:flex-start}}

    /* Barra de √∫ltimas pesquisas (fixa na base) */
    .recent-bar{position:fixed;left:0;right:0;bottom:0;z-index:1001;background:#ffffffcc;backdrop-filter:saturate(120%) blur(8px);border-top:1px solid var(--border);padding:8px 10px calc(8px + env(safe-area-inset-bottom));height:var(--recent-h)}
    .recent-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;gap:10px;overflow:auto;scrollbar-width:none;height:100%}
    .recent-inner::-webkit-scrollbar{display:none}
    .recent-title{font-weight:800;color:var(--ink-2);white-space:nowrap}
    .recent-chip{border:1px solid var(--border);background:#fff;color:#0b2f3b;font-weight:700;padding:8px 12px;border-radius:999px;cursor:pointer;white-space:nowrap}
    .recent-empty{color:var(--ink-2)}

    /* DARK MODE refinado */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1518;
        --bg-gradient: radial-gradient(1200px 800px at 10% -10%, #0f2a2a 0%, transparent 60%),
                       radial-gradient(800px 600px at 110% 10%, #0f1d2a 0%, transparent 55%);
        --surface:#101b1f;
        --surface-2:#0f2328;
        --ink:#eaf2f4;
        --ink-2:#b2c8cf;
        --border:#21353c;
      }
      .label{color:#e6f6f8}
      .tab-btn{background:#0f2328;color:#dbe9ed;border-color:#21353c}
      .tab-btn[aria-selected="true"]{background:#1e444b}
      .tabbar{background:#0f1a1fcc;border-top-color:#21353c}
      .recent-bar{background:#0f1a1fcc;border-top-color:#21353c}
      .recent-chip{background:#0f2328;color:#eaf2f4;border-color:#21353c}
      .btn-primary{background:#146f81}
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar" aria-label="Barra superior">
    <div class="topbar-inner">
      <a class="brand-wrap" href="./" aria-label="direito.love ‚Äî in√≠cio">
        <img class="brand-logo" src="./icons/logo-menu.png"
             onerror="this.onerror=null; this.src='./icons/icon-192.png';"
             alt="direito.love" />
      </a>
      <div class="right">
        <a class="insta-link" href="https://www.instagram.com/osvaldosereiajr/" target="_blank" rel="noopener" aria-label="Abrir Instagram @osvaldosereiajr" title="@osvaldosereiajr">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <defs><linearGradient id="igGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f58529"/><stop offset="30%" stop-color="#feda77"/><stop offset="60%" stop-color="#dd2a7b"/><stop offset="80%" stop-color="#8134af"/><stop offset="100%" stop-color="#515bd4"/></linearGradient></defs>
            <rect x="0" y="0" width="24" height="24" rx="6" fill="url(#igGrad)"/>
            <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="#ffffff" stroke-width="2"/>
            <circle cx="12" cy="12" r="4.5" fill="none" stroke="#ffffff" stroke-width="2"/>
            <circle cx="17.2" cy="6.8" r="1.3" fill="#ffffff"/>
          </svg>
        </a>
      </div>
    </div>
  </nav>

  <!-- HERO (frase) -->
  <header class="hero">
    <div id="quote" class="quote">‚Äî</div>
    <div id="author" class="author"></div>
  </header>

  <!-- Tabs (desktop) -->
  <nav class="tabs" role="tablist" aria-label="Navega√ß√£o de se√ß√µes (desktop)">
    <button class="tab-btn" aria-selected="true" aria-controls="tab-gerador" id="tabbtn-gerador">Gerador</button>
    <button class="tab-btn" aria-selected="false" aria-controls="tab-book" id="tabbtn-book">Arquivo</button>
    <button class="tab-btn" aria-selected="false" aria-controls="tab-dicas" id="tabbtn-dicas">Dicas</button>
  </nav>

  <!-- Gerador -->
  <section id="tab-gerador" class="tab-content is-active" aria-labelledby="tabbtn-gerador">
    <main class="panel">
      <div class="field-wrap">
        <h3 class="label">Qual seu objetivo?</h3>
        <select id="strategy" class="field" aria-label="Escolher objetivo">
          <option value="entendo">AGORA EU ENTENDO</option>
          <option value="treinar">VAMOS TREINAR</option>
          <option value="raiox">RAIO-X</option>
        </select>
        <div class="help">Escolha o formato de estudo.</div>
      </div>

      <!-- Campos extras (s√≥ para VAMOS TREINAR) -->
      <div id="extra-fields" class="extras" aria-live="polite" style="display:none;gap:12px;flex-wrap:wrap">
        <div>
          <label class="label" for="nivel">N√≠vel</label>
          <select id="nivel" class="field">
            <option>Iniciante</option>
            <option>Intermedi√°rio</option>
            <option>Avan√ßado</option>
          </select>
        </div>
        <div>
          <label class="label" for="quant">Quantidade (5‚Äì30)</label>
          <input id="quant" class="field" type="number" min="5" max="30" step="1" value="10" />
        </div>
      </div>

      <div class="field-wrap">
        <h3 class="label">Vamos falar sobre o qu√™?</h3>
        <textarea id="theme" class="field" placeholder="Ex.: Dano est√©tico; Fun√ß√£o social do contrato"></textarea>
      </div>

      <div class="actions-out">
        <div class="actions-buttons">
          <button id="generate" class="btn btn-primary">Gerar</button>
          <button id="copy" class="btn btn-copy" aria-label="Copiar resultado">Copiar</button>
          <button id="reset" class="btn btn-reset">Reiniciar</button>
        </div>
        <textarea id="result" class="output" placeholder="Prompt gerado aqui..." readonly aria-label="Resultado"></textarea>
      </div>
    </main>
  </section>

  <!-- Arquivo -->
  <section id="tab-book" class="tab-content" aria-labelledby="tabbtn-book">
    <main class="panel">
      <h2 class="label">Arquivo ‚Äì Suas √∫ltimas 500 gera√ß√µes</h2>
      <p class="field" style="min-height:0;margin-top:0">Carrega automaticamente de 10 em 10 enquanto voc√™ rola.</p>
      <div id="book-list" class="book-list"></div>
    </main>
  </section>

  <!-- Dicas -->
  <section id="tab-dicas" class="tab-content" aria-labelledby="tabbtn-dicas">
    <main class="panel">
      <h2 class="label">üìò Estruturas de Resposta (3 modos)</h2>
      <div class="field" style="white-space:pre-wrap">
1) <b>AGORA EU ENTENDO</b>
- Explica√ß√£o did√°tica, simples, sem met√°foras.
- Sempre que poss√≠vel: listas, passos numerados e QUADROS/TABELAS comparativas.
- Se tiver aspecto processual: legitimidade, compet√™ncia, prazos, rito e recursos.

2) <b>VAMOS TREINAR</b>
- Quest√µes objetivas A‚ÄìD, varia√ß√£o de dificuldade.
- Primeiro todas as quest√µes; depois <b>Gabarito Comentado</b>.
- Campos extras no gerador: <i>N√≠vel</i> e <i>Quantidade</i>.

3) <b>RAIO-X</b>
- Cap√≠tulos sequenciais com autoriza√ß√£o cap√≠tulo a cap√≠tulo.
- <b>Links obrigat√≥rios</b> (sites jur√≠dicos/not√≠cias, artigos acad√™micos e universit√°rios; exce√ß√µes: Planalto e JusBrasil).
- Entrega: Sum√°rio ‚Üí Cap√≠tulo 1 ‚Üí "Continuo?"</div>
    </main>
  </section>

  <!-- Tabbar (mobile) -->
  <nav class="tabbar" role="tablist" aria-label="Navega√ß√£o (mobile)">
    <button aria-selected="true" aria-controls="tab-gerador" id="m-tabbtn-gerador"><span class="lbl">Gerar</span></button>
    <button aria-selected="false" aria-controls="tab-book" id="m-tabbtn-book"><span class="lbl">Arquivo</span></button>
    <button aria-selected="false" aria-controls="tab-dicas" id="m-tabbtn-dicas"><span class="lbl">Dicas</span></button>
  </nav>

  <!-- Barra fixa com as √∫ltimas pesquisas -->
  <div id="recent-bar" class="recent-bar" aria-live="polite">
    <div class="recent-inner" id="recent-inner">
      <span class="recent-title">√öltimas pesquisas:</span>
      <span class="recent-empty" id="recent-empty">(vazio)</span>
      <!-- chips entram aqui -->
    </div>
  </div>

  <script>
    // ===== Frases (frases.txt na raiz) =====
    async function loadRandomQuoteFromFile(){
      const fallback = ['N√£o h√° liberdade sem lei. ‚Äî Montesquieu','A justi√ßa sem for√ßa √© impotente; a for√ßa sem justi√ßa √© tirana. ‚Äî Pascal'];
      try{
        const res = await fetch('./frases.txt', {cache:'no-cache'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s && !s.startsWith('#'));
        const arr = lines.length ? lines : fallback;
        const pick = arr[Math.floor(Math.random()*arr.length)];
        const parts = pick.split('‚Äî');
        document.getElementById('quote').textContent = (parts[0]||pick).trim();
        document.getElementById('author').textContent = parts[1] ? '‚Äî '+parts[1].trim() : '';
      }catch{
        const pick = fallback[Math.floor(Math.random()*fallback.length)];
        const parts = pick.split('‚Äî');
        document.getElementById('quote').textContent = (parts[0]||pick).trim();
        document.getElementById('author').textContent = parts[1] ? '‚Äî '+parts[1].trim() : '';
      }
    }
    loadRandomQuoteFromFile();

    // ===== Tabs =====
    const tabIds=['gerador','book','dicas'];
    function activateTab(id){
      for(const t of tabIds){
        document.getElementById('tab-'+t).classList.toggle('is-active',t===id);
        document.getElementById('tabbtn-'+t)?.setAttribute('aria-selected',String(t===id));
        document.getElementById('m-tabbtn-'+t)?.setAttribute('aria-selected',String(t===id));
      }
    }
    for(const t of tabIds){
      document.getElementById('tabbtn-'+t)?.addEventListener('click',()=>activateTab(t));
      document.getElementById('m-tabbtn-'+t)?.addEventListener('click',()=>activateTab(t));
    }

    // ===== PWA: Service Worker =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    // ====== GERADOR: TEMPLATES (apenas 3) ======
    const TEMPLATES = {
      entendo: (tema) => `Voc√™ √© um tutor de Direito para iniciantes. Linguagem simples, objetiva e sem met√°foras.

Objetivo: explicar **${tema}** de forma clara e aplic√°vel.

Regras:
- Frases curtas. Sem jarg√£o desnecess√°rio.
- Sempre que poss√≠vel, use listas, passos numerados e QUADROS/TABELAS comparativas.
- Se o tema tiver aspecto processual, inclua: legitimidade, compet√™ncia, prazos, rito e recursos.

Formato (Markdown):
# Conceito em at√© 4 linhas
# Base legal essencial (artigos/leis)
# Quadro comparativo (tabela): Instituto | Quando se aplica | Exemplo r√°pido
# Passo a passo de racioc√≠nio (4‚Äì6 passos pr√°ticos)
# Exemplos pr√°ticos (3 mini-casos resolvidos)
# Erros comuns (3) e Pegadinhas de prova (2)
# Checklist de prova (5 itens objetivos)
# Mini gloss√°rio (5 termos-chave)`,

      treinar: (tema, nivel='Iniciante', quantidade=10) => {
        const q = Math.min(30, Math.max(5, Number(quantidade)||10));
        return `Voc√™ √© um elaborador de quest√µes de Direito para treino universit√°rio e OAB.

Par√¢metros do treino:
- N√≠vel: **${nivel}**
- Quantidade: **${q}** quest√µes

Regras:
- Quest√µes de m√∫ltipla escolha (A‚ÄìD), 1 correta + 3 alternativas plaus√≠veis.
- Misture: conceito, aplica√ß√£o pr√°tica e interpreta√ß√£o.
- Varie a dificuldade dentro do n√≠vel. Marque [F], [M] ou [D] no fim de cada enunciado.
- Primeiro liste TODAS as quest√µes ‚Üí depois traga o **GABARITO COMENTADO**.
- Cada justificativa: 1‚Äì2 linhas, explicando por que a correta est√° certa e as outras n√£o.

Tema: **${tema}**

Formato (Markdown):
# Quest√µes (1..N)
- Q1) ...
- ...
# Gabarito Comentado
- Q1) Letra X ‚Äî justificativa curta
- ...
# Pr√≥ximos passos sugeridos (3 t√≥picos r√°pidos)`;
      },

      raiox: (tema) => `Voc√™ √© um analista jur√≠dico. Produza um **RAIO-X** completo em cap√≠tulos sequenciais sobre **${tema}**, avan√ßando apenas com minha autoriza√ß√£o.

FONTES PERMITIDAS (estritamente):
- Sites de not√≠cias jur√≠dicas;
- Artigos acad√™micos e sites universit√°rios;
- EXCE√á√ïES oficiais: Planalto e JusBrasil.
(N√£o use outros sites governamentais. N√£o use blogs pessoais sem afilia√ß√£o acad√™mica/jur√≠dica.)

POL√çTICA DE LINKS (OBRIGAT√ìRIA):
- Toda afirma√ß√£o relevante deve vir com link CLIC√ÅVEL para a fonte.
- Use a URL CAN√îNICA do conte√∫do (evite Google/encurtadores).
- Para cada cita√ß√£o, informe: **[T√≠tulo] (Site/Institui√ß√£o ‚Äî Data)** e o **link** em Markdown.
- Se a confirma√ß√£o ainda n√£o for 100% segura, marque **[verificar]** sem inventar dados.

ESTILO:
- Linguagem clara, objetiva e profissional.
- Listas, t√≥picos e quadros/tabelas quando √∫teis.
- Se citar jurisprud√™ncia/s√∫mula/enunciado/ac√≥rd√£o: traga a **tese em 1‚Äì2 linhas** + link para a not√≠cia/artigo acad√™mico ou JusBrasil/Planalto.

FLUXO DE ENTREGA (obrigat√≥rio):
1) Mostrar **SUM√ÅRIO** dos cap√≠tulos (t√≠tulos curtos) ‚Äî com 1 linha de objetivo para cada cap√≠tulo.
2) Entregar **apenas o CAP√çTULO 1**.
3) Perguntar: **‚ÄúContinuo para o pr√≥ximo cap√≠tulo? (sim/n√£o) ‚Äî ou ‚Äòpular para: [n¬∫]‚Äô.‚Äù**
4) S√≥ avan√ßar ap√≥s minha resposta.

ESTRUTURA SUGERIDA DE CAP√çTULOS:
1. Conceito e Base legal
2. Doutrina (corrente majorit√°ria √ó minorit√°ria + autores)
3. Panorama acad√™mico (artigos universit√°rios, debates e tend√™ncias)
4. Not√≠cias jur√≠dicas recentes (s√≠nteses)
5. Jurisprud√™ncia e S√∫mulas (STF/STJ; enunciados ‚Äî teses em 1‚Äì2 linhas)
6. Aspectos processuais: legitimidade | compet√™ncia | prazos | rito | recursos | √¥nus da prova
7. Pr√°tica profissional: mini-pe√ßa (esqueleto), teses usuais, riscos e cuidados
8. Casos t√≠picos e como resolver (3 cen√°rios curtos, passo a passo)
9. Diverg√™ncias e controv√©rsias atuais (3‚Äì5 pontos)
10. Pegadinhas de prova (3) e D√∫vidas frequentes (5)
11. Checklist final (5 itens objetivos)
12. Refer√™ncias consolidadas (todas as fontes citadas, organizadas)

FORMATO (Markdown) DE CADA CAP√çTULO:
# T√≠tulo do cap√≠tulo
**Objetivo:** (1 linha)
## Conte√∫do
- T√≥picos claros, quadros/tabelas quando couber.
## Fontes do cap√≠tulo
- [T√≠tulo] (Site/Institui√ß√£o ‚Äî Data). Link: https://...
- [T√≠tulo] (Site/Institui√ß√£o ‚Äî Data). Link: https://...

Ao concluir cada cap√≠tulo, pergunte: **‚ÄúContinuo para o pr√≥ximo cap√≠tulo?‚Äù**`
    };

    // ====== GERADOR: handlers ======
    const strategyEl=document.getElementById('strategy');
    const themeEl=document.getElementById('theme');
    const resultEl=document.getElementById('result');
    const btnGen=document.getElementById('generate');
    const btnCopy=document.getElementById('copy');
    const btnReset=document.getElementById('reset');

    // Extras (somente para VAMOS TREINAR)
    const extrasWrap = document.getElementById('extra-fields');
    const nivelEl = document.getElementById('nivel');
    const quantEl = document.getElementById('quant');

    function toggleExtras(){
      const isTreinar = strategyEl.value === 'treinar';
      extrasWrap.style.display = isTreinar ? 'flex' : 'none';
    }
    toggleExtras();
    strategyEl.addEventListener('change', toggleExtras);

    function strategyHumanName(v){
      const map={ entendo:'AGORA EU ENTENDO', treinar:'VAMOS TREINAR', raiox:'RAIO-X' };
      return map[v]||v;
    }

    // ===== Recentes: util de truncar (30 chars)
    function truncate30(s){
      const str=(s||'').trim();
      if(str.length<=30) return str; return str.slice(0,30).replace(/[\s\.,;:!-]+$/,'')+'‚Ä¶';
    }

    // ===== BOOK (persist√™ncia local) =====
    const BOOK_KEY='book_data_v1';
    const PAGE_SIZE=10;
    let bookData=[]; let bookCursor=0; const bookWrap=document.getElementById('book-list');

    function loadBook(){ try{ bookData = JSON.parse(localStorage.getItem(BOOK_KEY)||'[]'); if(!Array.isArray(bookData)) bookData=[]; }catch{ bookData=[]; } }
    function truncate150(s){return (s||'').length>150?s.slice(0,150)+'‚Ä¶':s}
    function clearBookUI(){ if(bookWrap){ bookWrap.innerHTML=''; bookCursor=0; } }
    function renderBatch(){
      if(!bookWrap) return; const end=Math.min(bookCursor+PAGE_SIZE, bookData.length); const frag=document.createDocumentFragment();
      for(let i=bookCursor;i<end;i++){
        const {objetivo,tema,prompt}=bookData[i];
        const el=document.createElement('div'); el.className='book-item';
        el.innerHTML=`
          <div class="book-meta">
            <div class="book-obj">${objetivo||'‚Äî'}</div>
            <div class="book-tema">${truncate150(tema||'')}</div>
          </div>
          <div><button class="chipbtn" data-prompt="${String(prompt||'').replace(/"/g,'&quot;')}">Copiar</button></div>`;
        frag.appendChild(el);
      }
      bookWrap.appendChild(frag); bookCursor=end;
    }
    function onScroll(){
      if(!bookWrap) return;
      const near=bookWrap.scrollTop+bookWrap.clientHeight>=bookWrap.scrollHeight-8;
      if(near && bookCursor<bookData.length) renderBatch();
    }
    bookWrap?.addEventListener('scroll', onScroll);

    // ===== Recentes (6 √∫ltimos √∫nicos) =====
    const recentWrap=document.getElementById('recent-inner');
    const recentEmpty=document.getElementById('recent-empty');
    function updateRecentBar(){
      let data=[]; try{ data=JSON.parse(localStorage.getItem(BOOK_KEY)||'[]'); if(!Array.isArray(data)) data=[]; }catch{}
      const recent=[];
      for(const it of data){
        const tema=(it?.tema||'').trim(); if(!tema) continue;
        if(!recent.includes(tema)) recent.push(tema);
        if(recent.length>=6) break;
      }
      // remove chips antigos
      Array.from(recentWrap.querySelectorAll('button.recent-chip')).forEach(n=>n.remove());
      if(recent.length===0){ recentEmpty.style.display='inline'; return; }
      recentEmpty.style.display='none';
      recent.forEach(tema=>{
        const b=document.createElement('button');
        b.className='recent-chip'; b.type='button'; b.title=tema; b.textContent=truncate30(tema);
        b.addEventListener('click',()=>{ themeEl.value=tema; themeEl.focus(); });
        recentWrap.appendChild(b);
      });
    }

    // ===== GERAR / COPIAR / RESET =====
    function generate(){
      const s = strategyEl.value;
      const t = (themeEl.value||'').trim();
      if(!s){ alert('Selecione o objetivo.'); return; }
      if(!t){ alert('Digite o tema.'); themeEl.focus(); return; }
      const tpl = TEMPLATES[s];
      if(!tpl){ alert('Estrat√©gia inv√°lida. Atualize a p√°gina.'); return; }

      let out;
      if(s==='treinar'){
        const nivel = (nivelEl?.value)||'Iniciante';
        let q = Number(quantEl?.value)||10; q = Math.min(30, Math.max(5, q));
        out = tpl(t, nivel, q);
      } else {
        out = tpl(t);
      }
      resultEl.value = out;

      // Book local (salva no hist√≥rico)
      try{
        let bd=JSON.parse(localStorage.getItem(BOOK_KEY)||'[]'); if(!Array.isArray(bd)) bd=[];
        bd.unshift({ objetivo: strategyHumanName(s), tema: t, prompt: out, ts: Date.now() });
        if(bd.length>500) bd = bd.slice(0,500);
        localStorage.setItem(BOOK_KEY, JSON.stringify(bd));
      }catch{}

      // Se estiver na aba Arquivo, atualiza a lista
      if(document.getElementById('tab-book').classList.contains('is-active')){ clearBookUI(); loadBook(); renderBatch(); }
      // Atualiza barra de recentes (6 √∫ltimos, 30 chars)
      updateRecentBar();

      window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    }

    async function copyOut(){
      if(!resultEl.value) return alert('Nada para copiar.');
      try{
        await navigator.clipboard.writeText(resultEl.value);
        const old = btnCopy.textContent; btnCopy.textContent='COPIADO'; btnCopy.disabled=true;
        setTimeout(()=>{ btnCopy.textContent=old; btnCopy.disabled=false; }, 1200);
      }catch{
        const ta = document.createElement('textarea'); ta.value = resultEl.value; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.focus(); ta.select();
        try{ document.execCommand('copy'); const old = btnCopy.textContent; btnCopy.textContent='COPIADO'; btnCopy.disabled=true; setTimeout(()=>{ btnCopy.textContent=old; btnCopy.disabled=false; }, 1200); }
        catch{ alert('N√£o foi poss√≠vel copiar.'); }
        finally{ document.body.removeChild(ta); }
      }
    }
    function resetAll(){
      strategyEl.value='entendo';
      themeEl.value=''; resultEl.value='';
      if(nivelEl) nivelEl.value='Iniciante'; if(quantEl) quantEl.value='10';
      toggleExtras();
      window.scrollTo({top:0,behavior:'smooth'});
    }

    btnGen?.addEventListener('click', generate);
    btnCopy?.addEventListener('click', copyOut);
    btnReset?.addEventListener('click', resetAll);
    themeEl?.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='enter'){generate();}});

    // ===== Inicializa√ß√µes =====
    // Carrega book ao abrir aba
    const _activate=activateTab;
    activateTab=function(id){
      _activate(id);
      if(id==='book'){
        if(!bookData.length){ loadBook(); }
        if(bookCursor===0){ renderBatch(); }
      }
    };

    // Copiar direto dos cards do Arquivo
    document.addEventListener('click',async e=>{
      const btn=e.target.closest('.chipbtn'); if(!btn||!btn.dataset.prompt) return;
      try{
        await navigator.clipboard.writeText(btn.dataset.prompt);
        const old=btn.textContent; btn.textContent='Copiado!'; setTimeout(()=>btn.textContent=old,1000);
      }catch{ alert('N√£o foi poss√≠vel copiar.'); }
    });

    // Primeira renderiza√ß√£o da barra de recentes
    updateRecentBar();
  </script>
</body>
</html>
