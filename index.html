<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>direito.love — Estudo & Pesquisa</title>
<meta name="theme-color" content="#F5C400" />
<link rel="icon" href="favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="favicon-180.png" />
<style>
  :root{
    --bg:#FFFDF0; --surface:#fff; --text:#001840; --border:#e5e7eb;
    --primary:#102A71; --highlight:#F5C400; --highlight-light:#FFDC5F;
    --radius:12px; --shadow:0 4px 16px rgba(0,0,0,.05);
    --font:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,system-ui,sans-serif;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --btn-py:6px; --btn-px:10px; --btn-f:12.5px; --btn-h:34px; --btn-w:96px;
    --chip-py:6px; --chip-px:10px; --chip-f:12.5px; --chip-r:8px;
    --mark-bg:#CFF8CF; --mark-t:#063106;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:400 13px/1.5 var(--font)}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:100;background:var(--highlight);border-bottom:1px solid rgba(0,0,0,.08)}
  .topbar__inner{max-width:1160px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;color:#111;text-decoration:none}
  .brand__logo{height:32px}
  .nav__actions{display:flex;gap:8px}
  .chip{padding:var(--chip-py) var(--chip-px);border-radius:var(--chip-r);background:#fff;border:1px solid var(--border);font-size:var(--chip-f);color:var(--primary);text-decoration:none;font-weight:600;transition:.15s}
  .chip:hover{background:var(--highlight-light)}
  .chip.is-active{background:#0f1d4a;color:#fff;border-color:#0f1d4a}

  /* Layout base */
  .wrap{max-width:960px;margin:0 auto;padding:22px}
  h2{margin:0 0 8px;color:var(--primary)}
  .muted{color:#475569;margin-top:2px}

  /* Botões menores */
  .btn{appearance:none;border:1px solid var(--border);background:var(--highlight);color:#000;padding:var(--btn-py) var(--btn-px);border-radius:8px;font-size:var(--btn-f);cursor:pointer;min-height:var(--btn-h);min-width:var(--btn-w);transition:.15s}
  .btn:hover{background:var(--highlight-light)}
  .btn-alt{appearance:none;border:1px solid #0f2a71;background:var(--primary);color:#fff;padding:var(--btn-py) var(--btn-px);border-radius:8px;font-size:var(--btn-f);cursor:pointer;min-height:var(--btn-h);min-width:var(--btn-w);transition:.15s}
  .btn-alt:hover{background:#27439a}
  .btn-alt.is-selected{background:#16a34a;border-color:#148c41}
  .btn-ghost{appearance:none;border:1px solid var(--border);background:#fff;color:#0f172a;padding:var(--btn-py) var(--btn-px);border-radius:8px;font-size:var(--btn-f);cursor:pointer;min-height:var(--btn-h);min-width:var(--btn-w)}
  .btn-danger{background:#ef4444;color:#fff;border:1px solid #b91c1c}

  /* Inputs */
  .search-box{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:18px 0}
  .text{flex:1;padding:10px 12px;border:2px solid var(--primary);border-radius:10px;font-size:15px;background:#fff}
  .pills{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 10px;cursor:pointer;font-weight:600}
  .pill.is-on{background:#0f2a71;color:#fff;border-color:#0f2a71}

  /* Categorias (acordeões) */
  .cat{background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);margin:12px 0;overflow:hidden}
  .cat > summary{list-style:none;display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:10px 14px;font-weight:800;color:var(--primary)}
  .cat > summary::-webkit-details-marker{display:none}
  .cat[open] > summary{background:#fff7d6}
  .cat-count{font-weight:700;background:#0f172a0d;color:#0f172a;padding:2px 8px;border-radius:999px;font-size:12px}
  .cat-body{padding:10px 14px}
  .cat-more{display:flex;justify-content:center;padding:6px 14px 12px}
  .result{background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:12px 14px;margin:10px 0}
  .filetag{display:inline-block;font-weight:700;font-size:12px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;margin:0 0 8px 0}
  .result p{margin:0;font-size:13px;line-height:1.55}
  mark{background:var(--mark-bg);color:var(--mark-t);padding:0 .1em;border-radius:3px}
  .actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn-news{background:#16a34a;color:#fff;border:1px solid #0e8f42;padding:var(--btn-py) var(--btn-px);border-radius:8px;font-size:var(--btn-f);min-height:var(--btn-h);min-width:var(--btn-w);text-decoration:none}

  /* Barra seleção (pesquisa) */
  .bar{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(12px + var(--safe-bottom));z-index:60;background:#111;color:#fff;padding:8px 10px;border-radius:12px;display:none;gap:8px;align-items:center;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .bar .btn, .bar .btn-alt{min-width:120px}

  /* Prompt */
  .section{display:none}
  .section.is-active{display:block}
  .hint{margin-top:8px;color:#0f2a71;font-weight:700;display:none}
  .hint.show{display:block}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px}
  .opt{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;border:1px dashed #d7dce5;border-radius:10px;padding:10px;margin:8px 0;background:#fafcff}
  .opt__txt{max-width:70%}
  .opt__txt h4{margin:0 0 6px}
  .opt__toggle{white-space:nowrap}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:80}
  .modal.show{display:flex}
  .modal__box{background:#fff;max-width:820px;width:100%;border-radius:12px;box-shadow:var(--shadow);padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .textarea{width:100%;min-height:220px;border:1px solid var(--border);border-radius:10px;padding:10px;font-size:13px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip-link{padding:6px 10px;border-radius:999px;background:#0f2a71;color:#fff;text-decoration:none;font-weight:700;border:1px solid #0d2463}
  .chip-link:hover{filter:brightness(1.05)}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;opacity:0;transition:.2s;z-index:90}
  .toast.show{opacity:1}

  @media (min-width: 880px){
    .grid{grid-template-columns:1.1fr .9fr}
  }
  @media (max-width:600px){
    .opt__txt{max-width:100%}
  }
</style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar__inner">
      <a class="brand" href="#prompt" aria-label="Início">
        <img class="brand__logo" src="icons/logo.png" alt="direito.love" />
      </a>
      <nav class="nav__actions">
        <a id="navPrompt" class="chip is-active" href="#prompt">Prompt</a>
        <a id="navSearch" class="chip" href="#pesquisa">Pesquisar</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- ========== SEÇÃO PESQUISA ========== -->
    <section id="sec-pesquisa" class="section">
      <h2>Pesquisa de Conteúdo Jurídico</h2>
      <p class="muted">Busque por <b>tema</b>, <b>artigo</b>, <b>súmula</b>, <b>jurisprudência</b> ou <b>julgado</b>. Resultados agrupados e com marca-texto.</p>

      <div class="search-box">
        <input id="busca" class="text" type="text" placeholder="Ex: art. 120 CP, súmula 381, crime de homicídio..." />
        <button id="btnBuscar" class="btn-alt">Buscar</button>
      </div>

      <div class="pills" id="quickPills">
        <button class="pill is-on" data-mode="tema">Tema</button>
        <button class="pill" data-mode="artigo">Artigo</button>
        <button class="pill" data-mode="sumula">Súmula</button>
        <button class="pill" data-mode="juris">Jurisprudência</button>
        <button class="pill" data-mode="julgado">Julgado</button>
      </div>

      <!-- Categorias -->
      <section id="categorias"></section>
    </section>

    <!-- ========== SEÇÃO PROMPT ========== -->
    <section id="sec-prompt" class="section is-active">
      <h2>Criador de Prompts para Estudantes de Direito</h2>

      <div class="grid">
        <div class="card">
          <label for="tema"><b>Digite o tema ou utilize a pesquisa para encontrar:</b></label>
          <textarea id="tema" class="textarea" placeholder="Ex.: Dano moral por inscrição indevida, Art. 120 do Código Penal, Homicídio qualificado..."></textarea>
          <div id="temaHint" class="hint">Tema definido. Agora selecione as sessões do seu prompt.</div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:flex-end">
            <button id="btnGerar" class="btn-alt">Gerar Prompt</button>
            <button id="btnLimparTema" class="btn-ghost">Limpar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Sessões do seu prompt</h3>
        <div id="opts"></div>
      </div>
    </section>
  </main>

  <!-- Barra seleção (pesquisa) -->
  <div id="selectBar" class="bar" aria-live="polite">
    <button id="barEnviar" class="btn-alt">Enviar para o Prompt</button>
    <button id="barLimpar" class="btn-ghost">Limpar</button>
  </div>

  <!-- Modal do Prompt -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal__box">
      <h3 style="margin:0 0 8px;color:#102A71">Seu Prompt</h3>
      <textarea id="outPrompt" class="textarea" readonly></textarea>
      <div class="row" style="margin-top:8px">
        <button id="btnCopy" class="btn-alt">Copiar Prompt</button>
        <button id="btnNovo" class="btn-ghost">Novo</button>
        <button id="btnFechar" class="btn-danger">Fechar</button>
      </div>
      <div id="iaChips" style="display:none;margin-top:10px">
        <p style="margin:10px 0 6px"><b>Abrir em uma IA:</b></p>
        <div class="chips">
          <a class="chip-link" target="_blank" href="https://chatgpt.com/">ChatGPT</a>
          <a class="chip-link" target="_blank" href="https://claude.ai/new">Claude</a>
          <a class="chip-link" target="_blank" href="https://gemini.google.com/app">Gemini</a>
          <a class="chip-link" target="_blank" href="https://www.perplexity.ai/">Perplexity</a>
          <a class="chip-link" target="_blank" href="https://copilot.microsoft.com/">Copilot</a>
          <a class="chip-link" target="_blank" href="https://www.phind.com/">Phind</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

<script>
(() => {
  /* ========= util ========= */
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
  const toast=(m,t=1600)=>{const el=$("#toast");el.textContent=m;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);};
  const debounce=(fn,ms)=>{let id;return(...a)=>{clearTimeout(id);id=setTimeout(()=>fn(...a),ms);};};

  /* ========= router (hash) ========= */
  const sectionsMap = {
    prompt:  $("#sec-prompt"),
    pesquisa:$("#sec-pesquisa"),
  };
  const navPrompt=$("#navPrompt"), navSearch=$("#navSearch");
  function setActive(hash){
    const key = (hash||'').replace(/^#/, '') || 'prompt';
    for(const [k,el] of Object.entries(sectionsMap)){ el.classList.toggle('is-active', k===key); }
    navPrompt.classList.toggle('is-active', key==='prompt');
    navSearch.classList.toggle('is-active', key==='pesquisa');
  }
  window.addEventListener('hashchange', ()=>setActive(location.hash));
  setActive(location.hash);

  /* ========= dados / arquivos ========= */
  const arquivos = [
    "data/julgados_direito_administrativo.json",
    "data/julgados_direito_ambiental.json",
    "data/julgados_direito_bancario.json",
    "data/julgados_direito_civil.json",
    "data/julgados_direito_constitucional.json",
    "data/julgados_direito_eleitoral.json",
    "data/julgados_direito_empresarial.json",
    "data/noticias_migalhas_1.json",
    "data/noticias_migalhas_2.json",
    "data/noticias_migalhas_3.json",
    "data/codigo_penal.json",
    "data/codigo_processo_penal.json",
    "data/sumula_stf.json",
    "data/sumulas_stj.json",
    "data/sumulas_tse.json",
    "data/sumulas_vinculantes_stf.json",
    "data/temas_repetitivos_stj.json",
    "data/teses_stf.json",
    "data/codigo_processo_civil.json",
    "data/codigo_civil.json",
    "data/codigo_tributario_nacional.json",
    "data/codigo_defesa_consumidor.json",
    "data/codigo_transito_brasileiro.json",
  ];
  const nomesAmigaveis = {
    noticias: "Notícias",
    noticias_migalhas_1:"Notícias Migalhas",
    noticias_migalhas_2:"Notícias Migalhas",
    noticias_migalhas_3:"Notícias Migalhas",
    sumula_stf:"Súmulas STF", sumulas_stj:"Súmulas STJ", sumulas_tse:"Súmulas TSE",
    sumulas_vinculantes_stf:"Súmulas Vinculantes STF",
    temas_repetitivos_stj:"Temas Repetitivos STJ", teses_stf:"Teses STF",
    codigo_tributario_nacional:"Código Tributário Nacional",
    codigo_penal:"Código Penal", codigo_civil:"Código Civil",
    codigo_processo_penal:"Código de Processo Penal", codigo_processo_civil:"Código de Processo Civil",
    julgados_direito_administrativo:"Julgados de Direito Administrativo",
    julgados_direito_ambiental:"Julgados de Direito Ambiental",
    julgados_direito_bancario:"Julgados de Direito Bancário",
    julgados_direito_civil:"Julgados de Direito Civil",
    julgados_direito_constitucional:"Julgados de Direito Constitucional",
    julgados_direito_eleitoral:"Julgados de Direito Eleitoral",
    julgados_direito_empresarial:"Julgados de Direito Empresarial",
    codigo_defesa_consumidor:"Código de Defesa do Consumidor",
    codigo_transito_brasileiro:"Código de Trânsito Brasileiro",
  };
  const categorias = {
    noticias: { label:"Notícias", match:f=>f.startsWith('noticias') },
    codigos:  { label:"Códigos",  match:f=>f.startsWith('codigo_') },
    sumulas:  { label:"Súmulas",  match:f=>f.startsWith('sumula') || f.startsWith('sumulas_') || f==='sumulas_vinculantes_stf' },
    julgados: { label:"Julgados", match:f=>f.startsWith('julgados_') },
    temas_repetitivos_stj:{ label:"Temas Repetitivos STJ", match:f=>f==='temas_repetitivos_stj' },
    teses_stf:{ label:"Teses STF", match:f=>f==='teses_stf' },
    outros:   { label:"Outros", match:_=>true },
  };
  const normalizarFonte=f=>f && f.startsWith('noticias') ? 'noticias' : f;

  /* ========= normalização / parsing ========= */
  const norm=(s="")=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  function normalizeLegal(s){
    let t=norm(s);
    t=t.replace(/§+/g,' paragrafo ');
    t=t.replace(/\bpar\.?\b/g,' paragrafo ');
    t=t.replace(/\bart\.?\b|\bartigo\b/g,' art ');
    t=t.replace(/\binc\.?\b/g,' inciso ');
    t=t.replace(/\bal\.?\b/g,' alinea ');
    t=t.replace(/\bunico\b/g,' unico ');
    t=t.replace(/(\d+)\s*[ºªoa]\b/g,'$1');
    t=t.replace(/["'()]/g,' ').replace(/\s+/g,' ').trim();
    return t;
  }
  const STOP=new Set(['de','da','do','das','dos','e','ou','a','o','as','os','no','na','nos','nas','para','por','em','um','uma','ao','à','que','com','sem','sobre','entre','ate','dois','três','seu','sua']);
  const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const hasWhole=(hay,word)=>!word||new RegExp(`(^|[^a-z0-9])${esc(word)}([^a-z0-9]|$)`,'i').test(hay);

  /* Proximidade: tokeniza e verifica se todas as palavras aparecem numa janela com gap≤1 */
  function okProximity(text, words, gap=1){
    const toks = normalizeLegal(text).split(' ').filter(Boolean);
    const q = words.filter(w=>w && !STOP.has(w));
    if(!q.length) return true;
    const posmap = new Map();
    q.forEach(w=>posmap.set(w,[]));
    toks.forEach((t,i)=>{ q.forEach(w=>{ if(t===w) posmap.get(w).push(i); }); });
    // precisa ter ao menos uma ocorrência de cada
    for(const w of q){ if(posmap.get(w).length===0) return false; }
    // brute-force pequeno: tenta alinhamentos iniciais
    for(const p0 of posmap.get(q[0])){
      let last = p0, ok = true;
      for(let k=1;k<q.length;k++){
        const arr = posmap.get(q[k]);
        const next = arr.find(ix => ix>=last && (ix-last-1) <= gap);
        if(next==null){ ok=false; break; }
        last = next;
      }
      if(ok) return true;
    }
    return false;
  }

  /* Marca-texto: envolve tokens da query (limpos) com <mark> */
  function highlight(text, words){
    let html = text;
    const uniq = [...new Set(words.filter(w=>w && !STOP.has(w)).sort((a,b)=>b.length-a.length))];
    for(const w of uniq){
      const re = new RegExp(`(^|[^\\p{L}\\p{N}])(${esc(w)})(?=[^\\p{L}\\p{N}]|$)`,'giu');
      html = html.replace(re, (_,b,mid)=> `${b}<mark>${mid}</mark>`);
    }
    return html;
  }

  function parseQuery(raw){
    const base = normalizeLegal(raw);
    const padded = ` ${base} `;
    const alias=[/\\bcp\\b|\\bcodigo penal\\b/,/\\bcpp\\b|\\bcodigo de processo penal\\b/,/\\bcc\\b|\\bcodigo civil\\b/,/\\bcpc\\b|\\bcodigo de processo civil\\b/,/\\bctn\\b|\\bcodigo tributario nacional\\b/,/\\bcdc\\b|\\bcodigo de defesa do consumidor\\b/,/\\bctb\\b|\\bcodigo de transito brasileiro\\b/];
    let tokens = base.split(' ').filter(Boolean).filter(t=>!STOP.has(t));
    // normalizar menções
    if(/\\bart\\b/.test(padded)){ const m=padded.match(/\\bart\\s*([0-9][0-9a-z\\-]*)\\b/); if(m) tokens = ['art', m[1], ...tokens]; }
    alias.forEach(re=>{ if(re.test(padded)) tokens.push(base.match(re)?.[0].split(' ')[0]); });
    return [...new Set(tokens)];
  }

  /* ========= carregar base ========= */
  let baseDados=[];
  async function carregarDados(){
    const dados=[];
    for(const arq of arquivos){
      try{
        const tag=arq.split('/').pop().replace(/\\.json$/,'');
        const r=await fetch(arq); if(!r.ok) continue;
        const j=await r.json();
        (Array.isArray(j)?j:[]).forEach((it,idx)=>{
          const _id=it.id||`${tag}_${idx}`;
          const texto=(it.texto||'').trim();
          dados.push({ ...it, _id, fonte:tag, textoNorm:norm(texto), textoLegal:normalizeLegal(texto) });
        });
      }catch(e){ console.warn('Erro ao carregar',arq,e); }
    }
    baseDados = dados;
    toast('Base carregada com sucesso!');
  }
  carregarDados();

  /* ========= pesquisa ========= */
  const MAX_SNIPPET=400, PAGE_SIZE=10;
  const KEY='dl_pesq_sel';
  const getCarrinho=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
  const setCarrinho=(a)=>localStorage.setItem(KEY, JSON.stringify(a));
  const dedupPush=(arr,item)=>{ const k=item.id||item._id||(item.fonte+':'+(item.texto||'').slice(0,50)); if(!arr.some(x=>x.id===k)) arr.push({...item,id:k}); return arr; };
  const categoriasEl=$("#categorias");
  const busca=$("#busca");
  const pills=$("#quickPills");
  let searchMode='tema';

  pills.addEventListener('click', e=>{
    const b=e.target.closest('.pill'); if(!b) return;
    $$('.pill',pills).forEach(x=>x.classList.remove('is-on'));
    b.classList.add('is-on'); searchMode=b.dataset.mode||'tema';
  });

  function groupResults(items){
    const groups={};
    for(const id of Object.keys(categorias)){ groups[id]={label:categorias[id].label,items:[],rendered:0}; }
    items.forEach(it=>{
      const f=it.fonte||''; let buck='outros';
      for(const id of Object.keys(categorias)){
        if(id==='outros') continue;
        if(categorias[id].match(f)){ buck=id; break; }
      }
      groups[buck].items.push(it);
    });
    // ordenar por volume desc
    return Object.fromEntries(Object.entries(groups).filter(([,g])=>g.items.length).sort((a,b)=>b[1].items.length-a[1].items.length));
  }

  function buildCard(item, words, carrinho){
    const fNorm=normalizarFonte(item.fonte);
    const isNoticias=fNorm==='noticias';
    const nome=nomesAmigaveis[fNorm]||nomesAmigaveis[item.fonte]||item.fonte;
    const div=document.createElement('div'); div.className='result';

    const tag=document.createElement('div'); tag.className='filetag'; tag.textContent=nome; div.appendChild(tag);

    const p=document.createElement('p'); const txt=(item.texto||'').trim();
    const isLong = txt.length>MAX_SNIPPET;
    const snippet = isLong ? (txt.substring(0,MAX_SNIPPET)+'…') : txt;
    p.innerHTML = highlight(snippet, words);
    div.appendChild(p);

    if(isLong){
      const tg=document.createElement('button'); tg.className='btn-ghost'; tg.textContent='Ver mais';
      tg.addEventListener('click', ()=>{ if(tg.textContent==='Ver mais'){ p.innerHTML = highlight(txt, words); tg.textContent='Ver menos'; } else { p.innerHTML = highlight(snippet, words); tg.textContent='Ver mais'; }});
      div.appendChild(tg);
    }

    const actions=document.createElement('div'); actions.className='actions';

    // copiar: NÃO para notícias
    if(!isNoticias){
      const copiar=document.createElement('button'); copiar.className='btn'; copiar.textContent='Copiar';
      copiar.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(item.texto||''); toast('Copiado!'); }catch{ toast('Erro ao copiar.'); } });
      actions.appendChild(copiar);
    }

    // selecionar: sempre
    const sel=document.createElement('button'); sel.className='btn-alt';
    const key=item.id||item._id; const sync=(on)=>{ sel.textContent=on?'Selecionado':'Selecionar'; sel.classList.toggle('is-selected',on); };
    sync(carrinho.some(x=>x.id===key));
    sel.addEventListener('click',()=>{ let arr=getCarrinho(); const obj={id:key,fonte:item.fonte,texto:item.texto||item.titulo||''};
      if(arr.some(x=>x.id===key)){ arr=arr.filter(x=>x.id!==key); sync(false); } else { arr=dedupPush(arr,obj); sync(true); }
      setCarrinho(arr); updateSelectBar();
    });
    actions.appendChild(sel);

    // ver notícia (se tiver url)
    if(item.url){
      const a=document.createElement('a'); a.className='btn-news'; a.textContent='Ver notícia'; a.href=item.url; a.target='_blank'; a.rel='noopener noreferrer';
      actions.appendChild(a);
    }

    div.appendChild(actions);
    return div;
  }

  function renderCategorias(groups, words){
    categoriasEl.innerHTML='';
    const entries=Object.entries(groups);
    if(!entries.length){ categoriasEl.innerHTML='<p>Nenhum resultado encontrado.</p>'; return; }
    let first=false;
    for(const [id,g] of entries){
      const det=document.createElement('details'); det.className='cat';
      const sum=document.createElement('summary'); const t=document.createElement('span'); t.textContent=g.label; const c=document.createElement('span'); c.className='cat-count'; c.textContent=g.items.length;
      sum.appendChild(t); sum.appendChild(c); det.appendChild(sum);

      const body=document.createElement('div'); body.className='cat-body'; det.appendChild(body);
      const moreW=document.createElement('div'); moreW.className='cat-more'; const mbtn=document.createElement('button'); mbtn.className='btn'; mbtn.textContent='Carregar mais'; moreW.appendChild(mbtn); moreW.style.display='none'; det.appendChild(moreW);

      function renderBatch(append=false){
        const carrinho=getCarrinho();
        const start=g.rendered; const end=Math.min(g.items.length, start+PAGE_SIZE);
        if(!append) body.innerHTML='';
        for(let i=start;i<end;i++){ body.appendChild(buildCard(g.items[i], words, carrinho)); }
        g.rendered=end; moreW.style.display = (g.rendered<g.items.length)?'flex':'none';
      }

      det.addEventListener('toggle', ()=>{ if(det.open && g.rendered===0) renderBatch(false); });
      mbtn.addEventListener('click', ()=>renderBatch(true));

      categoriasEl.appendChild(det);
      if(!first){ /* começa FECHADO por padrão */ first=true; }
    }
  }

  function updateSelectBar(){
    const bar=$("#selectBar");
    const hasSel = getCarrinho().length>0;
    bar.style.display = hasSel ? 'flex' : 'none';
  }
  $("#barLimpar").addEventListener('click', ()=>{ localStorage.removeItem(KEY); updateSelectBar(); [...$$('.btn-alt.is-selected', categoriasEl)].forEach(b=>b.classList.remove('is-selected')); [...$$('.btn-alt', categoriasEl)].forEach(b=>{ if(b.textContent==='Selecionado') b.textContent='Selecionar'; }); });

  // enviar para prompt → cola no campo tema e troca para #prompt
  $("#barEnviar").addEventListener('click', ()=>{
    const arr=getCarrinho(); if(!arr.length) return;
    const bloco = arr.map(x=> (x.texto||'').trim()).filter(Boolean).join('\n\n— — —\n\n');
    const tema=$("#tema"); tema.value = (tema.value.trim() ? (tema.value.trim()+'\n\n') : '') + bloco;
    localStorage.removeItem(KEY); updateSelectBar();
    $("#temaHint").classList.add('show');
    location.hash='#prompt';
    toast('Conteúdo da pesquisa inserido no Tema.');
  });

  async function executarBusca(){
    const raw = busca.value.trim();
    categoriasEl.innerHTML='';
    if(!raw){ updateSelectBar(); return; }
    const words = parseQuery(raw);
    // modo pode influenciar pesos no futuro; por ora só mantém flexível
    const all = baseDados.filter(x => hasWhole(x.textoLegal, words[0]||'') && okProximity(x.texto, words, 1));
    const groups=groupResults(all);
    renderCategorias(groups, words);
    updateSelectBar();
  }
  $("#btnBuscar").addEventListener('click', executarBusca);
  busca.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); executarBusca(); } });

  /* ========= Prompt ========= */
  const optsData = [
    ["conceitos","Conceitos & Definições","Definições objetivas, linguagem clara e diferenciações essenciais, com 1–2 exemplos curtos."],
    ["baselegal","Base Legal Essencial","Artigos, incisos, parágrafos e súmulas diretamente aplicáveis ao tema, com citação literal quando necessário."],
    ["juris","Jurisprudência Majoritária","Entendimento predominante (STJ/STF) e teses repetitivas. Indique se há divergências relevantes."],
    ["doutrina","Doutrina Relevante","Pontos-chave de autores clássicos e contemporâneos. Traga posições contrastantes se houver."],
    ["casos","Exemplos & Casos Práticos","Cenários típicos e aplicação dos requisitos, com estrutura de raciocínio e resultado esperado."],
    ["comparativo","Quadro Comparativo","Similaridades/diferenças entre institutos próximos; tabela mental rápida quando couber."],
    ["fixacao","Questões de Fixação","5–10 questões objetivas com gabarito e justificativa curta."],
    ["debates","Debates, Críticas & Tendências","Controvérsias atuais, impactos práticos e movimentos recentes nos tribunais."],
    ["sumulas","Súmulas & Enunciados","Lista das súmulas centrais (STJ/STF/TJs) com síntese aplicada ao tema."],
    ["modelos","Estrutura de Peça / Modelos","Esqueleto de peça com tópicos obrigatórios e trechos sugeridos (ajuste de forma)."],
    ["checklist","Checklist de Peça","Checklist final para revisão: requisitos, documentos e fundamentos mínimos."],
    ["raciocinio","Raciocínio Jurídico (passo a passo)","Sequência lógica para analisar qualquer caso sobre o tema (perguntas-chave)."],
    ["mapa","Mapa Mental","Mapa textual hierárquico, compacto, destacando palavras-chave."],
    ["flash","Flashcards","10–20 cartões frente/verso com conceitos e fundamentos."],
    ["erros","Erros Comuns","Armadilhas frequentes e como evitá-las (OAB/concursos/prática)."],
    ["atual","Atualizações Recentes","Mudanças legislativas/jurisprudenciais relevantes dos últimos 24 meses."],
    ["dicas","Dicas de Prova (OAB/Concursos)","Como a banca costuma cobrar, pegadinhas e gestão de tempo."],
    ["refs","Referências Bibliográficas","Obras e artigos recomendados para aprofundamento."],
  ];
  const optsWrap=$("#opts");
  function renderOpts(){
    optsWrap.innerHTML='';
    optsData.forEach(([id,titulo,desc])=>{
      const row=document.createElement('div'); row.className='opt';
      const txt=document.createElement('div'); txt.className='opt__txt';
      txt.innerHTML=`<h4>${titulo}</h4><div class="muted">${desc}</div>`;
      const tog=document.createElement('div'); tog.className='opt__toggle';
      const b=document.createElement('button'); b.className='btn-ghost'; b.textContent='Selecionar'; b.dataset.id=id;
      b.addEventListener('click',()=>{ const on=b.classList.toggle('is-on'); b.textContent=on?'Selecionado':'Selecionar'; });
      tog.appendChild(b); row.appendChild(txt); row.appendChild(tog); optsWrap.appendChild(row);
    });
  }
  renderOpts();

  // dica após 3s do primeiro digito
  const tema=$("#tema"), temaHint=$("#temaHint");
  let typedOnce=false, hintTimer=null;
  tema.addEventListener('input', ()=>{
    if(!typedOnce && tema.value.trim().length>=1){
      typedOnce=true;
      clearTimeout(hintTimer);
      hintTimer=setTimeout(()=>temaHint.classList.add('show'), 3000);
    }
  });

  $("#btnLimparTema").addEventListener('click', ()=>{ tema.value=''; temaHint.classList.remove('show'); typedOnce=false; });

  function montarPrompt(){
    const temaTxt = tema.value.trim();
    const escolhidas = [...$$('.opt .btn-ghost.is-on')].map(b=>b.dataset.id);
    const blocos = escolhidas.map(id=>{
      const item = optsData.find(x=>x[0]===id);
      if(!item) return '';
      return `### ${item[1]}\n${item[2]}`;
    }).filter(Boolean).join('\n\n');
    const core = `Você é um assistente jurídico. Elabore um material de estudo claro e objetivo sobre o tema abaixo, seguindo as sessões selecionadas.\n\n**Tema:** ${temaTxt || '(definir)'}\n\n${blocos ? `**Sessões selecionadas:**\n\n${blocos}` : 'Selecione sessões para detalhamento.'}`;
    return core;
  }

  const modal=$("#modal"), out=$("#outPrompt"), iaChips=$("#iaChips");
  $("#btnGerar").addEventListener('click', ()=>{
    out.value = montarPrompt();
    iaChips.style.display='none';
    modal.classList.add('show');
  });
  $("#btnFechar").addEventListener('click', ()=>{ modal.classList.remove('show'); });
  $("#btnNovo").addEventListener('click', ()=>{
    tema.value=''; temaHint.classList.remove('show'); typedOnce=false;
    [...$$('.opt .btn-ghost.is-on')].forEach(b=>{ b.classList.remove('is-on'); b.textContent='Selecionar'; });
    out.value=''; iaChips.style.display='none'; modal.classList.remove('show');
  });
  $("#btnCopy").addEventListener('click', async()=>{
    try{ await navigator.clipboard.writeText(out.value||''); toast('Copiado!'); iaChips.style.display='block'; }
    catch{ toast('Erro ao copiar.'); }
  });

})();</script>
</body>
</html>
